<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Fasset: C:/main/trunk/src/soil/soilProfile.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Fasset</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">C:/main/trunk/src/soil/soilProfile.cpp</div>  </div>
</div>
<div class="contents">
<a href="soil_profile_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/****************************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"> $URL$</span>
<a name="l00003"></a>00003 <span class="comment"> $LastChangedDate$</span>
<a name="l00004"></a>00004 <span class="comment"> $LastChangedRevision$</span>
<a name="l00005"></a>00005 <span class="comment"> $LastChangedBy$</span>
<a name="l00006"></a>00006 <span class="comment">\****************************************************************************/</span>
<a name="l00007"></a>00007 <span class="comment">/****************************************************************************\</span>
<a name="l00008"></a>00008 <span class="comment">Column of soil layers stored as a list</span>
<a name="l00009"></a>00009 <span class="comment">(c) J�rgen E. Olesen, Statens Planteavlsfors�g</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment">Changes:</span>
<a name="l00012"></a>00012 <span class="comment">   JEO 23-06-1997: Support for NULL-pointer in rootLengthList added</span>
<a name="l00013"></a>00013 <span class="comment">   JEO 23-06-1997: GetPoolCarbon and GetPoolNitrogen added</span>
<a name="l00014"></a>00014 <span class="comment">   JEO 08-07-1997: GetAmmoniumLeaching and GetNitrateLeaching added</span>
<a name="l00015"></a>00015 <span class="comment">   JEO 27-10-1997: New soil evaporation formula</span>
<a name="l00016"></a>00016 <span class="comment">   BMP 15-09-1999: Corrected errors in function &quot;GetTemperature&quot;</span>
<a name="l00017"></a>00017 <span class="comment">   BMP 04-07-2000: Corrected error in destructor</span>
<a name="l00018"></a>00018 <span class="comment">   BMP 02-08-2000: Switch between tipping bucket and darcy flow implemented</span>
<a name="l00019"></a>00019 <span class="comment">   MEL 01-03-2007: New temperature model (finite difference solution) implemented</span>
<a name="l00020"></a>00020 <span class="comment">   MEL 15-05-2007: New Water model from the SWAT model implemented</span>
<a name="l00021"></a>00021 <span class="comment">\****************************************************************************/</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;../base/common.h&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="soil_profile_8h.html">soilProfile.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;../base/cloneList.h&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;../base/bstime.h&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;../base/message.h&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="soil_8h.html">soil.h</a>&quot;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;../base/controlParameters.h&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;../base/climate.h&quot;</span>
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="soil_profile_8cpp.html#abe32a77da4fc54336203eca151b28875">00033</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_profile_8cpp.html#abe32a77da4fc54336203eca151b28875">LatentHeatMelting</a> = 334400.0;                                              <span class="comment">//J/kg</span>
<a name="l00034"></a><a class="code" href="soil_profile_8cpp.html#aa802d053b0e834f15ac8331c6c1d42b8">00034</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_layer_8cpp.html#aa802d053b0e834f15ac8331c6c1d42b8">HeatCapacityWater</a> = 4192.0;                                                <span class="comment">// J/(kg dgC)</span>
<a name="l00035"></a><a class="code" href="soil_profile_8cpp.html#a3429b0569d7d39f18cbcb8bfba864023">00035</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_layer_8cpp.html#a3429b0569d7d39f18cbcb8bfba864023">HeatCapacitySolid</a> = 750.0;                                                         <span class="comment">// J/(kg dgC)</span>
<a name="l00036"></a><a class="code" href="soil_profile_8cpp.html#a60ac72fe64fb25fb3826fa9324a8ab6e">00036</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_layer_8cpp.html#a60ac72fe64fb25fb3826fa9324a8ab6e">HeatCapacityIce</a> = 2050;                              <span class="comment">// J/(kg dgC)</span>
<a name="l00037"></a><a class="code" href="soil_profile_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">00037</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_layer_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">WaterDensity</a>=1000;                                                                 <span class="comment">// kg/m3</span>
<a name="l00038"></a><a class="code" href="soil_profile_8cpp.html#a9b7cb6558bb43062b69e5ff4633ab65e">00038</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_profile_8cpp.html#a9b7cb6558bb43062b69e5ff4633ab65e">IceDensity</a>=920;                                                                    <span class="comment">// kg/m3</span>
<a name="l00039"></a><a class="code" href="soil_profile_8cpp.html#a93c72ef3556ca3c949c47c262342d6d8">00039</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_profile_8cpp.html#a93c72ef3556ca3c949c47c262342d6d8">VolHeatCapacityIce</a>=<a class="code" href="soil_layer_8cpp.html#a60ac72fe64fb25fb3826fa9324a8ab6e">HeatCapacityIce</a>*<a class="code" href="soil_profile_8cpp.html#a9b7cb6558bb43062b69e5ff4633ab65e">IceDensity</a>;             <span class="comment">//J/(m3 dgC)</span>
<a name="l00040"></a><a class="code" href="soil_profile_8cpp.html#a9f9b68b68cac2da8b1f620458740f11e">00040</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_profile_8cpp.html#a9f9b68b68cac2da8b1f620458740f11e">VolHeatCapacityWater</a>=<a class="code" href="soil_layer_8cpp.html#aa802d053b0e834f15ac8331c6c1d42b8">HeatCapacityWater</a>*<a class="code" href="soil_layer_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">WaterDensity</a>; <span class="comment">//J/(m3 dgC)</span>
<a name="l00041"></a><a class="code" href="soil_profile_8cpp.html#a269902d013e2fa7ce90ecb1d85805602">00041</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_profile_8cpp.html#a269902d013e2fa7ce90ecb1d85805602">snowConductivity</a> = 2.86e-6*300*300;  <span class="comment">// se DAISY</span>
<a name="l00042"></a><a class="code" href="soil_profile_8cpp.html#a2b1af553057bae6c283762156c7f5469">00042</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_profile_8cpp.html#a2b1af553057bae6c283762156c7f5469">specCapacity</a> = <a class="code" href="soil_profile_8cpp.html#abe32a77da4fc54336203eca151b28875">LatentHeatMelting</a>*<a class="code" href="soil_layer_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">WaterDensity</a>; <span class="comment">//J/m3</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="comment">/****************************************************************************\</span>
<a name="l00045"></a>00045 <span class="comment">\****************************************************************************/</span>
<a name="l00046"></a><a class="code" href="classsoil_profile.html#a189f609ac4771c844111fd994bc6fdd4">00046</a> <a class="code" href="classsoil_profile.html#a189f609ac4771c844111fd994bc6fdd4">soilProfile::soilProfile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * Pname,<span class="keyword">const</span> <span class="keywordtype">int</span> Index,<span class="keyword">const</span> <a class="code" href="classbase.html">base</a> * owner)
<a name="l00047"></a>00047    : <a class="code" href="classbase.html">base</a>(Pname,Index,owner)
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049         last=first = NULL;
<a name="l00050"></a>00050         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>;i++)
<a name="l00051"></a>00051                 nitrogenUptake[i].Clear();
<a name="l00052"></a>00052         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>;i++)
<a name="l00053"></a>00053    {
<a name="l00054"></a>00054       soilLayerArray[i]=NULL;
<a name="l00055"></a>00055       distanceToPreviousLayer[i]=0;
<a name="l00056"></a>00056       distanceToNextLayer[i]=0;
<a name="l00057"></a>00057       <span class="comment">//NJH did this, feb 2009</span>
<a name="l00058"></a>00058       temperature[i]=0;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">//</span>
<a name="l00061"></a>00061    }
<a name="l00062"></a>00062       <span class="comment">//NJH did this, feb 2009</span>
<a name="l00063"></a>00063    infiltration = 0.0;
<a name="l00064"></a>00064    depthDampning = 0.0;
<a name="l00065"></a>00065         maxRootDepth        = 0.0;
<a name="l00066"></a>00066         NumOfSoilLayers     = 0;
<a name="l00067"></a>00067         EvapExtCoef         = 0.01;
<a name="l00068"></a>00068         EvaporationCapacity = 10.0;
<a name="l00069"></a>00069         EvaporationContent  = 0.0;
<a name="l00070"></a>00070    minTemp[0]=-10;
<a name="l00071"></a>00071    minTemp[1]=-10;
<a name="l00072"></a>00072    minTemp[2]=-10;
<a name="l00073"></a>00073    minTemp[3]=-3;
<a name="l00074"></a>00074    minTemp[4]=0;
<a name="l00075"></a>00075    minTemp[5]=5;
<a name="l00076"></a>00076    minTemp[6]=7;
<a name="l00077"></a>00077    minTemp[7]=8; <span class="comment">// Because of start-up problem</span>
<a name="l00078"></a>00078    minTemp[8]=8;
<a name="l00079"></a>00079    minTemp[9]=3;
<a name="l00080"></a>00080    minTemp[10]=-5;
<a name="l00081"></a>00081    minTemp[11]=-10;
<a name="l00082"></a>00082    lastErrorYear=-1;
<a name="l00083"></a>00083    calculateAverage=<span class="keyword">true</span>;
<a name="l00084"></a>00084 }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="comment">/****************************************************************************\</span>
<a name="l00087"></a>00087 <span class="comment">\****************************************************************************/</span>
<a name="l00088"></a><a class="code" href="classsoil_profile.html#a4047f818afa5dc48f8d7abdeb85658b9">00088</a> <a class="code" href="classsoil_profile.html#a189f609ac4771c844111fd994bc6fdd4">soilProfile::soilProfile</a>(<span class="keyword">const</span> <a class="code" href="classsoil_profile.html">soilProfile</a>&amp; Profile)
<a name="l00089"></a>00089  : <a class="code" href="classbase.html">base</a>(Profile)
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091    NumOfSoilLayers     = Profile.NumOfSoilLayers;
<a name="l00092"></a>00092    EvapExtCoef         = Profile.EvapExtCoef;
<a name="l00093"></a>00093    EvaporationCapacity = Profile.EvaporationCapacity;
<a name="l00094"></a>00094    EvaporationContent  = Profile.EvaporationContent;
<a name="l00095"></a>00095    maxRootDepth        = Profile.maxRootDepth;
<a name="l00096"></a>00096    first = NULL;
<a name="l00097"></a>00097    last  = NULL;
<a name="l00098"></a>00098    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>;i++)
<a name="l00099"></a>00099         nitrogenUptake[i].Clear();
<a name="l00100"></a>00100    <span class="keywordtype">int</span> i = 0;
<a name="l00101"></a>00101    <span class="keywordflow">if</span> (&amp;Profile)
<a name="l00102"></a>00102    {
<a name="l00103"></a>00103         <a class="code" href="classsoil_layer.html">soilLayer</a> * current;
<a name="l00104"></a>00104         <a class="code" href="classsoil_layer.html">soilLayer</a> * tempLayer;
<a name="l00105"></a>00105         current = Profile.first;
<a name="l00106"></a>00106       <span class="keywordflow">while</span> (current)
<a name="l00107"></a>00107       {
<a name="l00108"></a>00108          tempLayer = <span class="keyword">new</span> <a class="code" href="classsoil_layer.html">soilLayer</a>(*current);
<a name="l00109"></a>00109          <a class="code" href="classsoil_profile.html#a92dfd951458d1d150e642f35e135f4b3">AddItem</a>(tempLayer);
<a name="l00110"></a>00110          soilLayerArray[i]=tempLayer;
<a name="l00111"></a>00111          soilLayerArray[i]-&gt;<a class="code" href="classbase.html#a42c446f0adea294e97a2486946b7cbc4">SetOwner</a>(<span class="keyword">this</span>);
<a name="l00112"></a>00112          current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l00113"></a>00113          i++;
<a name="l00114"></a>00114       }
<a name="l00115"></a>00115       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;ExtraLayers;i++)             <span class="comment">// extra layers</span>
<a name="l00116"></a>00116       {
<a name="l00117"></a>00117         soilLayerArray[NumOfSoilLayers+i] = <span class="keyword">new</span> <a class="code" href="classsoil_layer.html">soilLayer</a>(*Profile.soilLayerArray[NumOfSoilLayers+i]);    <span class="comment">//  extraLayer</span>
<a name="l00118"></a>00118          soilLayerArray[NumOfSoilLayers+i]-&gt;<a class="code" href="classbase.html#a42c446f0adea294e97a2486946b7cbc4">SetOwner</a>(<span class="keyword">this</span>);
<a name="l00119"></a>00119       }
<a name="l00120"></a>00120       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;(NumOfSoilLayers+ExtraLayers);i++)
<a name="l00121"></a>00121       {
<a name="l00122"></a>00122          distanceToPreviousLayer[i] = Profile.distanceToPreviousLayer[i];
<a name="l00123"></a>00123          distanceToNextLayer[i]     = Profile.distanceToNextLayer[i];
<a name="l00124"></a>00124          temperature[i]             = Profile.temperature[i];
<a name="l00125"></a>00125       }
<a name="l00126"></a>00126    }
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="comment">/****************************************************************************\</span>
<a name="l00130"></a>00130 <span class="comment">Distances between layers considered equal.</span>
<a name="l00131"></a>00131 <span class="comment">This assumption is not tested though.</span>
<a name="l00132"></a>00132 <span class="comment">\****************************************************************************/</span>
<a name="l00133"></a><a class="code" href="classsoil_profile.html#a7fd5e793b56ea8fbc1aeb79e1927565e">00133</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#a7fd5e793b56ea8fbc1aeb79e1927565e">soilProfile::Add</a>(<a class="code" href="classsoil_profile.html">soilProfile</a>* Profile,<span class="keywordtype">double</span> <a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135    <span class="keywordflow">if</span> (NumOfSoilLayers!=Profile-&gt;NumOfSoilLayers)
<a name="l00136"></a>00136         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::profiles with different number of layers can&#39;t be added!&quot;</span>);
<a name="l00137"></a>00137 
<a name="l00138"></a>00138    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>;i++)
<a name="l00139"></a>00139         nitrogenUptake[i].Clear();
<a name="l00140"></a>00140    EvapExtCoef         = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*EvapExtCoef+fraction*Profile-&gt;EvapExtCoef;
<a name="l00141"></a>00141    EvaporationCapacity = (1.0-fraction)*EvaporationCapacity+fraction*Profile-&gt;EvaporationCapacity;
<a name="l00142"></a>00142    EvaporationContent  = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*EvaporationContent+fraction*Profile-&gt;EvaporationContent;
<a name="l00143"></a>00143    maxRootDepth        = (1.0-fraction)*maxRootDepth+fraction*Profile-&gt;maxRootDepth;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(NumOfSoilLayers+ExtraLayers); i++)
<a name="l00146"></a>00146    {
<a name="l00147"></a>00147       soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a6dcefc2b3278461493f73971d8885cb7">Add</a>(Profile-&gt;soilLayerArray[i],fraction);
<a name="l00148"></a>00148       temperature[i]  = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*temperature[i]+fraction*Profile-&gt;temperature[i];
<a name="l00149"></a>00149    }
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 <span class="comment">/****************************************************************************\</span>
<a name="l00153"></a>00153 <span class="comment">\****************************************************************************/</span>
<a name="l00154"></a><a class="code" href="classsoil_profile.html#a1af23872681bafd0ed93e666646e5f2d">00154</a> <a class="code" href="classsoil_profile.html#a1af23872681bafd0ed93e666646e5f2d">soilProfile::~soilProfile</a>()
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156         <span class="keywordflow">if</span> (NumOfSoilLayers&gt;0) <span class="comment">// Otherwise never initialised</span>
<a name="l00157"></a>00157                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(NumOfSoilLayers+ExtraLayers); i++)
<a name="l00158"></a>00158                 <span class="keyword">delete</span> soilLayerArray[i];
<a name="l00159"></a>00159    <span class="keywordflow">if</span> (SoilTempFile)
<a name="l00160"></a>00160         SoilTempFile.close();
<a name="l00161"></a>00161 }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="comment">/****************************************************************************\</span>
<a name="l00164"></a>00164 <span class="comment">\****************************************************************************/</span>
<a name="l00165"></a>00165 <span class="keywordtype">void</span> soilProfile::AssignMaxRootDepth()
<a name="l00166"></a>00166 {
<a name="l00167"></a>00167    <span class="keyword">const</span> <span class="keywordtype">double</span> c1=0.06;
<a name="l00168"></a>00168    <span class="keyword">const</span> <span class="keywordtype">double</span> c2=0.15;
<a name="l00169"></a>00169    <span class="keyword">const</span> <span class="keywordtype">double</span> d1=600.0;
<a name="l00170"></a>00170    <span class="keyword">const</span> <span class="keywordtype">double</span> d2=2000.0;
<a name="l00171"></a>00171    <a class="code" href="classbase.html#a5c9e361dfd9a7804a33b7baa8f5a4b1f">UnsetCritical</a>();
<a name="l00172"></a>00172    <span class="keywordflow">if</span> (!<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;MaxRootDepth&quot;</span>, &amp;maxRootDepth))
<a name="l00173"></a>00173    {
<a name="l00174"></a>00174         <span class="keywordtype">double</span> Clay = <a class="code" href="classsoil_profile.html#a27959c28ab4031f581b0e17142a45b7f">GetClayContent</a>(500.0,200.0);
<a name="l00175"></a>00175         <span class="keywordflow">if</span> (Clay&lt;c1)
<a name="l00176"></a>00176                 maxRootDepth = d1;
<a name="l00177"></a>00177         <span class="keywordflow">else</span>
<a name="l00178"></a>00178                 maxRootDepth = min(d2,d1+(d2-d1)*(Clay-c1)/(c2-c1));
<a name="l00179"></a>00179    }
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 <span class="comment">/****************************************************************************\</span>
<a name="l00183"></a>00183 <span class="comment">FARM-N pig farm 96074: calls a NULL here at some point ???!!!</span>
<a name="l00184"></a>00184 <span class="comment">\****************************************************************************/</span>
<a name="l00185"></a><a class="code" href="classsoil_profile.html#aa28fc2eb898f40cec10a9e57906b36de">00185</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#aa28fc2eb898f40cec10a9e57906b36de">soilProfile::GetMaximumDepth</a>()
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187    <span class="keywordflow">if</span> (soilLayerArray[NumOfSoilLayers-1]==NULL)
<a name="l00188"></a>00188       <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::GetMaximumDepth - array points at NULL&quot;</span>);
<a name="l00189"></a>00189    <span class="keywordflow">else</span>
<a name="l00190"></a>00190       <span class="keywordflow">return</span> soilLayerArray[NumOfSoilLayers-1]-&gt;<a class="code" href="classsoil_layer.html#ab046484e00090278933a7e253e9fc004">GetEndDepth</a>();
<a name="l00191"></a>00191    <span class="keywordflow">return</span> 0;
<a name="l00192"></a>00192 }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 <span class="comment">/****************************************************************************\</span>
<a name="l00195"></a>00195 <span class="comment">\****************************************************************************/</span>
<a name="l00196"></a><a class="code" href="classsoil_profile.html#af06cdd8163adae8f60c89365e242f189">00196</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#af06cdd8163adae8f60c89365e242f189">soilProfile::Initialize</a>(fstream * f)
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198    <a class="code" href="classbase.html#a3cb378050dc4ced8420f41dcd7292239">Setfile</a>(f);
<a name="l00199"></a>00199    <span class="keywordtype">double</span> startDepth = 0.0;
<a name="l00200"></a>00200    <a class="code" href="classbase.html#a80052a7eeb8bce90247aedd358cc1cf6">SetCritical</a>();
<a name="l00201"></a>00201    <a class="code" href="classbase.html#a88e41ff60ffb7e707312a09f20457e73">FindSection</a>(<span class="stringliteral">&quot;SoilParameters&quot;</span>);
<a name="l00202"></a>00202    <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;Nodes&quot;</span>,&amp;NumOfSoilLayers);
<a name="l00203"></a>00203    <span class="keywordtype">double</span> nodeThickNess=100;
<a name="l00204"></a>00204    <a class="code" href="classbase.html#a5c9e361dfd9a7804a33b7baa8f5a4b1f">UnsetCritical</a>();
<a name="l00205"></a>00205    <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;NodeThickness&quot;</span>,&amp;nodeThickNess);
<a name="l00206"></a>00206    <span class="keywordtype">double</span> JBC[] = {0.030,0.03,0.025,0.02,0.02,0.015,0.015,0.01,0.01,0.01}; <span class="comment">// �ndre til afh�ngighed af ler !!!!!</span>
<a name="l00207"></a>00207    <span class="keywordtype">int</span> JB = 5; <span class="comment">// Dette m� v�re en fejl !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209    EvapExtCoef = JBC[JB-1];
<a name="l00210"></a>00210 
<a name="l00211"></a>00211    <a class="code" href="classsoil_layer.html">soilLayer</a> * aTempSoilLayer;
<a name="l00212"></a>00212    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;NumOfSoilLayers; i++)
<a name="l00213"></a>00213    {
<a name="l00214"></a>00214       aTempSoilLayer = <span class="keyword">new</span> <a class="code" href="classsoil_layer.html">soilLayer</a>(<span class="stringliteral">&quot;soilLayer&quot;</span>,i,<span class="keyword">this</span>);
<a name="l00215"></a>00215       aTempSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a9408711ac2943d5aff72bf3fc0e9e7c7">Initialize</a>(startDepth,nodeThickNess,f);
<a name="l00216"></a>00216       <a class="code" href="classsoil_profile.html#a92dfd951458d1d150e642f35e135f4b3">AddItem</a>(aTempSoilLayer);
<a name="l00217"></a>00217       soilLayerArray[i]=aTempSoilLayer;
<a name="l00218"></a>00218       startDepth += nodeThickNess;
<a name="l00219"></a>00219    }
<a name="l00220"></a>00220    AssignMaxRootDepth();
<a name="l00221"></a>00221    <span class="keywordflow">if</span> (startDepth&lt;maxRootDepth)
<a name="l00222"></a>00222         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::Initialize - The depth of defined layers is smaller than the root depth&quot;</span>);
<a name="l00223"></a>00223    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;NumOfSoilLayers;i++)       <span class="comment">// Calculates the distance between layers and converts to meter</span>
<a name="l00224"></a>00224    {
<a name="l00225"></a>00225       temperature[i] = 8.0;                    <span class="comment">// default temperature</span>
<a name="l00226"></a>00226       aTempSoilLayer = soilLayerArray[i];
<a name="l00227"></a>00227       <span class="keywordflow">if</span> (i==0)
<a name="l00228"></a>00228         distanceToPreviousLayer[i] = aTempSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>()/2000; <span class="comment">// 1000 ???!!!</span>
<a name="l00229"></a>00229       <span class="keywordflow">else</span>
<a name="l00230"></a>00230         distanceToPreviousLayer[i] = (aTempSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>()+soilLayerArray[i-1]-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>())/2000.0;
<a name="l00231"></a>00231       <span class="keywordflow">if</span> (i==(NumOfSoilLayers-1))
<a name="l00232"></a>00232         distanceToNextLayer[i] =  aTempSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>()/1000;
<a name="l00233"></a>00233       <span class="keywordflow">else</span>
<a name="l00234"></a>00234         distanceToNextLayer[i] = (aTempSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>()+soilLayerArray[i+1]-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>())/2000.0;
<a name="l00235"></a>00235       }
<a name="l00236"></a>00236    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;ExtraLayers;i++)             <span class="comment">// extra layers to ensure no heat flow at bottom (boundary condition)</span>
<a name="l00237"></a>00237    {
<a name="l00238"></a>00238       soilLayerArray[NumOfSoilLayers+i] = <span class="keyword">new</span> <a class="code" href="classsoil_layer.html">soilLayer</a>(*soilLayerArray[NumOfSoilLayers-1]);    <span class="comment">//  extraLayer</span>
<a name="l00239"></a>00239       temperature[i+NumOfSoilLayers] = 8.0;
<a name="l00240"></a>00240       distanceToNextLayer[i+NumOfSoilLayers]     = distanceToNextLayer[NumOfSoilLayers-1]*(i+1)*10.0; <span class="comment">// 50;</span>
<a name="l00241"></a>00241       soilLayerArray[NumOfSoilLayers+i]-&gt;<a class="code" href="classsoil_layer.html#a3c7e4208dd19b461a5fd4be87d4547b3">SetStartDepth</a>(soilLayerArray[NumOfSoilLayers+i-1]-&gt;GetStartDepth()+
<a name="l00242"></a>00242                                                        1000.0*distanceToNextLayer[i+NumOfSoilLayers-1]);
<a name="l00243"></a>00243       distanceToPreviousLayer[i+NumOfSoilLayers] = distanceToNextLayer[i+NumOfSoilLayers-1];
<a name="l00244"></a>00244       soilLayerArray[NumOfSoilLayers+i]-&gt;<a class="code" href="classsoil_layer.html#ae1569e3fcbab8c73a3fdd6d6f6e7921a">SetThickness</a>(distanceToNextLayer[i+NumOfSoilLayers]*1000.0);
<a name="l00245"></a>00245       soilLayerArray[NumOfSoilLayers+i]-&gt;<a class="code" href="classsoil_layer.html#a3483f1af86de1d9478d2d68d671ef622">SetFieldCapacity</a>(soilLayerArray[NumOfSoilLayers-1]-&gt;<a class="code" href="classsoil_profile.html#a6c154b0cb0b3ab611efde6f50d53cbc7">GetFieldCapacity</a>()/
<a name="l00246"></a>00246                                                           soilLayerArray[NumOfSoilLayers-1]-&gt;GetThickness()*
<a name="l00247"></a>00247                                                           soilLayerArray[NumOfSoilLayers+i]-&gt;GetThickness());
<a name="l00248"></a>00248       soilLayerArray[NumOfSoilLayers+i]-&gt;<a class="code" href="classsoil_layer.html#aa1344b68a8f85cd0a3e65ead0569c761">SetWater</a>(soilLayerArray[NumOfSoilLayers+i]-&gt;<a class="code" href="classsoil_profile.html#a6c154b0cb0b3ab611efde6f50d53cbc7">GetFieldCapacity</a>());
<a name="l00249"></a>00249    }
<a name="l00250"></a>00250    f=NULL;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;(NumOfSoilLayers+ExtraLayers);i++)
<a name="l00253"></a>00253    {
<a name="l00254"></a>00254         DistPreviousLayerInv[i] = 1.0/distanceToPreviousLayer[i];
<a name="l00255"></a>00255       DistNextLayerInv[i]     = 1.0/distanceToNextLayer[i];
<a name="l00256"></a>00256    }
<a name="l00257"></a>00257    <span class="keywordflow">if</span> (<a class="code" href="control_parameters_8h.html#a5f2fa76e64eab2ae2d13f038d69004aa">theControlParameters</a>-&gt;<a class="code" href="classcontrol_parameters.html#a5222f361b4bdd1ce711b9b930b7bef56">GetWriteSoilTemperature</a>())
<a name="l00258"></a>00258         SoilTempFile.open(<span class="stringliteral">&quot;soiltemp.txt&quot;</span>,ios::out);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 <span class="comment">/****************************************************************************\</span>
<a name="l00263"></a>00263 <span class="comment">Adds nitrogen to the first layer in the profile</span>
<a name="l00264"></a>00264 <span class="comment">   addNitrate    - Nitrate to be added [g N/m�]</span>
<a name="l00265"></a>00265 <span class="comment">   addAmmonium   - Ammonium to be added [g N/m�]</span>
<a name="l00266"></a>00266 <span class="comment">\****************************************************************************/</span>
<a name="l00267"></a><a class="code" href="classsoil_profile.html#aabd57b1bc75b4960731ed99fb01adba5">00267</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#aabd57b1bc75b4960731ed99fb01adba5">soilProfile::AddNutrient</a>(<a class="code" href="classnitrogen.html">nitrogen</a> soilNitrate, <a class="code" href="classnitrogen.html">nitrogen</a> soilAmmonium)
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269  <span class="keywordflow">if</span> (first != NULL)
<a name="l00270"></a>00270   first-&gt;<a class="code" href="classsoil_layer.html#a1cdb99656097b11d7b7acb329dd6cd5e">AddNutrient</a>(soilNitrate,soilAmmonium);
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="comment">/****************************************************************************\</span>
<a name="l00274"></a>00274 <span class="comment">Adds a soil layer to the profile</span>
<a name="l00275"></a>00275 <span class="comment">   data          - Soil layer object</span>
<a name="l00276"></a>00276 <span class="comment">\****************************************************************************/</span>
<a name="l00277"></a><a class="code" href="classsoil_profile.html#a92dfd951458d1d150e642f35e135f4b3">00277</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#a92dfd951458d1d150e642f35e135f4b3">soilProfile::AddItem</a>(<a class="code" href="classsoil_layer.html">soilLayer</a> * data)
<a name="l00278"></a>00278 {
<a name="l00279"></a>00279  <span class="keywordflow">if</span> (first == NULL) first = data;
<a name="l00280"></a>00280  <span class="keywordflow">else</span> last-&gt;<a class="code" href="classsoil_layer.html#a09f4c3dc099147645d71480166261191">AddNext</a>(data);
<a name="l00281"></a>00281  last = data;
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 <span class="comment">/****************************************************************************\</span>
<a name="l00285"></a>00285 <span class="comment">Performs infiltration of water, nitrate and ammonium in profile using the SWAT</span>
<a name="l00286"></a>00286 <span class="comment">water model. Simulates the transport of water and solutes with timestep one hour.</span>
<a name="l00287"></a>00287 <span class="comment">Solutes are equilibrated between mobile and immobile domain only once a day.</span>
<a name="l00288"></a>00288 <span class="comment">Optional use of convection-dispersion equation for transport in mobile domain.</span>
<a name="l00289"></a>00289 <span class="comment">(MEL 2007)</span>
<a name="l00290"></a>00290 <span class="comment">   surplus         - Water to be added to/returned from profile [mm]</span>
<a name="l00291"></a>00291 <span class="comment">   nitrateLeached  - Nitrate to the added to/returned from profile [g N/m�]</span>
<a name="l00292"></a>00292 <span class="comment">   ammoniumLeached - Ammonium to the added to/returned from profile [g N/m�]</span>
<a name="l00293"></a>00293 <span class="comment">\****************************************************************************/</span>
<a name="l00294"></a><a class="code" href="classsoil_profile.html#a942247912493da600aafecfa845d2d9c">00294</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#a942247912493da600aafecfa845d2d9c">soilProfile::UpdateInfiltrationSWAT</a>(<span class="keywordtype">double</span> *surplus, <a class="code" href="classnitrogen.html">nitrogen</a> * surfaceNitrate,
<a name="l00295"></a>00295                                      <a class="code" href="classnitrogen.html">nitrogen</a> * surfaceAmmonium, <a class="code" href="classnitrogen.html">nitrogen</a> *NitrateLeached,
<a name="l00296"></a>00296                                      <a class="code" href="classnitrogen.html">nitrogen</a> *AmmoniumLeached, <span class="keywordtype">double</span> Chloride)
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298 
<a name="l00299"></a>00299    <span class="keywordtype">double</span>
<a name="l00300"></a>00300       totalFlux[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00301"></a>00301       maxContent[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00302"></a>00302       waterContent[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00303"></a>00303 
<a name="l00304"></a>00304       FC[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00305"></a>00305       satHydraulicConductivity[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00306"></a>00306       layerThickness[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00307"></a>00307       theta[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00308"></a>00308       thetaOld[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00309"></a>00309       thetaBack[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00310"></a>00310       thetaForward[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00311"></a>00311       dispersion[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00312"></a>00312       dispersionBack[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00313"></a>00313       dispersionForward[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00314"></a>00314       flowBack[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00315"></a>00315       flowForward[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00316"></a>00316       upperVector[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00317"></a>00317       midVector[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00318"></a>00318       lowerVector[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00319"></a>00319       soluteOldVector[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00320"></a>00320       soluteOld[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00321"></a>00321       soluteNew[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00322"></a>00322       mobileNitrateFlux[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00323"></a>00323       mobileAmmoniumFlux[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00324"></a>00324       mobileNitrateN15Flux[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00325"></a>00325       mobileAmmoniumN15Flux[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00326"></a>00326       mobileChlorideFlux[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00327"></a>00327       mobileWaterNew[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00328"></a>00328       mobileWaterOld[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00329"></a>00329         immobileWater[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l00330"></a>00330 
<a name="l00331"></a>00331    <span class="keywordtype">double</span> molecularDiff=0,
<a name="l00332"></a>00332         soluteInFlux=0,
<a name="l00333"></a>00333         soluteIn=0,
<a name="l00334"></a>00334       nitrateIn=0,
<a name="l00335"></a>00335       nitrateN15In=0,
<a name="l00336"></a>00336       ammoniumIn=0,
<a name="l00337"></a>00337       ammoniumN15In=0,
<a name="l00338"></a>00338       chlorideIn=0,
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 
<a name="l00343"></a>00343 
<a name="l00344"></a>00344       standingWater=0;
<a name="l00345"></a>00345 
<a name="l00346"></a>00346    <span class="keywordtype">bool</span> IsThereSoluteFlux[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l00347"></a>00347 
<a name="l00348"></a>00348    <a class="code" href="classnitrogen.html">nitrogen</a> surplusNH4[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l00349"></a>00349    <a class="code" href="classnitrogen.html">nitrogen</a> surplusNO3[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l00350"></a>00350 
<a name="l00351"></a>00351    <span class="keywordtype">double</span> simulationTime = 0.0;
<a name="l00352"></a>00352    <span class="keywordtype">double</span> deltaT=3600;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 
<a name="l00356"></a>00356    <span class="keywordtype">int</span> TotalNumberOfLayers = NumOfSoilLayers + ExtraLayers;
<a name="l00357"></a>00357    <a class="code" href="classp_f___curve.html">pF_Curve</a> * pF[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l00358"></a>00358    <span class="keywordtype">int</span> i;
<a name="l00359"></a>00359         <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00360"></a>00360    {
<a name="l00361"></a>00361                 soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a1d47dbea22d315b19238696a7fb5bbe6">ClearLeaching</a>();             <span class="comment">// set leaching to zero</span>
<a name="l00362"></a>00362       waterContent[i] = soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#af01077dc70989747d1f48ba46bb0556c">GetTotalWater</a>();
<a name="l00363"></a>00363       pF[i] = soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a444bc7c75f30a1f722d044d7fe8f7033">GetpF_Curve</a>();
<a name="l00364"></a>00364 
<a name="l00365"></a>00365       maxContent[i]=(soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a7a50b8f89f7bc086de8ed078b729e1a3">GetPorosity</a>()*soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>());
<a name="l00366"></a>00366       totalFlux[i]=0.0;
<a name="l00367"></a>00367       FC[i]=soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#aab16e356a7dad4934471e1b0f74589ec">GetFieldCapacity</a>();
<a name="l00368"></a>00368       surplusNH4[i].<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00369"></a>00369       surplusNO3[i].<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00370"></a>00370    }
<a name="l00371"></a>00371    standingWater=*surplus;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 
<a name="l00374"></a>00374    <span class="keywordtype">int</span> soluteTransportMethod=1;     <span class="comment">//if 1 use SLIM transport option</span>
<a name="l00375"></a>00375 
<a name="l00376"></a>00376    <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00377"></a>00377    {
<a name="l00378"></a>00378       satHydraulicConductivity[i] = pF[i]-&gt;<a class="code" href="classp_f___curve.html#ad91243e8ef9217ea0979deac6dffa268">GetConductivity</a>(pF[i]-&gt;GetpF(maxContent[i]/soilLayerArray[i]-&gt;GetThickness())); <span class="comment">//in m/s</span>
<a name="l00379"></a>00379       layerThickness[i]=soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>();
<a name="l00380"></a>00380    }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382    <span class="keywordflow">while</span> (simulationTime&lt;86400)     <span class="comment">//simulates 24 hours</span>
<a name="l00383"></a>00383    {
<a name="l00384"></a>00384       <span class="keywordtype">double</span> fluxInTimeStep[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l00385"></a>00385 
<a name="l00386"></a>00386       <span class="comment">// Perform infiltration of top layer.</span>
<a name="l00387"></a>00387       infiltration=max(0.0,min(standingWater,maxContent[0]-waterContent[0]));          <span class="comment">// in mm</span>
<a name="l00388"></a>00388       <span class="keywordflow">if</span> (infiltration&gt;0.0)
<a name="l00389"></a>00389       {
<a name="l00390"></a>00390          standingWater-=infiltration;
<a name="l00391"></a>00391          waterContent[0]+=infiltration;
<a name="l00392"></a>00392          <span class="keywordflow">if</span> (waterContent[0]&gt;maxContent[0]+0.0001)
<a name="l00393"></a>00393             <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateInfiltration - top layer contains more water than physically possible&quot;</span>);
<a name="l00394"></a>00394       }
<a name="l00395"></a>00395       <span class="keywordflow">else</span>
<a name="l00396"></a>00396          <span class="keywordflow">if</span> (infiltration&lt;(-1E-10))
<a name="l00397"></a>00397             <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateInfiltrationSWAT - top layer contains more water than physically possible&quot;</span>);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399       <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00400"></a>00400          fluxInTimeStep[i]=0.0;
<a name="l00401"></a>00401 
<a name="l00402"></a>00402       <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00403"></a>00403       {
<a name="l00404"></a>00404                 <span class="keywordtype">double</span> NotFrozenWater = waterContent[i]-soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#ac3ebf6c7d7f1cb21dff528dfb33cf28d">GetIce</a>();                                            <span class="comment">//in mm</span>
<a name="l00405"></a>00405          <span class="keywordtype">double</span> travelTime = (maxContent[i]-FC[i])/(satHydraulicConductivity[i]/1000);                  <span class="comment">//in s</span>
<a name="l00406"></a>00406          <span class="keywordtype">double</span> soilWaterExcess=max(0.0,min(NotFrozenWater,waterContent[i]- FC[i]));                                    <span class="comment">//in mm</span>
<a name="l00407"></a>00407          <span class="keywordflow">if</span> (soilWaterExcess&gt;0.0)   <span class="comment">// drainage</span>
<a name="l00408"></a>00408          {
<a name="l00409"></a>00409             fluxInTimeStep[i] = soilWaterExcess*(1.0-exp(-deltaT/travelTime));   <span class="comment">//in mm per timestep</span>
<a name="l00410"></a>00410             <span class="keywordflow">if</span> (i&lt;(TotalNumberOfLayers-1))
<a name="l00411"></a>00411             {
<a name="l00412"></a>00412                fluxInTimeStep[i] = max(0.0,min(fluxInTimeStep[i],maxContent[i+1]-waterContent[i+1]));       <span class="comment">//reduce flux according to capacity in next layer</span>
<a name="l00413"></a>00413                waterContent[i+1] += fluxInTimeStep[i];                                                  <span class="comment">//add flux to next layer</span>
<a name="l00414"></a>00414             }
<a name="l00415"></a>00415             waterContent[i] -= fluxInTimeStep[i];                                                       <span class="comment">//remove flux from present layer</span>
<a name="l00416"></a>00416             totalFlux[i]+=fluxInTimeStep[i];
<a name="l00417"></a>00417          }
<a name="l00418"></a>00418          <span class="keywordflow">else</span>
<a name="l00419"></a>00419          fluxInTimeStep[i]=0.0;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421          <span class="keywordflow">if</span> (waterContent[i]&gt;maxContent[i]+0.0001)
<a name="l00422"></a>00422             <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateInfiltrationSWAT - soil layer contains more than physically possible&quot;</span>);
<a name="l00423"></a>00423       }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425       <span class="comment">// Transport of water and solutes -------------------------------------------</span>
<a name="l00426"></a>00426       <span class="keywordtype">double</span> f=1.0; <span class="comment">// f is fraction of surface water that enter the soil</span>
<a name="l00427"></a>00427       <span class="keywordflow">if</span> (*surplus&gt;0)
<a name="l00428"></a>00428          f=(*surplus-standingWater)/(*surplus);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430       <span class="keywordflow">if</span> (soluteTransportMethod==1)
<a name="l00431"></a>00431       {
<a name="l00432"></a>00432          <a class="code" href="classnitrogen.html">nitrogen</a> Nadd = *surfaceNitrate*f + (*surfaceAmmonium*f);
<a name="l00433"></a>00433          soilLayerArray[0]-&gt;<a class="code" href="classsoil_layer.html#a491ca2b3b788a1c66221610124e19929">AddWater</a>(*surplus*f,*surfaceNitrate*f,*surfaceAmmonium*f,Chloride);
<a name="l00434"></a>00434          <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00435"></a>00435          {
<a name="l00436"></a>00436             <span class="keywordflow">if</span> (waterContent[i]&gt;(maxContent[i]+0.1))
<a name="l00437"></a>00437                <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateInfiltrationSWAT - water content in soil layer exceeds the possible&quot;</span>);
<a name="l00438"></a>00438             soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a8b23d590179f5af403f95521d83aa98c">SetWaterFlux</a>(fluxInTimeStep[i]);
<a name="l00439"></a>00439             soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#ac58f88c6110ed8e40e12dd469fca7600">SetEquilibrated</a>(<span class="keyword">false</span>);
<a name="l00440"></a>00440             <a class="code" href="classnitrogen.html">nitrogen</a> NO3;
<a name="l00441"></a>00441             <a class="code" href="classnitrogen.html">nitrogen</a> NH4;
<a name="l00442"></a>00442             <span class="keywordflow">if</span> (fluxInTimeStep[i]&gt;0.0) <span class="comment">// Downward movement</span>
<a name="l00443"></a>00443             {
<a name="l00444"></a>00444                soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a88b4d99d40dcc208f9a4c3776e85d130">RemoveWaterHourly</a>(fluxInTimeStep[i],&amp;NO3,&amp;NH4,&amp;Chloride);
<a name="l00445"></a>00445                <span class="keywordflow">if</span> (i==TotalNumberOfLayers-1)
<a name="l00446"></a>00446                {
<a name="l00447"></a>00447                   *NitrateLeached = NO3;
<a name="l00448"></a>00448                   *AmmoniumLeached = NH4;
<a name="l00449"></a>00449                }
<a name="l00450"></a>00450                <span class="keywordflow">if</span> (i&lt;(TotalNumberOfLayers-1))
<a name="l00451"></a>00451                   soilLayerArray[i+1]-&gt;<a class="code" href="classsoil_layer.html#a491ca2b3b788a1c66221610124e19929">AddWater</a>(fluxInTimeStep[i],NO3,NH4,Chloride);
<a name="l00452"></a>00452             }
<a name="l00453"></a>00453          }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455          *surplus=*surplus*(1.0-f);
<a name="l00456"></a>00456          *surfaceNitrate=*surfaceNitrate*(1.0-f);
<a name="l00457"></a>00457          *surfaceAmmonium=*surfaceAmmonium*(1.0-f);
<a name="l00458"></a>00458          <span class="comment">//hvad med chloride!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00459"></a>00459       }
<a name="l00460"></a>00460       <span class="keywordflow">else</span>
<a name="l00461"></a>00461       <span class="comment">// Use convection-dispersion equation on mobile domain</span>
<a name="l00462"></a>00462       {
<a name="l00463"></a>00463       <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::UpdateInfiltrationSWAT - Convection-dispersion equation for solute transport not properly implemented&quot;</span>);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465          <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00466"></a>00466          {
<a name="l00467"></a>00467             mobileWaterOld[i]=max(0.0,soilLayerArray[i]-&gt;<a class="code" href="classsoil_profile.html#a25cf83f98b4a58017331dbf78ee31824">GetTotalWater</a>()-FC[i]);
<a name="l00468"></a>00468             immobileWater[i]= soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#af01077dc70989747d1f48ba46bb0556c">GetTotalWater</a>()-mobileWaterOld[i];
<a name="l00469"></a>00469             mobileWaterNew[i]=max(0.0,waterContent[i]-immobileWater[i]);  <span class="comment">//</span>
<a name="l00470"></a>00470          }
<a name="l00471"></a>00471          <span class="comment">//solve individually for nitrate, ammonium and chloride</span>
<a name="l00472"></a>00472          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> soluteType=0;soluteType&lt;5;soluteType++)
<a name="l00473"></a>00473          {
<a name="l00474"></a>00474             <span class="keywordflow">if</span> (soluteType==0)        <span class="comment">//nitrate N</span>
<a name="l00475"></a>00475             {
<a name="l00476"></a>00476                molecularDiff=1.902e-9;        <span class="comment">//m2 s-1               //Change to diffusion coefficient in dilute solutions  !!!!!!!!!!!!</span>
<a name="l00477"></a>00477                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00478"></a>00478                   <span class="keywordflow">if</span> (mobileWaterOld[i]&gt;0.0)
<a name="l00479"></a>00479                      soluteOld[i]=soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#aea200059c9f20c7c8583080eb088a0a0">GetMobileNitrate</a>().<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>/(mobileWaterOld[i]/1000.0);
<a name="l00480"></a>00480                   <span class="keywordflow">else</span>
<a name="l00481"></a>00481                      soluteOld[i]=0.0;
<a name="l00482"></a>00482                soluteIn= surfaceNitrate-&gt;<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>*f;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484                nitrateIn=soluteIn;
<a name="l00485"></a>00485             }
<a name="l00486"></a>00486             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (soluteType==1)    <span class="comment">//ammonium N</span>
<a name="l00487"></a>00487             {
<a name="l00488"></a>00488                molecularDiff=1.957e-9;        <span class="comment">//m2 s-1</span>
<a name="l00489"></a>00489                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00490"></a>00490                   <span class="keywordflow">if</span> (mobileWaterOld[i]&gt;0.0)
<a name="l00491"></a>00491                      soluteOld[i]=soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#ac8edbc242467d49754f2e9dd75e0f06c">GetMobileAmmonium</a>().<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>/(mobileWaterOld[i]/1000.0);
<a name="l00492"></a>00492                   <span class="keywordflow">else</span>
<a name="l00493"></a>00493                      soluteOld[i]=0.0;
<a name="l00494"></a>00494                soluteIn= surfaceAmmonium-&gt;<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>*f;
<a name="l00495"></a>00495 
<a name="l00496"></a>00496 
<a name="l00497"></a>00497                 ammoniumIn=soluteIn;
<a name="l00498"></a>00498             }
<a name="l00499"></a>00499             <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (soluteType==2)    <span class="comment">//chloride</span>
<a name="l00500"></a>00500             {
<a name="l00501"></a>00501                molecularDiff=2.032e-9;        <span class="comment">//m2 s-1</span>
<a name="l00502"></a>00502                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00503"></a>00503                   <span class="keywordflow">if</span> (mobileWaterOld[i]&gt;0.0)
<a name="l00504"></a>00504                      soluteOld[i]=soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a5fbc355a58ae5a65cacdc2646c3539ff">GetMobileChloride</a>()/(mobileWaterOld[i]/1000.0);
<a name="l00505"></a>00505                   <span class="keywordflow">else</span>
<a name="l00506"></a>00506                      soluteOld[i]=0.0;
<a name="l00507"></a>00507                soluteIn=Chloride*f;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 
<a name="l00510"></a>00510                chlorideIn=soluteIn;
<a name="l00511"></a>00511             }
<a name="l00512"></a>00512             <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (soluteType==3)    <span class="comment">//nitrate 15N</span>
<a name="l00513"></a>00513             {
<a name="l00514"></a>00514                molecularDiff=1.902e-9;        <span class="comment">//m2 s-1</span>
<a name="l00515"></a>00515                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00516"></a>00516                   <span class="keywordflow">if</span> (mobileWaterOld[i]&gt;0.0)
<a name="l00517"></a>00517                      soluteOld[i]=soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#aea200059c9f20c7c8583080eb088a0a0">GetMobileNitrate</a>().<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>/(mobileWaterOld[i]/1000.0);
<a name="l00518"></a>00518                   <span class="keywordflow">else</span>
<a name="l00519"></a>00519                      soluteOld[i]=0.0;
<a name="l00520"></a>00520                soluteIn=surfaceNitrate-&gt;<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>*f;
<a name="l00521"></a>00521 
<a name="l00522"></a>00522 
<a name="l00523"></a>00523                nitrateN15In=soluteIn;
<a name="l00524"></a>00524             }
<a name="l00525"></a>00525             <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (soluteType==4)    <span class="comment">//ammonium 15N</span>
<a name="l00526"></a>00526             {
<a name="l00527"></a>00527                molecularDiff=1.957e-9;                                                                                    <span class="comment">//m2 s-1</span>
<a name="l00528"></a>00528                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00529"></a>00529                   <span class="keywordflow">if</span> (mobileWaterOld[i]&gt;0.0)
<a name="l00530"></a>00530                      soluteOld[i]=soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#ac8edbc242467d49754f2e9dd75e0f06c">GetMobileAmmonium</a>().<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>/(mobileWaterOld[i]/1000.0);   <span class="comment">//g/m2</span>
<a name="l00531"></a>00531                   <span class="keywordflow">else</span>
<a name="l00532"></a>00532                      soluteOld[i]=0.0;
<a name="l00533"></a>00533                soluteIn=surfaceAmmonium-&gt;<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>*f;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 
<a name="l00536"></a>00536                ammoniumN15In=soluteIn;
<a name="l00537"></a>00537             }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539             <span class="keywordtype">bool</span> nonZeroConcentration=<span class="keyword">false</span>;
<a name="l00540"></a>00540             <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00541"></a>00541                <span class="keywordflow">if</span> (soluteOld[i]&gt;0.0)
<a name="l00542"></a>00542                    nonZeroConcentration=<span class="keyword">true</span>;
<a name="l00543"></a>00543             <span class="keywordflow">if</span> (soluteIn&gt;0.0)
<a name="l00544"></a>00544                nonZeroConcentration=<span class="keyword">true</span>;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546 
<a name="l00547"></a>00547                <span class="keywordtype">double</span> tortuosity=0.6;             <span class="comment">//</span>
<a name="l00548"></a>00548                <span class="keywordtype">double</span> dispersionLength=0.02;                                                                              <span class="comment">//m</span>
<a name="l00549"></a>00549 
<a name="l00550"></a>00550                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00551"></a>00551                {
<a name="l00552"></a>00552                   theta[i]=min(1.0,mobileWaterNew[i]/soilLayerArray[i]-&gt;GetThickness());
<a name="l00553"></a>00553                   thetaOld[i]=min(1.0,mobileWaterOld[i]/soilLayerArray[i]-&gt;GetThickness());
<a name="l00554"></a>00554                   soluteNew[i]= soluteOld[i];
<a name="l00555"></a>00555                }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557             <span class="keywordflow">if</span>(nonZeroConcentration)  <span class="comment">//bypass if no concentration is above zero</span>
<a name="l00558"></a>00558             {
<a name="l00559"></a>00559             <span class="comment">//determine where there is a solute flux (calculated out of the layer)</span>
<a name="l00560"></a>00560                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00561"></a>00561                   <span class="keywordflow">if</span> ((fluxInTimeStep[i]&gt;0.0) ||
<a name="l00562"></a>00562                   ((mobileWaterOld[i+1]&gt;0.0) &amp;&amp;
<a name="l00563"></a>00563                   (mobileWaterOld[i]&gt;0.0)))
<a name="l00564"></a>00564                      IsThereSoluteFlux[i]=<span class="keyword">true</span>;
<a name="l00565"></a>00565                   <span class="keywordflow">else</span>
<a name="l00566"></a>00566                      IsThereSoluteFlux[i]=<span class="keyword">false</span>;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568                <span class="comment">//calculate centered values</span>
<a name="l00569"></a>00569                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00570"></a>00570                {
<a name="l00571"></a>00571                   <span class="keywordflow">if</span> (i==0)
<a name="l00572"></a>00572                   {
<a name="l00573"></a>00573                      thetaBack[i]=0.5*(theta[i]+thetaOld[i]);
<a name="l00574"></a>00574                      thetaForward[i]=0.25*(theta[i]+theta[i+1]+thetaOld[i]+thetaOld[i+1]);
<a name="l00575"></a>00575                      flowBack[i]=infiltration/deltaT/1000;
<a name="l00576"></a>00576                      flowForward[i]=fluxInTimeStep[i]/deltaT/1000;
<a name="l00577"></a>00577                      <span class="keywordflow">if</span> (theta[i]==0.0||thetaOld[i]==0.0)
<a name="l00578"></a>00578                         dispersion[i]=0.0;
<a name="l00579"></a>00579                      <span class="keywordflow">else</span>
<a name="l00580"></a>00580                         dispersion[i]=dispersionLength*0.5*(flowForward[i]+flowBack[i])/(0.5*(theta[i]+thetaOld[i]))+molecularDiff*tortuosity;
<a name="l00581"></a>00581 <span class="comment">//                     if ((theta[i]==0.0)||(theta[i-1]==0.0))</span>
<a name="l00582"></a>00582                         dispersionBack[i]=0.0;
<a name="l00583"></a>00583 <span class="comment">//                     else</span>
<a name="l00584"></a>00584 <span class="comment">//                        dispersionBack[i]=dispersionLength*flowBack[i]/thetaBack[i]+molecularDiff*tortuosity;</span>
<a name="l00585"></a>00585                      <span class="keywordflow">if</span> ((theta[i]==0.0) || (thetaOld[i]==0.0)||(theta[i+1]==0.0)||(thetaOld[i+1]==0.0))
<a name="l00586"></a>00586                         dispersionForward[i]=0.0;
<a name="l00587"></a>00587                      <span class="keywordflow">else</span>
<a name="l00588"></a>00588                         dispersionForward[i]=dispersionLength*flowForward[i]/thetaForward[i]+molecularDiff*tortuosity;
<a name="l00589"></a>00589                   }
<a name="l00590"></a>00590                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i==TotalNumberOfLayers-1)
<a name="l00591"></a>00591                   {
<a name="l00592"></a>00592                      thetaBack[i]=0.25*(theta[i-1]+theta[i]+thetaOld[i-1]+thetaOld[i]);
<a name="l00593"></a>00593                      thetaForward[i]=0.5*(theta[i]+thetaOld[i]);
<a name="l00594"></a>00594                      flowBack[i]=fluxInTimeStep[i-1]/deltaT/1000;
<a name="l00595"></a>00595                      flowForward[i]=fluxInTimeStep[i]/deltaT/1000;
<a name="l00596"></a>00596                      <span class="keywordflow">if</span> (theta[i]==0.0||thetaOld[i]==0.0)
<a name="l00597"></a>00597                         dispersion[i]=0.0;
<a name="l00598"></a>00598                      <span class="keywordflow">else</span>
<a name="l00599"></a>00599                         dispersion[i]=dispersionLength*0.5*(flowForward[i]+flowBack[i])/(0.5*(theta[i]+thetaOld[i]))+molecularDiff*tortuosity;
<a name="l00600"></a>00600                      <span class="keywordflow">if</span> ((theta[i-1]==0.0) || (thetaOld[i-1]==0.0)||(theta[i]==0.0)||(thetaOld[i]==0.0))
<a name="l00601"></a>00601                         dispersionBack[i]=0.0;
<a name="l00602"></a>00602                      <span class="keywordflow">else</span>
<a name="l00603"></a>00603                         dispersionBack[i]=dispersionLength*flowBack[i]/thetaBack[i]+molecularDiff*tortuosity;
<a name="l00604"></a>00604                      <span class="keywordflow">if</span> ((theta[i]==0.0) || (thetaOld[i]==0.0))
<a name="l00605"></a>00605                         dispersionForward[i]=0.0;
<a name="l00606"></a>00606                      <span class="keywordflow">else</span>
<a name="l00607"></a>00607                         dispersionForward[i]=dispersionLength*flowForward[i]/thetaForward[i]+molecularDiff*tortuosity;
<a name="l00608"></a>00608                   }
<a name="l00609"></a>00609                   <span class="keywordflow">else</span>
<a name="l00610"></a>00610                   {
<a name="l00611"></a>00611                      thetaBack[i]=0.25*(theta[i-1]+theta[i]+thetaOld[i-1]+thetaOld[i]);
<a name="l00612"></a>00612                      thetaForward[i]=0.25*(theta[i]+theta[i+1]+thetaOld[i]+thetaOld[i+1]);
<a name="l00613"></a>00613                      flowBack[i]=fluxInTimeStep[i-1]/deltaT/1000;
<a name="l00614"></a>00614                      flowForward[i]=fluxInTimeStep[i]/deltaT/1000;
<a name="l00615"></a>00615                      <span class="keywordflow">if</span> (theta[i]==0.0 ||thetaOld[i]==0.0)
<a name="l00616"></a>00616                         dispersion[i]=0.0;
<a name="l00617"></a>00617                      <span class="keywordflow">else</span>
<a name="l00618"></a>00618                         dispersion[i]=dispersionLength*0.5*(flowForward[i]+flowBack[i])/(0.5*(theta[i]+thetaOld[i]))+molecularDiff*tortuosity;
<a name="l00619"></a>00619                      <span class="keywordflow">if</span> ((theta[i-1]==0.0) || (thetaOld[i-1]==0.0)||(theta[i]==0.0)||(thetaOld[i]==0.0))
<a name="l00620"></a>00620                         dispersionBack[i]=0.0;
<a name="l00621"></a>00621                      <span class="keywordflow">else</span>
<a name="l00622"></a>00622                         dispersionBack[i]=dispersionLength*flowBack[i]/thetaBack[i]+molecularDiff*tortuosity;
<a name="l00623"></a>00623                      <span class="keywordflow">if</span> ((theta[i]==0.0) || (thetaOld[i]==0.0)||(theta[i+1]==0.0)||(thetaOld[i+1]==0.0))
<a name="l00624"></a>00624                         dispersionForward[i]=0.0;
<a name="l00625"></a>00625                      <span class="keywordflow">else</span>
<a name="l00626"></a>00626                         dispersionForward[i]=dispersionLength*flowForward[i]/thetaForward[i]+molecularDiff*tortuosity;
<a name="l00627"></a>00627                   }
<a name="l00628"></a>00628                }
<a name="l00629"></a>00629                <span class="keywordtype">double</span> a[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],b[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],c[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],
<a name="l00630"></a>00630                         da[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],db[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],dc[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l00631"></a>00631 
<a name="l00632"></a>00632                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00633"></a>00633                {
<a name="l00634"></a>00634                   a[i]= dispersionBack[i]*DistPreviousLayerInv[i]/(2*layerThickness[i])
<a name="l00635"></a>00635                         +flowBack[i]/(4*layerThickness[i]);
<a name="l00636"></a>00636 
<a name="l00637"></a>00637                   b[i]= -theta[i]/deltaT
<a name="l00638"></a>00638                         -dispersionForward[i]*DistNextLayerInv[i]/(2*layerThickness[i])
<a name="l00639"></a>00639                         -dispersionBack[i]*DistPreviousLayerInv[i]/(2*layerThickness[i])
<a name="l00640"></a>00640                         -flowForward[i]/(4*layerThickness[i])
<a name="l00641"></a>00641                         +flowBack[i]/(4*layerThickness[i]);
<a name="l00642"></a>00642 
<a name="l00643"></a>00643                   c[i]= dispersionForward[i]*DistNextLayerInv[i]/(2*layerThickness[i])
<a name="l00644"></a>00644                         -flowForward[i]/(4*layerThickness[i]);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646                   da[i]=-dispersionBack[i]*DistPreviousLayerInv[i]/(2*layerThickness[i])
<a name="l00647"></a>00647                         -flowBack[i]/(4*layerThickness[i]);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649                   db[i]=-thetaOld[i]/deltaT
<a name="l00650"></a>00650                         +dispersionForward[i]*DistNextLayerInv[i]/(2*layerThickness[i])
<a name="l00651"></a>00651                         +dispersionBack[i]*DistPreviousLayerInv[i]/(2*layerThickness[i])
<a name="l00652"></a>00652                         +flowForward[i]/(4*layerThickness[i])
<a name="l00653"></a>00653                         -flowBack[i]/(4*layerThickness[i]);
<a name="l00654"></a>00654 
<a name="l00655"></a>00655                   dc[i]= -dispersionForward[i]*DistNextLayerInv[i]/(2*layerThickness[i])
<a name="l00656"></a>00656                          +flowForward[i]/(4*layerThickness[i]);
<a name="l00657"></a>00657 
<a name="l00658"></a>00658                }
<a name="l00659"></a>00659                <span class="comment">//Assign values to vectors</span>
<a name="l00660"></a>00660                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00661"></a>00661                {
<a name="l00662"></a>00662                   <span class="keywordflow">if</span> (i==0)
<a name="l00663"></a>00663                   {
<a name="l00664"></a>00664                      <span class="keywordtype">double</span> b_null,d_null;
<a name="l00665"></a>00665                      <span class="keywordflow">if</span> (soluteIn&gt;0.0)
<a name="l00666"></a>00666                      {
<a name="l00667"></a>00667                         soluteInFlux = soluteIn/deltaT;
<a name="l00668"></a>00668                         b_null=(dispersion[i]*DistPreviousLayerInv[i]-0.5*flowBack[i])/(2*(dispersion[i]*DistPreviousLayerInv[i]+0.5*flowBack[i]));
<a name="l00669"></a>00669                         d_null=(soluteInFlux+(dispersion[i]*DistPreviousLayerInv[i]-0.5*flowBack[i]))*soluteOld[i]/(2*(dispersion[i]*DistPreviousLayerInv[i]+0.5*flowBack[i]));
<a name="l00670"></a>00670                      }
<a name="l00671"></a>00671                      <span class="keywordflow">else</span>
<a name="l00672"></a>00672                      {
<a name="l00673"></a>00673                         b_null=0.0;
<a name="l00674"></a>00674                         d_null=0.0;
<a name="l00675"></a>00675                      }
<a name="l00676"></a>00676                      lowerVector[i]= 0.0;
<a name="l00677"></a>00677                      midVector[i]= b[i]+ b_null*a[i];
<a name="l00678"></a>00678                      upperVector[i]= c[i];
<a name="l00679"></a>00679                      soluteOldVector[i]= soluteOld[i]*(da[i]+db[i]) + soluteOld[i+1]* dc[i]
<a name="l00680"></a>00680                                  -d_null*a[i];
<a name="l00681"></a>00681                   }
<a name="l00682"></a>00682                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i==TotalNumberOfLayers-1)
<a name="l00683"></a>00683                   {
<a name="l00684"></a>00684                      lowerVector[i]= a[i];
<a name="l00685"></a>00685                      midVector[i]=b[i]+c[i];
<a name="l00686"></a>00686                      upperVector[i]= 0.0;
<a name="l00687"></a>00687                      soluteOldVector[i]= soluteOld[i-1]* da[i]+ soluteOld[i]*(db[i]+dc[i]);
<a name="l00688"></a>00688                   }
<a name="l00689"></a>00689                   <span class="keywordflow">else</span>
<a name="l00690"></a>00690                   {
<a name="l00691"></a>00691                      lowerVector[i]= a[i];
<a name="l00692"></a>00692                      midVector[i]= b[i];
<a name="l00693"></a>00693                      upperVector[i]= c[i];
<a name="l00694"></a>00694                      soluteOldVector[i]= soluteOld[i-1]* da[i]+ soluteOld[i]*db[i] + soluteOld[i+1]* dc[i];
<a name="l00695"></a>00695                   }
<a name="l00696"></a>00696                }
<a name="l00697"></a>00697 
<a name="l00698"></a>00698 
<a name="l00699"></a>00699                <span class="comment">//correct vectors for start of mobile domain</span>
<a name="l00700"></a>00700                <span class="keywordtype">int</span> k=0;
<a name="l00701"></a>00701                <span class="keywordtype">int</span> <a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cafec48674e69529e52b1724bc9164052f">l</a>=0;
<a name="l00702"></a>00702                <span class="keywordflow">while</span> (IsThereSoluteFlux[l]==<span class="keyword">false</span>)
<a name="l00703"></a>00703                {
<a name="l00704"></a>00704                   k=l+1;
<a name="l00705"></a>00705                   l=1+<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cafec48674e69529e52b1724bc9164052f">l</a>;
<a name="l00706"></a>00706                }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708                <span class="keywordflow">if</span> (k&gt;0)
<a name="l00709"></a>00709                {
<a name="l00710"></a>00710                   <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers-k;i++)
<a name="l00711"></a>00711                   {
<a name="l00712"></a>00712                      <span class="keywordflow">if</span> (i==0)
<a name="l00713"></a>00713                      {
<a name="l00714"></a>00714                         midVector[i]=midVector[i+k]+dispersion[i+k]*DistPreviousLayerInv[i+k]/(2*layerThickness[i+k]);
<a name="l00715"></a>00715                         lowerVector[i]=0.0;
<a name="l00716"></a>00716                         soluteOldVector[i]=soluteOldVector[i+k]+dispersion[i+k]*DistPreviousLayerInv[i+k]/(2*layerThickness[i+k])*soluteOld[i+k];
<a name="l00717"></a>00717                         upperVector[i]= upperVector[i+k];
<a name="l00718"></a>00718                      }
<a name="l00719"></a>00719                      <span class="keywordflow">else</span>
<a name="l00720"></a>00720                      {
<a name="l00721"></a>00721                         <span class="keywordflow">if</span> ((IsThereSoluteFlux[i+k-1]==<span class="keyword">false</span>)&amp;&amp;
<a name="l00722"></a>00722                            (IsThereSoluteFlux[i+k]==<span class="keyword">false</span>))
<a name="l00723"></a>00723                         {
<a name="l00724"></a>00724                            lowerVector[i]=0.0;
<a name="l00725"></a>00725                            midVector[i]= 0.0;
<a name="l00726"></a>00726                            upperVector[i]= 0.0;
<a name="l00727"></a>00727                            soluteOldVector[i]=0.0;
<a name="l00728"></a>00728                         }
<a name="l00729"></a>00729                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((IsThereSoluteFlux[i+k-1]==<span class="keyword">false</span>)&amp;&amp;
<a name="l00730"></a>00730                            (IsThereSoluteFlux[i+k]==<span class="keyword">true</span>))
<a name="l00731"></a>00731                         {
<a name="l00732"></a>00732                            lowerVector[i]=0.0;
<a name="l00733"></a>00733                            midVector[i]= midVector[i+k]+dispersion[i+k]*DistPreviousLayerInv[i+k]/(2*layerThickness[i+k])
<a name="l00734"></a>00734                                     +flowBack[i]/(4*layerThickness[i]);
<a name="l00735"></a>00735                            soluteOldVector[i]=soluteOldVector[i+k]+soluteOld[i]*(dispersion[i+k]*DistPreviousLayerInv[i+k]/(2*layerThickness[i+k])
<a name="l00736"></a>00736                                     +flowBack[i]/(4*layerThickness[i]));
<a name="l00737"></a>00737                            upperVector[i]= upperVector[i+k];
<a name="l00738"></a>00738                        }
<a name="l00739"></a>00739                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>  ((IsThereSoluteFlux[i+k-1]==<span class="keyword">true</span>)&amp;&amp;
<a name="l00740"></a>00740                            (IsThereSoluteFlux[i+k]==<span class="keyword">false</span>))
<a name="l00741"></a>00741                         {
<a name="l00742"></a>00742                            lowerVector[i]=lowerVector[i+k];
<a name="l00743"></a>00743                            midVector[i]= midVector[i+k]+dispersion[i+k]*DistNextLayerInv[i+k]/(2*layerThickness[i+k])
<a name="l00744"></a>00744                                     -flowForward[i+k]/(4*layerThickness[i+k]);
<a name="l00745"></a>00745                            soluteOldVector[i]=soluteOldVector[i+k]+soluteOld[i+k]*(dispersion[i+k]*DistNextLayerInv[i+k]/(2*layerThickness[i+k])
<a name="l00746"></a>00746                                     -flowForward[i+k]/(4*layerThickness[i+k]));
<a name="l00747"></a>00747                            upperVector[i]= 0.0;
<a name="l00748"></a>00748                         }
<a name="l00749"></a>00749                         <span class="keywordflow">else</span>
<a name="l00750"></a>00750                         {
<a name="l00751"></a>00751                            lowerVector[i]=lowerVector[i+k];
<a name="l00752"></a>00752                            midVector[i]= midVector[i+k];
<a name="l00753"></a>00753                            soluteOldVector[i]=soluteOldVector[i+k];
<a name="l00754"></a>00754                            upperVector[i]= upperVector[i+k];
<a name="l00755"></a>00755                         }
<a name="l00756"></a>00756                      }
<a name="l00757"></a>00757                   }
<a name="l00758"></a>00758                }
<a name="l00759"></a>00759 
<a name="l00760"></a>00760                <span class="comment">//Solve with the double sweep method (function tridag)</span>
<a name="l00761"></a>00761                <a class="code" href="classsoil_profile.html#a97afe4fe7935e3f3fa732f8fe20f6730">Tridag</a>(lowerVector, midVector, upperVector, soluteOldVector, soluteNew, TotalNumberOfLayers-k);
<a name="l00762"></a>00762 
<a name="l00763"></a>00763                <span class="keywordflow">if</span> (k&gt;0)
<a name="l00764"></a>00764                {
<a name="l00765"></a>00765                   <span class="keywordflow">for</span> (i=TotalNumberOfLayers-1;i&gt;k-1;i--)
<a name="l00766"></a>00766                      soluteNew[i]=soluteNew[i-k];
<a name="l00767"></a>00767                   <span class="keywordflow">for</span> (i=0;i&lt;k;i++)
<a name="l00768"></a>00768                      soluteNew[i]=0.0;
<a name="l00769"></a>00769                }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771             <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00772"></a>00772                <span class="keywordflow">if</span> (soluteNew[i]&lt;0.0)
<a name="l00773"></a>00773                {
<a name="l00774"></a>00774                   <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateInfiltrationSWAT - negative concentration&quot;</span>);
<a name="l00775"></a>00775                   cout &lt;&lt; <span class="stringliteral">&quot;solutetype &quot;</span> &lt;&lt; soluteType &lt;&lt; <span class="stringliteral">&quot; in layer &quot;</span> &lt;&lt; i &lt;&lt; endl;
<a name="l00776"></a>00776                }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778             <span class="comment">//Calculate the fluxes between layers</span>
<a name="l00779"></a>00779             <span class="comment">//mobileXXXXFlux[i] refer to the flux out of the layer can be both negative and positive</span>
<a name="l00780"></a>00780 
<a name="l00781"></a>00781             <span class="keywordflow">if</span> (soluteType==0)
<a name="l00782"></a>00782                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00783"></a>00783                   <span class="keywordflow">if</span>(i==0)
<a name="l00784"></a>00784                   mobileNitrateFlux[i]=nitrateIn-soluteNew[i]*mobileWaterNew[i]/1000.0+soluteOld[i]*mobileWaterOld[i]/1000.0;
<a name="l00785"></a>00785                   <span class="keywordflow">else</span>
<a name="l00786"></a>00786                   mobileNitrateFlux[i]=mobileNitrateFlux[i-1]-soluteNew[i]*mobileWaterNew[i]/1000.0+soluteOld[i]*mobileWaterOld[i]/1000.0;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (soluteType==1)
<a name="l00789"></a>00789                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00790"></a>00790                   <span class="keywordflow">if</span>(i==0)
<a name="l00791"></a>00791                   mobileAmmoniumFlux[i]=ammoniumIn-soluteNew[i]*mobileWaterNew[i]/1000.0+soluteOld[i]*mobileWaterOld[i]/1000.0;
<a name="l00792"></a>00792                   <span class="keywordflow">else</span>
<a name="l00793"></a>00793                   mobileAmmoniumFlux[i]=mobileAmmoniumFlux[i-1]-soluteNew[i]*mobileWaterNew[i]/1000.0+soluteOld[i]*mobileWaterOld[i]/1000.0;
<a name="l00794"></a>00794 
<a name="l00795"></a>00795             <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (soluteType==2)
<a name="l00796"></a>00796                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00797"></a>00797                   <span class="keywordflow">if</span>(i==0)
<a name="l00798"></a>00798                   mobileChlorideFlux[i]=chlorideIn-(soluteNew[i]*mobileWaterNew[i]-soluteOld[i]*mobileWaterOld[i])/1000.0;
<a name="l00799"></a>00799                   <span class="keywordflow">else</span>
<a name="l00800"></a>00800                   mobileChlorideFlux[i]=mobileChlorideFlux[i-1]-(soluteNew[i]*mobileWaterNew[i]-soluteOld[i]*mobileWaterOld[i])/1000.0;
<a name="l00801"></a>00801 
<a name="l00802"></a>00802             <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (soluteType==3)
<a name="l00803"></a>00803                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00804"></a>00804                   <span class="keywordflow">if</span>(i==0)
<a name="l00805"></a>00805                   mobileNitrateN15Flux[i]=nitrateN15In-(soluteNew[i]*mobileWaterNew[i]-soluteOld[i]*mobileWaterOld[i])/1000.0;
<a name="l00806"></a>00806                   <span class="keywordflow">else</span>
<a name="l00807"></a>00807                   mobileNitrateN15Flux[i]=mobileNitrateN15Flux[i-1]-(soluteNew[i]*mobileWaterNew[i]-soluteOld[i]*mobileWaterOld[i])/1000.0;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809             <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (soluteType==4)
<a name="l00810"></a>00810                <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00811"></a>00811                   <span class="keywordflow">if</span>(i==0)
<a name="l00812"></a>00812                   mobileAmmoniumN15Flux[i]=ammoniumN15In-(soluteNew[i]*mobileWaterNew[i]-soluteOld[i]*mobileWaterOld[i])/1000.0;
<a name="l00813"></a>00813                   <span class="keywordflow">else</span>
<a name="l00814"></a>00814                   mobileAmmoniumN15Flux[i]=mobileAmmoniumN15Flux[i-1]-(soluteNew[i]*mobileWaterNew[i]-soluteOld[i]*mobileWaterOld[i])/1000.0;
<a name="l00815"></a>00815 
<a name="l00816"></a>00816             }  <span class="comment">//End bypass if nonzeroconcentration is false</span>
<a name="l00817"></a>00817             <span class="keywordflow">else</span>  <span class="comment">//non-zero concentration true</span>
<a name="l00818"></a>00818             {
<a name="l00819"></a>00819                <span class="keywordflow">if</span> (soluteType==0)
<a name="l00820"></a>00820                   <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00821"></a>00821                      mobileNitrateFlux[i]=0.0;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (soluteType==1)
<a name="l00824"></a>00824                   <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00825"></a>00825                      mobileAmmoniumFlux[i]=0.0;
<a name="l00826"></a>00826 
<a name="l00827"></a>00827                <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (soluteType==2)
<a name="l00828"></a>00828                   <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00829"></a>00829                      mobileChlorideFlux[i]=0.0;
<a name="l00830"></a>00830 
<a name="l00831"></a>00831                <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (soluteType==3)
<a name="l00832"></a>00832                   <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00833"></a>00833                      mobileNitrateN15Flux[i]=0.0;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835                <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (soluteType==4)
<a name="l00836"></a>00836                   <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00837"></a>00837                      mobileAmmoniumN15Flux[i]=0.0;
<a name="l00838"></a>00838             }
<a name="l00839"></a>00839          }  <span class="comment">//all solutes</span>
<a name="l00840"></a>00840 
<a name="l00841"></a>00841          <span class="comment">//update budgets and assign values</span>
<a name="l00842"></a>00842          <a class="code" href="classnitrogen.html">nitrogen</a> aMobileNitrateFlux, aMobileAmmoniumFlux, aNitrateIn, aAmmoniumIn;
<a name="l00843"></a>00843          <span class="keywordtype">double</span> aMobileChlorideFlux, aChlorideIn;
<a name="l00844"></a>00844 
<a name="l00845"></a>00845          aNitrateIn.<a class="code" href="classnitrogen.html#a49bebcba4c40f3c0a6abb24f590b2c8c">SetBoth</a>(nitrateIn, nitrateN15In);
<a name="l00846"></a>00846          aAmmoniumIn.<a class="code" href="classnitrogen.html#a49bebcba4c40f3c0a6abb24f590b2c8c">SetBoth</a>(ammoniumIn, ammoniumN15In);
<a name="l00847"></a>00847          aChlorideIn=chlorideIn;
<a name="l00848"></a>00848 
<a name="l00849"></a>00849          <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00850"></a>00850          {
<a name="l00851"></a>00851             aMobileNitrateFlux.<a class="code" href="classnitrogen.html#a49bebcba4c40f3c0a6abb24f590b2c8c">SetBoth</a>(mobileNitrateFlux[i],mobileNitrateN15Flux[i]);
<a name="l00852"></a>00852             aMobileAmmoniumFlux.<a class="code" href="classnitrogen.html#a49bebcba4c40f3c0a6abb24f590b2c8c">SetBoth</a>(mobileAmmoniumFlux[i],mobileAmmoniumN15Flux[i]);
<a name="l00853"></a>00853             aMobileChlorideFlux= mobileChlorideFlux[i];
<a name="l00854"></a>00854             <span class="keywordflow">if</span> (i==0)
<a name="l00855"></a>00855             {
<a name="l00856"></a>00856                soilLayerArray[0]-&gt;<a class="code" href="classsoil_layer.html#af8268406c1828af1fdd3fe704d386f1e">AddWaterAndSolutes</a>(infiltration,aNitrateIn,
<a name="l00857"></a>00857                      aAmmoniumIn,aChlorideIn);
<a name="l00858"></a>00858                soilLayerArray[1]-&gt;<a class="code" href="classsoil_layer.html#af8268406c1828af1fdd3fe704d386f1e">AddWaterAndSolutes</a>(fluxInTimeStep[0],aMobileNitrateFlux,
<a name="l00859"></a>00859                                  aMobileAmmoniumFlux,aMobileChlorideFlux);                    <span class="comment">//Add to next</span>
<a name="l00860"></a>00860                soilLayerArray[0]-&gt;<a class="code" href="classsoil_layer.html#aa3c2588bb518594ccb63a7004bc823d4">RemoveWaterAndSolutes</a>(fluxInTimeStep[0],aMobileNitrateFlux,
<a name="l00861"></a>00861                                  aMobileAmmoniumFlux,aMobileChlorideFlux);                    <span class="comment">//remove from current</span>
<a name="l00862"></a>00862             }
<a name="l00863"></a>00863             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i==TotalNumberOfLayers-1)
<a name="l00864"></a>00864             {
<a name="l00865"></a>00865                soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#aa3c2588bb518594ccb63a7004bc823d4">RemoveWaterAndSolutes</a>(fluxInTimeStep[i],aMobileNitrateFlux,
<a name="l00866"></a>00866                               aMobileAmmoniumFlux,aMobileChlorideFlux);                    <span class="comment">//remove from current</span>
<a name="l00867"></a>00867                *NitrateLeached = *NitrateLeached+aMobileNitrateFlux;                       <span class="comment">//update leaching</span>
<a name="l00868"></a>00868                *AmmoniumLeached = *AmmoniumLeached+aMobileAmmoniumFlux;
<a name="l00869"></a>00869             }
<a name="l00870"></a>00870             <span class="keywordflow">else</span>
<a name="l00871"></a>00871             {
<a name="l00872"></a>00872                soilLayerArray[i+1]-&gt;<a class="code" href="classsoil_layer.html#af8268406c1828af1fdd3fe704d386f1e">AddWaterAndSolutes</a>(fluxInTimeStep[i],aMobileNitrateFlux,
<a name="l00873"></a>00873                               aMobileAmmoniumFlux,aMobileChlorideFlux);                    <span class="comment">//Add to next layer</span>
<a name="l00874"></a>00874                soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#aa3c2588bb518594ccb63a7004bc823d4">RemoveWaterAndSolutes</a>(fluxInTimeStep[i],aMobileNitrateFlux,
<a name="l00875"></a>00875                               aMobileAmmoniumFlux,aMobileChlorideFlux);                    <span class="comment">//remove from current</span>
<a name="l00876"></a>00876             }
<a name="l00877"></a>00877          }
<a name="l00878"></a>00878          *surplus=*surplus*(1.0-f);
<a name="l00879"></a>00879          *surfaceNitrate=*surfaceNitrate*(1.0-f);
<a name="l00880"></a>00880          *surfaceAmmonium=*surfaceAmmonium*(1.0-f);
<a name="l00881"></a>00881          <span class="comment">//hvad med chloride!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00882"></a>00882       }
<a name="l00883"></a>00883 
<a name="l00884"></a>00884       simulationTime+=deltaT;
<a name="l00885"></a>00885    }  <span class="comment">// End transport of water and solute</span>
<a name="l00886"></a>00886 
<a name="l00887"></a>00887    <span class="comment">//Equilibrate between mobile and immobile water   (once a day)</span>
<a name="l00888"></a>00888    <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00889"></a>00889    <span class="keywordflow">if</span> (waterContent[i]&lt;FC[i])
<a name="l00890"></a>00890         soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a0761c6670b5ffb8affd945117f84335b">EquilibrateNitrogen</a>(0.0);
<a name="l00891"></a>00891    <span class="keywordflow">else</span>
<a name="l00892"></a>00892       soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a0761c6670b5ffb8affd945117f84335b">EquilibrateNitrogen</a>(waterContent[i]-FC[i]);
<a name="l00893"></a>00893 
<a name="l00894"></a>00894    EvaporationContent=min(EvaporationCapacity,infiltration+EvaporationContent);
<a name="l00895"></a>00895 
<a name="l00896"></a>00896    <span class="keywordflow">for</span> (i=0;i&lt;TotalNumberOfLayers;i++)
<a name="l00897"></a>00897    {
<a name="l00898"></a>00898       soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a8b23d590179f5af403f95521d83aa98c">SetWaterFlux</a>(totalFlux[i]);
<a name="l00899"></a>00899    }
<a name="l00900"></a>00900 
<a name="l00901"></a>00901    <span class="comment">// End transport of water and solute ----------------------------------------</span>
<a name="l00902"></a>00902 
<a name="l00903"></a>00903 }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905 <span class="comment">/****************************************************************************\</span>
<a name="l00906"></a>00906 <span class="comment">Calculates soil water content for the profile.</span>
<a name="l00907"></a>00907 <span class="comment">   returns       - Water content [mm]</span>
<a name="l00908"></a>00908 <span class="comment">\****************************************************************************/</span>
<a name="l00909"></a><a class="code" href="classsoil_profile.html#a25cf83f98b4a58017331dbf78ee31824">00909</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a25cf83f98b4a58017331dbf78ee31824">soilProfile::GetTotalWater</a>()
<a name="l00910"></a>00910 {
<a name="l00911"></a>00911  <span class="keywordtype">double</span> Content = 0;
<a name="l00912"></a>00912  <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l00913"></a>00913  <span class="keywordflow">while</span> (current != NULL)
<a name="l00914"></a>00914  {
<a name="l00915"></a>00915   Content+=current-&gt;<a class="code" href="classsoil_layer.html#af01077dc70989747d1f48ba46bb0556c">GetTotalWater</a>();
<a name="l00916"></a>00916   current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l00917"></a>00917  }
<a name="l00918"></a>00918  <span class="keywordflow">return</span> Content;
<a name="l00919"></a>00919 }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921 <span class="comment">/****************************************************************************\</span>
<a name="l00922"></a>00922 <span class="comment">Calculates soil water content for a portion of the profile.</span>
<a name="l00923"></a>00923 <span class="comment">   startDep      - Start depth of layer to be calculated for [mm]</span>
<a name="l00924"></a>00924 <span class="comment">   thick         - Thickness of layer to be calculated for [mm]</span>
<a name="l00925"></a>00925 <span class="comment">   returns       - Plant available water [mm]</span>
<a name="l00926"></a>00926 <span class="comment">\****************************************************************************/</span>
<a name="l00927"></a><a class="code" href="classsoil_profile.html#a3a8791cd9244ae7c70246be2e5a27b02">00927</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a25cf83f98b4a58017331dbf78ee31824">soilProfile::GetTotalWater</a>(<span class="keywordtype">double</span> startDepth,
<a name="l00928"></a>00928                                                                           <span class="keywordtype">double</span> thickness)
<a name="l00929"></a>00929 {
<a name="l00930"></a>00930  <span class="keywordtype">double</span> Content = 0;
<a name="l00931"></a>00931  <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l00932"></a>00932  <span class="keywordflow">while</span> (current != NULL)
<a name="l00933"></a>00933  {
<a name="l00934"></a>00934   Content+=current-&gt;<a class="code" href="classsoil_layer.html#af01077dc70989747d1f48ba46bb0556c">GetTotalWater</a>(startDepth,thickness);
<a name="l00935"></a>00935   current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l00936"></a>00936  }
<a name="l00937"></a>00937  <span class="keywordflow">return</span> Content;
<a name="l00938"></a>00938 }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940 <span class="comment">/****************************************************************************\</span>
<a name="l00941"></a>00941 <span class="comment">Calculates plant available soil water content for a portion of the profile.</span>
<a name="l00942"></a>00942 <span class="comment">   startDep      - Start depth of layer to be calculated for [mm]</span>
<a name="l00943"></a>00943 <span class="comment">   thick         - Thickness of layer to be calculated for [mm]</span>
<a name="l00944"></a>00944 <span class="comment">   returns       - Plant available water [mm]</span>
<a name="l00945"></a>00945 <span class="comment">\****************************************************************************/</span>
<a name="l00946"></a><a class="code" href="classsoil_profile.html#a51f57a7397df5853e8899f34ada2d374">00946</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a51f57a7397df5853e8899f34ada2d374">soilProfile::GetAvailWater</a>(<span class="keywordtype">double</span> startDepth,<span class="keywordtype">double</span> thickness)
<a name="l00947"></a>00947 {
<a name="l00948"></a>00948  <span class="keywordtype">double</span> Content = 0;
<a name="l00949"></a>00949  <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l00950"></a>00950  <span class="keywordflow">while</span> (current != NULL)
<a name="l00951"></a>00951  {
<a name="l00952"></a>00952   Content+=current-&gt;<a class="code" href="classsoil_layer.html#aadce28fdd5d1a819981785e6f4954674">GetAvailWater</a>(startDepth,thickness);
<a name="l00953"></a>00953   current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l00954"></a>00954  }
<a name="l00955"></a>00955  <span class="keywordflow">return</span> Content;
<a name="l00956"></a>00956 }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958 <span class="comment">/****************************************************************************\</span>
<a name="l00959"></a>00959 <span class="comment">Calculates capacity for plant available water for a portion of the profile.</span>
<a name="l00960"></a>00960 <span class="comment">   startDep      - Start depth of layer to be calculated for [mm]</span>
<a name="l00961"></a>00961 <span class="comment">   thick         - Thickness of layer to be calculated for [mm]</span>
<a name="l00962"></a>00962 <span class="comment">   returns       - Capacity for plant available water [mm]</span>
<a name="l00963"></a>00963 <span class="comment">\****************************************************************************/</span>
<a name="l00964"></a><a class="code" href="classsoil_profile.html#adc7003b312a9bcc2fffdd45acfc65f28">00964</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#adc7003b312a9bcc2fffdd45acfc65f28">soilProfile::GetAvailCapacity</a>(<span class="keywordtype">double</span> startDepth,
<a name="l00965"></a>00965                                                                                                  <span class="keywordtype">double</span> thickness)
<a name="l00966"></a>00966 {
<a name="l00967"></a>00967  <span class="keywordtype">double</span> Capacity = 0.0;
<a name="l00968"></a>00968  <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l00969"></a>00969  <span class="keywordflow">while</span> (current != NULL)
<a name="l00970"></a>00970  {
<a name="l00971"></a>00971   Capacity+=current-&gt;<a class="code" href="classsoil_layer.html#a08cd2b12daf06c2cd45ef9bad249bdb9">GetAvailCapacity</a>(startDepth,thickness);
<a name="l00972"></a>00972   current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l00973"></a>00973  }
<a name="l00974"></a>00974  <span class="keywordflow">return</span> Capacity;
<a name="l00975"></a>00975 }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977 <span class="comment">/****************************************************************************\</span>
<a name="l00978"></a>00978 <span class="comment">Calculates field capacity for water for a portion of the profile.</span>
<a name="l00979"></a>00979 <span class="comment">   startDep      - Start depth of layer to be calculated for [mm]</span>
<a name="l00980"></a>00980 <span class="comment">   thick         - Thickness of layer to be calculated for [mm]</span>
<a name="l00981"></a>00981 <span class="comment">   returns       - Capacity for plant available water [mm]</span>
<a name="l00982"></a>00982 <span class="comment">\****************************************************************************/</span>
<a name="l00983"></a><a class="code" href="classsoil_profile.html#a6c154b0cb0b3ab611efde6f50d53cbc7">00983</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a6c154b0cb0b3ab611efde6f50d53cbc7">soilProfile::GetFieldCapacity</a>(<span class="keywordtype">double</span> startDepth,
<a name="l00984"></a>00984                                                                                                  <span class="keywordtype">double</span> thickness)
<a name="l00985"></a>00985 {
<a name="l00986"></a>00986  <span class="keywordtype">double</span> Capacity = 0.0;
<a name="l00987"></a>00987  <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l00988"></a>00988  <span class="keywordflow">while</span> (current != NULL)
<a name="l00989"></a>00989  {
<a name="l00990"></a>00990   Capacity+=current-&gt;<a class="code" href="classsoil_layer.html#aab16e356a7dad4934471e1b0f74589ec">GetFieldCapacity</a>(startDepth,thickness);
<a name="l00991"></a>00991   current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l00992"></a>00992  }
<a name="l00993"></a>00993  <span class="keywordflow">return</span> Capacity;
<a name="l00994"></a>00994 }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996 <span class="comment">/****************************************************************************\</span>
<a name="l00997"></a>00997 <span class="comment">Calculates wilting capacity for for a portion of the profile.</span>
<a name="l00998"></a>00998 <span class="comment">   startDep      - Start depth of layer to be calculated for [mm]</span>
<a name="l00999"></a>00999 <span class="comment">   thick         - Thickness of layer to be calculated for [mm]</span>
<a name="l01000"></a>01000 <span class="comment">   returns       - Capacity for plant available water [mm]</span>
<a name="l01001"></a>01001 <span class="comment">\****************************************************************************/</span>
<a name="l01002"></a><a class="code" href="classsoil_profile.html#a1ff69f03ceffe60204f25f0fd73b2e07">01002</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a1ff69f03ceffe60204f25f0fd73b2e07">soilProfile::GetWiltCapacity</a>(<span class="keywordtype">double</span> startDepth,
<a name="l01003"></a>01003                                                                                                 <span class="keywordtype">double</span> thickness)
<a name="l01004"></a>01004 {
<a name="l01005"></a>01005  <span class="keywordtype">double</span> Capacity = 0.0;
<a name="l01006"></a>01006  <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01007"></a>01007  <span class="keywordflow">while</span> (current != NULL)
<a name="l01008"></a>01008  {
<a name="l01009"></a>01009   Capacity+=current-&gt;<a class="code" href="classsoil_layer.html#a722893625125bc8ab7be416118ed908e">GetWiltCapacity</a>(startDepth,thickness);
<a name="l01010"></a>01010   current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01011"></a>01011  }
<a name="l01012"></a>01012  <span class="keywordflow">return</span> Capacity;
<a name="l01013"></a>01013 }
<a name="l01014"></a>01014 
<a name="l01015"></a>01015 
<a name="l01016"></a>01016 <span class="comment">/****************************************************************************\</span>
<a name="l01017"></a>01017 <span class="comment">The temperature of a given soil layer is defined at the top of the layer</span>
<a name="l01018"></a>01018 <span class="comment">\****************************************************************************/</span>
<a name="l01019"></a><a class="code" href="classsoil_profile.html#a0ce7a0cacb136fae92fac737f23fe46f">01019</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a0ce7a0cacb136fae92fac737f23fe46f">soilProfile::GetTemperature</a>(<span class="keywordtype">double</span> depth)
<a name="l01020"></a>01020 {
<a name="l01021"></a>01021         <span class="keywordtype">int</span> i=0;
<a name="l01022"></a>01022         <span class="keywordflow">while</span> (soilLayerArray[i]-&gt;GetStartDepth()&lt;=depth &amp;&amp; i&lt;NumOfSoilLayers)
<a name="l01023"></a>01023                 i++;
<a name="l01024"></a>01024    <span class="keywordflow">if</span> (i==(NumOfSoilLayers-1))
<a name="l01025"></a>01025       <span class="keywordflow">return</span> soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a4767a2f084104f8c8407af7a6c7d7513">GetTemperature</a>();
<a name="l01026"></a>01026         <span class="keywordtype">double</span> a=depth-soilLayerArray[i-1]-&gt;<a class="code" href="classsoil_layer.html#a067dc1539ac09a475b678ef6d67b2812">GetStartDepth</a>();
<a name="l01027"></a>01027    <span class="keywordtype">double</span> b=soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a067dc1539ac09a475b678ef6d67b2812">GetStartDepth</a>()-depth;
<a name="l01028"></a>01028    <span class="keywordflow">return</span> soilLayerArray[i-1]-&gt;<a class="code" href="classsoil_layer.html#a4767a2f084104f8c8407af7a6c7d7513">GetTemperature</a>()*b/(a+b)
<a name="l01029"></a>01029           +soilLayerArray[i]-&gt;<a class="code" href="classsoil_profile.html#a0ce7a0cacb136fae92fac737f23fe46f">GetTemperature</a>()*a/(a+b);
<a name="l01030"></a>01030 }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032 <span class="comment">/****************************************************************************\</span>
<a name="l01033"></a>01033 <span class="comment">\****************************************************************************/</span>
<a name="l01034"></a><a class="code" href="classsoil_profile.html#a46d21083a35260e54710785e8b9b8249">01034</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a46d21083a35260e54710785e8b9b8249">soilProfile::GetDrainage</a>(<span class="keywordtype">double</span> depth)
<a name="l01035"></a>01035 {
<a name="l01036"></a>01036         <span class="keywordflow">if</span> (depth&lt;=(soilLayerArray[0]-&gt;GetThickness()/2.0))
<a name="l01037"></a>01037                 <span class="keywordflow">return</span> soilLayerArray[0]-&gt;<a class="code" href="classsoil_layer.html#a41a31736ecff9877a3fbc566eb11e1ad">GetWaterFlux</a>();
<a name="l01038"></a>01038         <span class="keywordflow">if</span> (depth&gt;=(soilLayerArray[NumOfSoilLayers-1]-&gt;GetStartDepth()
<a name="l01039"></a>01039                  +soilLayerArray[NumOfSoilLayers-1]-&gt;GetThickness()/2.0))
<a name="l01040"></a>01040                 <span class="keywordflow">return</span> soilLayerArray[NumOfSoilLayers-1]-&gt;<a class="code" href="classsoil_layer.html#a41a31736ecff9877a3fbc566eb11e1ad">GetWaterFlux</a>();
<a name="l01041"></a>01041         <span class="keywordtype">int</span> i=0;
<a name="l01042"></a>01042         <span class="keywordflow">while</span> ((soilLayerArray[i]-&gt;GetStartDepth()+soilLayerArray[i]-&gt;GetThickness()/2.0)&lt;depth)
<a name="l01043"></a>01043                 i++;
<a name="l01044"></a>01044    <span class="keywordflow">if</span> (i==(NumOfSoilLayers-1))
<a name="l01045"></a>01045         <span class="keywordflow">return</span> soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a41a31736ecff9877a3fbc566eb11e1ad">GetWaterFlux</a>();
<a name="l01046"></a>01046    <span class="keywordflow">return</span> soilLayerArray[i-1]-&gt;<a class="code" href="classsoil_layer.html#a41a31736ecff9877a3fbc566eb11e1ad">GetWaterFlux</a>();
<a name="l01047"></a>01047 }
<a name="l01048"></a>01048 
<a name="l01049"></a>01049 <span class="comment">/****************************************************************************\</span>
<a name="l01050"></a>01050 <span class="comment">Estimated maximum evaporation from whole profile</span>
<a name="l01051"></a>01051 <span class="comment">\****************************************************************************/</span>
<a name="l01052"></a><a class="code" href="classsoil_profile.html#acfcd258f5c2c0914b13a39d6772e0f5c">01052</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#acfcd258f5c2c0914b13a39d6772e0f5c">soilProfile::GetMaximumEvaporation</a>()
<a name="l01053"></a>01053 {
<a name="l01054"></a>01054    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01055"></a>01055    <span class="keywordtype">double</span> sum = 0.0;
<a name="l01056"></a>01056         <span class="keywordflow">while</span> (current != NULL)
<a name="l01057"></a>01057         {
<a name="l01058"></a>01058                 sum += max(0.,current-&gt;<a class="code" href="classsoil_layer.html#aadce28fdd5d1a819981785e6f4954674">GetAvailWater</a>())*exp(-EvapExtCoef*current-&gt;<a class="code" href="classsoil_layer.html#a1789c88edae9f3ef01bc1b321bc71913">GetCenterDepth</a>());       <span class="comment">//current-&gt;GetThickness()*</span>
<a name="l01059"></a>01059                 current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01060"></a>01060         }
<a name="l01061"></a>01061         <span class="keywordflow">return</span> sum;
<a name="l01062"></a>01062 }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064 <span class="comment">/****************************************************************************\</span>
<a name="l01065"></a>01065 <span class="comment">Subtracts evaporation from profile</span>
<a name="l01066"></a>01066 <span class="comment">   evaporation   - Evaporation to be subtracted [mm].</span>
<a name="l01067"></a>01067 <span class="comment">\****************************************************************************/</span>
<a name="l01068"></a><a class="code" href="classsoil_profile.html#a4edb42ee540e88473200024afd61b232">01068</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#a4edb42ee540e88473200024afd61b232">soilProfile::SubtractEvaporation</a>(<span class="keywordtype">double</span> soilEvaporation)
<a name="l01069"></a>01069 {
<a name="l01070"></a>01070  <span class="comment">/*</span>
<a name="l01071"></a>01071 <span class="comment"> // Newest, but presently discarded method</span>
<a name="l01072"></a>01072 <span class="comment"> soilLayer * current = first;</span>
<a name="l01073"></a>01073 <span class="comment"> while (soilEvaporation&gt;0)</span>
<a name="l01074"></a>01074 <span class="comment">  {</span>
<a name="l01075"></a>01075 <span class="comment">        double subtractAmount = min(soilEvaporation,current-&gt;GetAvailWater());</span>
<a name="l01076"></a>01076 <span class="comment">   soilEvaporation -= subtractAmount;</span>
<a name="l01077"></a>01077 <span class="comment">   current-&gt;SubtractEvaporation(subtractAmount);</span>
<a name="l01078"></a>01078 <span class="comment">        current = current-&gt;Next();</span>
<a name="l01079"></a>01079 <span class="comment"> }</span>
<a name="l01080"></a>01080 <span class="comment"> */</span>
<a name="l01081"></a>01081  <span class="comment">// Original method - extended with the EvaporationContent part</span>
<a name="l01082"></a>01082  <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01083"></a>01083  <span class="keywordtype">double</span> a;
<a name="l01084"></a>01084 
<a name="l01085"></a>01085  <span class="keywordtype">double</span> directEvaporation=min(min(soilEvaporation,EvaporationContent),soilLayerArray[0]-&gt;<a class="code" href="classsoil_profile.html#a51f57a7397df5853e8899f34ada2d374">GetAvailWater</a>());
<a name="l01086"></a>01086  soilEvaporation-=directEvaporation;
<a name="l01087"></a>01087  EvaporationContent-=directEvaporation;
<a name="l01088"></a>01088  soilLayerArray[0]-&gt;<a class="code" href="classsoil_layer.html#a9a38de935d6d6abe383bfd2f886559f3">SubtractEvaporation</a>(directEvaporation);
<a name="l01089"></a>01089 
<a name="l01090"></a>01090  <span class="keywordflow">if</span> (soilEvaporation&gt;0)
<a name="l01091"></a>01091  {
<a name="l01092"></a>01092   <span class="keywordtype">double</span> sum = <a class="code" href="classsoil_profile.html#acfcd258f5c2c0914b13a39d6772e0f5c">GetMaximumEvaporation</a>();
<a name="l01093"></a>01093   <span class="keywordflow">while</span> (current != NULL &amp;&amp; sum&gt;0)
<a name="l01094"></a>01094   {
<a name="l01095"></a>01095         a = <span class="comment">//current-&gt;GetThickness()*</span>
<a name="l01096"></a>01096                  max(0.,current-&gt;<a class="code" href="classsoil_layer.html#aadce28fdd5d1a819981785e6f4954674">GetAvailWater</a>())*exp(-EvapExtCoef*current-&gt;<a class="code" href="classsoil_layer.html#a1789c88edae9f3ef01bc1b321bc71913">GetCenterDepth</a>());
<a name="l01097"></a>01097    current-&gt;<a class="code" href="classsoil_layer.html#a9a38de935d6d6abe383bfd2f886559f3">SubtractEvaporation</a>(soilEvaporation*a/sum);
<a name="l01098"></a>01098         current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01099"></a>01099   }
<a name="l01100"></a>01100  }
<a name="l01101"></a>01101 
<a name="l01102"></a>01102 }
<a name="l01103"></a>01103 
<a name="l01104"></a>01104 
<a name="l01105"></a>01105 <span class="comment">/****************************************************************************\</span>
<a name="l01106"></a>01106 <span class="comment">Generates average total root</span>
<a name="l01107"></a>01107 <span class="comment">\****************************************************************************/</span>
<a name="l01108"></a>01108 <span class="keywordtype">void</span> soilProfile::EstimateTotalRoot(<a class="code" href="structroot_structure.html">rootStructure</a>* TotalRoot,<a class="code" href="classlink_list.html" title="Utility link list class.">linkList&lt;rootStructure&gt;</a>* rootList)
<a name="l01109"></a>01109 {
<a name="l01110"></a>01110         TotalRoot-&gt;<a class="code" href="structroot_structure.html#ae822dd60a6dd1507a84c10ab228fe97e">rootRadius</a> = TotalRoot-&gt;<a class="code" href="structroot_structure.html#aeb9a13ce72bd039bc6821e4264b2da64">rootpF</a> = TotalRoot-&gt;<a class="code" href="structroot_structure.html#a6279d30c06e19a3e088f57fd6d793ed9">NitrateUptakeRate</a> = TotalRoot-&gt;<a class="code" href="structroot_structure.html#a5a6c705454eeafeb83624a2351b53cf1">AmmoniumUptakeRate</a>= 0.0;
<a name="l01111"></a>01111    TotalRoot-&gt;<a class="code" href="structroot_structure.html#a51bcb0f431a64a3b26d21a4e86a9d16e">MinimumSoilNitrate</a> = TotalRoot-&gt;<a class="code" href="structroot_structure.html#a80208bc0dea6228779648359e9bd1c01">MinimumSoilAmmonium</a>= 0.0;
<a name="l01112"></a>01112    TotalRoot-&gt;<a class="code" href="structroot_structure.html#a20025f911a33441a80de37712a1a659c">rootLengthList</a> = <span class="keyword">new</span> <span class="keywordtype">double</span>[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>]; <span class="comment">// LEAK !!!</span>
<a name="l01113"></a>01113    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>;j++) TotalRoot-&gt;<a class="code" href="structroot_structure.html#a20025f911a33441a80de37712a1a659c">rootLengthList</a>[j] = 0.0;
<a name="l01114"></a>01114 
<a name="l01115"></a>01115    <span class="keywordtype">double</span> TotalPlantRootLength[<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>];
<a name="l01116"></a>01116    <span class="keywordtype">double</span> TotalRootLength = 0.0;
<a name="l01117"></a>01117    <span class="keywordtype">int</span> AttackerNumber = 0;
<a name="l01118"></a>01118    if (rootList) AttackerNumber = rootList-&gt;<a class="code" href="classlink_list.html#aee3f890e4e8f48db1518e5114d5bcca8" title="Returned total number of nodes.">NumOfNodes</a>();
<a name="l01119"></a>01119 
<a name="l01120"></a>01120    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;AttackerNumber;i++)
<a name="l01121"></a>01121    {
<a name="l01122"></a>01122       <a class="code" href="structroot_structure.html">rootStructure</a>* currentRoot = rootList-&gt;<a class="code" href="classlink_list.html#a5735a6e54a2eed841bdf1fdb52aed03f" title="Return the address of the node with a given logical number in the list.">ElementAtNumber</a>(i);
<a name="l01123"></a>01123       TotalPlantRootLength[i] = 0.0;
<a name="l01124"></a>01124       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>;j++)
<a name="l01125"></a>01125                 TotalPlantRootLength[i] += currentRoot-&gt;<a class="code" href="structroot_structure.html#a20025f911a33441a80de37712a1a659c">rootLengthList</a>[j];
<a name="l01126"></a>01126       TotalRootLength += TotalPlantRootLength[i];
<a name="l01127"></a>01127    }
<a name="l01128"></a>01128    <span class="keywordflow">if</span> (TotalRootLength&gt;0)
<a name="l01129"></a>01129    {
<a name="l01130"></a>01130            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;AttackerNumber;i++)
<a name="l01131"></a>01131            {
<a name="l01132"></a>01132                 <a class="code" href="structroot_structure.html">rootStructure</a>* currentRoot = rootList-&gt;<a class="code" href="classlink_list.html#a5735a6e54a2eed841bdf1fdb52aed03f" title="Return the address of the node with a given logical number in the list.">ElementAtNumber</a>(i);
<a name="l01133"></a>01133               TotalRoot-&gt;<a class="code" href="structroot_structure.html#ae822dd60a6dd1507a84c10ab228fe97e">rootRadius</a> += TotalPlantRootLength[i]/TotalRootLength*currentRoot-&gt;<a class="code" href="structroot_structure.html#ae822dd60a6dd1507a84c10ab228fe97e">rootRadius</a>;
<a name="l01134"></a>01134                 TotalRoot-&gt;<a class="code" href="structroot_structure.html#aeb9a13ce72bd039bc6821e4264b2da64">rootpF</a> += TotalPlantRootLength[i]/TotalRootLength*currentRoot-&gt;<a class="code" href="structroot_structure.html#aeb9a13ce72bd039bc6821e4264b2da64">rootpF</a>;
<a name="l01135"></a>01135                         TotalRoot-&gt;<a class="code" href="structroot_structure.html#a6279d30c06e19a3e088f57fd6d793ed9">NitrateUptakeRate</a> += TotalPlantRootLength[i]/TotalRootLength*currentRoot-&gt;<a class="code" href="structroot_structure.html#a6279d30c06e19a3e088f57fd6d793ed9">NitrateUptakeRate</a>;
<a name="l01136"></a>01136                         TotalRoot-&gt;<a class="code" href="structroot_structure.html#a5a6c705454eeafeb83624a2351b53cf1">AmmoniumUptakeRate</a> += TotalPlantRootLength[i]/TotalRootLength*currentRoot-&gt;<a class="code" href="structroot_structure.html#a5a6c705454eeafeb83624a2351b53cf1">AmmoniumUptakeRate</a>;
<a name="l01137"></a>01137                         TotalRoot-&gt;<a class="code" href="structroot_structure.html#a51bcb0f431a64a3b26d21a4e86a9d16e">MinimumSoilNitrate</a> += TotalPlantRootLength[i]/TotalRootLength*currentRoot-&gt;<a class="code" href="structroot_structure.html#a51bcb0f431a64a3b26d21a4e86a9d16e">MinimumSoilNitrate</a>;
<a name="l01138"></a>01138                         TotalRoot-&gt;<a class="code" href="structroot_structure.html#a80208bc0dea6228779648359e9bd1c01">MinimumSoilAmmonium</a> += TotalPlantRootLength[i]/TotalRootLength*currentRoot-&gt;<a class="code" href="structroot_structure.html#a80208bc0dea6228779648359e9bd1c01">MinimumSoilAmmonium</a>;
<a name="l01139"></a>01139 
<a name="l01140"></a>01140               <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>;j++)
<a name="l01141"></a>01141                         TotalRoot-&gt;<a class="code" href="structroot_structure.html#a20025f911a33441a80de37712a1a659c">rootLengthList</a>[j] += currentRoot-&gt;<a class="code" href="structroot_structure.html#a20025f911a33441a80de37712a1a659c">rootLengthList</a>[j];
<a name="l01142"></a>01142            }
<a name="l01143"></a>01143    }
<a name="l01144"></a>01144 }
<a name="l01145"></a>01145 
<a name="l01146"></a>01146 <span class="comment">/****************************************************************************\</span>
<a name="l01147"></a>01147 <span class="comment">Subtracts estimated transpiration from the water in the layer.</span>
<a name="l01148"></a>01148 <span class="comment">\****************************************************************************/</span>
<a name="l01149"></a><a class="code" href="classsoil_profile.html#a276eab1d6e61326093e214a89a9af7db">01149</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#a276eab1d6e61326093e214a89a9af7db">soilProfile::SubtractTranspiration</a>(<a class="code" href="classlink_list.html" title="Utility link list class.">linkList&lt;rootStructure&gt;</a>* rootList)
<a name="l01150"></a>01150 {
<a name="l01151"></a>01151    <span class="keywordtype">double</span> waterBefore = soilLayerArray[0]-&gt;<a class="code" href="classsoil_layer.html#aadce28fdd5d1a819981785e6f4954674">GetAvailWater</a>();
<a name="l01152"></a>01152    <span class="keywordtype">double</span> PlantDemand[<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>];
<a name="l01153"></a>01153    <span class="keywordtype">double</span> WaterUptakeAbility[MaxSoilLayers*<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>];
<a name="l01154"></a>01154    <span class="keywordtype">double</span> TotalWaterUptakeAbility[MaxSoilLayers*<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>];
<a name="l01155"></a>01155    <span class="keywordtype">double</span> WaterResource[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01156"></a>01156    <span class="keywordtype">double</span> PlantUptake[<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>*<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01157"></a>01157    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>*<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>;i++)
<a name="l01158"></a>01158    {
<a name="l01159"></a>01159            PlantUptake[i]=0;
<a name="l01160"></a>01160    }
<a name="l01161"></a>01161    <span class="keywordtype">int</span> AttackerNumber = rootList-&gt;<a class="code" href="classlink_list.html#aee3f890e4e8f48db1518e5114d5bcca8" title="Returned total number of nodes.">NumOfNodes</a>();
<a name="l01162"></a>01162    <span class="keywordflow">if</span> (AttackerNumber&gt;<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>)
<a name="l01163"></a>01163    {
<a name="l01164"></a>01164       cout &lt;&lt; <a class="code" href="classbase.html#aae39ec3da4311af6b93e424d29b2c66a">GetLongName</a>() &lt;&lt; endl;
<a name="l01165"></a>01165                 <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::SubtractTranspiration maximum number of crops exceeded.&quot;</span>);
<a name="l01166"></a>01166    }
<a name="l01167"></a>01167    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;AttackerNumber;i++)
<a name="l01168"></a>01168         PlantDemand[i] = max(0.0,rootList-&gt;<a class="code" href="classlink_list.html#a5735a6e54a2eed841bdf1fdb52aed03f" title="Return the address of the node with a given logical number in the list.">ElementAtNumber</a>(i)-&gt;<a class="code" href="structroot_structure.html#a9a245fabd4034d40698a238e789c3c7d">transpirationDemand</a>);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170    <a class="code" href="structroot_structure.html">rootStructure</a> *TotalRoot = <span class="keyword">new</span> <a class="code" href="structroot_structure.html">rootStructure</a>;
<a name="l01171"></a>01171    EstimateTotalRoot(TotalRoot,rootList);
<a name="l01172"></a>01172 
<a name="l01173"></a>01173    <span class="keywordtype">int</span> ResourceNumber = 0;
<a name="l01174"></a>01174    <a class="code" href="classsoil_layer.html">soilLayer</a> * currentSoilLayer = first;
<a name="l01175"></a>01175    <span class="keywordflow">while</span> (currentSoilLayer != NULL)
<a name="l01176"></a>01176    {
<a name="l01177"></a>01177                 currentSoilLayer = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01178"></a>01178            ResourceNumber++;
<a name="l01179"></a>01179         }
<a name="l01180"></a>01180         <span class="keywordtype">double</span> TotalPlantUptake[<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>];
<a name="l01181"></a>01181    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;AttackerNumber;j++)
<a name="l01182"></a>01182         TotalPlantUptake[j] = 0.0;
<a name="l01183"></a>01183    <a class="code" href="structlink_list_1_1_snode.html" title="Node contains a pointer to some class and to the next node in the list.">linkList &lt;rootStructure&gt;::PS</a> currentRoot;
<a name="l01184"></a>01184    rootList-&gt;<a class="code" href="classlink_list.html#a7a7cc9e8690c7e9c73d5b406cae066d3" title="Returned a pointer to the first node.">PeekHead</a>(currentRoot);
<a name="l01185"></a>01185    <span class="keywordtype">int</span> PlantIndex = 0;
<a name="l01186"></a>01186    <span class="keywordflow">while</span> (currentRoot != NULL)
<a name="l01187"></a>01187    {
<a name="l01188"></a>01188         <span class="keywordtype">int</span> SoilLayerIndex = 0;
<a name="l01189"></a>01189       <a class="code" href="classsoil_layer.html">soilLayer</a> * currentSoilLayer = first;
<a name="l01190"></a>01190       <span class="keywordflow">while</span> (currentSoilLayer != NULL)
<a name="l01191"></a>01191       {
<a name="l01192"></a>01192         WaterUptakeAbility[SoilLayerIndex+PlantIndex*ResourceNumber] = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#aaa3df5650bfb89fe57e853d34680b887">MaxTranspiration</a>(currentRoot-&gt;<a class="code" href="structlink_list_1_1_snode.html#acb14b868acbf854a0c1be65d99a00c01">element</a>);
<a name="l01193"></a>01193          currentSoilLayer = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01194"></a>01194          SoilLayerIndex++;
<a name="l01195"></a>01195       }
<a name="l01196"></a>01196       rootList-&gt;<a class="code" href="classlink_list.html#a2b549aa4a51e457cb8e0ef19e35978f3" title="Move one step in list.">OneStep</a>(currentRoot);
<a name="l01197"></a>01197       PlantIndex++;
<a name="l01198"></a>01198    }
<a name="l01199"></a>01199    currentSoilLayer = first;
<a name="l01200"></a>01200    <span class="keywordtype">int</span> SoilLayerIndex = 0;
<a name="l01201"></a>01201    <span class="keywordflow">while</span> (currentSoilLayer != NULL)
<a name="l01202"></a>01202    {
<a name="l01203"></a>01203         TotalWaterUptakeAbility[SoilLayerIndex] = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#aaa3df5650bfb89fe57e853d34680b887">MaxTranspiration</a>(TotalRoot);
<a name="l01204"></a>01204       WaterResource[SoilLayerIndex] = min(currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#af01077dc70989747d1f48ba46bb0556c">GetTotalWater</a>()-currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#ac3ebf6c7d7f1cb21dff528dfb33cf28d">GetIce</a>(),TotalWaterUptakeAbility[SoilLayerIndex]);
<a name="l01205"></a>01205       currentSoilLayer = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01206"></a>01206       SoilLayerIndex++;
<a name="l01207"></a>01207    }
<a name="l01208"></a>01208 
<a name="l01209"></a>01209    ResourceCompetition(ResourceNumber, AttackerNumber, PlantDemand, &amp;WaterUptakeAbility[0], &amp;WaterResource[0], &amp;PlantUptake[0]);
<a name="l01210"></a>01210 <span class="preprocessor">#ifndef __BCplusplus__</span>
<a name="l01211"></a>01211 <span class="preprocessor"></span>   <span class="keyword">delete</span> [] TotalRoot-&gt;<a class="code" href="structroot_structure.html#a20025f911a33441a80de37712a1a659c">rootLengthList</a>; <span class="comment">// BMP added June 2002</span>
<a name="l01212"></a>01212 <span class="preprocessor">#else</span>
<a name="l01213"></a>01213 <span class="preprocessor"></span>   <span class="keyword">delete</span> [<span class="keyword">sizeof</span>(double)*MaxSoilLayers] TotalRoot-&gt;<a class="code" href="structroot_structure.html#a20025f911a33441a80de37712a1a659c">rootLengthList</a>; <span class="comment">// BMP added June 2002</span>
<a name="l01214"></a>01214 #endif
<a name="l01215"></a>01215    <span class="keyword">delete</span> TotalRoot;
<a name="l01216"></a>01216 
<a name="l01217"></a>01217    if (rootList!=NULL) <span class="comment">// Perform only if plants has roots</span>
<a name="l01218"></a>01218    {
<a name="l01219"></a>01219         <a class="code" href="classsoil_layer.html">soilLayer</a> * currentSoilLayer = first;
<a name="l01220"></a>01220       <span class="keywordtype">int</span> SoilLayerIndex = 0;
<a name="l01221"></a>01221       <span class="keywordflow">while</span> (currentSoilLayer != NULL)
<a name="l01222"></a>01222       {
<a name="l01223"></a>01223         <span class="keywordtype">double</span> subtractTransp = 0.0;
<a name="l01224"></a>01224          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;AttackerNumber;j++)
<a name="l01225"></a>01225          {
<a name="l01226"></a>01226                 <span class="keywordtype">double</span>  transpirationRate = PlantUptake[SoilLayerIndex+j*ResourceNumber];
<a name="l01227"></a>01227             transpirationRate = min(transpirationRate,currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#aaa3df5650bfb89fe57e853d34680b887">MaxTranspiration</a>(rootList-&gt;<a class="code" href="classlink_list.html#a5735a6e54a2eed841bdf1fdb52aed03f" title="Return the address of the node with a given logical number in the list.">ElementAtNumber</a>(j)));
<a name="l01228"></a>01228             subtractTransp += transpirationRate;
<a name="l01229"></a>01229             TotalPlantUptake[j] += transpirationRate;
<a name="l01230"></a>01230          }
<a name="l01231"></a>01231          currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#afed3ac753d46a4ed2ea2b1f3e160752b">SubtractTranspiration</a>(subtractTransp);
<a name="l01232"></a>01232          currentSoilLayer = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01233"></a>01233          SoilLayerIndex++;
<a name="l01234"></a>01234       }
<a name="l01235"></a>01235    }
<a name="l01236"></a>01236 
<a name="l01237"></a>01237    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;AttackerNumber;i++)
<a name="l01238"></a>01238    {
<a name="l01239"></a>01239         rootList-&gt;<a class="code" href="classlink_list.html#a5735a6e54a2eed841bdf1fdb52aed03f" title="Return the address of the node with a given logical number in the list.">ElementAtNumber</a>(i)-&gt;<a class="code" href="structroot_structure.html#ac5932526da0cac056674b385da3b52a1">actualTranspiration</a> = TotalPlantUptake[i];
<a name="l01240"></a>01240       <span class="keywordflow">if</span> (TotalPlantUptake[i]&lt;0)
<a name="l01241"></a>01241         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::SubtractTranspiration negative &quot;</span>,TotalPlantUptake[i]);
<a name="l01242"></a>01242       <span class="keywordflow">if</span> (TotalPlantUptake[i]-rootList-&gt;<a class="code" href="classlink_list.html#a5735a6e54a2eed841bdf1fdb52aed03f" title="Return the address of the node with a given logical number in the list.">ElementAtNumber</a>(i)-&gt;<a class="code" href="structroot_structure.html#a9a245fabd4034d40698a238e789c3c7d">transpirationDemand</a>&gt;1e-5)
<a name="l01243"></a>01243       {
<a name="l01244"></a>01244          cout &lt;&lt; <a class="code" href="bstime_8h.html#ac0dc3834220ee5ae84c115e146194d75">theTime</a> &lt;&lt; endl;
<a name="l01245"></a>01245          cout &lt;&lt; <span class="stringliteral">&quot;Layer: &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;  TotalPlantUptake: &quot;</span> &lt;&lt; TotalPlantUptake[i] &lt;&lt; <span class="stringliteral">&quot;  RootList_transpirationDemand: &quot;</span> &lt;&lt; rootList-&gt;<a class="code" href="classlink_list.html#a5735a6e54a2eed841bdf1fdb52aed03f" title="Return the address of the node with a given logical number in the list.">ElementAtNumber</a>(i)-&gt;<a class="code" href="structroot_structure.html#a9a245fabd4034d40698a238e789c3c7d">transpirationDemand</a>;
<a name="l01246"></a>01246         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::SubtractTranspiration exceeds demand by &quot;</span>,TotalPlantUptake[i]-rootList-&gt;<a class="code" href="classlink_list.html#a5735a6e54a2eed841bdf1fdb52aed03f" title="Return the address of the node with a given logical number in the list.">ElementAtNumber</a>(i)-&gt;<a class="code" href="structroot_structure.html#a9a245fabd4034d40698a238e789c3c7d">transpirationDemand</a>);
<a name="l01247"></a>01247       }
<a name="l01248"></a>01248    }
<a name="l01249"></a>01249    <span class="keywordflow">if</span> (waterBefore&gt;1E-5)
<a name="l01250"></a>01250         EvaporationContent *= soilLayerArray[0]-&gt;<a class="code" href="classsoil_layer.html#aadce28fdd5d1a819981785e6f4954674">GetAvailWater</a>()/waterBefore;
<a name="l01251"></a>01251 }
<a name="l01252"></a>01252 <span class="comment">/****************************************************************************\</span>
<a name="l01253"></a>01253 <span class="comment">Subtracts estimated nitrogen uptake by the plants from the mineral</span>
<a name="l01254"></a>01254 <span class="comment">nitrogen pools in the layer.</span>
<a name="l01255"></a>01255 <span class="comment">\****************************************************************************/</span>
<a name="l01256"></a><a class="code" href="classsoil_profile.html#af357c8e8608de267646daf715ca1a125">01256</a> <a class="code" href="classnitrogen.html">nitrogen</a>* <a class="code" href="classsoil_profile.html#af357c8e8608de267646daf715ca1a125">soilProfile::SubtractNitrogenUptake</a>(<a class="code" href="classlink_list.html" title="Utility link list class.">linkList&lt;rootStructure&gt;</a>* rootList)
<a name="l01257"></a>01257 {
<a name="l01258"></a>01258    <span class="keywordtype">double</span> PlantDemand[<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>];
<a name="l01259"></a>01259    <span class="keywordtype">double</span> NitrogenUptakeAbility[2*MaxSoilLayers*<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>];  
<a name="l01260"></a>01260    <span class="keywordtype">double</span> NitrogenResource[2*<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01261"></a>01261    <span class="keywordtype">double</span> PlantUptake[<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>*2*<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01262"></a>01262    <span class="keywordtype">int</span> Iteration=<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>*2*<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>;
<a name="l01263"></a>01263    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;Iteration;i++)
<a name="l01264"></a>01264    {
<a name="l01265"></a>01265            PlantUptake[i]=0;
<a name="l01266"></a>01266    }
<a name="l01267"></a>01267    <a class="code" href="classnitrogen.html">nitrogen</a> TotalPlantUptake[<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>];
<a name="l01268"></a>01268 
<a name="l01269"></a>01269    <span class="keywordtype">int</span> AttackerNumber = rootList-&gt;<a class="code" href="classlink_list.html#aee3f890e4e8f48db1518e5114d5bcca8" title="Returned total number of nodes.">NumOfNodes</a>();
<a name="l01270"></a>01270    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;AttackerNumber;i++)
<a name="l01271"></a>01271         PlantDemand[i] = rootList-&gt;<a class="code" href="classlink_list.html#a5735a6e54a2eed841bdf1fdb52aed03f" title="Return the address of the node with a given logical number in the list.">ElementAtNumber</a>(i)-&gt;<a class="code" href="structroot_structure.html#ac0f131a12d7d312fb63c8f5731d2bedd">NitrogenDemand</a>;
<a name="l01272"></a>01272         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;AttackerNumber;j++)
<a name="l01273"></a>01273         TotalPlantUptake[j].Clear();
<a name="l01274"></a>01274 
<a name="l01275"></a>01275    <a class="code" href="structroot_structure.html">rootStructure</a> * TotalRoot = <span class="keyword">new</span> <a class="code" href="structroot_structure.html">rootStructure</a>;
<a name="l01276"></a>01276    EstimateTotalRoot(TotalRoot,rootList);
<a name="l01277"></a>01277 
<a name="l01278"></a>01278         <span class="keywordtype">int</span> ResourceNumber = 0;
<a name="l01279"></a>01279    <a class="code" href="classsoil_layer.html">soilLayer</a> * currentSoilLayer = first;
<a name="l01280"></a>01280    <span class="keywordflow">while</span> (currentSoilLayer != NULL)
<a name="l01281"></a>01281    {
<a name="l01282"></a>01282         currentSoilLayer = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01283"></a>01283       ResourceNumber++;
<a name="l01284"></a>01284    }
<a name="l01285"></a>01285    ResourceNumber = ResourceNumber*2;                                 <span class="comment">// 2 as both nitrate and ammonium are substrates</span>
<a name="l01286"></a>01286 
<a name="l01287"></a>01287    <a class="code" href="structlink_list_1_1_snode.html" title="Node contains a pointer to some class and to the next node in the list.">linkList &lt;rootStructure&gt;::PS</a> currentRoot;
<a name="l01288"></a>01288    rootList-&gt;<a class="code" href="classlink_list.html#a7a7cc9e8690c7e9c73d5b406cae066d3" title="Returned a pointer to the first node.">PeekHead</a>(currentRoot);
<a name="l01289"></a>01289    <span class="keywordtype">int</span> PlantIndex = 0;
<a name="l01290"></a>01290    <span class="keywordflow">while</span> (currentRoot != NULL)
<a name="l01291"></a>01291    {
<a name="l01292"></a>01292         <span class="keywordtype">int</span> SoilLayerIndex = 0;
<a name="l01293"></a>01293       <a class="code" href="classsoil_layer.html">soilLayer</a> * currentSoilLayer = first;
<a name="l01294"></a>01294       <span class="keywordflow">while</span> (currentSoilLayer != NULL)
<a name="l01295"></a>01295       {
<a name="l01296"></a>01296         NitrogenUptakeAbility[2*SoilLayerIndex+PlantIndex*ResourceNumber]   = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a5685f314f5fc88763799e71fd34b8c75">MaxNitrogenFlux</a>(<span class="keyword">false</span>,currentRoot-&gt;<a class="code" href="structlink_list_1_1_snode.html#acb14b868acbf854a0c1be65d99a00c01">element</a>);
<a name="l01297"></a>01297                         NitrogenUptakeAbility[2*SoilLayerIndex+PlantIndex*ResourceNumber+1] = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a5685f314f5fc88763799e71fd34b8c75">MaxNitrogenFlux</a>(<span class="keyword">true</span> ,currentRoot-&gt;<a class="code" href="structlink_list_1_1_snode.html#acb14b868acbf854a0c1be65d99a00c01">element</a>);
<a name="l01298"></a>01298          currentSoilLayer = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01299"></a>01299          SoilLayerIndex++;
<a name="l01300"></a>01300       }
<a name="l01301"></a>01301       rootList-&gt;<a class="code" href="classlink_list.html#a2b549aa4a51e457cb8e0ef19e35978f3" title="Move one step in list.">OneStep</a>(currentRoot);
<a name="l01302"></a>01302       PlantIndex++;
<a name="l01303"></a>01303    }
<a name="l01304"></a>01304 
<a name="l01305"></a>01305    <span class="keywordtype">int</span> SoilLayerIndex = 0;
<a name="l01306"></a>01306    currentSoilLayer = first;
<a name="l01307"></a>01307    <span class="keyword">static</span> <span class="keywordtype">int</span> tmp=0;
<a name="l01308"></a>01308    tmp++;
<a name="l01309"></a>01309    <span class="keywordflow">while</span> (currentSoilLayer != NULL)
<a name="l01310"></a>01310    {
<a name="l01311"></a>01311       <span class="keywordtype">double</span> TotalAmmoniumUptake = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a5685f314f5fc88763799e71fd34b8c75">MaxNitrogenFlux</a>(<span class="keyword">false</span>,TotalRoot);
<a name="l01312"></a>01312       <span class="keywordtype">double</span> LayerAmmonium = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a6c55ade0e8450447467b46f13c169309">GetAmmonium</a>().<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>*currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a45a1255f7f65f6f2ac3087b13061ee93">FracAmmoniumInWater</a>();
<a name="l01313"></a>01313         NitrogenResource[2*SoilLayerIndex]   = min(LayerAmmonium,TotalAmmoniumUptake);
<a name="l01314"></a>01314         <span class="keywordflow">if</span>(tmp==0)
<a name="l01315"></a>01315         {
<a name="l01316"></a>01316                 cout&lt;&lt;currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a6c55ade0e8450447467b46f13c169309">GetAmmonium</a>().<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;&lt;endl;
<a name="l01317"></a>01317         }
<a name="l01318"></a>01318       <span class="keywordtype">double</span> TotalNitrateUptake = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a5685f314f5fc88763799e71fd34b8c75">MaxNitrogenFlux</a>(<span class="keyword">true</span>,TotalRoot);
<a name="l01319"></a>01319       <span class="keywordtype">double</span> LayerNitrate = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a35ebeffcc6514687cac1cb50dea2cad1">GetNitrate</a>().<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>;
<a name="l01320"></a>01320         NitrogenResource[2*SoilLayerIndex+1] = min(LayerNitrate,TotalNitrateUptake);
<a name="l01321"></a>01321 
<a name="l01322"></a>01322       currentSoilLayer = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01323"></a>01323       SoilLayerIndex++;
<a name="l01324"></a>01324    }
<a name="l01325"></a>01325 
<a name="l01326"></a>01326    ResourceCompetition(ResourceNumber, AttackerNumber, PlantDemand, &amp;NitrogenUptakeAbility[0], &amp;NitrogenResource[0], &amp;PlantUptake[0]);
<a name="l01327"></a>01327    <span class="comment">//delete [sizeof(double)*MaxSoilLayers] TotalRoot-&gt;rootLengthList; // BMP added June 2002</span>
<a name="l01328"></a>01328    <span class="keyword">delete</span> [] TotalRoot-&gt;<a class="code" href="structroot_structure.html#a20025f911a33441a80de37712a1a659c">rootLengthList</a>; <span class="comment">// BMP added June 2002</span>
<a name="l01329"></a>01329    <span class="keyword">delete</span> TotalRoot;
<a name="l01330"></a>01330 
<a name="l01331"></a>01331    <span class="keywordflow">if</span> (rootList!=NULL) <span class="comment">// Perform only if plants has roots</span>
<a name="l01332"></a>01332         {
<a name="l01333"></a>01333                 <a class="code" href="classsoil_layer.html">soilLayer</a> * currentSoilLayer = first;
<a name="l01334"></a>01334         <span class="keywordtype">int</span> SoilLayerIndex = 0;
<a name="l01335"></a>01335         <span class="keywordflow">while</span> (currentSoilLayer != NULL)
<a name="l01336"></a>01336         {
<a name="l01337"></a>01337                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;AttackerNumber;j++)
<a name="l01338"></a>01338          {
<a name="l01339"></a>01339             <a class="code" href="classnitrogen.html">nitrogen</a> NH4LayerUptake = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a88b301de01a73797ff3c48b11d1eef58">SubtractAmmoniumUptake</a>(PlantUptake[2*SoilLayerIndex+j*ResourceNumber]);
<a name="l01340"></a>01340             <a class="code" href="classnitrogen.html">nitrogen</a> NO3LayerUptake = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#aa7189120b1afb35795a040acd399b179">SubtractNitrateUptake</a>(PlantUptake[2*SoilLayerIndex+j*ResourceNumber+1]);
<a name="l01341"></a>01341             TotalPlantUptake[j] = TotalPlantUptake[j] + NH4LayerUptake + NO3LayerUptake;
<a name="l01342"></a>01342                         }
<a name="l01343"></a>01343          currentSoilLayer = currentSoilLayer-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01344"></a>01344          SoilLayerIndex++;
<a name="l01345"></a>01345         }
<a name="l01346"></a>01346         }
<a name="l01347"></a>01347    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;AttackerNumber;i++)
<a name="l01348"></a>01348         nitrogenUptake[i] = TotalPlantUptake[i];
<a name="l01349"></a>01349    <span class="keywordflow">return</span> nitrogenUptake;
<a name="l01350"></a>01350 }
<a name="l01351"></a>01351 
<a name="l01352"></a>01352 <span class="comment">/****************************************************************************\</span>
<a name="l01353"></a>01353 <span class="comment">\****************************************************************************/</span>
<a name="l01354"></a>01354 <span class="keywordtype">void</span> soilProfile::ResourceCompetition(<span class="keywordtype">int</span> ResourceNumber, <span class="keywordtype">int</span> AttackerNumber, <span class="keywordtype">double</span>* Demand, <span class="keywordtype">double</span>* UptakeAbility, <span class="keywordtype">double</span>* Resource, <span class="keywordtype">double</span>* ResourceRemoved)
<a name="l01355"></a>01355 {
<a name="l01356"></a>01356 
<a name="l01357"></a>01357    <span class="keywordtype">double</span> PossibleUptake[<a class="code" href="typer_8h.html#adc29c2ff13d900c2f185ee95427fb06ca1f37f2cf718636fd4290eea4cbbfaf6d">MaxPlants</a>];
<a name="l01358"></a>01358    <span class="keywordtype">double</span> MaxResourceUptake[2*<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01359"></a>01359    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;AttackerNumber; j++) PossibleUptake[j] = 0.0;
<a name="l01360"></a>01360    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ResourceNumber; i++) MaxResourceUptake[i] = 0.0;
<a name="l01361"></a>01361    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;AttackerNumber; j++)
<a name="l01362"></a>01362         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ResourceNumber; i++)
<a name="l01363"></a>01363         ResourceRemoved[i+j*ResourceNumber] = 0.0;
<a name="l01364"></a>01364    <span class="keywordtype">bool</span> DemandFullfilled = <span class="keyword">false</span>;
<a name="l01365"></a>01365 
<a name="l01366"></a>01366    <span class="keywordflow">while</span> (!DemandFullfilled)
<a name="l01367"></a>01367    {
<a name="l01368"></a>01368 
<a name="l01369"></a>01369       DemandFullfilled = <span class="keyword">true</span>;
<a name="l01370"></a>01370         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;AttackerNumber; j++)
<a name="l01371"></a>01371                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ResourceNumber; i++)
<a name="l01372"></a>01372                 MaxResourceUptake[i] += UptakeAbility[i+j*ResourceNumber];
<a name="l01373"></a>01373 
<a name="l01374"></a>01374         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;AttackerNumber; j++)
<a name="l01375"></a>01375       {
<a name="l01376"></a>01376                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ResourceNumber; i++)
<a name="l01377"></a>01377             <span class="keywordflow">if</span> (MaxResourceUptake[i]&gt;0)
<a name="l01378"></a>01378                 PossibleUptake[j] += UptakeAbility[i+j*ResourceNumber]*min(1.0,Resource[i]/MaxResourceUptake[i]);
<a name="l01379"></a>01379          DemandFullfilled = DemandFullfilled &amp; (PossibleUptake[j]&gt;Demand[j]);
<a name="l01380"></a>01380       }
<a name="l01381"></a>01381       <span class="keywordflow">if</span> (DemandFullfilled)
<a name="l01382"></a>01382       {
<a name="l01383"></a>01383         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j&lt;AttackerNumber; j++)
<a name="l01384"></a>01384                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ResourceNumber; i++)
<a name="l01385"></a>01385                         {
<a name="l01386"></a>01386 
<a name="l01387"></a>01387                 <span class="keywordflow">if</span> ((PossibleUptake[j]&gt;0) &amp;&amp; (MaxResourceUptake[i]&gt;0) &amp;&amp; (Demand[j]&gt;0))
<a name="l01388"></a>01388                                 ResourceRemoved[i+j*ResourceNumber] = Demand[j]/PossibleUptake[j]*UptakeAbility[i+j*ResourceNumber]*min(1.0,Resource[i]/MaxResourceUptake[i]);
<a name="l01389"></a>01389                         }
<a name="l01390"></a>01390       }
<a name="l01391"></a>01391       <span class="keywordflow">else</span>
<a name="l01392"></a>01392       {
<a name="l01393"></a>01393         <span class="keywordtype">bool</span> singleDemand = <span class="keyword">false</span>;
<a name="l01394"></a>01394         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j&lt;AttackerNumber; j++)
<a name="l01395"></a>01395         {
<a name="l01396"></a>01396                         <span class="keywordflow">if</span> ((PossibleUptake[j]&gt;Demand[j]) &amp;&amp; (Demand[j]&gt;0))                 <span class="comment">// single plant demand can be fullfilled !!</span>
<a name="l01397"></a>01397             {
<a name="l01398"></a>01398                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ResourceNumber; i++)
<a name="l01399"></a>01399                {
<a name="l01400"></a>01400                         <span class="keywordflow">if</span> ((PossibleUptake[j]&gt;0) &amp;&amp; (MaxResourceUptake[i]&gt;0))
<a name="l01401"></a>01401                                         ResourceRemoved[i+j*ResourceNumber] = Demand[j]/PossibleUptake[j]*UptakeAbility[i+j*ResourceNumber]*min(1.0,Resource[i]/MaxResourceUptake[i]);
<a name="l01402"></a>01402                   UptakeAbility[i+j*ResourceNumber] = 0.0;
<a name="l01403"></a>01403                }
<a name="l01404"></a>01404                singleDemand = <span class="keyword">true</span>;
<a name="l01405"></a>01405                Demand[j] = 0.0;
<a name="l01406"></a>01406             }
<a name="l01407"></a>01407         }
<a name="l01408"></a>01408          <span class="keywordflow">if</span> (!singleDemand)                                    <span class="comment">// all plants uptake are below demand !!</span>
<a name="l01409"></a>01409          {
<a name="l01410"></a>01410                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;AttackerNumber; j++)
<a name="l01411"></a>01411                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ResourceNumber; i++)
<a name="l01412"></a>01412                 <span class="keywordflow">if</span> ((PossibleUptake[j]&gt;0) &amp;&amp; (MaxResourceUptake[i]&gt;0) &amp;&amp; (Demand[j]&gt;0))
<a name="l01413"></a>01413                         ResourceRemoved[i+j*ResourceNumber] = UptakeAbility[i+j*ResourceNumber]*min(1.0,Resource[i]/MaxResourceUptake[i]);
<a name="l01414"></a>01414             DemandFullfilled = <span class="keyword">true</span>;
<a name="l01415"></a>01415          }
<a name="l01416"></a>01416       }
<a name="l01417"></a>01417    }
<a name="l01418"></a>01418 }
<a name="l01419"></a>01419 
<a name="l01420"></a>01420 <span class="comment">/****************************************************************************\</span>
<a name="l01421"></a>01421 <span class="comment">Calculates soil temperature using a simple algorithm.</span>
<a name="l01422"></a>01422 <span class="comment">Returned values for periods without frost are good estimates, returned</span>
<a name="l01423"></a>01423 <span class="comment">values for periods with frost are fair estimates as frost and snow influence</span>
<a name="l01424"></a>01424 <span class="comment">are not accounted for in a fully satisfactory fashion using this simple method.</span>
<a name="l01425"></a>01425 <span class="comment">Konstants are presently hand-fitted (8.3.1999).</span>
<a name="l01426"></a>01426 <span class="comment">   soilTemperature    -</span>
<a name="l01427"></a>01427 <span class="comment">   airTemperature     - mean air temperature of the current day (Celsius)</span>
<a name="l01428"></a>01428 <span class="comment">   depth              - soil depth in mm</span>
<a name="l01429"></a>01429 <span class="comment">   meanAirTemperature - yearly mean air temperature for the site (Celsius)</span>
<a name="l01430"></a>01430 <span class="comment">\****************************************************************************/</span>
<a name="l01431"></a><a class="code" href="classsoil_profile.html#a746e2b78952a19280ace39d3518dc109">01431</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#a746e2b78952a19280ace39d3518dc109">soilProfile::UpdateT</a>(<span class="keywordtype">double</span> * soilTemperature,<span class="keywordtype">double</span> airTemperature,<span class="keywordtype">double</span> depth,<span class="keywordtype">double</span> meanAirTemperature)
<a name="l01432"></a>01432 {
<a name="l01433"></a>01433    <span class="keyword">const</span> <span class="keywordtype">double</span> k1      =  30000.0;
<a name="l01434"></a>01434    <span class="keyword">const</span> <span class="keywordtype">double</span> k2      = -0.00033;
<a name="l01435"></a>01435    <span class="keyword">const</span> <span class="keywordtype">double</span> k3      =  0.006;
<a name="l01436"></a>01436    <span class="keyword">const</span> <span class="keywordtype">double</span> k4      =  0.12;
<a name="l01437"></a>01437 
<a name="l01438"></a>01438    <span class="keywordflow">if</span> (depth&gt;0)
<a name="l01439"></a>01439    {
<a name="l01440"></a>01440       <span class="keywordtype">double</span> a1=k1/(k1+(depth*depth));
<a name="l01441"></a>01441       <span class="keywordflow">if</span> (*soilTemperature&lt;k3*depth)
<a name="l01442"></a>01442          a1=a1*k4;
<a name="l01443"></a>01443       <span class="keywordtype">double</span> dampenFactor=exp(k2*depth);
<a name="l01444"></a>01444       <span class="keywordtype">double</span> Tdampened=((airTemperature-meanAirTemperature)*dampenFactor)+meanAirTemperature; <span class="comment">// Dampen amplitude. Tdampened is target value for this depth</span>
<a name="l01445"></a>01445       *soilTemperature+=a1*(Tdampened-*soilTemperature); <span class="comment">// Pursue target value</span>
<a name="l01446"></a>01446    }
<a name="l01447"></a>01447    <span class="keywordflow">else</span>
<a name="l01448"></a>01448       <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soil::UpdateT - depth must be &gt; 0.0&quot;</span>);
<a name="l01449"></a>01449 }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451 
<a name="l01452"></a>01452 
<a name="l01453"></a>01453 <span class="comment">/*******************************************************</span>
<a name="l01454"></a>01454 <span class="comment">Alternative 3 (MEL 2007): UpdateFinDiffTemperature calculates</span>
<a name="l01455"></a>01455 <span class="comment">the soil temperature according the finite difference sceme</span>
<a name="l01456"></a>01456 <span class="comment">The upper boundary condition consist terms with</span>
<a name="l01457"></a>01457 <span class="comment">both airtemperature, radiation and snow cover.</span>
<a name="l01458"></a>01458 <span class="comment">fractionEvaporation is used to correct radiation for</span>
<a name="l01459"></a>01459 <span class="comment">reflection by leaves.</span>
<a name="l01460"></a>01460 <span class="comment">*******************************************************/</span>
<a name="l01461"></a><a class="code" href="classsoil_profile.html#a11708c4ea232e4ba78ba3b7cf425853c">01461</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#a11708c4ea232e4ba78ba3b7cf425853c">soilProfile::UpdateFinDiffTemperature</a>(<span class="keywordtype">double</span> AirTemperature, <span class="keywordtype">double</span> snow)
<a name="l01462"></a>01462 {
<a name="l01463"></a>01463 
<a name="l01464"></a>01464 
<a name="l01465"></a>01465    <span class="keywordflow">if</span> (<a class="code" href="control_parameters_8h.html#a5f2fa76e64eab2ae2d13f038d69004aa">theControlParameters</a>-&gt;<a class="code" href="classcontrol_parameters.html#acc775aa5ded70768f3248110f1ff47b7">GetSimpleTemperatureModel</a>() || <a class="code" href="control_parameters_8h.html#a5f2fa76e64eab2ae2d13f038d69004aa">theControlParameters</a>-&gt;<a class="code" href="classcontrol_parameters.html#ae6fc8fcf70764dce9c38d52aaaad6bfe">GetMeasuredSoilTemperature</a>()||<a class="code" href="control_parameters_8h.html#a5f2fa76e64eab2ae2d13f038d69004aa">theControlParameters</a>-&gt;<a class="code" href="classcontrol_parameters.html#add34033c9c86c35d6f55c9da59db3818">GetAirToSoilTemperature</a>())
<a name="l01466"></a>01466    {
<a name="l01467"></a>01467         <span class="keywordflow">if</span> (<a class="code" href="control_parameters_8h.html#a5f2fa76e64eab2ae2d13f038d69004aa">theControlParameters</a>-&gt;<a class="code" href="classcontrol_parameters.html#acc775aa5ded70768f3248110f1ff47b7">GetSimpleTemperatureModel</a>())
<a name="l01468"></a>01468       {
<a name="l01469"></a>01469         <span class="keywordtype">double</span> soilTemperature;
<a name="l01470"></a>01470               <span class="keywordtype">double</span> depth;
<a name="l01471"></a>01471            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1;i&lt;NumOfSoilLayers;i++)
<a name="l01472"></a>01472         {
<a name="l01473"></a>01473                 soilTemperature=soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a4767a2f084104f8c8407af7a6c7d7513">GetTemperature</a>();
<a name="l01474"></a>01474                  <span class="keywordflow">if</span> ((soilTemperature&lt;-50) || (soilTemperature&gt;50))
<a name="l01475"></a>01475                     <a class="code" href="classsoil_profile.html#a63e938ce16657be6fbff5eb6a6b63791">Terminate</a>(<span class="stringliteral">&quot;soilProfile::UpdateFinDiffTemperature - soil temperature not within realistic range&quot;</span>);
<a name="l01476"></a>01476                  depth = soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a067dc1539ac09a475b678ef6d67b2812">GetStartDepth</a>()+ soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>()*0.5;
<a name="l01477"></a>01477                  <a class="code" href="classsoil_profile.html#a746e2b78952a19280ace39d3518dc109">UpdateT</a>(&amp;soilTemperature,AirTemperature,depth,8.0);
<a name="l01478"></a>01478               }
<a name="l01479"></a>01479               soilLayerArray[0]-&gt;<a class="code" href="classsoil_layer.html#a6b3b3438c29df1bf4037d00875b676e7">PutTemperature</a>(AirTemperature);
<a name="l01480"></a>01480       }
<a name="l01481"></a>01481       <span class="keywordflow">else</span>
<a name="l01482"></a>01482               <span class="keywordflow">if</span>  (<a class="code" href="control_parameters_8h.html#a5f2fa76e64eab2ae2d13f038d69004aa">theControlParameters</a>-&gt;<a class="code" href="classcontrol_parameters.html#add34033c9c86c35d6f55c9da59db3818">GetAirToSoilTemperature</a>())
<a name="l01483"></a>01483               {
<a name="l01484"></a>01484          <span class="comment">//set soil temperature to the same as air temperature - special for laboratory conditions</span>
<a name="l01485"></a>01485                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;NumOfSoilLayers;i++)
<a name="l01486"></a>01486                         soilLayerArray[i]-&gt;PutTemperature(AirTemperature);
<a name="l01487"></a>01487 
<a name="l01488"></a>01488         }
<a name="l01489"></a>01489         <span class="keywordflow">else</span>
<a name="l01490"></a>01490       {
<a name="l01491"></a>01491         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;NumOfSoilLayers;i++)
<a name="l01492"></a>01492                 soilLayerArray[i]-&gt;PutTemperature(<a class="code" href="climate_8h.html#ad05fb99191dc4a9cb94e7f8c99280389">theClimate</a>-&gt;<a class="code" href="classclimate.html#a7aca9683881d45a8bd1111da605adaca">GetNextSoilTemperature</a>());
<a name="l01493"></a>01493       }
<a name="l01494"></a>01494    }
<a name="l01495"></a>01495    <span class="keywordflow">else</span>
<a name="l01496"></a>01496 
<a name="l01497"></a>01497    {
<a name="l01498"></a>01498       <span class="keywordtype">int</span> i;
<a name="l01499"></a>01499       <a class="code" href="classsoil_layer.html">soilLayer</a> * currentLayer;
<a name="l01500"></a>01500 
<a name="l01501"></a>01501       <span class="keywordtype">double</span> deltaTime =  0.0;
<a name="l01502"></a>01502       <span class="keywordtype">double</span> currentTime = 0.0;
<a name="l01503"></a>01503                 <span class="keywordtype">double</span> moreFrozen[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01504"></a>01504       <span class="keywordtype">double</span> waterFlux[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>], waterFluxMean[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>], waterFluxSlope[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01505"></a>01505         <span class="keywordtype">double</span> heatConductivity[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>], heatConductivityMean[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>], heatConductivitySlope[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>],  SpecWaterCapacity[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01506"></a>01506         <span class="keywordtype">double</span> UpperVector[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01507"></a>01507         <span class="keywordtype">double</span> MidVector[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01508"></a>01508                 <span class="keywordtype">double</span> LowerVector[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01509"></a>01509                 <span class="keywordtype">double</span> TOldArray[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01510"></a>01510                 <span class="keywordtype">double</span> TNew[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01511"></a>01511                 <span class="keywordtype">double</span> TOld[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01512"></a>01512         <span class="keywordtype">double</span> A[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01513"></a>01513         <span class="keywordtype">double</span> B[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01514"></a>01514         <span class="keywordtype">double</span> Ka[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01515"></a>01515         <span class="keywordtype">double</span> Kb[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01516"></a>01516         <span class="keywordtype">double</span> Kc[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01517"></a>01517       <span class="keywordtype">bool</span> frostChange[<a class="code" href="typer_8h.html#a61dadd085c1777f559549e05962b2c9ea489863aec95253fced254923e4cb8148">MaxSoilLayers</a>];
<a name="l01518"></a>01518       <span class="keywordtype">double</span> TLB, TUB;
<a name="l01519"></a>01519       <span class="keywordtype">bool</span> reduceTimestep=<span class="keyword">false</span>;
<a name="l01520"></a>01520       <span class="keywordtype">double</span> averageThermalCond;
<a name="l01521"></a>01521       <span class="keywordtype">double</span> averageHeatCapacity;
<a name="l01522"></a>01522       <span class="keywordtype">double</span> WaterInFlux=<a class="code" href="soil_layer_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">WaterDensity</a>*infiltration/86400/1000;            <span class="comment">// unit kg m-2 s-1</span>
<a name="l01523"></a>01523 
<a name="l01524"></a>01524       <span class="keywordtype">int</span> numberOfTotalLayers = NumOfSoilLayers + ExtraLayers;
<a name="l01525"></a>01525 
<a name="l01526"></a>01526         <span class="keywordflow">for</span> (i=0;i&lt;numberOfTotalLayers;i++)
<a name="l01527"></a>01527          moreFrozen[i]=0.0;
<a name="l01528"></a>01528 
<a name="l01529"></a>01529 
<a name="l01530"></a>01530       <span class="keywordflow">for</span> (i=0;i&lt;numberOfTotalLayers;i++)
<a name="l01531"></a>01531       {
<a name="l01532"></a>01532          waterFlux[i] = <a class="code" href="soil_layer_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">WaterDensity</a>*soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a41a31736ecff9877a3fbc566eb11e1ad">GetWaterFlux</a>()/86400/1000;            <span class="comment">// unit kg m-2 s-1</span>
<a name="l01533"></a>01533                 <span class="keywordflow">if</span> (fabs(waterFlux[i])&gt;0.01)
<a name="l01534"></a>01534                 <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateFinDiffTemperature waterflux is larger than 0.01 kg m-2 s-1&quot;</span>);
<a name="l01535"></a>01535                 <span class="keywordflow">if</span> (waterFlux[i]&lt;0.0)
<a name="l01536"></a>01536                 <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateFinDiffTemperature waterflux is negative&quot;</span>);
<a name="l01537"></a>01537       }
<a name="l01538"></a>01538       <span class="keywordflow">for</span> (i=0;i&lt;numberOfTotalLayers;i++)
<a name="l01539"></a>01539       {
<a name="l01540"></a>01540         <span class="keywordflow">if</span> (waterFlux[i]&gt; 10)
<a name="l01541"></a>01541                 <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateFinDiffTemperature - Waterflux unrealistic high&quot;</span>);
<a name="l01542"></a>01542       }
<a name="l01543"></a>01543       waterFluxMean[0]= (WaterInFlux+waterFlux[0])*0.5;
<a name="l01544"></a>01544       <span class="keywordflow">for</span> (i=1;i&lt;numberOfTotalLayers-1;i++)
<a name="l01545"></a>01545         waterFluxMean[i]= (waterFlux[i-1]+waterFlux[i])*0.5;
<a name="l01546"></a>01546       waterFluxMean[numberOfTotalLayers-1]= (waterFlux[numberOfTotalLayers-1]+waterFlux[numberOfTotalLayers-2])*0.5;
<a name="l01547"></a>01547 
<a name="l01548"></a>01548       <span class="comment">// calculate the slope of the waterfluxes</span>
<a name="l01549"></a>01549       waterFluxSlope[0] =  (waterFlux[0]-WaterInFlux)*DistPreviousLayerInv[0];
<a name="l01550"></a>01550       <span class="keywordflow">for</span> (i=1;i&lt;numberOfTotalLayers-1;i++)
<a name="l01551"></a>01551         waterFluxSlope[i] = (waterFlux[i]-waterFlux[i-1])*DistPreviousLayerInv[i];
<a name="l01552"></a>01552       waterFluxSlope[numberOfTotalLayers-1] = (waterFlux[numberOfTotalLayers-1]-waterFlux[numberOfTotalLayers-2])
<a name="l01553"></a>01553                                                                                                                 *DistPreviousLayerInv[numberOfTotalLayers-1];
<a name="l01554"></a>01554 
<a name="l01555"></a>01555       <span class="comment">//get new LB and UB conditions</span>
<a name="l01556"></a>01556       <span class="comment">//LB from analytical solution (as in DAISY)</span>
<a name="l01557"></a>01557       <span class="keywordtype">double</span> maxDepth = (<a class="code" href="classsoil_profile.html#aa28fc2eb898f40cec10a9e57906b36de">GetMaximumDepth</a>()+soilLayerArray[numberOfTotalLayers-2]-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>()+soilLayerArray[numberOfTotalLayers-1]-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>())/1000;           <span class="comment">//change to actual depth!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l01558"></a>01558       <span class="keywordflow">if</span> (calculateAverage)
<a name="l01559"></a>01559       {
<a name="l01560"></a>01560          averageThermalCond=0.0;
<a name="l01561"></a>01561          averageHeatCapacity=0.0;
<a name="l01562"></a>01562         <span class="keywordflow">for</span> (i=0;i&lt;numberOfTotalLayers;i++)
<a name="l01563"></a>01563          {
<a name="l01564"></a>01564                 averageThermalCond += soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a68f3bd7b3e269ba3592e6fd5f04ba9e3">HeatConductivity</a>()*<a class="code" href="classsoil_profile.html#a062bc6b13eb0debe7a8a8c1e31c53b4e">GetLayerThickness</a>(i)/1000/maxDepth;
<a name="l01565"></a>01565                 averageHeatCapacity += soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a0f90f88d0dfdd44b5075f2e20cec6f45">HeatCapacity</a>()*<a class="code" href="classsoil_profile.html#a062bc6b13eb0debe7a8a8c1e31c53b4e">GetLayerThickness</a>(i)/1000/maxDepth;
<a name="l01566"></a>01566         }
<a name="l01567"></a>01567          calculateAverage =<span class="keyword">false</span>;
<a name="l01568"></a>01568       depthDampning = pow(2*averageThermalCond/(averageHeatCapacity*0.0172142/(3600*24)),0.5);                 <span class="comment">//approximately 2.4</span>
<a name="l01569"></a>01569       }
<a name="l01570"></a>01570       <span class="keywordtype">double</span> averageAirTemp = 7.7;
<a name="l01571"></a>01571       <span class="keywordtype">double</span> amplitudeAirTemp = 8.0;
<a name="l01572"></a>01572       <span class="keywordtype">double</span> dayInYear=<a class="code" href="bstime_8h.html#ac0dc3834220ee5ae84c115e146194d75">theTime</a>.<a class="code" href="classbs_time.html#a91f0b41e938320843b362bed6bc87ef2">GetDayInYear</a>();
<a name="l01573"></a>01573       <span class="keywordtype">double</span> dayZero=212.0;   <span class="comment">//august 1th the hottest day january 30th the coldest day</span>
<a name="l01574"></a>01574       <span class="keywordtype">double</span> daysFromZero=dayInYear-dayZero;
<a name="l01575"></a>01575       TLB=averageAirTemp + amplitudeAirTemp*exp(-maxDepth/depthDampning)*cos(0.0172142*(daysFromZero)-maxDepth/depthDampning);
<a name="l01576"></a>01576 
<a name="l01577"></a>01577       <span class="keywordflow">if</span> (snow&gt;0.0)
<a name="l01578"></a>01578          {
<a name="l01579"></a>01579                 <span class="keywordflow">if</span> (AirTemperature&gt;0.0)      <span class="comment">//snow contains liquid water</span>
<a name="l01580"></a>01580                 TUB = 0.0;
<a name="l01581"></a>01581                                 <span class="keywordflow">else</span>                         <span class="comment">//no water in snowpack</span>
<a name="l01582"></a>01582                 TUB = (AirTemperature*<a class="code" href="soil_profile_8cpp.html#a269902d013e2fa7ce90ecb1d85805602">snowConductivity</a>/(snow/1000.0)+
<a name="l01583"></a>01583                         temperature[0]*soilLayerArray[0]-&gt;<a class="code" href="classsoil_layer.html#a68f3bd7b3e269ba3592e6fd5f04ba9e3">HeatConductivity</a>()*DistPreviousLayerInv[0])
<a name="l01584"></a>01584                           /(<a class="code" href="soil_profile_8cpp.html#a269902d013e2fa7ce90ecb1d85805602">snowConductivity</a>/(snow/1000.0)+soilLayerArray[0]-&gt;<a class="code" href="classsoil_layer.html#a68f3bd7b3e269ba3592e6fd5f04ba9e3">HeatConductivity</a>()*DistPreviousLayerInv[0]);
<a name="l01585"></a>01585          }
<a name="l01586"></a>01586       <span class="keywordflow">else</span>
<a name="l01587"></a>01587          TUB = AirTemperature;
<a name="l01588"></a>01588       <span class="comment">// Initialise starting condition</span>
<a name="l01589"></a>01589         <span class="keywordflow">for</span>(i=0;i&lt;numberOfTotalLayers;++i)
<a name="l01590"></a>01590       {
<a name="l01591"></a>01591          TNew[i]=temperature[i];
<a name="l01592"></a>01592          <span class="keywordflow">if</span> ((temperature[i]&lt;0.0) &amp;&amp; (reduceTimestep==<span class="keyword">false</span>))
<a name="l01593"></a>01593                 reduceTimestep=<span class="keyword">true</span>;
<a name="l01594"></a>01594          <span class="keywordflow">if</span> ((soilLayerArray[i]-&gt; GetIce()&gt;0.0) &amp;&amp; (reduceTimestep==<span class="keyword">false</span>))
<a name="l01595"></a>01595             reduceTimestep=<span class="keyword">true</span>;
<a name="l01596"></a>01596       }
<a name="l01597"></a>01597       <span class="keywordflow">if</span> ((AirTemperature &lt; 0.0) &amp;&amp;  (reduceTimestep==<span class="keyword">false</span>))
<a name="l01598"></a>01598         reduceTimestep=<span class="keyword">true</span>;
<a name="l01599"></a>01599 
<a name="l01600"></a>01600       deltaTime=3600;         <span class="comment">//timestep  1 hour</span>
<a name="l01601"></a>01601       <span class="keywordflow">if</span> (reduceTimestep)
<a name="l01602"></a>01602       deltaTime=100;           <span class="comment">//timestep 5 min</span>
<a name="l01603"></a>01603 
<a name="l01604"></a>01604       <span class="keywordtype">bool</span> firstTime=<span class="keyword">true</span>;
<a name="l01605"></a>01605       <span class="comment">// simulate 24 hours</span>
<a name="l01606"></a>01606       <span class="keywordflow">while</span> (currentTime&lt;86400)
<a name="l01607"></a>01607       {
<a name="l01608"></a>01608                         <span class="comment">//transfer of new temperature to old temperature</span>
<a name="l01609"></a>01609                         <span class="keywordflow">for</span>(i=0;i&lt;numberOfTotalLayers;++i)
<a name="l01610"></a>01610          {
<a name="l01611"></a>01611                                 TOld[i]=TNew[i];
<a name="l01612"></a>01612             frostChange[i]=fabs(moreFrozen[i])&gt;1E-30; <span class="comment">// True if change in icecontent</span>
<a name="l01613"></a>01613          }
<a name="l01614"></a>01614 
<a name="l01615"></a>01615 
<a name="l01616"></a>01616             <span class="comment">//calculate heatconductivity etc.</span>
<a name="l01617"></a>01617          <span class="keywordflow">for</span> (i=0;i&lt;numberOfTotalLayers;i++)
<a name="l01618"></a>01618             <span class="keywordflow">if</span> (frostChange[i] || firstTime)
<a name="l01619"></a>01619             {
<a name="l01620"></a>01620                heatConductivity[i] = soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a68f3bd7b3e269ba3592e6fd5f04ba9e3">HeatConductivity</a>();
<a name="l01621"></a>01621 
<a name="l01622"></a>01622                SpecWaterCapacity[i] = soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a670e17930818ea08c5ace53a25700f4a">SpecWaterCapacity</a>();
<a name="l01623"></a>01623             }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625          <span class="keywordflow">for</span> (i=0;i&lt;numberOfTotalLayers;i++)      <span class="comment">// calculates the slope of the heatconductivity</span>
<a name="l01626"></a>01626             <span class="keywordflow">if</span> (frostChange[i] || firstTime)
<a name="l01627"></a>01627             {
<a name="l01628"></a>01628                 <span class="keywordflow">if</span> (i==0)
<a name="l01629"></a>01629                 {
<a name="l01630"></a>01630                   heatConductivitySlope[i] = (0.025+(heatConductivity[i+1]-heatConductivity[i])*DistNextLayerInv[i])*0.5;    <span class="comment">// mean between soil and air</span>
<a name="l01631"></a>01631                   heatConductivityMean[i]=  (heatConductivity[i+1]+heatConductivity[i])*0.5;
<a name="l01632"></a>01632                }
<a name="l01633"></a>01633                <span class="keywordflow">else</span>
<a name="l01634"></a>01634                {
<a name="l01635"></a>01635                   <span class="keywordflow">if</span> (i==(numberOfTotalLayers-1))
<a name="l01636"></a>01636                   {
<a name="l01637"></a>01637                      heatConductivitySlope[i] =  (heatConductivity[i]-heatConductivity[i-1])*DistPreviousLayerInv[i];
<a name="l01638"></a>01638                                 heatConductivityMean[i]=  heatConductivity[i];
<a name="l01639"></a>01639                   }
<a name="l01640"></a>01640                   <span class="keywordflow">else</span>
<a name="l01641"></a>01641                   {
<a name="l01642"></a>01642                      heatConductivitySlope[i] =  ((heatConductivity[i+1]-heatConductivity[i])*DistNextLayerInv[i]+
<a name="l01643"></a>01643                                                   (heatConductivity[i]-heatConductivity[i-1])*DistPreviousLayerInv[i])*0.5;
<a name="l01644"></a>01644                      heatConductivityMean[i]=  (heatConductivity[i+1]+heatConductivity[i])*0.5;;
<a name="l01645"></a>01645                   }
<a name="l01646"></a>01646                }
<a name="l01647"></a>01647             }
<a name="l01648"></a>01648 
<a name="l01649"></a>01649          <span class="keywordflow">for</span> (i=0;i&lt;numberOfTotalLayers;i++)
<a name="l01650"></a>01650             <span class="keywordflow">if</span> (frostChange[i] || firstTime)
<a name="l01651"></a>01651             {
<a name="l01652"></a>01652                currentLayer = soilLayerArray[i];
<a name="l01653"></a>01653             <span class="keywordflow">if</span> (((TNew[i] &lt; 0.0) &amp;&amp; (currentLayer-&gt;<a class="code" href="classsoil_layer.html#ac3ebf6c7d7f1cb21dff528dfb33cf28d">GetIce</a>()&lt;currentLayer-&gt;<a class="code" href="classsoil_layer.html#af01077dc70989747d1f48ba46bb0556c">GetTotalWater</a>())) || <span class="comment">//freezing</span>
<a name="l01654"></a>01654                ((TNew[i] &gt; 0.0) &amp;&amp; (currentLayer-&gt;<a class="code" href="classsoil_layer.html#ac3ebf6c7d7f1cb21dff528dfb33cf28d">GetIce</a>()&gt;0.0)))    <span class="comment">//thawing</span>
<a name="l01655"></a>01655                {
<a name="l01656"></a>01656                   A[i]=<a class="code" href="soil_profile_8cpp.html#a2b1af553057bae6c283762156c7f5469">specCapacity</a>*<a class="code" href="soil_profile_8cpp.html#a2b1af553057bae6c283762156c7f5469">specCapacity</a>/273.0*SpecWaterCapacity[i]+currentLayer-&gt;<a class="code" href="classsoil_layer.html#a0f90f88d0dfdd44b5075f2e20cec6f45">HeatCapacity</a>();
<a name="l01657"></a>01657                   B[i]=<a class="code" href="soil_profile_8cpp.html#a2b1af553057bae6c283762156c7f5469">specCapacity</a>*waterFluxSlope[i];
<a name="l01658"></a>01658                }
<a name="l01659"></a>01659                <span class="keywordflow">else</span>
<a name="l01660"></a>01660                {
<a name="l01661"></a>01661                   A[i]=currentLayer-&gt;<a class="code" href="classsoil_layer.html#a0f90f88d0dfdd44b5075f2e20cec6f45">HeatCapacity</a>();
<a name="l01662"></a>01662                   B[i]=0;
<a name="l01663"></a>01663                }
<a name="l01664"></a>01664                Ka[i]=A[i]/deltaTime;
<a name="l01665"></a>01665                Kb[i]=heatConductivityMean[i]/(distanceToPreviousLayer[i]+distanceToNextLayer[i]);
<a name="l01666"></a>01666                Kc[i]=(heatConductivitySlope[i]-<a class="code" href="soil_layer_8cpp.html#aa802d053b0e834f15ac8331c6c1d42b8">HeatCapacityWater</a>*waterFluxMean[i])/
<a name="l01667"></a>01667                   (2*(distanceToPreviousLayer[i]+distanceToNextLayer[i]));
<a name="l01668"></a>01668                 }
<a name="l01669"></a>01669 
<a name="l01670"></a>01670          <span class="comment">//Initialization of diagonal vectors</span>
<a name="l01671"></a>01671 
<a name="l01672"></a>01672          <span class="keywordflow">for</span>(i=0; i&lt;numberOfTotalLayers; ++i)
<a name="l01673"></a>01673             <span class="keywordflow">if</span> (frostChange[i] || firstTime)
<a name="l01674"></a>01674             {
<a name="l01675"></a>01675                UpperVector[i]=-Kb[i]*DistNextLayerInv[i]-Kc[i];                                                 <span class="comment">//c</span>
<a name="l01676"></a>01676                MidVector[i]=Ka[i]+Kb[i]*(DistNextLayerInv[i]+DistPreviousLayerInv[i]); <span class="comment">//b</span>
<a name="l01677"></a>01677                LowerVector[i]= -Kb[i]*DistPreviousLayerInv[i]+Kc[i];                   <span class="comment">//a</span>
<a name="l01678"></a>01678                LowerVector[0]= 0.0;
<a name="l01679"></a>01679                UpperVector[numberOfTotalLayers-1]=0.0;
<a name="l01680"></a>01680                <span class="keywordflow">if</span> (MidVector[0]==0.0)
<a name="l01681"></a>01681                 <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateFinDiffTemperature - Error 1 in tridag vectors&quot;</span>);
<a name="l01682"></a>01682             }
<a name="l01683"></a>01683 
<a name="l01684"></a>01684 
<a name="l01685"></a>01685                 <span class="comment">//Initialization of vector with old values</span>
<a name="l01686"></a>01686 
<a name="l01687"></a>01687                         i=0;
<a name="l01688"></a>01688          TOldArray[i]=Ka[i]*TOld[i]
<a name="l01689"></a>01689             +Kb[i]*((TOld[i+1]-TOld[i])*DistNextLayerInv[i]-(TOld[i]-TUB)*DistPreviousLayerInv[i])
<a name="l01690"></a>01690             +Kc[i]*(TOld[i+1]-TUB)-B[i]-(-Kb[i]*DistPreviousLayerInv[i]+Kc[i])*TUB;
<a name="l01691"></a>01691 
<a name="l01692"></a>01692         <span class="keywordflow">for</span> (i=1;i&lt;numberOfTotalLayers-1;++i)
<a name="l01693"></a>01693                 TOldArray[i]=Ka[i]*TOld[i]
<a name="l01694"></a>01694                 +Kb[i]*((TOld[i+1]-TOld[i])*DistNextLayerInv[i]-(TOld[i]-TOld[i-1])*DistPreviousLayerInv[i])
<a name="l01695"></a>01695                +Kc[i]*(TOld[i+1]-TOld[i-1])-B[i];
<a name="l01696"></a>01696 
<a name="l01697"></a>01697          TOldArray[numberOfTotalLayers-1]=Ka[numberOfTotalLayers-1]*TOld[numberOfTotalLayers-1]
<a name="l01698"></a>01698                                                                                                 +Kb[numberOfTotalLayers-1]*((TLB-TOld[numberOfTotalLayers-1])*DistNextLayerInv[numberOfTotalLayers-1]-(TOld[numberOfTotalLayers-1]-TOld[numberOfTotalLayers-2])*DistPreviousLayerInv[numberOfTotalLayers-1])
<a name="l01699"></a>01699                                           +Kc[numberOfTotalLayers-1]*(TLB-TOld[numberOfTotalLayers-2])-B[numberOfTotalLayers-1]+(Kb[numberOfTotalLayers-1]*DistNextLayerInv[numberOfTotalLayers-1]+Kc[numberOfTotalLayers-1])*TLB;
<a name="l01700"></a>01700 
<a name="l01701"></a>01701          <span class="comment">//Solve with the double sweep method (function tridag)</span>
<a name="l01702"></a>01702          <a class="code" href="classsoil_profile.html#a97afe4fe7935e3f3fa732f8fe20f6730">Tridag</a>(LowerVector, MidVector, UpperVector, TOldArray, TNew, numberOfTotalLayers);
<a name="l01703"></a>01703 
<a name="l01704"></a>01704          <span class="comment">//update IceContent</span>
<a name="l01705"></a>01705                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;numberOfTotalLayers;i++)
<a name="l01706"></a>01706                 {
<a name="l01707"></a>01707             currentLayer = soilLayerArray[i];
<a name="l01708"></a>01708                <span class="comment">// is there freezing or thawing</span>
<a name="l01709"></a>01709             <span class="keywordflow">if</span> (((TNew[i] &lt; 0.0) &amp;&amp; (currentLayer-&gt;<a class="code" href="classsoil_layer.html#ac3ebf6c7d7f1cb21dff528dfb33cf28d">GetIce</a>()&lt;currentLayer-&gt;<a class="code" href="classsoil_layer.html#af01077dc70989747d1f48ba46bb0556c">GetTotalWater</a>())) || <span class="comment">//freezing</span>
<a name="l01710"></a>01710                   ((TNew[i] &gt; 0.0) &amp;&amp; (currentLayer-&gt;<a class="code" href="classsoil_layer.html#ac3ebf6c7d7f1cb21dff528dfb33cf28d">GetIce</a>()&gt;0.0)))    <span class="comment">//thawing</span>
<a name="l01711"></a>01711             {
<a name="l01712"></a>01712                 <span class="keywordtype">double</span> TimeDerivTemp=(TNew[i]-TOld[i])/deltaTime;
<a name="l01713"></a>01713                <span class="keywordtype">double</span> TimeDerivIce = <a class="code" href="soil_layer_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">WaterDensity</a>/<a class="code" href="soil_profile_8cpp.html#a9b7cb6558bb43062b69e5ff4633ab65e">IceDensity</a>*(-1.0/<a class="code" href="soil_layer_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">WaterDensity</a>*waterFluxSlope[i]-
<a name="l01714"></a>01714                        (<a class="code" href="soil_profile_8cpp.html#a2b1af553057bae6c283762156c7f5469">specCapacity</a>*SpecWaterCapacity[i]/273.0*TimeDerivTemp));
<a name="l01715"></a>01715                moreFrozen[i] =  deltaTime*TimeDerivIce*currentLayer-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>();     <span class="comment">//in mm</span>
<a name="l01716"></a>01716                <span class="keywordflow">if</span> (moreFrozen[i]+ currentLayer-&gt;<a class="code" href="classsoil_layer.html#ac3ebf6c7d7f1cb21dff528dfb33cf28d">GetIce</a>() &gt; currentLayer-&gt;<a class="code" href="classsoil_layer.html#af01077dc70989747d1f48ba46bb0556c">GetTotalWater</a>())      <span class="comment">//frozen water exceeds water</span>
<a name="l01717"></a>01717                {
<a name="l01718"></a>01718                 TNew[i]=-0.001;
<a name="l01719"></a>01719                   moreFrozen[i]=currentLayer-&gt;<a class="code" href="classsoil_layer.html#af01077dc70989747d1f48ba46bb0556c">GetTotalWater</a>()-currentLayer-&gt;<a class="code" href="classsoil_layer.html#ac3ebf6c7d7f1cb21dff528dfb33cf28d">GetIce</a>();
<a name="l01720"></a>01720                }
<a name="l01721"></a>01721                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (moreFrozen[i]+ currentLayer-&gt;<a class="code" href="classsoil_layer.html#ac3ebf6c7d7f1cb21dff528dfb33cf28d">GetIce</a>()&lt;0.0)                             <span class="comment">//frozen water negative</span>
<a name="l01722"></a>01722                {
<a name="l01723"></a>01723                 TNew[i]=0.001;
<a name="l01724"></a>01724                   moreFrozen[i]= -currentLayer-&gt;<a class="code" href="classsoil_layer.html#ac3ebf6c7d7f1cb21dff528dfb33cf28d">GetIce</a>();
<a name="l01725"></a>01725                }
<a name="l01726"></a>01726                <span class="keywordtype">double</span> ice=currentLayer-&gt;<a class="code" href="classsoil_layer.html#ac3ebf6c7d7f1cb21dff528dfb33cf28d">GetIce</a>();
<a name="l01727"></a>01727                currentLayer-&gt;<a class="code" href="classsoil_layer.html#a1f943c69c9e19526aa5e7e8ef11503fa">SetIceContent</a>(max(0.0,min(currentLayer-&gt;<a class="code" href="classsoil_layer.html#af01077dc70989747d1f48ba46bb0556c">GetTotalWater</a>(),ice+ moreFrozen[i])));
<a name="l01728"></a>01728 
<a name="l01729"></a>01729             }
<a name="l01730"></a>01730             <span class="keywordflow">else</span>
<a name="l01731"></a>01731                 moreFrozen[i]=0.0;
<a name="l01732"></a>01732             <span class="keywordflow">if</span> (TNew[i]&gt;50)
<a name="l01733"></a>01733                <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateFinDiffTemperature - soil layer temperature above realistic temperature&quot;</span>);
<a name="l01734"></a>01734             <span class="keywordflow">if</span> (TNew[i]&lt;-50)
<a name="l01735"></a>01735                 <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateFinDiffTemperature - soil layer temperature below realistic value&quot;</span>);
<a name="l01736"></a>01736          }
<a name="l01737"></a>01737          currentTime += deltaTime;
<a name="l01738"></a>01738          firstTime=<span class="keyword">false</span>;
<a name="l01739"></a>01739         }
<a name="l01740"></a>01740 
<a name="l01741"></a>01741       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;numberOfTotalLayers;i++)
<a name="l01742"></a>01742          temperature[i]=TNew[i];
<a name="l01743"></a>01743 
<a name="l01744"></a>01744       <span class="comment">//check if the temperature is witin realistic boundaries</span>
<a name="l01745"></a>01745       <span class="keywordtype">int</span> month=<a class="code" href="bstime_8h.html#ac0dc3834220ee5ae84c115e146194d75">theTime</a>.<a class="code" href="classbs_time.html#a777a59c97951688c4b2a67c4b0bca16e">GetMonth</a>();
<a name="l01746"></a>01746       <span class="keywordtype">int</span> year=<a class="code" href="bstime_8h.html#ac0dc3834220ee5ae84c115e146194d75">theTime</a>.<a class="code" href="classbs_time.html#afcb5953580c085bce20eb33a4b21e155">GetYear</a>();
<a name="l01747"></a>01747       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;numberOfTotalLayers;i++)
<a name="l01748"></a>01748       {
<a name="l01749"></a>01749          <span class="keywordflow">if</span> (i&gt;9 &amp;&amp; i&lt;19 &amp;&amp; temperature[i]&lt;minTemp[month-1] &amp;&amp; year!=lastErrorYear)
<a name="l01750"></a>01750          {
<a name="l01751"></a>01751             lastErrorYear=year;
<a name="l01752"></a>01752             cout &lt;&lt; <span class="stringliteral">&quot;Layer no &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot; temperature is &quot;</span> &lt;&lt; temperature[i];
<a name="l01753"></a>01753             <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateFinDiffTemperature - soil layer temperature below expert opinion monthly threshold&quot;</span>);
<a name="l01754"></a>01754          }
<a name="l01755"></a>01755          <span class="keywordflow">if</span> (temperature[i]&gt;100)
<a name="l01756"></a>01756             <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::UpdateFinDiffTemperature - soil layer temperature above boiling point&quot;</span>);
<a name="l01757"></a>01757          <span class="keywordflow">if</span> (temperature[i]&gt;50)
<a name="l01758"></a>01758             <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilProfile::UpdateFinDiffTemperature - soil layer temperature above realistic temperature&quot;</span>);
<a name="l01759"></a>01759          <span class="keywordflow">if</span> (temperature[i]&lt;-50)
<a name="l01760"></a>01760             <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::UpdateFinDiffTemperature - soil layer temperature below possible value&quot;</span>);
<a name="l01761"></a>01761          soilLayerArray[i]-&gt;<a class="code" href="classsoil_layer.html#a6b3b3438c29df1bf4037d00875b676e7">PutTemperature</a>(temperature[i]);
<a name="l01762"></a>01762       }
<a name="l01763"></a>01763       <span class="keywordflow">if</span> (<a class="code" href="control_parameters_8h.html#a5f2fa76e64eab2ae2d13f038d69004aa">theControlParameters</a>-&gt;<a class="code" href="classcontrol_parameters.html#a5222f361b4bdd1ce711b9b930b7bef56">GetWriteSoilTemperature</a>())
<a name="l01764"></a>01764       {
<a name="l01765"></a>01765         SoilTempFile &lt;&lt; <a class="code" href="bstime_8h.html#ac0dc3834220ee5ae84c115e146194d75">theTime</a>;
<a name="l01766"></a>01766          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;numberOfTotalLayers;i++)
<a name="l01767"></a>01767            SoilTempFile &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> &lt;&lt; temperature[i];
<a name="l01768"></a>01768          SoilTempFile &lt;&lt; endl;
<a name="l01769"></a>01769       }
<a name="l01770"></a>01770    }
<a name="l01771"></a>01771 
<a name="l01772"></a>01772 }
<a name="l01773"></a>01773 
<a name="l01774"></a>01774 <span class="comment">/****************************************************************************\</span>
<a name="l01775"></a>01775 <span class="comment"> Terminates the execution with an error message</span>
<a name="l01776"></a>01776 <span class="comment">\****************************************************************************/</span>
<a name="l01777"></a><a class="code" href="classsoil_profile.html#a63e938ce16657be6fbff5eb6a6b63791">01777</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#a63e938ce16657be6fbff5eb6a6b63791">soilProfile::Terminate</a>(<span class="keywordtype">string</span> c)
<a name="l01778"></a>01778 {
<a name="l01779"></a>01779 
<a name="l01780"></a>01780       cout &lt;&lt; endl &lt;&lt; c &lt;&lt; endl;
<a name="l01781"></a>01781    cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;Program terminated. Press any key.&quot;</span> &lt;&lt; endl;
<a name="l01782"></a>01782 <span class="preprocessor">#ifndef __BCplusplus__</span>
<a name="l01783"></a>01783 <span class="preprocessor"></span>        getchar();
<a name="l01784"></a>01784 <span class="preprocessor">#else</span>
<a name="l01785"></a>01785 <span class="preprocessor"></span>   <span class="keywordtype">char</span> ch=getch();
<a name="l01786"></a>01786 <span class="preprocessor">#endif</span>
<a name="l01787"></a>01787 <span class="preprocessor"></span>   exit(99);
<a name="l01788"></a>01788 }
<a name="l01789"></a>01789 
<a name="l01790"></a>01790 <span class="comment">/****************************************************************************\</span>
<a name="l01791"></a>01791 <span class="comment">Solves for a vector u[0..n-1] the tridiagonal linear set. The input vectors</span>
<a name="l01792"></a>01792 <span class="comment">a,b,c and r are unmodified, and u contains the result</span>
<a name="l01793"></a>01793 <span class="comment">Slightly modified after Numerical Recipies in C (Press, 1992), main modification</span>
<a name="l01794"></a>01794 <span class="comment">is shift from [1..n] to [0..n-1], in concordance with mainstream C++ conventions.</span>
<a name="l01795"></a>01795 <span class="comment">Used to calculate the Finite difference solution for temperature.</span>
<a name="l01796"></a>01796 <span class="comment">\****************************************************************************/</span>
<a name="l01797"></a><a class="code" href="classsoil_profile.html#a97afe4fe7935e3f3fa732f8fe20f6730">01797</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#a97afe4fe7935e3f3fa732f8fe20f6730">soilProfile::Tridag</a>(<span class="keywordtype">double</span> a[], <span class="keywordtype">double</span> b[], <span class="keywordtype">double</span> c[], <span class="keywordtype">double</span> r[], <span class="keywordtype">double</span> u[], <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> n)
<a name="l01798"></a>01798 {
<a name="l01799"></a>01799    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> j;
<a name="l01800"></a>01800    <span class="keywordtype">double</span> bet, *gam;
<a name="l01801"></a>01801    gam=<span class="keyword">new</span> <span class="keywordtype">double</span> [n]; <span class="comment">//</span>
<a name="l01802"></a>01802    <span class="keywordflow">if</span> (0==b[0])
<a name="l01803"></a>01803       <a class="code" href="classsoil_profile.html#a63e938ce16657be6fbff5eb6a6b63791">Terminate</a>(<span class="stringliteral">&quot;Error 1 in function Tridag&quot;</span>);
<a name="l01804"></a>01804    bet=b[0];
<a name="l01805"></a>01805    u[0]=r[0]/bet;
<a name="l01806"></a>01806    <span class="keywordflow">for</span> (j=1;j&lt;n;j++)
<a name="l01807"></a>01807    {  <span class="comment">// Decomposition and forward substitution</span>
<a name="l01808"></a>01808       gam[j]=c[j-1]/bet;      <span class="comment">// e[j]</span>
<a name="l01809"></a>01809       bet=b[j]-a[j]*gam[j];   <span class="comment">// g[j]</span>
<a name="l01810"></a>01810       <span class="keywordflow">if</span> (0==bet)
<a name="l01811"></a>01811          <a class="code" href="classsoil_profile.html#a63e938ce16657be6fbff5eb6a6b63791">Terminate</a>(<span class="stringliteral">&quot;Error 2 in function Tridag&quot;</span>);
<a name="l01812"></a>01812       u[j]=(r[j]-a[j]*u[j-1])/bet;
<a name="l01813"></a>01813    }
<a name="l01814"></a>01814    <span class="keywordflow">for</span> (j=n-2;j+1&gt;0;j--)
<a name="l01815"></a>01815       u[j]-=gam[j+1]*u[j+1]; <span class="comment">// Backsubstitution</span>
<a name="l01816"></a>01816    <span class="keyword">delete</span>[] gam;
<a name="l01817"></a>01817 }
<a name="l01818"></a>01818 
<a name="l01819"></a>01819 <span class="comment">/****************************************************************************\</span>
<a name="l01820"></a>01820 <span class="comment">Updates organic matter pools in profile.</span>
<a name="l01821"></a>01821 <span class="comment">\****************************************************************************/</span>
<a name="l01822"></a><a class="code" href="classsoil_profile.html#a9928340939c7a139c0e708be2e7d4ca0">01822</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a9928340939c7a139c0e708be2e7d4ca0">soilProfile::UpdateOrganicMatter</a>()
<a name="l01823"></a>01823 {
<a name="l01824"></a>01824    <span class="keywordtype">double</span> CO2Evolution = 0.0;
<a name="l01825"></a>01825    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01826"></a>01826    <span class="keywordflow">while</span> (current != NULL)
<a name="l01827"></a>01827    {
<a name="l01828"></a>01828       CO2Evolution += current-&gt;<a class="code" href="classsoil_layer.html#a3499e118eccf838b5d9c7784cfbecee8">UpdateOrganicMatter</a>();
<a name="l01829"></a>01829       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01830"></a>01830    }
<a name="l01831"></a>01831    <span class="keywordflow">return</span> CO2Evolution;
<a name="l01832"></a>01832 }
<a name="l01833"></a>01833 
<a name="l01834"></a>01834 <span class="comment">/****************************************************************************\</span>
<a name="l01835"></a>01835 <span class="comment">Performs nitrification and updates contents of ammonia and nitrate.</span>
<a name="l01836"></a>01836 <span class="comment">   returns       - Nitrification [g N/m�/d]</span>
<a name="l01837"></a>01837 <span class="comment">\****************************************************************************/</span>
<a name="l01838"></a><a class="code" href="classsoil_profile.html#a4a0d204ede21c28dc81b117813781ee1">01838</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#a4a0d204ede21c28dc81b117813781ee1">soilProfile::UpdateNitrification</a>()
<a name="l01839"></a>01839 {
<a name="l01840"></a>01840    <a class="code" href="classnitrogen.html">nitrogen</a> sum;
<a name="l01841"></a>01841    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01842"></a>01842    <span class="keywordflow">while</span> (current!=NULL)
<a name="l01843"></a>01843    {
<a name="l01844"></a>01844         sum = sum + current-&gt;<a class="code" href="classsoil_layer.html#a05e9eb7bc23f2ca60d2358eae2e3638c">UpdateNitrification</a>();
<a name="l01845"></a>01845         current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01846"></a>01846    }
<a name="l01847"></a>01847    <span class="keywordflow">return</span> sum;
<a name="l01848"></a>01848 }
<a name="l01849"></a>01849 
<a name="l01850"></a>01850 <span class="comment">/****************************************************************************\</span>
<a name="l01851"></a>01851 <span class="comment">Performs denitrification and updates contents of nitrate.</span>
<a name="l01852"></a>01852 <span class="comment">//  returns       - Nitrification [g N/m�/d]</span>
<a name="l01853"></a>01853 <span class="comment">\****************************************************************************/</span>
<a name="l01854"></a><a class="code" href="classsoil_profile.html#abd4b5dd658a93bc311fcd9a1233eaa1f">01854</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#abd4b5dd658a93bc311fcd9a1233eaa1f">soilProfile::UpdateDenitrification</a>(<span class="keywordtype">double</span> TotalCO2Emission)
<a name="l01855"></a>01855 {
<a name="l01856"></a>01856    <a class="code" href="classnitrogen.html">nitrogen</a> sum;
<a name="l01857"></a>01857    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01858"></a>01858    <span class="keywordflow">while</span> (current!=NULL)
<a name="l01859"></a>01859    {
<a name="l01860"></a>01860       current-&gt;<a class="code" href="classsoil_layer.html#ae923fdabe8dc5e40195e3cf39b9ef569">UpdateN2OFromDenitrification</a>(TotalCO2Emission);
<a name="l01861"></a>01861       sum = sum + current-&gt;<a class="code" href="classsoil_layer.html#a994f47ea2ca0d8a0d98515bb83600cf2">UpdateN2Production</a>();
<a name="l01862"></a>01862       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01863"></a>01863    }
<a name="l01864"></a>01864    <span class="keywordflow">return</span> sum;
<a name="l01865"></a>01865 }
<a name="l01866"></a>01866 
<a name="l01867"></a>01867 <span class="comment">/****************************************************************************\</span>
<a name="l01868"></a>01868 <span class="comment">\****************************************************************************/</span>
<a name="l01869"></a><a class="code" href="classsoil_profile.html#ae5719e1e82452eefb240900a9e62e27d">01869</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#ae08f75a5b3b0af43054c75f7c6b0867e">soilProfile::GetAmmonium</a>(<span class="keywordtype">double</span> startDep,<span class="keywordtype">double</span> thick)
<a name="l01870"></a>01870 {
<a name="l01871"></a>01871    <a class="code" href="classnitrogen.html">nitrogen</a> Content;
<a name="l01872"></a>01872    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01873"></a>01873    <span class="keywordflow">while</span> (current != NULL)
<a name="l01874"></a>01874    {
<a name="l01875"></a>01875       Content = Content + current-&gt;<a class="code" href="classsoil_layer.html#a6c55ade0e8450447467b46f13c169309">GetAmmonium</a>(startDep,thick);
<a name="l01876"></a>01876       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01877"></a>01877    }
<a name="l01878"></a>01878    <span class="keywordflow">return</span> Content;
<a name="l01879"></a>01879 }
<a name="l01880"></a>01880 
<a name="l01881"></a>01881 <span class="comment">/****************************************************************************\</span>
<a name="l01882"></a>01882 <span class="comment">\****************************************************************************/</span>
<a name="l01883"></a><a class="code" href="classsoil_profile.html#a52af6d32aff7208063bd86a2a8b3c25b">01883</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#a753455cef3dae233090a481b833e25c6">soilProfile::GetNitrate</a>(<span class="keywordtype">double</span> startDep,<span class="keywordtype">double</span> thick)
<a name="l01884"></a>01884 {
<a name="l01885"></a>01885    <a class="code" href="classnitrogen.html">nitrogen</a> Content;
<a name="l01886"></a>01886    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01887"></a>01887    <span class="keywordflow">while</span> (current != NULL)
<a name="l01888"></a>01888    {
<a name="l01889"></a>01889       Content = Content + current-&gt;<a class="code" href="classsoil_layer.html#a35ebeffcc6514687cac1cb50dea2cad1">GetNitrate</a>(startDep,thick);
<a name="l01890"></a>01890       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01891"></a>01891    }
<a name="l01892"></a>01892    <span class="keywordflow">if</span> (Content.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1e6)
<a name="l01893"></a>01893         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::GetNitrate - returns negative value&quot;</span>);
<a name="l01894"></a>01894    <span class="keywordflow">return</span> Content;
<a name="l01895"></a>01895 }
<a name="l01896"></a>01896 <span class="comment">/****************************************************************************\</span>
<a name="l01897"></a>01897 <span class="comment">\****************************************************************************/</span>
<a name="l01898"></a><a class="code" href="classsoil_profile.html#a1a70449a5466f3a625a9b393ee18112f">01898</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#a1a70449a5466f3a625a9b393ee18112f">soilProfile::GetN2OFromNitrification</a>()
<a name="l01899"></a>01899 {
<a name="l01900"></a>01900    <a class="code" href="classnitrogen.html">nitrogen</a> Content;
<a name="l01901"></a>01901    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01902"></a>01902    <span class="keywordflow">while</span> (current != NULL)
<a name="l01903"></a>01903    {
<a name="l01904"></a>01904       Content = Content + current-&gt;<a class="code" href="classsoil_layer.html#a455eb10fae87a69aeb706a55b0a934c8">GetN2OFromNitrification</a>();
<a name="l01905"></a>01905       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01906"></a>01906    }
<a name="l01907"></a>01907    <span class="keywordflow">return</span> Content;
<a name="l01908"></a>01908 }
<a name="l01909"></a>01909 <span class="comment">/****************************************************************************\</span>
<a name="l01910"></a>01910 <span class="comment">\****************************************************************************/</span>
<a name="l01911"></a><a class="code" href="classsoil_profile.html#a9be3f4ec8fe381095d2f9a15f1b7d77d">01911</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#a9be3f4ec8fe381095d2f9a15f1b7d77d">soilProfile::GetN2OFromDenitrification</a>()
<a name="l01912"></a>01912 {
<a name="l01913"></a>01913    <a class="code" href="classnitrogen.html">nitrogen</a> Content;
<a name="l01914"></a>01914    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01915"></a>01915    <span class="keywordflow">while</span> (current != NULL)
<a name="l01916"></a>01916    {
<a name="l01917"></a>01917       Content = Content + current-&gt;<a class="code" href="classsoil_layer.html#a75f44f1c6c3825b28dcdfe4653790618">GetN2OFromDenitrification</a>();
<a name="l01918"></a>01918       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01919"></a>01919    }
<a name="l01920"></a>01920    <span class="keywordflow">return</span> Content;
<a name="l01921"></a>01921 }
<a name="l01922"></a>01922 <span class="comment">/****************************************************************************\</span>
<a name="l01923"></a>01923 <span class="comment">\****************************************************************************/</span>
<a name="l01924"></a><a class="code" href="classsoil_profile.html#a51f252742a43f831953d0ea34e273530">01924</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a51f252742a43f831953d0ea34e273530">soilProfile::GetChloride</a>(<span class="keywordtype">double</span> startDep,<span class="keywordtype">double</span> thick)
<a name="l01925"></a>01925 {
<a name="l01926"></a>01926    <span class="keywordtype">double</span> Content = 0.0;
<a name="l01927"></a>01927    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01928"></a>01928    <span class="keywordflow">while</span> (current != NULL)
<a name="l01929"></a>01929    {
<a name="l01930"></a>01930       Content += current-&gt;<a class="code" href="classsoil_layer.html#ad3683d88ec613da7fd985169287c1553">GetChloride</a>(startDep,thick);
<a name="l01931"></a>01931       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01932"></a>01932    }
<a name="l01933"></a>01933    <span class="keywordflow">if</span> (Content&lt;-1e6)
<a name="l01934"></a>01934         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::GetChloride - returns negative value&quot;</span>);
<a name="l01935"></a>01935    <span class="keywordflow">return</span> Content;
<a name="l01936"></a>01936 }
<a name="l01937"></a>01937 
<a name="l01938"></a>01938 <span class="comment">/****************************************************************************\</span>
<a name="l01939"></a>01939 <span class="comment">\****************************************************************************/</span>
<a name="l01940"></a><a class="code" href="classsoil_profile.html#ae08f75a5b3b0af43054c75f7c6b0867e">01940</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#ae08f75a5b3b0af43054c75f7c6b0867e">soilProfile::GetAmmonium</a>()
<a name="l01941"></a>01941 {
<a name="l01942"></a>01942    <a class="code" href="classnitrogen.html">nitrogen</a> Content;
<a name="l01943"></a>01943    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01944"></a>01944    <span class="keywordflow">while</span> (current != NULL)
<a name="l01945"></a>01945    {
<a name="l01946"></a>01946       Content = Content + current-&gt;<a class="code" href="classsoil_layer.html#a6c55ade0e8450447467b46f13c169309">GetAmmonium</a>();
<a name="l01947"></a>01947       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01948"></a>01948    }
<a name="l01949"></a>01949    <span class="keywordflow">if</span> (Content.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;0.0)
<a name="l01950"></a>01950         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::GetAmmonium - returns negative value&quot;</span>);
<a name="l01951"></a>01951    <span class="keywordflow">return</span> Content;
<a name="l01952"></a>01952 }
<a name="l01953"></a>01953 
<a name="l01954"></a>01954 <span class="comment">/****************************************************************************\</span>
<a name="l01955"></a>01955 <span class="comment">\****************************************************************************/</span>
<a name="l01956"></a><a class="code" href="classsoil_profile.html#a753455cef3dae233090a481b833e25c6">01956</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#a753455cef3dae233090a481b833e25c6">soilProfile::GetNitrate</a>()
<a name="l01957"></a>01957 {
<a name="l01958"></a>01958    <a class="code" href="classnitrogen.html">nitrogen</a> Content;
<a name="l01959"></a>01959    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01960"></a>01960    <span class="keywordflow">while</span> (current != NULL)
<a name="l01961"></a>01961    {
<a name="l01962"></a>01962       Content = Content + current-&gt;<a class="code" href="classsoil_layer.html#a35ebeffcc6514687cac1cb50dea2cad1">GetNitrate</a>();
<a name="l01963"></a>01963       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01964"></a>01964    }
<a name="l01965"></a>01965    <span class="keywordflow">return</span> Content;
<a name="l01966"></a>01966 }
<a name="l01967"></a>01967 
<a name="l01968"></a>01968 <span class="comment">/****************************************************************************\</span>
<a name="l01969"></a>01969 <span class="comment">\****************************************************************************/</span>
<a name="l01970"></a><a class="code" href="classsoil_profile.html#a71a258ab02b886dcfe4e495c16490f80">01970</a> <span class="keywordtype">int</span> <a class="code" href="classsoil_profile.html#a71a258ab02b886dcfe4e495c16490f80">soilProfile::GetNumberOfLayers</a>()
<a name="l01971"></a>01971 {
<a name="l01972"></a>01972    <span class="keywordtype">int</span> n = 0;
<a name="l01973"></a>01973    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01974"></a>01974    <span class="keywordflow">while</span> (current != NULL)
<a name="l01975"></a>01975    {
<a name="l01976"></a>01976       n++;
<a name="l01977"></a>01977       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01978"></a>01978    }
<a name="l01979"></a>01979    <span class="keywordflow">return</span> n;
<a name="l01980"></a>01980 }
<a name="l01981"></a>01981 
<a name="l01982"></a>01982 
<a name="l01983"></a>01983 <span class="comment">/****************************************************************************\</span>
<a name="l01984"></a>01984 <span class="comment">\****************************************************************************/</span>
<a name="l01985"></a><a class="code" href="classsoil_profile.html#a062bc6b13eb0debe7a8a8c1e31c53b4e">01985</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a062bc6b13eb0debe7a8a8c1e31c53b4e">soilProfile::GetLayerThickness</a>(<span class="keywordtype">int</span> No)
<a name="l01986"></a>01986 {
<a name="l01987"></a>01987    <span class="keywordtype">int</span> n = 0;
<a name="l01988"></a>01988    <span class="keywordtype">double</span> thick = 0.;
<a name="l01989"></a>01989    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l01990"></a>01990    <span class="keywordflow">while</span> (current != NULL)
<a name="l01991"></a>01991    {
<a name="l01992"></a>01992       <span class="keywordflow">if</span> (n==No) thick = current-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>();
<a name="l01993"></a>01993       n++;
<a name="l01994"></a>01994       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l01995"></a>01995    }
<a name="l01996"></a>01996    <span class="keywordflow">return</span> thick;
<a name="l01997"></a>01997 }
<a name="l01998"></a>01998 
<a name="l01999"></a>01999 <span class="comment">/****************************************************************************\</span>
<a name="l02000"></a>02000 <span class="comment">\****************************************************************************/</span>
<a name="l02001"></a><a class="code" href="classsoil_profile.html#afb39b89d67044da69b0258915c5eed1e">02001</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#afb39b89d67044da69b0258915c5eed1e">soilProfile::GetCarbon</a>()
<a name="l02002"></a>02002 {
<a name="l02003"></a>02003    <span class="keywordtype">double</span> Content = 0;
<a name="l02004"></a>02004    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02005"></a>02005    <span class="keywordflow">while</span> (current != NULL)
<a name="l02006"></a>02006    {
<a name="l02007"></a>02007       Content+=current-&gt;<a class="code" href="classsoil_layer.html#a6fe7e84c83e345c297bc55cae7f36acc">GetCarbon</a>();
<a name="l02008"></a>02008       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02009"></a>02009    }
<a name="l02010"></a>02010    <span class="keywordflow">return</span> Content;
<a name="l02011"></a>02011 }
<a name="l02012"></a>02012 
<a name="l02013"></a>02013 <span class="comment">/****************************************************************************\</span>
<a name="l02014"></a>02014 <span class="comment">\****************************************************************************/</span>
<a name="l02015"></a><a class="code" href="classsoil_profile.html#aee00c88c701f2ef848b9c96a3013e294">02015</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#aee00c88c701f2ef848b9c96a3013e294">soilProfile::GetOrganicNitrogen</a>()
<a name="l02016"></a>02016 {
<a name="l02017"></a>02017    <a class="code" href="classnitrogen.html">nitrogen</a> Content;
<a name="l02018"></a>02018    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02019"></a>02019    <span class="keywordflow">while</span> (current != NULL)
<a name="l02020"></a>02020    {
<a name="l02021"></a>02021       Content = Content + current-&gt;<a class="code" href="classsoil_layer.html#ab59162a095c3cc12c515b5e37f3b650a">GetOrganicNitrogen</a>();
<a name="l02022"></a>02022       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02023"></a>02023    }
<a name="l02024"></a>02024    <span class="keywordflow">if</span> (Content.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;0.0)
<a name="l02025"></a>02025         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::GetOrganicNitrogen - returns negative value&quot;</span>);
<a name="l02026"></a>02026    <span class="keywordflow">return</span> Content;
<a name="l02027"></a>02027 }
<a name="l02028"></a>02028 
<a name="l02029"></a>02029 <span class="comment">/****************************************************************************\</span>
<a name="l02030"></a>02030 <span class="comment">\****************************************************************************/</span>
<a name="l02031"></a><a class="code" href="classsoil_profile.html#a4fc437a3643651526cdba9cb737d81bb">02031</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#aee00c88c701f2ef848b9c96a3013e294">soilProfile::GetOrganicNitrogen</a>(<span class="keywordtype">double</span> startDep, <span class="keywordtype">double</span> thick)
<a name="l02032"></a>02032 {
<a name="l02033"></a>02033    <a class="code" href="classnitrogen.html">nitrogen</a> Content;
<a name="l02034"></a>02034    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02035"></a>02035    <span class="keywordflow">while</span> (current != NULL)
<a name="l02036"></a>02036    {
<a name="l02037"></a>02037       Content = Content + current-&gt;<a class="code" href="classsoil_layer.html#ab59162a095c3cc12c515b5e37f3b650a">GetOrganicNitrogen</a>(startDep,thick);
<a name="l02038"></a>02038       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02039"></a>02039    }
<a name="l02040"></a>02040    <span class="keywordflow">if</span> (Content.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;0.0)
<a name="l02041"></a>02041         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilProfile::GetOrganicNitrogen - returns negative value&quot;</span>);
<a name="l02042"></a>02042  <span class="keywordflow">return</span> Content;
<a name="l02043"></a>02043 }
<a name="l02044"></a>02044 
<a name="l02045"></a>02045 <span class="comment">/****************************************************************************\</span>
<a name="l02046"></a>02046 <span class="comment">\****************************************************************************/</span>
<a name="l02047"></a><a class="code" href="classsoil_profile.html#ac3acd0216f995cbda5b47d393c5d6e98">02047</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#ac3acd0216f995cbda5b47d393c5d6e98">soilProfile::GetOrganicCarbon</a>(<span class="keywordtype">double</span> startDep, <span class="keywordtype">double</span> thick)
<a name="l02048"></a>02048 {
<a name="l02049"></a>02049  <span class="keywordtype">double</span> Content = 0;
<a name="l02050"></a>02050  <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02051"></a>02051  <span class="keywordflow">while</span> (current != NULL)
<a name="l02052"></a>02052  {
<a name="l02053"></a>02053   Content+=current-&gt;<a class="code" href="classsoil_layer.html#a5ee886837c6c59aa88ff44633bbd5c4b">GetOrganicCarbon</a>(startDep,thick);
<a name="l02054"></a>02054   current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02055"></a>02055  }
<a name="l02056"></a>02056  <span class="keywordflow">return</span> Content;
<a name="l02057"></a>02057 }
<a name="l02058"></a>02058 
<a name="l02059"></a>02059 <span class="comment">/****************************************************************************\</span>
<a name="l02060"></a>02060 <span class="comment">\****************************************************************************/</span>
<a name="l02061"></a><a class="code" href="classsoil_profile.html#a3f6845a54d38bc96d3c746c3e1875415">02061</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a3f6845a54d38bc96d3c746c3e1875415">soilProfile::GetSoilMass</a>(<span class="keywordtype">double</span> startDep, <span class="keywordtype">double</span> thick)
<a name="l02062"></a>02062 {
<a name="l02063"></a>02063  <span class="keywordtype">double</span> Content = 0;
<a name="l02064"></a>02064  <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02065"></a>02065  <span class="keywordflow">while</span> (current != NULL)
<a name="l02066"></a>02066  {
<a name="l02067"></a>02067   Content+=current-&gt;<a class="code" href="classsoil_layer.html#a4b942365583f2cb8356cdef3cebe8dde">GetSoilMass</a>(startDep,thick);
<a name="l02068"></a>02068   current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02069"></a>02069  }
<a name="l02070"></a>02070  <span class="keywordflow">return</span> Content;
<a name="l02071"></a>02071 }
<a name="l02072"></a>02072 
<a name="l02073"></a>02073 <span class="comment">/****************************************************************************\</span>
<a name="l02074"></a>02074 <span class="comment">\****************************************************************************/</span>
<a name="l02075"></a><a class="code" href="classsoil_profile.html#a27959c28ab4031f581b0e17142a45b7f">02075</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a27959c28ab4031f581b0e17142a45b7f">soilProfile::GetClayContent</a>(<span class="keywordtype">double</span> startdepth, <span class="keywordtype">double</span> thick)
<a name="l02076"></a>02076 {
<a name="l02077"></a>02077    <span class="keywordtype">double</span> Content=0.0;
<a name="l02078"></a>02078    <span class="keywordtype">double</span> TotalWeight=0.0;
<a name="l02079"></a>02079    <a class="code" href="classsoil_layer.html">soilLayer</a> * current=first;
<a name="l02080"></a>02080    <span class="keywordflow">while</span> (current != NULL)
<a name="l02081"></a>02081    {
<a name="l02082"></a>02082       <span class="keywordtype">double</span> top=current-&gt;<a class="code" href="classsoil_layer.html#a067dc1539ac09a475b678ef6d67b2812">GetStartDepth</a>();
<a name="l02083"></a>02083       <span class="keywordtype">double</span> th=current-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>();
<a name="l02084"></a>02084       <span class="keywordflow">if</span> ((top+th)&gt;startdepth &amp;&amp; top&lt;(startdepth+thick)) <span class="comment">// Test if within range</span>
<a name="l02085"></a>02085       {
<a name="l02086"></a>02086       <span class="keywordtype">double</span> slice=th;
<a name="l02087"></a>02087       <span class="keywordflow">if</span> (top&lt;startdepth)
<a name="l02088"></a>02088         slice=max(0.0,top+th-startdepth);
<a name="l02089"></a>02089       <span class="keywordflow">if</span> ((top+th)&gt;(startdepth+thick))
<a name="l02090"></a>02090         slice=max(0.0,startdepth+thick-top);
<a name="l02091"></a>02091       TotalWeight+=slice*current-&gt;<a class="code" href="classsoil_layer.html#a208a49fb1c6c738e50e5070682031a0c">GetDryBulkDensity</a>();
<a name="l02092"></a>02092       Content+=slice*current-&gt;<a class="code" href="classsoil_layer.html#a208a49fb1c6c738e50e5070682031a0c">GetDryBulkDensity</a>()*current-&gt;<a class="code" href="classsoil_layer.html#a75861976e9ef03938056de1307b11711">GetClayContent</a>();
<a name="l02093"></a>02093       }
<a name="l02094"></a>02094       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02095"></a>02095    }
<a name="l02096"></a>02096    Content=Content/TotalWeight;
<a name="l02097"></a>02097    <span class="keywordflow">return</span> Content;
<a name="l02098"></a>02098 }
<a name="l02099"></a>02099 
<a name="l02100"></a>02100 
<a name="l02101"></a>02101 <span class="comment">/****************************************************************************\</span>
<a name="l02102"></a>02102 <span class="comment">\****************************************************************************/</span>
<a name="l02103"></a><a class="code" href="classsoil_profile.html#a46a43c1164e3fb8bbed604653f908561">02103</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_profile.html#a46a43c1164e3fb8bbed604653f908561">soilProfile::GetPoolCarbon</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * Name,<span class="keywordtype">double</span> startDep,<span class="keywordtype">double</span> thick)
<a name="l02104"></a>02104 {
<a name="l02105"></a>02105  <span class="keywordtype">double</span> Content = 0;
<a name="l02106"></a>02106  <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02107"></a>02107  <span class="keywordflow">while</span> (current != NULL)
<a name="l02108"></a>02108  {
<a name="l02109"></a>02109   Content+=current-&gt;<a class="code" href="classsoil_layer.html#a80dfe52e3c2b3a2698f65658d9dd6c5e">GetPoolCarbon</a>(Name,startDep,thick);
<a name="l02110"></a>02110   current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02111"></a>02111  }
<a name="l02112"></a>02112  <span class="keywordflow">return</span> Content;
<a name="l02113"></a>02113 }
<a name="l02114"></a>02114 
<a name="l02115"></a>02115 <span class="comment">/****************************************************************************\</span>
<a name="l02116"></a>02116 <span class="comment">\****************************************************************************/</span>
<a name="l02117"></a><a class="code" href="classsoil_profile.html#a7cde7a4168ab9a8188fb4f6f18d79388">02117</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#a7cde7a4168ab9a8188fb4f6f18d79388">soilProfile::GetPoolNitrogen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * Name)
<a name="l02118"></a>02118 {
<a name="l02119"></a>02119    <a class="code" href="classnitrogen.html">nitrogen</a> Content;
<a name="l02120"></a>02120    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02121"></a>02121    <span class="keywordflow">while</span> (current != NULL)
<a name="l02122"></a>02122    {
<a name="l02123"></a>02123       Content = Content + current-&gt;<a class="code" href="classsoil_layer.html#ae96a8b15fed4200fee1a8001599e3c8d">GetPoolNitrogen</a>(Name);
<a name="l02124"></a>02124       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02125"></a>02125    }
<a name="l02126"></a>02126    <span class="keywordflow">return</span> Content;
<a name="l02127"></a>02127 }
<a name="l02128"></a>02128 
<a name="l02129"></a>02129 <span class="comment">/****************************************************************************\</span>
<a name="l02130"></a>02130 <span class="comment">\****************************************************************************/</span>
<a name="l02131"></a><a class="code" href="classsoil_profile.html#a928dcc3f93130bf5bff194453a36d4f8">02131</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#a7cde7a4168ab9a8188fb4f6f18d79388">soilProfile::GetPoolNitrogen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * Name,<span class="keywordtype">double</span> startDep,<span class="keywordtype">double</span> thick)
<a name="l02132"></a>02132 {
<a name="l02133"></a>02133    <a class="code" href="classnitrogen.html">nitrogen</a> Content;
<a name="l02134"></a>02134    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02135"></a>02135    <span class="keywordflow">while</span> (current != NULL)
<a name="l02136"></a>02136    {
<a name="l02137"></a>02137       Content = Content + current-&gt;<a class="code" href="classsoil_layer.html#ae96a8b15fed4200fee1a8001599e3c8d">GetPoolNitrogen</a>(Name,startDep,thick);
<a name="l02138"></a>02138       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02139"></a>02139    }
<a name="l02140"></a>02140    <span class="keywordflow">return</span> Content;
<a name="l02141"></a>02141 }
<a name="l02142"></a>02142 <span class="comment">/****************************************************************************\</span>
<a name="l02143"></a>02143 <span class="comment">\****************************************************************************/</span>
<a name="l02144"></a><a class="code" href="classsoil_profile.html#aaed7e24507f4b6af78401c985ab1cc12">02144</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#aaed7e24507f4b6af78401c985ab1cc12">soilProfile::GetTotalNitrogen</a>()
<a name="l02145"></a>02145 {
<a name="l02146"></a>02146    <a class="code" href="classnitrogen.html">nitrogen</a> TotalN = <a class="code" href="classsoil_profile.html#ae08f75a5b3b0af43054c75f7c6b0867e">GetAmmonium</a>()+<a class="code" href="classsoil_profile.html#a753455cef3dae233090a481b833e25c6">GetNitrate</a>()+<a class="code" href="classsoil_profile.html#aee00c88c701f2ef848b9c96a3013e294">GetOrganicNitrogen</a>();
<a name="l02147"></a>02147         <span class="keywordflow">return</span> TotalN;
<a name="l02148"></a>02148 }
<a name="l02149"></a>02149 <span class="comment">/****************************************************************************\</span>
<a name="l02150"></a>02150 <span class="comment">\****************************************************************************/</span>
<a name="l02151"></a><a class="code" href="classsoil_profile.html#a5714479e1a3ca3d9c0669dbdfedf3b57">02151</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#a5714479e1a3ca3d9c0669dbdfedf3b57">soilProfile::GetAmmoniumLeaching</a>(<span class="keywordtype">double</span> depth)
<a name="l02152"></a>02152 {
<a name="l02153"></a>02153    <a class="code" href="classnitrogen.html">nitrogen</a> N;
<a name="l02154"></a>02154    <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
<a name="l02155"></a>02155    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02156"></a>02156    <span class="keywordflow">while</span> (!found &amp;&amp; current !=NULL)
<a name="l02157"></a>02157    {
<a name="l02158"></a>02158       <span class="keywordflow">if</span> (depth&gt;=current-&gt;<a class="code" href="classsoil_layer.html#a067dc1539ac09a475b678ef6d67b2812">GetStartDepth</a>() &amp;&amp; depth&lt;=current-&gt;<a class="code" href="classsoil_layer.html#a067dc1539ac09a475b678ef6d67b2812">GetStartDepth</a>()+current-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>())
<a name="l02159"></a>02159       {
<a name="l02160"></a>02160               N = current-&gt;<a class="code" href="classsoil_layer.html#add04d61e6c1bb7294341d18070a0373f">GetAmmoniumLeaching</a>();
<a name="l02161"></a>02161          found = <span class="keyword">true</span>;
<a name="l02162"></a>02162       }
<a name="l02163"></a>02163       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02164"></a>02164    }
<a name="l02165"></a>02165    <span class="keywordflow">if</span> (N.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1e15)
<a name="l02166"></a>02166         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;SoilProfile: negative ammonium leaching&quot;</span>);
<a name="l02167"></a>02167    <span class="keywordflow">return</span> N;
<a name="l02168"></a>02168 }
<a name="l02169"></a>02169 <span class="comment">/****************************************************************************\</span>
<a name="l02170"></a>02170 <span class="comment">\****************************************************************************/</span>
<a name="l02171"></a><a class="code" href="classsoil_profile.html#aefe1b8475041b54e5f0a1fd6cdebff2a">02171</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_profile.html#aefe1b8475041b54e5f0a1fd6cdebff2a">soilProfile::GetNitrateLeaching</a>(<span class="keywordtype">double</span> depth)
<a name="l02172"></a>02172 {
<a name="l02173"></a>02173    <a class="code" href="classnitrogen.html">nitrogen</a> N;
<a name="l02174"></a>02174    <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
<a name="l02175"></a>02175    <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02176"></a>02176    <span class="keywordflow">while</span> (!found &amp;&amp; current !=NULL)
<a name="l02177"></a>02177    {
<a name="l02178"></a>02178       <span class="keywordflow">if</span> (depth&gt;=current-&gt;<a class="code" href="classsoil_layer.html#a067dc1539ac09a475b678ef6d67b2812">GetStartDepth</a>() &amp;&amp; depth&lt;=current-&gt;<a class="code" href="classsoil_layer.html#a067dc1539ac09a475b678ef6d67b2812">GetStartDepth</a>()+current-&gt;<a class="code" href="classsoil_layer.html#a2505c534964ced0b3d5a77c9c9ef3424">GetThickness</a>())
<a name="l02179"></a>02179       {
<a name="l02180"></a>02180               N = current-&gt;<a class="code" href="classsoil_layer.html#aa65c1b73e58aa539a36d46d3733ce1b8">GetNitrateLeaching</a>();
<a name="l02181"></a>02181          found = <span class="keyword">true</span>;
<a name="l02182"></a>02182       }
<a name="l02183"></a>02183       current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02184"></a>02184    }
<a name="l02185"></a>02185    <span class="keywordflow">if</span> (N.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1e15)
<a name="l02186"></a>02186         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;SoilProfile: negative nitrate leaching&quot;</span>);
<a name="l02187"></a>02187    <span class="keywordflow">return</span> N;
<a name="l02188"></a>02188 }
<a name="l02189"></a>02189 
<a name="l02190"></a>02190 <span class="comment">/****************************************************************************\</span>
<a name="l02191"></a>02191 <span class="comment">\****************************************************************************/</span>
<a name="l02192"></a><a class="code" href="classsoil_profile.html#a626f77b25f2ebf34e48b46fbc4c27088">02192</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#a626f77b25f2ebf34e48b46fbc4c27088">soilProfile::AddProduct</a>(<span class="keyword">const</span> <a class="code" href="classorganic_product.html">organicProduct</a>&amp; <a class="code" href="classproduct.html">product</a>,
<a name="l02193"></a>02193                                                                           <span class="keywordtype">double</span> * rootLengthList)
<a name="l02194"></a>02194 {
<a name="l02195"></a>02195    <span class="keywordflow">if</span> (rootLengthList!=NULL)     <span class="comment">// Perform only if a root distribution is defined</span>
<a name="l02196"></a>02196    {
<a name="l02197"></a>02197       <span class="keywordtype">int</span> n = <a class="code" href="classsoil_profile.html#a71a258ab02b886dcfe4e495c16490f80">GetNumberOfLayers</a>();
<a name="l02198"></a>02198       <span class="keywordtype">double</span> * L = rootLengthList;
<a name="l02199"></a>02199       <span class="keywordtype">double</span> sumL = 0.;
<a name="l02200"></a>02200       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;n; i++)
<a name="l02201"></a>02201          sumL += *(L++);
<a name="l02202"></a>02202       <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02203"></a>02203       <a class="code" href="classorganic_product.html">organicProduct</a> * prod = (<a class="code" href="classorganic_product.html">organicProduct</a> *)&amp;product; <span class="comment">// To avoid warning</span>
<a name="l02204"></a>02204       <a class="code" href="classorganic_product.html">organicProduct</a> * p;
<a name="l02205"></a>02205       L = rootLengthList;
<a name="l02206"></a>02206       <span class="keywordtype">int</span> k=0; <span class="comment">// Remove later !!!</span>
<a name="l02207"></a>02207       <span class="keywordflow">while</span> (current)
<a name="l02208"></a>02208       {
<a name="l02209"></a>02209          <span class="keywordflow">if</span> (*L&gt;0)
<a name="l02210"></a>02210          {
<a name="l02211"></a>02211                 p = prod-&gt;<a class="code" href="classorganic_product.html#ab9f2dcb358bab6290b9fc01af1992d74">GetFraction</a>((*L)/sumL);
<a name="l02212"></a>02212                 current-&gt;<a class="code" href="classsoil_layer.html#a02f3d74a63ae05911287bd29ce22427c">AddProduct</a>(*p);
<a name="l02213"></a>02213                 <span class="keyword">delete</span> p;
<a name="l02214"></a>02214         }
<a name="l02215"></a>02215         current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02216"></a>02216         L++;
<a name="l02217"></a>02217          k++;
<a name="l02218"></a>02218       }
<a name="l02219"></a>02219    }
<a name="l02220"></a>02220    <span class="keywordflow">else</span>
<a name="l02221"></a>02221         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;SoilProfile::Product not added&quot;</span>);
<a name="l02222"></a>02222 }
<a name="l02223"></a>02223 
<a name="l02224"></a>02224 <span class="comment">/****************************************************************************\</span>
<a name="l02225"></a>02225 <span class="comment">\****************************************************************************/</span>
<a name="l02226"></a><a class="code" href="classsoil_profile.html#ac0825115659eefb3cdf0d25bc385b594">02226</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#ac0825115659eefb3cdf0d25bc385b594">soilProfile::StartBudget</a>()
<a name="l02227"></a>02227 {
<a name="l02228"></a>02228         <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02229"></a>02229         <span class="keywordflow">while</span> (current != NULL)
<a name="l02230"></a>02230         {
<a name="l02231"></a>02231                 current-&gt;<a class="code" href="classsoil_layer.html#a183d7d2254081522d73ac4abf588691d">StartBudget</a>();
<a name="l02232"></a>02232                 current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02233"></a>02233         }
<a name="l02234"></a>02234 }
<a name="l02235"></a>02235 
<a name="l02236"></a>02236 <span class="comment">/****************************************************************************\</span>
<a name="l02237"></a>02237 <span class="comment">\****************************************************************************/</span>
<a name="l02238"></a><a class="code" href="classsoil_profile.html#af7441e5aa2d37028f2d8539bffba3580">02238</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_profile.html#af7441e5aa2d37028f2d8539bffba3580">soilProfile::EndBudget</a>()
<a name="l02239"></a>02239 {
<a name="l02240"></a>02240         <a class="code" href="classsoil_layer.html">soilLayer</a> * current = first;
<a name="l02241"></a>02241         <span class="keywordflow">while</span> (current != NULL)
<a name="l02242"></a>02242         {
<a name="l02243"></a>02243                 current-&gt;<a class="code" href="classsoil_layer.html#ac1c46edeecd5a54044c434adf939301b">EndBudget</a>();
<a name="l02244"></a>02244                 current = current-&gt;<a class="code" href="classsoil_layer.html#a53b5e6743e808dd6516867c5de2a0ded">Next</a>();
<a name="l02245"></a>02245         }
<a name="l02246"></a>02246 }
<a name="l02247"></a>02247 
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Mon Aug 22 2011 10:29:05 for Fasset by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
