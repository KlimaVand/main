<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Fasset: C:/main/trunk/src/soil/organicMatter.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Fasset</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">C:/main/trunk/src/soil/organicMatter.cpp</div>  </div>
</div>
<div class="contents">
<a href="organic_matter_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/****************************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"> $URL$</span>
<a name="l00003"></a>00003 <span class="comment"> $LastChangedDate$</span>
<a name="l00004"></a>00004 <span class="comment"> $LastChangedRevision$</span>
<a name="l00005"></a>00005 <span class="comment"> $LastChangedBy$</span>
<a name="l00006"></a>00006 <span class="comment">\****************************************************************************/</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &quot;../base/common.h&quot;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="organic_matter_8h.html">organicMatter.h</a>&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="added_matter_8h.html">addedMatter.h</a>&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="bio_matter_8h.html">bioMatter.h</a>&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;../base/message.h&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;../base/bstime.h&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;../tools/compare.h&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00015"></a>00015 <span class="comment">/****************************************************************************\</span>
<a name="l00016"></a>00016 <span class="comment">Constructor</span>
<a name="l00017"></a>00017 <span class="comment">\****************************************************************************/</span>
<a name="l00018"></a><a class="code" href="classorganic_matter.html#ac425d01b777c572657394ead4c91657f">00018</a> <a class="code" href="classorganic_matter.html#ac425d01b777c572657394ead4c91657f">organicMatter::organicMatter</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * Pname,<span class="keyword">const</span> <span class="keywordtype">int</span> Index,<span class="keyword">const</span> <a class="code" href="classbase.html">base</a> * owner)
<a name="l00019"></a>00019    : <a class="code" href="classbase.html">base</a>(Pname,Index,owner)
<a name="l00020"></a>00020 {
<a name="l00021"></a>00021    <span class="comment">// Parameters</span>
<a name="l00022"></a>00022    useSpringob=<span class="keyword">false</span>; <span class="comment">// Don&#39;t set this true - unfinished code !!!</span>
<a name="l00023"></a>00023    nCycling=0.0;
<a name="l00024"></a>00024    ncSlope=0.0;
<a name="l00025"></a>00025    useNCfractionation=<span class="keyword">false</span>;
<a name="l00026"></a>00026    ncIntercept=0.0;
<a name="l00027"></a>00027    maxAOM2=1.0;
<a name="l00028"></a>00028    exchangeRate=1E+36; <span class="comment">// Default full exchange, regardless of time step &quot;scaling&quot;</span>
<a name="l00029"></a>00029    exclusivePreferenceNH4=<span class="keyword">false</span>;
<a name="l00030"></a>00030    NH4allwaysLeft=2E-9;
<a name="l00031"></a>00031    beta=0.05; <span class="comment">// Parameter for Langmuir equation (value taken from Mary et al. 1998)</span>
<a name="l00032"></a>00032    nitrificationRate=0.0; <span class="comment">// Must be set from model file</span>
<a name="l00033"></a>00033    stepFactor=1.0; <span class="comment">// Scales the decay rates, used to be able to &quot;mix&quot; different timesteps</span>
<a name="l00034"></a>00034    TAGpercent=<span class="keyword">false</span>;
<a name="l00035"></a>00035    ReadTAG=<span class="keyword">false</span>; <span class="comment">// Indicates whether TAG values should be read from file</span>
<a name="l00036"></a>00036    C14FromFile=<span class="keyword">false</span>;
<a name="l00037"></a>00037    useDelta14Cvalues=<span class="keyword">true</span>;
<a name="l00038"></a>00038    temperatureAdjust=-1.0;   <span class="comment">// Adjustment parameter for temperature response</span>
<a name="l00039"></a>00039    Kirschbaum1=-3.432;
<a name="l00040"></a>00040    Kirschbaum2=0.186;           <span class="comment">//  value corrected from 0.168 to 0.186 by ALJ on 04-08-2010</span>
<a name="l00041"></a>00041    KirschbaumTopt=36.9;
<a name="l00042"></a>00042    Arrhenius=6352.0;         <span class="comment">// deg. Kelvin</span>
<a name="l00043"></a>00043    VantHoffQ10=2.0;
<a name="l00044"></a>00044    refT=30.0;
<a name="l00045"></a>00045    MaxDeltaCarbon=1E-9;
<a name="l00046"></a>00046    MaxDeltaIsotope=1E-9;
<a name="l00047"></a>00047    HalfTime=5568.0;          <span class="comment">// Halftime for 14C (years)</span>
<a name="l00048"></a>00048    Rzs=0.0112372;            <span class="comment">// Default ratio of 13C to 12C (PDB)</span>
<a name="l00049"></a>00049    clayContent=0.0;
<a name="l00050"></a>00050    clayContentLimit=0.25;    <span class="comment">// Upper limit for effect of clay content on decay</span>
<a name="l00051"></a>00051    clayRateLimit=0.5;        <span class="comment">// Relative decay at the upper clay limit</span>
<a name="l00052"></a>00052    clayParameter1=3.0895;
<a name="l00053"></a>00053    clayParameter2=2.672;
<a name="l00054"></a>00054    clayParameter3=-7.86;
<a name="l00055"></a>00055    clayParameter4=1.67;
<a name="l00056"></a>00056    clayParameter5=1.0;
<a name="l00057"></a>00057    waterResponseType=1;      <span class="comment">// Use SOILN water response by default</span>
<a name="l00058"></a>00058    tResponseType=1;          <span class="comment">// Use Kirschbaum temperature response by default</span>
<a name="l00059"></a>00059    ClayResponseType=1;       <span class="comment">// 0 : None</span>
<a name="l00060"></a>00060                              <span class="comment">// 1: Effect on turnover rates (only specified pools)</span>
<a name="l00061"></a>00061                              <span class="comment">// 2: Effect on biomass maintenance</span>
<a name="l00062"></a>00062    clayEffect1=1.0;          <span class="comment">// Get from conditionfile</span>
<a name="l00063"></a>00063    clayEffect2=1.0;
<a name="l00064"></a>00064    temperatureEffect=-1.0;
<a name="l00065"></a>00065    waterEffect=-1.0;
<a name="l00066"></a>00066    Isotope=0;                <span class="comment">// 0 : None; 1: 13C; 2: 14C; 3: TAG; Set from &quot;main&quot;, read from &quot;setup.dat&quot;</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068    <span class="comment">// SOILN water parameters below</span>
<a name="l00069"></a>00069    <span class="comment">// W1-W4 are be soil dependent, and these initialisations can hence be</span>
<a name="l00070"></a>00070    <span class="comment">// overwritten by the conditionfile</span>
<a name="l00071"></a>00071    W1=5.0;                   <span class="comment">// PWP</span>
<a name="l00072"></a>00072    W2Offset=10.0;            <span class="comment">// PWP + 10%</span>
<a name="l00073"></a>00073    W3Offset=-8.0;            <span class="comment">// Saturation - 8%</span>
<a name="l00074"></a>00074    W4=50.0;                  <span class="comment">// Saturation</span>
<a name="l00075"></a>00075    Y1=0.0;                   <span class="comment">// Parameter for water effect</span>
<a name="l00076"></a>00076    Y2=0.6;                   <span class="comment">// --------&quot;&quot;--------</span>
<a name="l00077"></a>00077    m=1.0;                    <span class="comment">// --------&quot;&quot;--------</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079    <span class="comment">// State variables</span>
<a name="l00080"></a>00080    carbon_avalibility=0.0;
<a name="l00081"></a>00081    deltaCarbon=1.0;
<a name="l00082"></a>00082    deltaIsotope=1.0;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 
<a name="l00085"></a>00085    numberOfPools=0;
<a name="l00086"></a>00086    numberOfProducts=0;
<a name="l00087"></a>00087    Nresidual=0.0;
<a name="l00088"></a>00088         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;max14CYears;i++)
<a name="l00089"></a>00089       radioCarbon[i]=100.0;
<a name="l00090"></a>00090         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;maxOrgProds;i++)
<a name="l00091"></a>00091       prodList[i]=NULL;
<a name="l00092"></a>00092         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;maxPools;i++)
<a name="l00093"></a>00093       poolList[i]=NULL;
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 
<a name="l00096"></a>00096    todayCO2.<a class="code" href="classcn_matter.html#a45d9021d50f76e167388bf5de2e406ed">Clear</a>();
<a name="l00097"></a>00097 
<a name="l00098"></a>00098    NO3.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00099"></a>00099    NH4.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00100"></a>00100    NH4near.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="comment">/****************************************************************************\</span>
<a name="l00104"></a>00104 <span class="comment">Copy constructor</span>
<a name="l00105"></a>00105 <span class="comment">\****************************************************************************/</span>
<a name="l00106"></a><a class="code" href="classorganic_matter.html#ae373d5e017ff62f6fa3d3c3dc789d716">00106</a> <a class="code" href="classorganic_matter.html#ac425d01b777c572657394ead4c91657f">organicMatter::organicMatter</a>(<span class="keyword">const</span> <a class="code" href="classorganic_matter.html">organicMatter</a>&amp; source)
<a name="l00107"></a>00107    : <a class="code" href="classbase.html">base</a> (source)
<a name="l00108"></a>00108 {
<a name="l00109"></a>00109    <span class="keywordflow">if</span> (&amp;source)
<a name="l00110"></a>00110    {
<a name="l00111"></a>00111          useSpringob=source.useSpringob;
<a name="l00112"></a>00112          nCycling=source.nCycling;
<a name="l00113"></a>00113          ncSlope=source.ncSlope;
<a name="l00114"></a>00114          useNCfractionation=source.useNCfractionation;
<a name="l00115"></a>00115          ncIntercept=source.ncIntercept;
<a name="l00116"></a>00116          maxAOM2=source.maxAOM2;
<a name="l00117"></a>00117          exchangeRate=source.exchangeRate;
<a name="l00118"></a>00118          exclusivePreferenceNH4=source.exclusivePreferenceNH4;
<a name="l00119"></a>00119          NH4allwaysLeft=source.NH4allwaysLeft;
<a name="l00120"></a>00120          beta=source.beta;
<a name="l00121"></a>00121          nitrificationRate=source.nitrificationRate;
<a name="l00122"></a>00122          stepFactor=source.stepFactor;
<a name="l00123"></a>00123          TAGpercent=source.TAGpercent;
<a name="l00124"></a>00124          ReadTAG=source.ReadTAG;
<a name="l00125"></a>00125          C14FromFile=source.C14FromFile;
<a name="l00126"></a>00126          useDelta14Cvalues=source.useDelta14Cvalues;
<a name="l00127"></a>00127          temperatureAdjust=source.temperatureAdjust;
<a name="l00128"></a>00128          Kirschbaum1=source.Kirschbaum1;
<a name="l00129"></a>00129          Kirschbaum2=source.Kirschbaum2;
<a name="l00130"></a>00130          KirschbaumTopt=source.KirschbaumTopt;
<a name="l00131"></a>00131          Arrhenius=source.Arrhenius;
<a name="l00132"></a>00132          VantHoffQ10=source.VantHoffQ10;
<a name="l00133"></a>00133          refT=source.refT;
<a name="l00134"></a>00134          MaxDeltaCarbon=source.MaxDeltaCarbon;
<a name="l00135"></a>00135          MaxDeltaIsotope=source.MaxDeltaIsotope;
<a name="l00136"></a>00136          HalfTime=source.HalfTime;
<a name="l00137"></a>00137          Rzs=source.Rzs;
<a name="l00138"></a>00138          clayContent=source.clayContent;
<a name="l00139"></a>00139          clayContentLimit=source.clayContentLimit;
<a name="l00140"></a>00140          clayRateLimit=source.clayRateLimit;
<a name="l00141"></a>00141          clayParameter1=source.clayParameter1;
<a name="l00142"></a>00142          clayParameter2=source.clayParameter2;
<a name="l00143"></a>00143          clayParameter3=source.clayParameter3;
<a name="l00144"></a>00144          clayParameter4=source.clayParameter4;
<a name="l00145"></a>00145          clayParameter5=source.clayParameter5;
<a name="l00146"></a>00146          clayEffect1=source.clayEffect1;
<a name="l00147"></a>00147          clayEffect2=source.clayEffect2;
<a name="l00148"></a>00148          waterResponseType=source.waterResponseType;
<a name="l00149"></a>00149          tResponseType=source.tResponseType;
<a name="l00150"></a>00150          ClayResponseType=source.ClayResponseType;
<a name="l00151"></a>00151          temperatureEffect=source.temperatureEffect;
<a name="l00152"></a>00152          waterEffect=source.waterEffect;
<a name="l00153"></a>00153          Isotope=source.Isotope;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155          W1=source.W1;
<a name="l00156"></a>00156          W2Offset=source.W2Offset;
<a name="l00157"></a>00157          W3Offset=source.W3Offset;
<a name="l00158"></a>00158          W4=source.W4;
<a name="l00159"></a>00159          Y1=source.Y1;
<a name="l00160"></a>00160          Y2=source.Y2;
<a name="l00161"></a>00161          m=source.m;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163          <span class="comment">// State variables</span>
<a name="l00164"></a>00164          carbon_avalibility=source.carbon_avalibility;
<a name="l00165"></a>00165          deltaCarbon=source.deltaCarbon;
<a name="l00166"></a>00166          deltaIsotope=source.deltaIsotope;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 
<a name="l00169"></a>00169          numberOfPools=source.numberOfPools;
<a name="l00170"></a>00170          numberOfProducts=source.numberOfProducts;
<a name="l00171"></a>00171          Nresidual=source.Nresidual;
<a name="l00172"></a>00172          <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;max14CYears;i++)
<a name="l00173"></a>00173             radioCarbon[i]=source.radioCarbon[i];
<a name="l00174"></a>00174         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;maxOrgProds;i++)
<a name="l00175"></a>00175             prodList[i]=source.prodList[i];
<a name="l00176"></a>00176          <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)
<a name="l00177"></a>00177             poolList[i] = source.poolList[i]-&gt;<a class="code" href="classmatter.html#afca594a86c75c8f40856bc5c8711266c">clone</a>();
<a name="l00178"></a>00178          <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)  <span class="comment">// To interconnect pools in the new structure</span>
<a name="l00179"></a>00179          {
<a name="l00180"></a>00180             poolList[i]-&gt;<a class="code" href="classbase.html#a42c446f0adea294e97a2486946b7cbc4">SetOwner</a>(<span class="keyword">this</span>);
<a name="l00181"></a>00181             poolList[i]-&gt;<a class="code" href="classmatter.html#adeae5b9c4239d6c02c19e04d346e6d10">Initialize</a>(clayEffect1,clayEffect2,ClayResponseType);
<a name="l00182"></a>00182          }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184 
<a name="l00185"></a>00185          todayCO2 = source.todayCO2;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187          NO3 = source.NO3;
<a name="l00188"></a>00188          NH4 = source.NH4;
<a name="l00189"></a>00189          NH4near = source.NH4near;
<a name="l00190"></a>00190    }
<a name="l00191"></a>00191    <span class="keywordflow">else</span>
<a name="l00192"></a>00192       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Attempt to copy &#39;organicMatter&#39; with NULL pointer&quot;</span>);
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 <span class="comment">/****************************************************************************\</span>
<a name="l00196"></a>00196 <span class="comment">Implicit assumptions, eg. equality of number of pools, are not tested</span>
<a name="l00197"></a>00197 <span class="comment">\****************************************************************************/</span>
<a name="l00198"></a><a class="code" href="classorganic_matter.html#af8e7ce68e31c09319d0b33d7f20a5100">00198</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#af8e7ce68e31c09319d0b33d7f20a5100">organicMatter::Add</a>(<a class="code" href="classorganic_matter.html">organicMatter</a> * source, <span class="keywordtype">double</span> <a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)
<a name="l00199"></a>00199 {
<a name="l00200"></a>00200    <span class="keywordflow">if</span> (&amp;source)
<a name="l00201"></a>00201    {
<a name="l00202"></a>00202       nCycling=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*nCycling+fraction*source-&gt;nCycling;
<a name="l00203"></a>00203       carbon_avalibility=(1.0-fraction)*carbon_avalibility+fraction*source-&gt;carbon_avalibility;
<a name="l00204"></a>00204       ncSlope=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*ncSlope+fraction*source-&gt;ncSlope;
<a name="l00205"></a>00205       ncIntercept=(1.0-fraction)*ncIntercept+fraction*source-&gt;ncIntercept;
<a name="l00206"></a>00206       maxAOM2=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*maxAOM2+fraction*source-&gt;maxAOM2;
<a name="l00207"></a>00207       exchangeRate=(1.0-fraction)*exchangeRate+fraction*source-&gt;exchangeRate;
<a name="l00208"></a>00208       NH4allwaysLeft=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*NH4allwaysLeft+fraction*source-&gt;NH4allwaysLeft;
<a name="l00209"></a>00209       beta=(1.0-fraction)*beta+fraction*source-&gt;beta;
<a name="l00210"></a>00210       nitrificationRate=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*nitrificationRate+fraction*source-&gt;nitrificationRate;
<a name="l00211"></a>00211       stepFactor=(1.0-fraction)*stepFactor+fraction*source-&gt;stepFactor;
<a name="l00212"></a>00212       temperatureEffect=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*temperatureEffect+fraction*source-&gt;temperatureEffect;
<a name="l00213"></a>00213       waterEffect=(1.0-fraction)*waterEffect+fraction*source-&gt;waterEffect;
<a name="l00214"></a>00214       clayContent=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*clayContent+fraction*source-&gt;clayContent;
<a name="l00215"></a>00215       clayParameter1=(1.0-fraction)*clayParameter1+fraction*source-&gt;clayParameter1;
<a name="l00216"></a>00216       clayParameter2=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*clayParameter2+fraction*source-&gt;clayParameter2;
<a name="l00217"></a>00217       clayParameter3=(1.0-fraction)*clayParameter3+fraction*source-&gt;clayParameter3;
<a name="l00218"></a>00218       clayParameter4=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*clayParameter4+fraction*source-&gt;clayParameter4;
<a name="l00219"></a>00219       clayParameter5=(1.0-fraction)*clayParameter5+fraction*source-&gt;clayParameter5;
<a name="l00220"></a>00220       deltaCarbon=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*deltaCarbon+fraction*source-&gt;deltaCarbon;
<a name="l00221"></a>00221       deltaIsotope=(1.0-fraction)*deltaIsotope+fraction*source-&gt;deltaIsotope;
<a name="l00222"></a>00222       Rzs=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*Rzs+fraction*source-&gt;Rzs;
<a name="l00223"></a>00223       Kirschbaum1=(1.0-fraction)*Kirschbaum1+fraction*source-&gt;Kirschbaum1;
<a name="l00224"></a>00224       Kirschbaum2=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*Kirschbaum2+fraction*source-&gt;Kirschbaum2;
<a name="l00225"></a>00225       KirschbaumTopt=(1.0-fraction)*KirschbaumTopt+fraction*source-&gt;KirschbaumTopt;
<a name="l00226"></a>00226       Arrhenius=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*Arrhenius+fraction*source-&gt;Arrhenius;
<a name="l00227"></a>00227       VantHoffQ10=(1.0-fraction)*VantHoffQ10+fraction*source-&gt;VantHoffQ10;
<a name="l00228"></a>00228       refT=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*refT+fraction*source-&gt;refT;
<a name="l00229"></a>00229       temperatureAdjust=(1.0-fraction)*temperatureAdjust+fraction*source-&gt;temperatureAdjust;
<a name="l00230"></a>00230       clayContentLimit=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*clayContentLimit+fraction*source-&gt;clayContentLimit;
<a name="l00231"></a>00231       clayRateLimit=(1.0-fraction)*clayRateLimit+fraction*source-&gt;clayRateLimit;
<a name="l00232"></a>00232       MaxDeltaCarbon=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*MaxDeltaCarbon+fraction*source-&gt;MaxDeltaCarbon;
<a name="l00233"></a>00233       MaxDeltaIsotope=(1.0-fraction)*MaxDeltaIsotope+fraction*source-&gt;MaxDeltaIsotope;
<a name="l00234"></a>00234       HalfTime=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*HalfTime+fraction*source-&gt;HalfTime;
<a name="l00235"></a>00235       W1=(1.0-fraction)*W1+fraction*source-&gt;W1;
<a name="l00236"></a>00236       W2Offset=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*W2Offset+fraction*source-&gt;W2Offset;
<a name="l00237"></a>00237       W3Offset=(1.0-fraction)*W3Offset+fraction*source-&gt;W3Offset;
<a name="l00238"></a>00238       W4=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*W4+fraction*source-&gt;W4;
<a name="l00239"></a>00239       Y1=(1.0-fraction)*Y1+fraction*source-&gt;Y1;
<a name="l00240"></a>00240       Y2=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*Y2+fraction*source-&gt;Y2;
<a name="l00241"></a>00241       m=(1.0-fraction)*m+fraction*source-&gt;m;
<a name="l00242"></a>00242       clayEffect1=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*clayEffect1+fraction*source-&gt;clayEffect1;
<a name="l00243"></a>00243       clayEffect2=(1.0-fraction)*clayEffect2+fraction*source-&gt;clayEffect2;
<a name="l00244"></a>00244       Nresidual=(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*Nresidual+fraction*source-&gt;Nresidual;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 
<a name="l00247"></a>00247       todayCO2=todayCO2*(1.0-fraction)+source-&gt;todayCO2*<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249       NO3=NO3*(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)+source-&gt;NO3*fraction;
<a name="l00250"></a>00250       NH4=NH4*(1.0-fraction)+source-&gt;NH4*<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>;
<a name="l00251"></a>00251       NH4near=NH4near*(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)+source-&gt;NH4near*fraction;
<a name="l00252"></a>00252       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)
<a name="l00253"></a>00253          poolList[i]-&gt;<a class="code" href="classmatter.html#a5cda91bc9eb0bfbc1fd1003cf574e39c">Add</a>(source-&gt;poolList[i],fraction);
<a name="l00254"></a>00254    }
<a name="l00255"></a>00255    <span class="keywordflow">else</span>
<a name="l00256"></a>00256       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::Add - function called with NULL pointer&quot;</span>);
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00259"></a>00259 <span class="comment">/****************************************************************************\</span>
<a name="l00260"></a>00260 <span class="comment">Destructor</span>
<a name="l00261"></a>00261 <span class="comment">\****************************************************************************/</span>
<a name="l00262"></a><a class="code" href="classorganic_matter.html#ad02ba3d5422d82ec8dd56b01e12c50fe">00262</a> <a class="code" href="classorganic_matter.html#ad02ba3d5422d82ec8dd56b01e12c50fe">organicMatter::~organicMatter</a>()
<a name="l00263"></a>00263 {
<a name="l00264"></a>00264    <span class="keywordflow">if</span> (numberOfPools&gt;=maxPools) <span class="comment">// Previous problems, caused by incomplete copy constructors - should be solved now</span>
<a name="l00265"></a>00265       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::~organicMatter - &#39;numberOfPools&#39; to high!&quot;</span>);
<a name="l00266"></a>00266    <span class="keywordflow">if</span> (numberOfProducts&gt;=maxOrgProds) <span class="comment">// Previous problems, caused by incomplete copy constructors - should be solved now</span>
<a name="l00267"></a>00267       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::~organicMatter - &#39;numberOfProducts&#39; to high!&quot;</span>);
<a name="l00268"></a>00268    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)
<a name="l00269"></a>00269       <span class="keywordflow">if</span> (poolList[i])
<a name="l00270"></a>00270          <span class="keyword">delete</span> poolList[i];
<a name="l00271"></a>00271    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfProducts;i++)
<a name="l00272"></a>00272       <span class="keywordflow">if</span> (prodList[i])
<a name="l00273"></a>00273          <span class="keyword">delete</span> prodList[i];
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 <span class="comment">/****************************************************************************\</span>
<a name="l00277"></a>00277 <span class="comment">Initiates all soil matter pools with data which each instance reads</span>
<a name="l00278"></a>00278 <span class="comment">from the file.</span>
<a name="l00279"></a>00279 <span class="comment">   filename   input file name</span>
<a name="l00280"></a>00280 <span class="comment">\****************************************************************************/</span>
<a name="l00281"></a><a class="code" href="classorganic_matter.html#a571a15d4863954c5f1f2adbaca71e9bf">00281</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#a571a15d4863954c5f1f2adbaca71e9bf">organicMatter::InitStructure</a>(<span class="keywordtype">char</span> * filename)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283    <a class="code" href="classbase.html#a5c9e361dfd9a7804a33b7baa8f5a4b1f">UnsetCritical</a>();
<a name="l00284"></a>00284    <span class="keywordflow">if</span> (!<a class="code" href="classbase.html#a551ea12cd21bfc786892b5bb8c333ee0">OpenInputFile</a>(filename))
<a name="l00285"></a>00285       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Structurefile [&quot;</span>,filename,<span class="stringliteral">&quot;] could not be opened.&quot;</span>);
<a name="l00286"></a>00286    <span class="keywordtype">int</span> n,<a class="code" href="typer_8h.html#a74e289adaa38a655bd68482967f86cfdaa4500e61db092c2e1719b5d68b047ec3">first</a>;
<a name="l00287"></a>00287    <a class="code" href="classbase.html#a4f63fec241f5857f3fe28b43f85d0fa5">GetSectionNumbers</a>(<span class="stringliteral">&quot;AddedMatter&quot;</span>,&amp;first,&amp;n);
<a name="l00288"></a>00288         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=first;i&lt;(first+n);i++)
<a name="l00289"></a>00289         {
<a name="l00290"></a>00290                 <a class="code" href="classmatter.html">matter</a> * m=<span class="keyword">new</span> <a class="code" href="classadded_matter.html">addedMatter</a>(<span class="stringliteral">&quot;AddedMatter&quot;</span>,i,<span class="keyword">this</span>);
<a name="l00291"></a>00291       m-&gt;<a class="code" href="classmatter.html#a850135c585ac81915cac266f0d8e04df">SetStepFactor</a>(stepFactor);
<a name="l00292"></a>00292       m-&gt;<a class="code" href="classmatter.html#a8418c63bc2206df9cb0de19aa195eeac">ReadParameters</a>(<a class="code" href="classbase.html#a3af52ee9891719d09b8b19b42450b6f6">file</a>);
<a name="l00293"></a>00293       poolList[numberOfPools]=m;
<a name="l00294"></a>00294       numberOfPools+=1;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         }
<a name="l00297"></a>00297    <a class="code" href="classbase.html#a4f63fec241f5857f3fe28b43f85d0fa5">GetSectionNumbers</a>(<span class="stringliteral">&quot;BioMatter&quot;</span>,&amp;first,&amp;n);
<a name="l00298"></a>00298         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=first;i&lt;(first+n);i++)
<a name="l00299"></a>00299         {
<a name="l00300"></a>00300                 <a class="code" href="classmatter.html">matter</a> * m=<span class="keyword">new</span> <a class="code" href="classbio_matter.html">bioMatter</a>(<span class="stringliteral">&quot;BioMatter&quot;</span>,i,<span class="keyword">this</span>);
<a name="l00301"></a>00301       m-&gt;<a class="code" href="classmatter.html#a850135c585ac81915cac266f0d8e04df">SetStepFactor</a>(stepFactor);
<a name="l00302"></a>00302       m-&gt;<a class="code" href="classmatter.html#a8418c63bc2206df9cb0de19aa195eeac">ReadParameters</a>(<a class="code" href="classbase.html#a3af52ee9891719d09b8b19b42450b6f6">file</a>);
<a name="l00303"></a>00303       poolList[numberOfPools]=m;
<a name="l00304"></a>00304       numberOfPools+=1;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306         }
<a name="l00307"></a>00307    <a class="code" href="classbase.html#a4f63fec241f5857f3fe28b43f85d0fa5">GetSectionNumbers</a>(<span class="stringliteral">&quot;Matter&quot;</span>,&amp;first,&amp;n);
<a name="l00308"></a>00308         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=first;i&lt;(first+n);i++)
<a name="l00309"></a>00309         {
<a name="l00310"></a>00310                 <a class="code" href="classmatter.html">matter</a> * m=<span class="keyword">new</span> <a class="code" href="classmatter.html">matter</a>(<span class="stringliteral">&quot;Matter&quot;</span>,i,<span class="keyword">this</span>);
<a name="l00311"></a>00311       m-&gt;<a class="code" href="classmatter.html#a850135c585ac81915cac266f0d8e04df">SetStepFactor</a>(stepFactor);
<a name="l00312"></a>00312       m-&gt;<a class="code" href="classmatter.html#a8418c63bc2206df9cb0de19aa195eeac">ReadParameters</a>(<a class="code" href="classbase.html#a3af52ee9891719d09b8b19b42450b6f6">file</a>);
<a name="l00313"></a>00313       poolList[numberOfPools]=m;
<a name="l00314"></a>00314       numberOfPools+=1;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317    <span class="keywordflow">if</span> (numberOfPools&lt;1)
<a name="l00318"></a>00318       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Pools are not properly defined in structurefile.&quot;</span>);
<a name="l00319"></a>00319    <span class="keywordflow">if</span> (<a class="code" href="classbase.html#a88e41ff60ffb7e707312a09f20457e73">FindSection</a>(<span class="stringliteral">&quot;Parameters&quot;</span>))
<a name="l00320"></a>00320    {
<a name="l00321"></a>00321       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;TemperatureResponse&quot;</span>,&amp;tResponseType);
<a name="l00322"></a>00322       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;WaterResponse&quot;</span>,&amp;waterResponseType);
<a name="l00323"></a>00323       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;W1&quot;</span>,&amp;W1);
<a name="l00324"></a>00324       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;W4&quot;</span>,&amp;W4);
<a name="l00325"></a>00325       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;W2Offset&quot;</span>,&amp;W2Offset);
<a name="l00326"></a>00326       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;W3Offset&quot;</span>,&amp;W3Offset);
<a name="l00327"></a>00327       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;Y1&quot;</span>,&amp;Y1);
<a name="l00328"></a>00328       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;Y2&quot;</span>,&amp;Y2);
<a name="l00329"></a>00329       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;m&quot;</span>,&amp;m);
<a name="l00330"></a>00330       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;HalfTime&quot;</span>,&amp;HalfTime);
<a name="l00331"></a>00331       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ClayResponse&quot;</span>,&amp;ClayResponseType);
<a name="l00332"></a>00332       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ClayContentLimit&quot;</span>,&amp;clayContentLimit);
<a name="l00333"></a>00333       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ClayRateLimit&quot;</span>,&amp;clayRateLimit);
<a name="l00334"></a>00334       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;TemperatureAdjust&quot;</span>,&amp;temperatureAdjust);
<a name="l00335"></a>00335       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;Kirschbaum1&quot;</span>,&amp;Kirschbaum1);
<a name="l00336"></a>00336       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;Kirschbaum2&quot;</span>,&amp;Kirschbaum2);
<a name="l00337"></a>00337       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;KirschbaumTopt&quot;</span>,&amp;KirschbaumTopt);
<a name="l00338"></a>00338       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;Arrhenius&quot;</span>,&amp;Arrhenius);
<a name="l00339"></a>00339       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;VantHoffQ10&quot;</span>,&amp;VantHoffQ10);
<a name="l00340"></a>00340       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ReferenceTemperature&quot;</span>,&amp;refT);
<a name="l00341"></a>00341       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ClayParameter1&quot;</span>,&amp;clayParameter1);
<a name="l00342"></a>00342       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ClayParameter2&quot;</span>,&amp;clayParameter2);
<a name="l00343"></a>00343       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ClayParameter3&quot;</span>,&amp;clayParameter3);
<a name="l00344"></a>00344       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ClayParameter4&quot;</span>,&amp;clayParameter4);
<a name="l00345"></a>00345       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ClayParameter5&quot;</span>,&amp;clayParameter5);
<a name="l00346"></a>00346       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;NitrificationRate&quot;</span>,&amp;nitrificationRate);
<a name="l00347"></a>00347       <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;NCslope&quot;</span>,&amp;ncSlope))
<a name="l00348"></a>00348       {
<a name="l00349"></a>00349          useNCfractionation=<span class="keyword">true</span>;
<a name="l00350"></a>00350          <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;NCintercept&quot;</span>,&amp;ncIntercept);
<a name="l00351"></a>00351          <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;MaxAOM2&quot;</span>,&amp;maxAOM2);
<a name="l00352"></a>00352          <span class="keywordflow">if</span> (maxAOM2&gt;1.0 || maxAOM2&lt;0.0)
<a name="l00353"></a>00353             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Model parameter &#39;MaxAOM2&#39; has illegal value&quot;</span>);
<a name="l00354"></a>00354       }
<a name="l00355"></a>00355       nitrificationRate=nitrificationRate*stepFactor;
<a name="l00356"></a>00356       exchangeRate=exchangeRate*stepFactor;
<a name="l00357"></a>00357    }
<a name="l00358"></a>00358    <a class="code" href="classbase.html#a56480e2d42e0f66e1416dbf064a913d1">CloseInputFile</a>();
<a name="l00359"></a>00359    <a class="code" href="classbase.html#a7ca584f6b100bb78cbaec8cfaaf9a30c">DeleteInputFile</a>(); <span class="comment">// ??????!!!!! I just don&#39;t get why this works without &quot;DeleteInputFile()&quot; most of the time, but not here - BMP</span>
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 
<a name="l00365"></a>00365 <span class="comment">/****************************************************************************\</span>
<a name="l00366"></a>00366 <span class="comment">\****************************************************************************/</span>
<a name="l00367"></a><a class="code" href="classorganic_matter.html#af10194d9d1242a94519886ad4fb2db4f">00367</a> <span class="keywordtype">bool</span> <a class="code" href="classorganic_matter.html#af10194d9d1242a94519886ad4fb2db4f">organicMatter::ExistsPool</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * poolName)
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369    <span class="keywordtype">int</span> j=-1;
<a name="l00370"></a>00370    <span class="keywordflow">if</span> (strcmp(poolName,<span class="stringliteral">&quot;CO2&quot;</span>)==0)
<a name="l00371"></a>00371       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00372"></a>00372    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)
<a name="l00373"></a>00373       <span class="keywordflow">if</span> (strcmp(poolName,poolList[i]-&gt;GetPoolName())==0)
<a name="l00374"></a>00374          j=i;
<a name="l00375"></a>00375    <span class="keywordflow">if</span> (j==-1)
<a name="l00376"></a>00376       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00377"></a>00377    <span class="keywordflow">else</span>
<a name="l00378"></a>00378       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 <span class="comment">/****************************************************************************\</span>
<a name="l00382"></a>00382 <span class="comment">\****************************************************************************/</span>
<a name="l00383"></a>00383 <span class="keywordtype">double</span> organicMatter::GetRatio(<span class="keyword">const</span> <span class="keywordtype">char</span> * poolName)
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385    <a class="code" href="classbio_matter.html">bioMatter</a> * b=(<a class="code" href="classbio_matter.html">bioMatter</a>*)<a class="code" href="classorganic_matter.html#a3c6a07a913e1f837f235329615787c22">GetPoolPointer</a>(poolName);
<a name="l00386"></a>00386    <span class="keywordtype">double</span> d=b-&gt;<a class="code" href="classbio_matter.html#a78a7ead491fa0a5b799e672309dfca3e">GetDeathRate</a>();
<a name="l00387"></a>00387    <span class="keywordtype">double</span> m=b-&gt;<a class="code" href="classbio_matter.html#af20366c312adfce4ae986a512043cfe7">GetMaintenanceRate</a>();
<a name="l00388"></a>00388    <span class="keywordflow">return</span> d/(d+m);
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="comment">/****************************************************************************\</span>
<a name="l00392"></a>00392 <span class="comment">\****************************************************************************/</span>
<a name="l00393"></a>00393 <span class="keywordtype">double</span> organicMatter::GetE(<span class="keyword">const</span> <span class="keywordtype">char</span> * poolName)
<a name="l00394"></a>00394 {
<a name="l00395"></a>00395    <a class="code" href="classbio_matter.html">bioMatter</a> * b=(<a class="code" href="classbio_matter.html">bioMatter</a>*)<a class="code" href="classorganic_matter.html#a3c6a07a913e1f837f235329615787c22">GetPoolPointer</a>(poolName);
<a name="l00396"></a>00396    <span class="keywordflow">return</span> b-&gt;<a class="code" href="classbio_matter.html#a47e39d55d2b9b4ad92a9f82fc7ad4cf7">GetUtilizationEfficiency</a>();
<a name="l00397"></a>00397 }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399 <span class="comment">/****************************************************************************\</span>
<a name="l00400"></a>00400 <span class="comment">\****************************************************************************/</span>
<a name="l00401"></a>00401 <span class="keywordtype">double</span> organicMatter::GetfSMB2()
<a name="l00402"></a>00402 {
<a name="l00403"></a>00403    <a class="code" href="classadded_matter.html">addedMatter</a> * a=(<a class="code" href="classadded_matter.html">addedMatter</a>*)<a class="code" href="classorganic_matter.html#a3c6a07a913e1f837f235329615787c22">GetPoolPointer</a>(<span class="stringliteral">&quot;AOM2&quot;</span>);
<a name="l00404"></a>00404    <span class="keywordflow">return</span> a-&gt;<a class="code" href="classmatter.html#a97573040212b5ac7047a2cba344346d1">GetConnectionFraction</a>(<span class="stringliteral">&quot;SMB2&quot;</span>);
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 <span class="comment">/****************************************************************************\</span>
<a name="l00408"></a>00408 <span class="comment">\****************************************************************************/</span>
<a name="l00409"></a><a class="code" href="classorganic_matter.html#a7f207a5cc9b81af56393be25209e0bde">00409</a> <span class="keywordtype">double</span> <a class="code" href="classorganic_matter.html#a7f207a5cc9b81af56393be25209e0bde">organicMatter::GetTurnoverRatioSMB1</a>(<span class="keywordtype">double</span> clayStandard)
<a name="l00410"></a>00410 {
<a name="l00411"></a>00411    <span class="keywordtype">double</span> retval;
<a name="l00412"></a>00412    <span class="keywordtype">double</span> E=GetE(<span class="stringliteral">&quot;SMB1&quot;</span>);
<a name="l00413"></a>00413    <span class="keywordtype">double</span> fSMB2=GetfSMB2();
<a name="l00414"></a>00414    <span class="keywordtype">double</span> r2=GetRatio(<span class="stringliteral">&quot;SMB2&quot;</span>);
<a name="l00415"></a>00415    <span class="keywordtype">double</span> R=clayParameter4*(1.85+1.6*exp(clayParameter3*clayStandard));
<a name="l00416"></a>00416    retval=1.0/((1.0+R)*E*(1.0-fSMB2+fSMB2*E*r2));
<a name="l00417"></a>00417    <span class="keywordflow">return</span> retval;
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 <span class="comment">/****************************************************************************\</span>
<a name="l00421"></a>00421 <span class="comment">Returns the effect of clay content on processes</span>
<a name="l00422"></a>00422 <span class="comment">Return value range 0-1</span>
<a name="l00423"></a>00423 <span class="comment">clay - clay fraction (0-1)</span>
<a name="l00424"></a>00424 <span class="comment">responseType</span>
<a name="l00425"></a>00425 <span class="comment">   0 : Clay response not used</span>
<a name="l00426"></a>00426 <span class="comment">   1 : Like DAISY</span>
<a name="l00427"></a>00427 <span class="comment">   2 : Like RothC</span>
<a name="l00428"></a>00428 <span class="comment">   3 : New principle</span>
<a name="l00429"></a>00429 <span class="comment">\****************************************************************************/</span>
<a name="l00430"></a>00430 <span class="keywordtype">double</span> organicMatter::ClayEffect(<span class="keywordtype">double</span> clay,<span class="keywordtype">int</span> responseType)
<a name="l00431"></a>00431 {
<a name="l00432"></a>00432    <span class="keywordtype">double</span> retVal=1.0;
<a name="l00433"></a>00433    <span class="keywordtype">double</span> b,r,r1,r2,E,fSMB2,s,h,fNOM,rCheck;
<a name="l00434"></a>00434    <a class="code" href="classbio_matter.html">bioMatter</a> * bio;
<a name="l00435"></a>00435    <span class="keywordflow">switch</span> (responseType)
<a name="l00436"></a>00436    {
<a name="l00437"></a>00437       <span class="keywordflow">case</span> 0: <span class="comment">// Clay response not used</span>
<a name="l00438"></a>00438          retVal=1.0;
<a name="l00439"></a>00439       <span class="keywordflow">break</span>;
<a name="l00440"></a>00440       <span class="keywordflow">case</span> 1:
<a name="l00441"></a>00441          <span class="comment">// Like DAISY</span>
<a name="l00442"></a>00442          retVal = clayRateLimit;    <span class="comment">// Default 0.5</span>
<a name="l00443"></a>00443          <span class="keywordflow">if</span> (clay&lt;clayContentLimit) <span class="comment">// Default 0.25</span>
<a name="l00444"></a>00444          retVal = 1.0-clay*(1.0-clayRateLimit)/clayContentLimit;
<a name="l00445"></a>00445       <span class="keywordflow">break</span>;
<a name="l00446"></a>00446       <span class="keywordflow">case</span> 2: <span class="comment">// Like RothC</span>
<a name="l00447"></a>00447          retVal=clayParameter1+clayParameter2*exp(clayParameter3*clay);
<a name="l00448"></a>00448       <span class="keywordflow">break</span>;
<a name="l00449"></a>00449       <span class="keywordflow">case</span> 3: <span class="comment">// New principle. Difference lies in class &quot;bioMatter&quot;.</span>
<a name="l00450"></a>00450          retVal=clayParameter4*(1.85+1.6*exp(-7.86*clay));
<a name="l00451"></a>00451       <span class="keywordflow">break</span>;
<a name="l00452"></a>00452       <span class="keywordflow">case</span> 4:
<a name="l00453"></a>00453          <span class="comment">// JBE principle</span>
<a name="l00454"></a>00454          <span class="keywordflow">if</span> (clayParameter5&lt;=0.0)
<a name="l00455"></a>00455             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;&#39;ClayParameter5 must be above zero&quot;</span>);
<a name="l00456"></a>00456          b=(0.1+clayParameter5)/clayParameter5;
<a name="l00457"></a>00457          retVal = clayParameter5*b/(clay+clayParameter5);
<a name="l00458"></a>00458       <span class="keywordflow">break</span>;
<a name="l00459"></a>00459       <span class="keywordflow">case</span> 5:
<a name="l00460"></a>00460       <span class="keywordflow">case</span> 8:
<a name="l00461"></a>00461          <span class="comment">// Double principle March 2002. Model pools AOM1, AOM2, SMB1, SMB2, SMR, NOM, IOM.</span>
<a name="l00462"></a>00462          <span class="comment">// If responseType is 8, effect on total turnover like DAISY</span>
<a name="l00463"></a>00463          <span class="keywordflow">if</span> (clayParameter5&lt;=0.0)
<a name="l00464"></a>00464             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;&#39;ClayParameter5 must be above zero&quot;</span>);
<a name="l00465"></a>00465          <span class="keywordflow">if</span> (responseType==5)
<a name="l00466"></a>00466          {
<a name="l00467"></a>00467             b=(0.1+clayParameter5)/clayParameter5;
<a name="l00468"></a>00468             retVal=clayParameter5*b/(clay+clayParameter5);
<a name="l00469"></a>00469          }
<a name="l00470"></a>00470          <span class="keywordflow">else</span>
<a name="l00471"></a>00471          {
<a name="l00472"></a>00472             retVal=1.0-2.0*min(0.25,clay);
<a name="l00473"></a>00473             retVal=retVal/0.8; <span class="comment">// !!! To ensure unity at 10% clay !!!</span>
<a name="l00474"></a>00474          }
<a name="l00475"></a>00475          r1=<a class="code" href="classorganic_matter.html#a7f207a5cc9b81af56393be25209e0bde">GetTurnoverRatioSMB1</a>(0.1);
<a name="l00476"></a>00476          bio=(<a class="code" href="classbio_matter.html">bioMatter</a>*)<a class="code" href="classorganic_matter.html#a3c6a07a913e1f837f235329615787c22">GetPoolPointer</a>(<span class="stringliteral">&quot;SMB1&quot;</span>);
<a name="l00477"></a>00477          rCheck=bio-&gt;<a class="code" href="classbio_matter.html#ab2f5c9de1f2d2e7df6a98a51459a2175">GetTurnoverRatio</a>();
<a name="l00478"></a>00478          rCheck=fabs(r1/rCheck-1.0);
<a name="l00479"></a>00479          <span class="keywordflow">if</span> (rCheck&gt;0.02)
<a name="l00480"></a>00480             <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;Turnover rate for &#39;SMB1&#39; is inconsistent with clay function&quot;</span>);
<a name="l00481"></a>00481          bio-&gt;<a class="code" href="classbio_matter.html#a1ade505ad2c176aedbcf4b3e937eb412">SetParameterByName</a>(<span class="stringliteral">&quot;TurnoverRatio&quot;</span>,r1); <span class="comment">// Set exact value every time</span>
<a name="l00482"></a>00482          r2=GetRatio(<span class="stringliteral">&quot;SMB2&quot;</span>); <span class="comment">// GetR2</span>
<a name="l00483"></a>00483          E=GetE(<span class="stringliteral">&quot;SMB1&quot;</span>);
<a name="l00484"></a>00484          fSMB2=GetfSMB2();
<a name="l00485"></a>00485          h=clayParameter4*(1.85+1.6*exp(-7.86*clay));
<a name="l00486"></a>00486          h=1.0/(h+1.0);
<a name="l00487"></a>00487          <span class="keywordflow">if</span> (fSMB2&gt;1E-5)
<a name="l00488"></a>00488          {
<a name="l00489"></a>00489             s=r1*(1.0-fSMB2)*r1*(1.0-fSMB2)+4.0*h*r1*r2*fSMB2;
<a name="l00490"></a>00490             <span class="keywordflow">if</span> (s&lt;0.0)
<a name="l00491"></a>00491                <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::ClayEffect - illegal numerical operation attempted&quot;</span>);
<a name="l00492"></a>00492             s=sqrt(s);
<a name="l00493"></a>00493             clayEffect2=(s-r1*(1.0-fSMB2))/(2.0*E*r1*r2*fSMB2);
<a name="l00494"></a>00494          }
<a name="l00495"></a>00495          <span class="keywordflow">else</span>
<a name="l00496"></a>00496             clayEffect2=h/(E*r1);
<a name="l00497"></a>00497          <span class="keywordflow">if</span> (clayEffect2&lt;0.0)
<a name="l00498"></a>00498             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::ClayEffect - &#39;clayEffect2&#39; is negative&quot;</span>);
<a name="l00499"></a>00499          <span class="keywordflow">break</span>;
<a name="l00500"></a>00500       <span class="keywordflow">case</span> 6:
<a name="l00501"></a>00501          <span class="comment">// Double principle June 2002. Model pools AOM1, AOM2, SMB, NOM, IOM.</span>
<a name="l00502"></a>00502          <span class="keywordflow">if</span> (clayParameter5&lt;=0.0)
<a name="l00503"></a>00503             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;&#39;ClayParameter5 must be above zero&quot;</span>);
<a name="l00504"></a>00504          b=(0.1+clayParameter5)/clayParameter5;
<a name="l00505"></a>00505          retVal=clayParameter5*b/(clay+clayParameter5);
<a name="l00506"></a>00506          r=GetRatio(<span class="stringliteral">&quot;SMB&quot;</span>);
<a name="l00507"></a>00507          E=GetE(<span class="stringliteral">&quot;SMB&quot;</span>);
<a name="l00508"></a>00508          h=clayParameter4*(1.85+1.6*exp(-7.86*clay));
<a name="l00509"></a>00509          h=1.0/(h+1.0);
<a name="l00510"></a>00510          clayEffect2=h/(E*r);
<a name="l00511"></a>00511          <span class="keywordflow">if</span> (clayEffect2&lt;0.0)
<a name="l00512"></a>00512             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;container::ClayEffect - &#39;clayEffect2&#39; is negative&quot;</span>);
<a name="l00513"></a>00513       <span class="keywordflow">break</span>;
<a name="l00514"></a>00514       <span class="keywordflow">case</span> 7:
<a name="l00515"></a>00515          <span class="comment">// Double principle June 2002. Model pools AOM1, AOM2, SMB, SMR, NOM, IOM.</span>
<a name="l00516"></a>00516          <span class="keywordflow">if</span> (clayParameter5&lt;=0.0)
<a name="l00517"></a>00517             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;&#39;ClayParameter5 must be above zero&quot;</span>);
<a name="l00518"></a>00518          b=(0.1+clayParameter5)/clayParameter5;
<a name="l00519"></a>00519          retVal=clayParameter5*b/(clay+clayParameter5);
<a name="l00520"></a>00520          r=GetRatio(<span class="stringliteral">&quot;SMB&quot;</span>);
<a name="l00521"></a>00521          E=GetE(<span class="stringliteral">&quot;SMB&quot;</span>);
<a name="l00522"></a>00522          bio=(<a class="code" href="classbio_matter.html">bioMatter</a>*)<a class="code" href="classorganic_matter.html#a3c6a07a913e1f837f235329615787c22">GetPoolPointer</a>(<span class="stringliteral">&quot;SMB&quot;</span>);
<a name="l00523"></a>00523          fNOM=bio-&gt;<a class="code" href="classmatter.html#a97573040212b5ac7047a2cba344346d1">GetConnectionFraction</a>(<span class="stringliteral">&quot;NOM&quot;</span>);
<a name="l00524"></a>00524          h=clayParameter4*(1.85+1.6*exp(-7.86*clay));
<a name="l00525"></a>00525          h=1.0/(h+1.0);
<a name="l00526"></a>00526          <span class="keywordflow">if</span> (fNOM&gt;0.99)
<a name="l00527"></a>00527             clayEffect2=h/(E*r);
<a name="l00528"></a>00528          <span class="keywordflow">else</span>
<a name="l00529"></a>00529             <span class="keywordflow">if</span> (fNOM&gt;h)
<a name="l00530"></a>00530                clayEffect2=(fNOM*r+sqrt(fNOM*r*fNOM*r+4.0*h*fNOM*(1.0-fNOM)))/(2.0*E*(1.0-fNOM)*fNOM);
<a name="l00531"></a>00531             <span class="keywordflow">else</span>
<a name="l00532"></a>00532                clayEffect2=1000.0;
<a name="l00533"></a>00533          <span class="keywordflow">if</span> (clayEffect2&lt;0.0)
<a name="l00534"></a>00534             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;container::ClayEffect - &#39;clayEffect2&#39; is negative&quot;</span>);
<a name="l00535"></a>00535       <span class="keywordflow">break</span>;
<a name="l00536"></a>00536       <span class="keywordflow">case</span> 9:
<a name="l00537"></a>00537          <span class="comment">// Double principle December 2002. Model pools AOM1, AOM2, SMB1, SMB2, SMR, NOM, IOM.</span>
<a name="l00538"></a>00538          <span class="comment">// Effect on total turnover like DAISY, and unity at 0 % clay.</span>
<a name="l00539"></a>00539          <span class="keywordflow">if</span> (clayParameter5&lt;=0.0)
<a name="l00540"></a>00540             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;&#39;ClayParameter5 must be above zero&quot;</span>);
<a name="l00541"></a>00541          retVal=1.0-2.0*min(0.25,clay); <span class="comment">// Clay function taken from DAISY</span>
<a name="l00542"></a>00542          r1=<a class="code" href="classorganic_matter.html#a7f207a5cc9b81af56393be25209e0bde">GetTurnoverRatioSMB1</a>(0.0);
<a name="l00543"></a>00543          bio=(<a class="code" href="classbio_matter.html">bioMatter</a>*)<a class="code" href="classorganic_matter.html#a3c6a07a913e1f837f235329615787c22">GetPoolPointer</a>(<span class="stringliteral">&quot;SMB1&quot;</span>);
<a name="l00544"></a>00544          rCheck=bio-&gt;<a class="code" href="classbio_matter.html#ab2f5c9de1f2d2e7df6a98a51459a2175">GetTurnoverRatio</a>();
<a name="l00545"></a>00545          rCheck=fabs(r1/rCheck-1.0);
<a name="l00546"></a>00546          <span class="keywordflow">if</span> (rCheck&gt;0.02)
<a name="l00547"></a>00547          {
<a name="l00548"></a>00548             cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;Turnover rate for &#39;SMB1&#39; &quot;</span> &lt;&lt; bio-&gt;<a class="code" href="classbio_matter.html#ab2f5c9de1f2d2e7df6a98a51459a2175">GetTurnoverRatio</a>()
<a name="l00549"></a>00549                  &lt;&lt; <span class="stringliteral">&quot; inconsistent with clay function. New value set at &quot;</span> &lt;&lt; r1 &lt;&lt; endl;
<a name="l00550"></a>00550          }
<a name="l00551"></a>00551          bio-&gt;<a class="code" href="classbio_matter.html#a1ade505ad2c176aedbcf4b3e937eb412">SetParameterByName</a>(<span class="stringliteral">&quot;TurnoverRatio&quot;</span>,r1);
<a name="l00552"></a>00552          r2=GetRatio(<span class="stringliteral">&quot;SMB2&quot;</span>);
<a name="l00553"></a>00553          E=GetE(<span class="stringliteral">&quot;SMB1&quot;</span>);
<a name="l00554"></a>00554          fSMB2=GetfSMB2();
<a name="l00555"></a>00555          h=clayParameter4*(1.85+1.6*exp(clayParameter3*clay));
<a name="l00556"></a>00556          h=1.0/(h+1.0);
<a name="l00557"></a>00557          <span class="keywordflow">if</span> (fSMB2&gt;1E-5)
<a name="l00558"></a>00558          {
<a name="l00559"></a>00559             s=r1*(1.0-fSMB2)*r1*(1.0-fSMB2)+4.0*h*r1*r2*fSMB2;
<a name="l00560"></a>00560             <span class="keywordflow">if</span> (s&lt;0.0)
<a name="l00561"></a>00561                <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;container::ClayEffect - illegal numerical operation attempted&quot;</span>);
<a name="l00562"></a>00562             s=sqrt(s);
<a name="l00563"></a>00563             clayEffect2=(s-r1*(1.0-fSMB2))/(2.0*E*r1*r2*fSMB2);
<a name="l00564"></a>00564          }
<a name="l00565"></a>00565          <span class="keywordflow">else</span>
<a name="l00566"></a>00566             clayEffect2=h/(E*r1);
<a name="l00567"></a>00567          <span class="keywordflow">if</span> (clayEffect2&lt;0.0)
<a name="l00568"></a>00568             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;container::ClayEffect - &#39;clayEffect2&#39; is negative&quot;</span>);
<a name="l00569"></a>00569       <span class="keywordflow">break</span>;
<a name="l00570"></a>00570       <span class="keywordflow">default</span>:
<a name="l00571"></a>00571          <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Illegal state of clay effect type&quot;</span>);
<a name="l00572"></a>00572          <span class="keywordflow">break</span>;
<a name="l00573"></a>00573    }
<a name="l00574"></a>00574    <span class="keywordflow">return</span> retVal;
<a name="l00575"></a>00575 }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 <span class="comment">/****************************************************************************\</span>
<a name="l00578"></a>00578 <span class="comment">Returns the effect of temperature on processes</span>
<a name="l00579"></a>00579 <span class="comment">temp - Soil temperature [C]</span>
<a name="l00580"></a>00580 <span class="comment">responseType</span>
<a name="l00581"></a>00581 <span class="comment">   0 : Temperature response not used</span>
<a name="l00582"></a>00582 <span class="comment">   1 : Kirschbaum   - default adjusted to unity at 10 deg.</span>
<a name="l00583"></a>00583 <span class="comment">   2 : ROTHC</span>
<a name="l00584"></a>00584 <span class="comment">   3 : DAISY</span>
<a name="l00585"></a>00585 <span class="comment">   4 : Arrhenius    - default adjusted to unity at 10 deg.</span>
<a name="l00586"></a>00586 <span class="comment">   5 : Van&#39;t Hoff   - defualt adjusted to unity at 10 deg.</span>
<a name="l00587"></a>00587 <span class="comment">   6 : Value used directly</span>
<a name="l00588"></a>00588 <span class="comment">\****************************************************************************/</span>
<a name="l00589"></a>00589 <span class="keywordtype">double</span> organicMatter::TemperatureEffect(<span class="keywordtype">double</span> temp,<span class="keywordtype">int</span> responseType)
<a name="l00590"></a>00590 {
<a name="l00591"></a>00591    <span class="keywordflow">if</span> (temperatureEffect&gt;0.0)
<a name="l00592"></a>00592       <span class="keywordflow">return</span> temperatureEffect; <span class="comment">// Return &quot;fixed&quot; value, regardless of settings</span>
<a name="l00593"></a>00593    <span class="keywordtype">double</span> retVal=1.0;
<a name="l00594"></a>00594    <span class="keywordflow">switch</span> (responseType)
<a name="l00595"></a>00595    {
<a name="l00596"></a>00596       <span class="keywordflow">case</span> 0: <span class="comment">// Temperature response not used</span>
<a name="l00597"></a>00597          retVal=1.0;
<a name="l00598"></a>00598          <span class="keywordflow">break</span>;
<a name="l00599"></a>00599       <span class="keywordflow">case</span> 1: <span class="comment">// Kirschbaum</span>
<a name="l00600"></a>00600          <span class="keywordflow">if</span> (temperatureAdjust&lt;0)
<a name="l00601"></a>00601          { <span class="comment">// Adjust to give unity output at 10 deg.</span>
<a name="l00602"></a>00602             temperatureAdjust=1.0;
<a name="l00603"></a>00603             temperatureAdjust=1/TemperatureEffect(10.0,responseType);
<a name="l00604"></a>00604          }
<a name="l00605"></a>00605          retVal=temperatureAdjust*exp(Kirschbaum1+Kirschbaum2*temp*(1.0-0.5*temp/KirschbaumTopt));
<a name="l00606"></a>00606          <span class="keywordflow">break</span>;
<a name="l00607"></a>00607       <span class="keywordflow">case</span> 2: <span class="comment">// ROTHC</span>
<a name="l00608"></a>00608          retVal=0.0;
<a name="l00609"></a>00609          <span class="keywordflow">if</span> (temperatureAdjust&lt;0)
<a name="l00610"></a>00610             temperatureAdjust=1.0;
<a name="l00611"></a>00611          <span class="keywordflow">if</span> (temp&gt;-17) <span class="comment">// Theoretically -18.3, but return value is so low for -17 that this is choosen to avoid numerical problems</span>
<a name="l00612"></a>00612             retVal=temperatureAdjust*47.9/(1.0+exp(106.0/(temp+18.3)));
<a name="l00613"></a>00613          <span class="keywordflow">break</span>; <span class="comment">// To get almost exact matches with RothC, use parameters 106.058 &amp; 18.2715 instead. Don&#39;t know why.</span>
<a name="l00614"></a>00614       <span class="keywordflow">case</span> 3: <span class="comment">// DAISY</span>
<a name="l00615"></a>00615          retVal=0.0;
<a name="l00616"></a>00616          <span class="keywordflow">if</span> (temperatureAdjust&lt;0)
<a name="l00617"></a>00617             temperatureAdjust=1.0;
<a name="l00618"></a>00618          <span class="keywordflow">if</span> (temp&gt;0 &amp;&amp; temp&lt;=20)
<a name="l00619"></a>00619             retVal = 0.1*temperatureAdjust*temp;
<a name="l00620"></a>00620          <span class="keywordflow">if</span> (temp&gt;20)
<a name="l00621"></a>00621             retVal=temperatureAdjust*exp(0.47-0.027*temp+0.00193*temp*temp);
<a name="l00622"></a>00622          <span class="keywordflow">break</span>;
<a name="l00623"></a>00623       <span class="keywordflow">case</span> 4: <span class="comment">// Arrhenius</span>
<a name="l00624"></a>00624          <span class="keywordflow">if</span> (temperatureAdjust&lt;0)
<a name="l00625"></a>00625          { <span class="comment">// Adjust to give unity output at 10 deg.</span>
<a name="l00626"></a>00626             temperatureAdjust=1.0;
<a name="l00627"></a>00627             temperatureAdjust=1/TemperatureEffect(10.0,responseType);
<a name="l00628"></a>00628          }
<a name="l00629"></a>00629          retVal=temperatureAdjust*exp(Arrhenius*(temp-refT)/((refT+273.2)*(temp+273.2)));
<a name="l00630"></a>00630          <span class="keywordflow">break</span>;
<a name="l00631"></a>00631       <span class="keywordflow">case</span> 5: <span class="comment">// Van&#39;t Hoff</span>
<a name="l00632"></a>00632          <span class="keywordflow">if</span> (temperatureAdjust&lt;0)
<a name="l00633"></a>00633          { <span class="comment">// Adjust to give unity output at 10 deg.</span>
<a name="l00634"></a>00634             temperatureAdjust=1.0;
<a name="l00635"></a>00635             temperatureAdjust=1/TemperatureEffect(10.0,responseType);
<a name="l00636"></a>00636          }
<a name="l00637"></a>00637          retVal=temperatureAdjust*pow(VantHoffQ10,(temp-refT)/10.0);
<a name="l00638"></a>00638          <span class="keywordflow">break</span>;
<a name="l00639"></a>00639       <span class="keywordflow">case</span> 6: <span class="comment">// Value used directly</span>
<a name="l00640"></a>00640          retVal=temp;
<a name="l00641"></a>00641          <span class="keywordflow">break</span>;
<a name="l00642"></a>00642       <span class="keywordflow">default</span>:
<a name="l00643"></a>00643          <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Illegal state of temperature effect type&quot;</span>);
<a name="l00644"></a>00644          <span class="keywordflow">break</span>;
<a name="l00645"></a>00645    }
<a name="l00646"></a>00646    <span class="keywordflow">if</span> (retVal&lt;0.0)
<a name="l00647"></a>00647       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Temperature effect negative&quot;</span>);
<a name="l00648"></a>00648    <span class="keywordflow">return</span> retVal;
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="comment">/****************************************************************************\</span>
<a name="l00652"></a>00652 <span class="comment">Returns the effect of soil water status on soil organic matter turnover</span>
<a name="l00653"></a>00653 <span class="comment">Return value range 0-1</span>
<a name="l00654"></a>00654 <span class="comment">water - Soil water status</span>
<a name="l00655"></a>00655 <span class="comment">responseType</span>
<a name="l00656"></a>00656 <span class="comment">   0 : Water response not used</span>
<a name="l00657"></a>00657 <span class="comment">   1 : Like SOILN</span>
<a name="l00658"></a>00658 <span class="comment">   2 : Value used directly</span>
<a name="l00659"></a>00659 <span class="comment">\****************************************************************************/</span>
<a name="l00660"></a>00660 <span class="keywordtype">double</span> organicMatter::SoilWaterEffect(<span class="keywordtype">double</span> <a class="code" href="classwater.html" title="water class in fasset">water</a>,<span class="keywordtype">int</span> responseType)
<a name="l00661"></a>00661 {
<a name="l00662"></a>00662    <span class="keywordflow">if</span> (waterEffect&gt;0.0)
<a name="l00663"></a>00663       <span class="keywordflow">return</span> waterEffect; <span class="comment">// Return &quot;fixed&quot; value, regardless of settings</span>
<a name="l00664"></a>00664    <span class="keywordtype">double</span> f=1.0;
<a name="l00665"></a>00665    <span class="keywordflow">switch</span> (responseType)
<a name="l00666"></a>00666    {
<a name="l00667"></a>00667       <span class="keywordflow">case</span> 0: <span class="comment">// Water response not used</span>
<a name="l00668"></a>00668       {
<a name="l00669"></a>00669          f=1.0;
<a name="l00670"></a>00670          <span class="keywordflow">break</span>;
<a name="l00671"></a>00671       }
<a name="l00672"></a>00672       <span class="keywordflow">case</span> 1:
<a name="l00673"></a>00673       {
<a name="l00674"></a>00674          <span class="keywordflow">if</span> (W2Offset&lt;0)
<a name="l00675"></a>00675             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;W2Offset can not be negative (soil water function)&quot;</span>);
<a name="l00676"></a>00676          <span class="keywordflow">if</span> (W3Offset&gt;0)
<a name="l00677"></a>00677             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;W3Offset can not be positive (soil water function)&quot;</span>);
<a name="l00678"></a>00678          <span class="keywordtype">double</span> W2=W1+W2Offset;
<a name="l00679"></a>00679          <span class="keywordtype">double</span> W3=W4+W3Offset;
<a name="l00680"></a>00680          <span class="keywordflow">if</span> (W2&gt;W3)
<a name="l00681"></a>00681             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;W2 is larger than W3 (soil water function)&quot;</span>);
<a name="l00682"></a>00682          f = Y1;
<a name="l00683"></a>00683          <span class="keywordflow">if</span> (water&gt;W1)
<a name="l00684"></a>00684          {
<a name="l00685"></a>00685             f = 1.0;
<a name="l00686"></a>00686             <span class="keywordflow">if</span> (water&lt;=W2)
<a name="l00687"></a>00687                f = Y1+(1.0-Y1)*pow((water-W1)/(W2-W1),m);
<a name="l00688"></a>00688             <span class="keywordflow">if</span> (water&gt;W3)
<a name="l00689"></a>00689                f = 1.0-(1.0-Y2)*pow((water-W3)/(W4-W3),m);
<a name="l00690"></a>00690             f = max(0.0,f);
<a name="l00691"></a>00691          }
<a name="l00692"></a>00692          <span class="keywordflow">break</span>;
<a name="l00693"></a>00693       }
<a name="l00694"></a>00694       <span class="keywordflow">case</span> 2: <span class="comment">// Value used directly</span>
<a name="l00695"></a>00695       {
<a name="l00696"></a>00696          f=max(0.0,water);
<a name="l00697"></a>00697          <span class="keywordflow">break</span>;
<a name="l00698"></a>00698       }
<a name="l00699"></a>00699       <span class="keywordflow">default</span>:
<a name="l00700"></a>00700          <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Illegal state of water effect type&quot;</span>);
<a name="l00701"></a>00701          <span class="keywordflow">break</span>;
<a name="l00702"></a>00702    }
<a name="l00703"></a>00703    <span class="keywordflow">if</span> (f&lt;0.0)
<a name="l00704"></a>00704       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Water effect negative&quot;</span>);
<a name="l00705"></a>00705    <span class="keywordflow">return</span> f;
<a name="l00706"></a>00706 }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708 <span class="comment">/****************************************************************************\</span>
<a name="l00709"></a>00709 <span class="comment">Returns a pointer to a given pool</span>
<a name="l00710"></a>00710 <span class="comment">poolName - name of pool for which a pointer is requested</span>
<a name="l00711"></a>00711 <span class="comment">\****************************************************************************/</span>
<a name="l00712"></a><a class="code" href="classorganic_matter.html#a3c6a07a913e1f837f235329615787c22">00712</a> <a class="code" href="classmatter.html">matter</a> * <a class="code" href="classorganic_matter.html#a3c6a07a913e1f837f235329615787c22">organicMatter::GetPoolPointer</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * poolName)
<a name="l00713"></a>00713 {
<a name="l00714"></a>00714    <span class="keywordtype">int</span> j=-1;
<a name="l00715"></a>00715    <span class="keywordflow">if</span> (strcmp(poolName,<span class="stringliteral">&quot;CO2&quot;</span>)==0)
<a name="l00716"></a>00716       <span class="keywordflow">return</span> NULL;
<a name="l00717"></a>00717    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)
<a name="l00718"></a>00718       <span class="keywordflow">if</span> (strcmp(poolName,poolList[i]-&gt;GetPoolName())==0)
<a name="l00719"></a>00719       {
<a name="l00720"></a>00720          j=i;
<a name="l00721"></a>00721          <span class="keywordflow">break</span>;
<a name="l00722"></a>00722       }
<a name="l00723"></a>00723    <span class="keywordflow">if</span> (j==-1)
<a name="l00724"></a>00724       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Pool [&quot;</span>,poolName,<span class="stringliteral">&quot;] not found&quot;</span>);
<a name="l00725"></a>00725    <span class="keywordflow">return</span> poolList[j];
<a name="l00726"></a>00726 }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728 <span class="comment">/****************************************************************************\</span>
<a name="l00729"></a>00729 <span class="comment">\****************************************************************************/</span>
<a name="l00730"></a><a class="code" href="classorganic_matter.html#a88b256f650c79221267c4d688f41f948">00730</a> <a class="code" href="classcn_matter.html">cnMatter</a> <a class="code" href="classorganic_matter.html#a88b256f650c79221267c4d688f41f948">organicMatter::GetCarbonInPool</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * s)
<a name="l00731"></a>00731 {
<a name="l00732"></a>00732    <span class="keywordflow">return</span> <a class="code" href="classorganic_matter.html#a3c6a07a913e1f837f235329615787c22">GetPoolPointer</a>(s)-&gt;<a class="code" href="classmatter.html#ae85f8f64ea546c5cbe056c641304b514">GetCarbon</a>();
<a name="l00733"></a>00733 }
<a name="l00734"></a>00734 
<a name="l00735"></a>00735 
<a name="l00736"></a>00736 <span class="comment">/****************************************************************************\</span>
<a name="l00737"></a>00737 <span class="comment">\****************************************************************************/</span>
<a name="l00738"></a><a class="code" href="classorganic_matter.html#a29e2ca4f26cf2ee55fc1ca49a9b9f8ff">00738</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#a29e2ca4f26cf2ee55fc1ca49a9b9f8ff">organicMatter::SetCarbonInPool</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * s,<a class="code" href="classcn_matter.html">cnMatter</a> c)
<a name="l00739"></a>00739 {
<a name="l00740"></a>00740    <a class="code" href="classorganic_matter.html#a3c6a07a913e1f837f235329615787c22">GetPoolPointer</a>(s)-&gt;<a class="code" href="classmatter.html#a6ede9887bd438658b4833d1242d8e2a7">SetCarbon</a>(c);
<a name="l00741"></a>00741 }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 
<a name="l00745"></a>00745 
<a name="l00746"></a>00746 
<a name="l00747"></a>00747 
<a name="l00748"></a>00748 <span class="comment">/****************************************************************************\</span>
<a name="l00749"></a>00749 <span class="comment">\****************************************************************************/</span>
<a name="l00750"></a>00750 <span class="keywordtype">double</span> organicMatter::GetFractionFromdelta(<span class="keywordtype">double</span> delta)
<a name="l00751"></a>00751 {
<a name="l00752"></a>00752    <span class="keywordtype">double</span> retVal;
<a name="l00753"></a>00753    <span class="keywordflow">if</span> (Rzs&gt;1E-6)
<a name="l00754"></a>00754    {
<a name="l00755"></a>00755       <span class="keywordtype">double</span> Rzi=Rzs+(Rzs*delta)/1000.0;
<a name="l00756"></a>00756       retVal=(Rzi+Rzi*Rzs)/(Rzs+Rzs*Rzi);
<a name="l00757"></a>00757    }
<a name="l00758"></a>00758    <span class="keywordflow">else</span>
<a name="l00759"></a>00759       retVal=(delta+1000.0)/1000.0;
<a name="l00760"></a>00760    <span class="keywordflow">return</span> retVal;
<a name="l00761"></a>00761 }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763 <span class="comment">/****************************************************************************\</span>
<a name="l00764"></a>00764 <span class="comment">\****************************************************************************/</span>
<a name="l00765"></a>00765 <span class="keywordtype">double</span> organicMatter::FromAtomExecessToInternal(<span class="keywordtype">double</span> excess)
<a name="l00766"></a>00766 {
<a name="l00767"></a>00767    <span class="keywordflow">return</span> (excess+0.3663033)/100.0;
<a name="l00768"></a>00768 }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770 <span class="comment">/****************************************************************************\</span>
<a name="l00771"></a>00771 <span class="comment">\****************************************************************************/</span>
<a name="l00772"></a>00772 <span class="keywordtype">void</span> organicMatter::SetFractionation(<a class="code" href="classorganic_product.html">organicProduct</a> * prod)
<a name="l00773"></a>00773 {
<a name="l00774"></a>00774    <span class="keywordtype">double</span> pc,pn,nc,fAOM2;
<a name="l00775"></a>00775    <span class="keywordtype">int</span> n=prod-&gt;<a class="code" href="classorganic_product.html#a8901cf7bada2bbba03698a61ba213ea4">GetNumOfFractions</a>();
<a name="l00776"></a>00776    <span class="keywordtype">double</span> fsum=0.0;
<a name="l00777"></a>00777    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;n;i++)
<a name="l00778"></a>00778       fsum+=prod-&gt;<a class="code" href="classorganic_product.html#a8017dbe0d08fdbc603c7e66c1aad6bb7">GetCFraction</a>(i);
<a name="l00779"></a>00779    <span class="keywordflow">if</span> (fsum&lt;0.9999 &amp;&amp; prod-&gt;GetAmount().c&gt;0.0)
<a name="l00780"></a>00780    {  <span class="comment">// Fractions have no default value, set according to N/C ratio</span>
<a name="l00781"></a>00781       <span class="comment">// Assumed to have AOM1 (0) and AOM2 (1), AOM2 beeing the easily decomposable</span>
<a name="l00782"></a>00782       pc=prod-&gt;<a class="code" href="classorganic_product.html#acf7568317f8ce00b6073eda432ba7483">GetAmount</a>().<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l00783"></a>00783       pn=prod-&gt;<a class="code" href="classorganic_product.html#acf7568317f8ce00b6073eda432ba7483">GetAmount</a>().<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>;
<a name="l00784"></a>00784       nc=pn/pc;
<a name="l00785"></a>00785       fAOM2=ncIntercept+ncSlope*nc;
<a name="l00786"></a>00786       fAOM2=max(0.0,min(maxAOM2,fAOM2));
<a name="l00787"></a>00787       prod-&gt;<a class="code" href="classorganic_product.html#ae6f2c4cfc006067ed21baa50e8e3c4db">SetCFraction</a>(0,1.0-fAOM2);
<a name="l00788"></a>00788       prod-&gt;<a class="code" href="classorganic_product.html#ae6f2c4cfc006067ed21baa50e8e3c4db">SetCFraction</a>(1,fAOM2);
<a name="l00789"></a>00789       prod-&gt;<a class="code" href="classorganic_product.html#a3442bd238770ac98b17b88b6a7939a51">SetNFraction</a>(0,1.0-fAOM2); <span class="comment">// No method for N fractionation decided yet !!!</span>
<a name="l00790"></a>00790       prod-&gt;<a class="code" href="classorganic_product.html#a3442bd238770ac98b17b88b6a7939a51">SetNFraction</a>(1,fAOM2);
<a name="l00791"></a>00791    }
<a name="l00792"></a>00792 }
<a name="l00793"></a>00793 
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 <span class="comment">/****************************************************************************\</span>
<a name="l00796"></a>00796 <span class="comment">Updates CO2 emmision variables</span>
<a name="l00797"></a>00797 <span class="comment">co2 - CO2-C emmision</span>
<a name="l00798"></a>00798 <span class="comment">\****************************************************************************/</span>
<a name="l00799"></a><a class="code" href="classorganic_matter.html#af8da4028cf9d47ffff40198537947652">00799</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#af8da4028cf9d47ffff40198537947652">organicMatter::CO2emmision</a>(<a class="code" href="classcn_matter.html">cnMatter</a> co2)
<a name="l00800"></a>00800 {
<a name="l00801"></a>00801 
<a name="l00802"></a>00802    todayCO2=todayCO2+co2;
<a name="l00803"></a>00803 }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805 <span class="comment">/****************************************************************************\</span>
<a name="l00806"></a>00806 <span class="comment">\****************************************************************************/</span>
<a name="l00807"></a><a class="code" href="classorganic_matter.html#ab31c08dc89717cfc1d1e212c4076ff3c">00807</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#ab31c08dc89717cfc1d1e212c4076ff3c">organicMatter::SetMineralNitrogen</a>(<a class="code" href="classnitrogen.html">nitrogen</a> nitrate,<a class="code" href="classnitrogen.html">nitrogen</a> ammonium)
<a name="l00808"></a>00808 {
<a name="l00809"></a>00809    <span class="keywordflow">if</span> (NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-12 || NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-12)
<a name="l00810"></a>00810       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::SetMineralNitrogen - negative value for mineral nitrogen&quot;</span>);
<a name="l00811"></a>00811    NH4=ammonium;
<a name="l00812"></a>00812    NO3=nitrate;
<a name="l00813"></a>00813 }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815 <span class="comment">/****************************************************************************\</span>
<a name="l00816"></a>00816 <span class="comment">\****************************************************************************/</span>
<a name="l00817"></a><a class="code" href="classorganic_matter.html#a08fafc2497f2ef975d24ed944a7fe39d">00817</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#a08fafc2497f2ef975d24ed944a7fe39d">organicMatter::GetMineralNitrogen</a>(<a class="code" href="classnitrogen.html">nitrogen</a> &amp;nitrate,<a class="code" href="classnitrogen.html">nitrogen</a> &amp;ammonium)
<a name="l00818"></a>00818 {
<a name="l00819"></a>00819    ammonium=NH4;
<a name="l00820"></a>00820    nitrate=NO3;
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 <span class="comment">/*********************************************h*******************************\</span>
<a name="l00824"></a>00824 <span class="comment">A comparatively crude mimic of the indirect-MIT theory</span>
<a name="l00825"></a>00825 <span class="comment">\****************************************************************************/</span>
<a name="l00826"></a><a class="code" href="classorganic_matter.html#a72ff536fcbc069deadb4f136080becbb">00826</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#a72ff536fcbc069deadb4f136080becbb">organicMatter::EquilibrateN15</a>(<a class="code" href="classcn_matter.html">cnMatter</a> &amp; c)
<a name="l00827"></a>00827 {
<a name="l00828"></a>00828    <span class="keywordflow">if</span> (c.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>&gt;1E-36 &amp;&amp; NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;1E-36)
<a name="l00829"></a>00829    {
<a name="l00830"></a>00830       <span class="keywordtype">double</span> q=(c.<a class="code" href="classcn_matter.html#a80822025457f202cd4199fb4a1a61ded">n15</a>+NH4.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>)/(c.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>+NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l00831"></a>00831       NH4.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>=NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>*q;
<a name="l00832"></a>00832       c.<a class="code" href="classcn_matter.html#a80822025457f202cd4199fb4a1a61ded">n15</a>=c.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>*q;
<a name="l00833"></a>00833    }
<a name="l00834"></a>00834 }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836 <span class="comment">/****************************************************************************\</span>
<a name="l00837"></a>00837 <span class="comment">\****************************************************************************/</span>
<a name="l00838"></a><a class="code" href="classorganic_matter.html#a43dda8881019ddfe13875940264505cb">00838</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#a43dda8881019ddfe13875940264505cb">organicMatter::ExchangeNitrogen</a>(<a class="code" href="classnitrogen.html">nitrogen</a> * nit)
<a name="l00839"></a>00839 {
<a name="l00840"></a>00840         <span class="keywordflow">if</span> ((NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)&lt;-nit-&gt;<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)
<a name="l00841"></a>00841       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::ExchangeNitrogen - total mineral N content below zero&quot;</span>);
<a name="l00842"></a>00842    <span class="keywordflow">if</span> (NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-9)
<a name="l00843"></a>00843       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::ExchangeNitrogen - NH4 content below zero&quot;</span>);
<a name="l00844"></a>00844    <span class="keywordflow">if</span> (NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-9)
<a name="l00845"></a>00845       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::ExchangeNitrogen - NO3 content below zero&quot;</span>);
<a name="l00846"></a>00846    <span class="keywordflow">if</span> (nit-&gt;<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;0)
<a name="l00847"></a>00847    {  <span class="comment">// Imobilisation</span>
<a name="l00848"></a>00848       <span class="keywordtype">double</span> f=1.0;
<a name="l00849"></a>00849       <span class="keywordtype">double</span> ntot=max(0.0,NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>-NH4allwaysLeft)+NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>;
<a name="l00850"></a>00850       <span class="keywordflow">if</span> (NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;=NH4allwaysLeft)
<a name="l00851"></a>00851          f=0.0;
<a name="l00852"></a>00852       <span class="keywordflow">else</span>
<a name="l00853"></a>00853       {
<a name="l00854"></a>00854          <span class="keywordflow">if</span> (NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0.0 &amp;&amp; !exclusivePreferenceNH4)
<a name="l00855"></a>00855             f=(NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>/ntot)/(beta+(1.0-beta)*NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>/ntot); <span class="comment">// Langmuir equation</span>
<a name="l00856"></a>00856          f=min(f,max(0.0,NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>-NH4allwaysLeft)/(-nit-&gt;<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>));
<a name="l00857"></a>00857       }
<a name="l00858"></a>00858       <span class="keywordflow">if</span> (f&lt;0.0)
<a name="l00859"></a>00859          f=0.0;
<a name="l00860"></a>00860       <span class="keywordflow">if</span> (f&gt;1.0)
<a name="l00861"></a>00861          f=1.0;
<a name="l00862"></a>00862       <span class="keywordflow">if</span> (f&lt;0.0 || f &gt;1.0)
<a name="l00863"></a>00863       {
<a name="l00864"></a>00864          cout &lt;&lt; f &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a> &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; nit-&gt;<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a> &lt;&lt; endl;
<a name="l00865"></a>00865          <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::ExchangeNitrogen - f must be in the range [0;1]&quot;</span>);
<a name="l00866"></a>00866       }
<a name="l00867"></a>00867       <a class="code" href="classnitrogen.html">nitrogen</a> fromNH4=*nit*f;
<a name="l00868"></a>00868       <a class="code" href="classnitrogen.html">nitrogen</a> fromNO3=*nit*(1.0-f);
<a name="l00869"></a>00869 
<a name="l00870"></a>00870       <span class="keywordtype">double</span> f1=0.0; <span class="comment">// From &quot;near&quot; NH4 pool</span>
<a name="l00871"></a>00871       <span class="keywordflow">if</span> (NH4near.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;1E-9)
<a name="l00872"></a>00872       {
<a name="l00873"></a>00873          <span class="keywordflow">if</span> (NH4near.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;=-fromNH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)
<a name="l00874"></a>00874             f1=1.0;
<a name="l00875"></a>00875          <span class="keywordflow">else</span>
<a name="l00876"></a>00876             f1=NH4near.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>/(-fromNH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l00877"></a>00877       }
<a name="l00878"></a>00878       fromNH4.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>=0.0;
<a name="l00879"></a>00879       <span class="keywordflow">if</span> (NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;1E-15)
<a name="l00880"></a>00880       {   <span class="keywordflow">if</span> (NH4near.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;1E-9 &amp;&amp; (NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>-NH4near.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)&gt;1E-9)
<a name="l00881"></a>00881             fromNH4.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>=fromNH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>*((1.0-f1)*(NH4.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>-NH4near.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>)/(NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>-NH4near.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)+f1*NH4near.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>/NH4near.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l00882"></a>00882          <span class="keywordflow">else</span>
<a name="l00883"></a>00883             fromNH4.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>=fromNH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>*NH4.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>/NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>;
<a name="l00884"></a>00884       }
<a name="l00885"></a>00885       fromNO3.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>=0.0;
<a name="l00886"></a>00886       <span class="keywordflow">if</span> (NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;1E-15)
<a name="l00887"></a>00887          fromNO3.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>=fromNO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>*NO3.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>/NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>;
<a name="l00888"></a>00888       NH4=NH4+fromNH4;
<a name="l00889"></a>00889       NH4near.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>=max(0.0,NH4near.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+fromNH4.n);
<a name="l00890"></a>00890       NH4near.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>=max(0.0,NH4near.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+fromNH4.n15);
<a name="l00891"></a>00891       NO3=NO3+fromNO3;
<a name="l00892"></a>00892       <span class="keywordflow">if</span> (NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-9)
<a name="l00893"></a>00893         <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::ExchangeNitrogen - NO3 content below zero&quot;</span>);
<a name="l00894"></a>00894       nit-&gt;<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>=fromNH4.n15+fromNO3.n15;
<a name="l00895"></a>00895    }
<a name="l00896"></a>00896    <span class="keywordflow">else</span> <span class="comment">// Mineralisation</span>
<a name="l00897"></a>00897    {
<a name="l00898"></a>00898       NH4=NH4+*nit;
<a name="l00899"></a>00899       NH4near=NH4near+*nit;
<a name="l00900"></a>00900    }
<a name="l00901"></a>00901 
<a name="l00902"></a>00902    <span class="keywordflow">if</span> (NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-9)
<a name="l00903"></a>00903       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::ExchangeNitrogen - NH4 content below zero&quot;</span>);
<a name="l00904"></a>00904    <span class="keywordflow">if</span> (NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-9)
<a name="l00905"></a>00905       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::ExchangeNitrogen - NO3 content below zero&quot;</span>);
<a name="l00906"></a>00906 }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908 <span class="comment">/****************************************************************************\</span>
<a name="l00909"></a>00909 <span class="comment">Returns the total amount of carbon and nitrogen in the whole system</span>
<a name="l00910"></a>00910 <span class="comment">\****************************************************************************/</span>
<a name="l00911"></a><a class="code" href="classorganic_matter.html#a0796a73dd50dd9cf1d97bf8a5de3d3a4">00911</a> <a class="code" href="classcn_matter.html">cnMatter</a> <a class="code" href="classorganic_matter.html#a0796a73dd50dd9cf1d97bf8a5de3d3a4">organicMatter::GetTotalSystem</a>()
<a name="l00912"></a>00912 {
<a name="l00913"></a>00913    <a class="code" href="classcn_matter.html">cnMatter</a> retval;
<a name="l00914"></a>00914    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)
<a name="l00915"></a>00915       retval=retval+poolList[i]-&gt;<a class="code" href="classorganic_matter.html#a5b3f9588dde6550e0311a13cf5fe50f5">GetCarbon</a>();
<a name="l00916"></a>00916    retval.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>+=NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>;
<a name="l00917"></a>00917    retval.<a class="code" href="classcn_matter.html#a80822025457f202cd4199fb4a1a61ded">n15</a>+=NH4.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+NO3.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>;
<a name="l00918"></a>00918    <span class="keywordflow">return</span> retval;
<a name="l00919"></a>00919 }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921 <span class="comment">/****************************************************************************\</span>
<a name="l00922"></a>00922 <span class="comment">Returns the total amount of carbon and nitrogen in all the soil pools</span>
<a name="l00923"></a>00923 <span class="comment">\****************************************************************************/</span>
<a name="l00924"></a><a class="code" href="classorganic_matter.html#ae19830c90a2f172ede6a81e778c98d32">00924</a> <a class="code" href="classcn_matter.html">cnMatter</a> <a class="code" href="classorganic_matter.html#ae19830c90a2f172ede6a81e778c98d32">organicMatter::GetTotalCarbon</a>()
<a name="l00925"></a>00925 {
<a name="l00926"></a>00926    <a class="code" href="classcn_matter.html">cnMatter</a> retval;
<a name="l00927"></a>00927    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)
<a name="l00928"></a>00928    {
<a name="l00929"></a>00929       retval=retval+poolList[i]-&gt;<a class="code" href="classmatter.html#ae85f8f64ea546c5cbe056c641304b514">GetCarbon</a>();
<a name="l00930"></a>00930 
<a name="l00931"></a>00931    }
<a name="l00932"></a>00932    <span class="keywordflow">return</span> retval;
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935 <span class="comment">/****************************************************************************\</span>
<a name="l00936"></a>00936 <span class="comment">Initializes the organic pool object</span>
<a name="l00937"></a>00937 <span class="comment"> clay       - Clay content of soil layer [fraction]</span>
<a name="l00938"></a>00938 <span class="comment"> carbon     - C content of layer [g/m2]</span>
<a name="l00939"></a>00939 <span class="comment"> f          - Parameter file</span>
<a name="l00940"></a>00940 <span class="comment">\****************************************************************************/</span>
<a name="l00941"></a><a class="code" href="classorganic_matter.html#af7bf4f5a06da9f6c4977c56d1bbb17ef">00941</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#af7bf4f5a06da9f6c4977c56d1bbb17ef">organicMatter::Initialize</a>(<span class="keywordtype">double</span> clay,
<a name="l00942"></a>00942                                <span class="keywordtype">double</span> carbon,
<a name="l00943"></a>00943                                                                                  fstream * f,
<a name="l00944"></a>00944                                <span class="keywordtype">int</span> index,
<a name="l00945"></a>00945                                <span class="keywordtype">char</span> * modelFileName)
<a name="l00946"></a>00946 {
<a name="l00947"></a>00947    clayContent=clay;
<a name="l00948"></a>00948    <span class="keywordtype">double</span> TotalC=carbon;
<a name="l00949"></a>00949    <a class="code" href="classorganic_matter.html#a571a15d4863954c5f1f2adbaca71e9bf">InitStructure</a>(modelFileName);
<a name="l00950"></a>00950    <a class="code" href="classbase.html#a3cb378050dc4ced8420f41dcd7292239">Setfile</a>(f);
<a name="l00951"></a>00951    <span class="keywordflow">if</span> (<a class="code" href="classbase.html#a88e41ff60ffb7e707312a09f20457e73">FindSection</a>(<span class="stringliteral">&quot;SoilLayer&quot;</span>,index)) <span class="comment">// Top of inheritance hierarcy</span>
<a name="l00952"></a>00952    {
<a name="l00953"></a>00953       <span class="keywordflow">if</span> (Isotope==2) <span class="comment">// 14C</span>
<a name="l00954"></a>00954          Rzs=0.0;
<a name="l00955"></a>00955       <span class="keywordtype">double</span> checkSum=0.0;
<a name="l00956"></a>00956       <span class="keywordtype">double</span> cnRatio=11;
<a name="l00957"></a>00957       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;CNRatio&quot;</span>,&amp;cnRatio);
<a name="l00958"></a>00958       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;MinContent&quot;</span>,&amp;W1);
<a name="l00959"></a>00959       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;MaxContent&quot;</span>,&amp;W4);
<a name="l00960"></a>00960       <span class="keywordtype">double</span> d=0.0;
<a name="l00961"></a>00961       <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;NH4&quot;</span>,&amp;d))
<a name="l00962"></a>00962          NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>=d;
<a name="l00963"></a>00963       <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;NH4.N15&quot;</span>,&amp;d))
<a name="l00964"></a>00964          NH4.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>=NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>*FromAtomExecessToInternal(d);
<a name="l00965"></a>00965       <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;NO3&quot;</span>,&amp;d))
<a name="l00966"></a>00966          NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>=d;
<a name="l00967"></a>00967       <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;NO3.N15&quot;</span>,&amp;d))
<a name="l00968"></a>00968          NO3.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>=NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>*FromAtomExecessToInternal(d);
<a name="l00969"></a>00969       d=0.0;
<a name="l00970"></a>00970       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)
<a name="l00971"></a>00971       {
<a name="l00972"></a>00972          poolList[i]-&gt;<a class="code" href="classmatter.html#a56ffe81f49ab5d79f47cc71ece13a48a">SetIsotope</a>(Isotope);
<a name="l00973"></a>00973          <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(poolList[i]-&gt;GetPoolName(),&amp;d))
<a name="l00974"></a>00974          {
<a name="l00975"></a>00975             <a class="code" href="classcn_matter.html">cnMatter</a> c;
<a name="l00976"></a>00976             c.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>=d*TotalC;
<a name="l00977"></a>00977             checkSum+=d;
<a name="l00978"></a>00978             <span class="keywordflow">if</span> (Isotope==1) <span class="comment">// 13 C</span>
<a name="l00979"></a>00979             {
<a name="l00980"></a>00980                <span class="keywordtype">char</span> s[250];
<a name="l00981"></a>00981                strcpy(s,poolList[i]-&gt;GetPoolName());
<a name="l00982"></a>00982                strcat(s,<span class="stringliteral">&quot;.d13C&quot;</span>);
<a name="l00983"></a>00983                <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(s,&amp;d))
<a name="l00984"></a>00984                {
<a name="l00985"></a>00985                   <span class="keywordflow">if</span> (d&gt;=-1000.0)
<a name="l00986"></a>00986                      c.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>=GetFractionFromdelta(d)*c.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l00987"></a>00987                   <span class="keywordflow">else</span>
<a name="l00988"></a>00988                      <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;delta value for carbon-13 in file is below -1000&quot;</span>);
<a name="l00989"></a>00989                }
<a name="l00990"></a>00990                <span class="keywordflow">else</span>
<a name="l00991"></a>00991                   c.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>=c.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l00992"></a>00992             }
<a name="l00993"></a>00993             <span class="keywordflow">if</span> (Isotope==2) <span class="comment">// 14 C</span>
<a name="l00994"></a>00994             {
<a name="l00995"></a>00995                 <span class="keywordtype">char</span> s[250];
<a name="l00996"></a>00996                 strcpy(s,poolList[i]-&gt;GetPoolName());
<a name="l00997"></a>00997                 strcat(s,<span class="stringliteral">&quot;.PM&quot;</span>);
<a name="l00998"></a>00998                <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(s,&amp;d))
<a name="l00999"></a>00999                {
<a name="l01000"></a>01000                   <span class="keywordflow">if</span> (d&gt;=0.0)
<a name="l01001"></a>01001                      c.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>=c.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>*d/100.0;
<a name="l01002"></a>01002                   <span class="keywordflow">else</span>
<a name="l01003"></a>01003                      <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Percent modern for carbon-14 in file is below zero&quot;</span>);
<a name="l01004"></a>01004                }
<a name="l01005"></a>01005                <span class="keywordflow">else</span>
<a name="l01006"></a>01006                {
<a name="l01007"></a>01007 ;
<a name="l01008"></a>01008                   strcpy(s,poolList[i]-&gt;GetPoolName());
<a name="l01009"></a>01009                   strcat(s,<span class="stringliteral">&quot;.d14C&quot;</span>);
<a name="l01010"></a>01010                   <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(s,&amp;d))
<a name="l01011"></a>01011                   {
<a name="l01012"></a>01012                      <span class="keywordflow">if</span> (d&gt;=-1000.0)
<a name="l01013"></a>01013                         c.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>=GetFractionFromdelta(d)*c.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l01014"></a>01014                      <span class="keywordflow">else</span>
<a name="l01015"></a>01015                         <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;delta value for carbon-14 in file is below -1000&quot;</span>);
<a name="l01016"></a>01016                   }
<a name="l01017"></a>01017                   <span class="keywordflow">else</span>
<a name="l01018"></a>01018                      c.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>=c.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l01019"></a>01019                }
<a name="l01020"></a>01020             }
<a name="l01021"></a>01021             <span class="keywordflow">if</span> (Isotope==3) <span class="comment">// Tagging</span>
<a name="l01022"></a>01022             {
<a name="l01023"></a>01023 
<a name="l01024"></a>01024                 <span class="keywordtype">char</span> s[250];
<a name="l01025"></a>01025                 strcpy(s,poolList[i]-&gt;GetPoolName());
<a name="l01026"></a>01026                 strcat(s,<span class="stringliteral">&quot;.TAG&quot;</span>);
<a name="l01027"></a>01027                <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(s,&amp;d))
<a name="l01028"></a>01028                {
<a name="l01029"></a>01029                   <span class="keywordflow">if</span> (d&gt;=0.0 &amp;&amp; d&lt;=1.0)
<a name="l01030"></a>01030                      c.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>=d*c.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l01031"></a>01031                   <span class="keywordflow">else</span>
<a name="l01032"></a>01032                      <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;TAG value in file must be between zero and one&quot;</span>);
<a name="l01033"></a>01033                }
<a name="l01034"></a>01034                <span class="keywordflow">else</span>
<a name="l01035"></a>01035                   c.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>=0.0;
<a name="l01036"></a>01036             }
<a name="l01037"></a>01037             <span class="keywordtype">char</span> s[250];
<a name="l01038"></a>01038             strcpy(s,poolList[i]-&gt;GetPoolName());
<a name="l01039"></a>01039             strcat(s,<span class="stringliteral">&quot;.N&quot;</span>);
<a name="l01040"></a>01040             <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(s,&amp;d))
<a name="l01041"></a>01041             {
<a name="l01042"></a>01042 <span class="comment">//             if (poolList[i]-&gt;GetCNratio()&gt;0 &amp;&amp; !poolList[i]-&gt;IsBiomass())</span>
<a name="l01043"></a>01043 <span class="comment">//                Terminate(&quot;Can not set N content in &#39;&quot;,(char*)poolList[i]-&gt;GetPoolName().c_str(),&quot;&#39; as this pool has a fixed C/N ratio&quot;);</span>
<a name="l01044"></a>01044                c.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>=d*TotalC;
<a name="l01045"></a>01045             }
<a name="l01046"></a>01046             <span class="keywordflow">else</span>
<a name="l01047"></a>01047             {
<a name="l01048"></a>01048                <span class="keywordtype">double</span> r=poolList[i]-&gt;<a class="code" href="classmatter.html#a96b0fe568fcecda260abc0a5d32ca3da">GetDefaultCNratio</a>();
<a name="l01049"></a>01049                <span class="keywordflow">if</span> (r&lt;=0 &amp;&amp; c.c&gt;1E-9)
<a name="l01050"></a>01050                   <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;C/N ratio must be set for pool &#39;&quot;</span>,poolList[i]-&gt;GetPoolName());
<a name="l01051"></a>01051                <span class="keywordflow">if</span> (r&gt;0)
<a name="l01052"></a>01052                   c.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>=c.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>/r;
<a name="l01053"></a>01053             }
<a name="l01054"></a>01054             strcpy(s,poolList[i]-&gt;GetPoolName());
<a name="l01055"></a>01055             strcat(s,<span class="stringliteral">&quot;.N15&quot;</span>);
<a name="l01056"></a>01056             <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(s,&amp;d))
<a name="l01057"></a>01057                c.<a class="code" href="classcn_matter.html#a80822025457f202cd4199fb4a1a61ded">n15</a>=c.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>*FromAtomExecessToInternal(d);
<a name="l01058"></a>01058             poolList[i]-&gt;<a class="code" href="classmatter.html#a6ede9887bd438658b4833d1242d8e2a7">SetCarbon</a>(c);
<a name="l01059"></a>01059          }
<a name="l01060"></a>01060       }
<a name="l01061"></a>01061       <span class="keywordflow">if</span> (fabs(1.0-checkSum)&gt;1E-3)
<a name="l01062"></a>01062          <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::Initialise - Pool carbon fractions do not add to one.&quot;</span>);
<a name="l01063"></a>01063       <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ClayContent&quot;</span>,&amp;clayContent))
<a name="l01064"></a>01064       {
<a name="l01065"></a>01065          <span class="keywordflow">if</span> (clayContent&gt;1.0)
<a name="l01066"></a>01066             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Clay fraction can not be bigger than one.&quot;</span>);
<a name="l01067"></a>01067          clayEffect1=ClayEffect(clayContent,ClayResponseType);
<a name="l01068"></a>01068       }
<a name="l01069"></a>01069       <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ClayEffect&quot;</span>,&amp;clayEffect1)) <span class="comment">// Overwrites clay content</span>
<a name="l01070"></a>01070          <span class="keywordflow">if</span> (clayEffect1&lt;0.0)
<a name="l01071"></a>01071             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;The parameter ClayEffect can not be below zero&quot;</span>);
<a name="l01072"></a>01072       <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;TemperatureEffect&quot;</span>,&amp;temperatureEffect)) <span class="comment">// &quot;Fixed&quot; temperature effect</span>
<a name="l01073"></a>01073          <span class="keywordflow">if</span> (temperatureEffect&lt;0.0)
<a name="l01074"></a>01074             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;The parameter TemperatureEffect can not be below zero&quot;</span>);
<a name="l01075"></a>01075       <span class="keywordflow">if</span> (<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;WaterEffect&quot;</span>,&amp;waterEffect))             <span class="comment">// &quot;Fixed&quot; water effect</span>
<a name="l01076"></a>01076          <span class="keywordflow">if</span> (waterEffect&lt;0.0)
<a name="l01077"></a>01077             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;The parameter WaterEffect can not be below zero&quot;</span>);
<a name="l01078"></a>01078       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)
<a name="l01079"></a>01079          poolList[i]-&gt;<a class="code" href="classorganic_matter.html#af7bf4f5a06da9f6c4977c56d1bbb17ef">Initialize</a>(clayEffect1,clayEffect2,ClayResponseType);
<a name="l01080"></a>01080       <span class="keywordflow">if</span> (useSpringob) <span class="comment">// Adjust size of &quot;IOM&quot; according to C/N ratio - not working properly!!!</span>
<a name="l01081"></a>01081       {
<a name="l01082"></a>01082          cnRatio=16;
<a name="l01083"></a>01083          <span class="keywordtype">double</span> iomf=61.651*pow(cnRatio,-1.7314);
<a name="l01084"></a>01084          iomf=min(1.0,iomf);
<a name="l01085"></a>01085          <span class="keywordtype">string</span> IOMname=<span class="stringliteral">&quot;&quot;</span>;
<a name="l01086"></a>01086          <span class="keywordtype">char</span> name[250];
<a name="l01087"></a>01087          strcpy(name,<span class="stringliteral">&quot;IOM&quot;</span>);
<a name="l01088"></a>01088          <span class="keywordflow">if</span> (<a class="code" href="classorganic_matter.html#af10194d9d1242a94519886ad4fb2db4f">ExistsPool</a>(name))
<a name="l01089"></a>01089             IOMname=name;
<a name="l01090"></a>01090          <a class="code" href="classcn_matter.html">cnMatter</a> iom=<a class="code" href="classorganic_matter.html#a88b256f650c79221267c4d688f41f948">GetCarbonInPool</a>((<span class="keywordtype">char</span>*)IOMname.c_str());
<a name="l01091"></a>01091          <a class="code" href="classcn_matter.html">cnMatter</a> before=<a class="code" href="classorganic_matter.html#ae19830c90a2f172ede6a81e778c98d32">GetTotalCarbon</a>();
<a name="l01092"></a>01092          <span class="keywordtype">double</span> activeNow=0.0; <span class="comment">// Is set below to 1 - fIOM</span>
<a name="l01093"></a>01093          <span class="keywordflow">if</span> (before.c&gt;0)
<a name="l01094"></a>01094          {
<a name="l01095"></a>01095             activeNow = (before.c-iom.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>)/before.c;
<a name="l01096"></a>01096             <span class="keywordtype">double</span> activeAfter=activeNow*iomf;
<a name="l01097"></a>01097             iomf=(1.0-activeAfter)/(1.0-activeNow);
<a name="l01098"></a>01098             strcpy(name,<span class="stringliteral">&quot;ROM&quot;</span>);
<a name="l01099"></a>01099             <span class="keywordflow">if</span> (<a class="code" href="classorganic_matter.html#af10194d9d1242a94519886ad4fb2db4f">ExistsPool</a>(name))
<a name="l01100"></a>01100                IOMname=name;
<a name="l01101"></a>01101             <span class="keywordflow">if</span> (IOMname==<span class="stringliteral">&quot;&quot;</span>)
<a name="l01102"></a>01102                <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;container::SetLocalParameterByName - could not find relevant inert pool for setting &#39;IOMFactor&#39;&quot;</span>);
<a name="l01103"></a>01103             <span class="keywordtype">string</span> humName=<span class="stringliteral">&quot;&quot;</span>;
<a name="l01104"></a>01104             strcpy(name,<span class="stringliteral">&quot;HUM&quot;</span>);
<a name="l01105"></a>01105             <span class="keywordflow">if</span> (<a class="code" href="classorganic_matter.html#af10194d9d1242a94519886ad4fb2db4f">ExistsPool</a>(name))
<a name="l01106"></a>01106                humName=name;
<a name="l01107"></a>01107             strcpy(name,<span class="stringliteral">&quot;NOM&quot;</span>);
<a name="l01108"></a>01108             <span class="keywordflow">if</span> (<a class="code" href="classorganic_matter.html#af10194d9d1242a94519886ad4fb2db4f">ExistsPool</a>(name))
<a name="l01109"></a>01109                humName=name;
<a name="l01110"></a>01110             <span class="keywordflow">if</span> (humName==<span class="stringliteral">&quot;&quot;</span>)
<a name="l01111"></a>01111                <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;Could not find relevant &#39;humus&#39; pool for setting &#39;IOMFactor&#39;&quot;</span>);
<a name="l01112"></a>01112             <a class="code" href="classcn_matter.html">cnMatter</a> nom=<a class="code" href="classorganic_matter.html#a88b256f650c79221267c4d688f41f948">GetCarbonInPool</a>((<span class="keywordtype">char</span>*)humName.c_str());
<a name="l01113"></a>01113             <span class="keywordtype">double</span> move_carbon=(1.0-iomf)*iom.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l01114"></a>01114             <span class="keywordtype">double</span> move_14c=0.0;
<a name="l01115"></a>01115             if (nom.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>&gt;0)
<a name="l01116"></a>01116                move_14c=move_carbon*nom.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>/nom.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l01117"></a>01117             iom.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>-=move_carbon;
<a name="l01118"></a>01118             iom.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>-=move_14c;
<a name="l01119"></a>01119             <span class="keywordflow">if</span> (iom.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>&lt;0.0)
<a name="l01120"></a>01120                            iom.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>=0.0;
<a name="l01121"></a>01121             nom.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>+=move_carbon;
<a name="l01122"></a>01122             nom.<a class="code" href="classcn_matter.html#ab65edcd54562238a4ca1e1c10e7abad1">c_iso</a>+=move_14c;
<a name="l01123"></a>01123             <a class="code" href="classorganic_matter.html#a29e2ca4f26cf2ee55fc1ca49a9b9f8ff">SetCarbonInPool</a>((<span class="keywordtype">char</span>*)IOMname.c_str(),iom);
<a name="l01124"></a>01124             <a class="code" href="classorganic_matter.html#a29e2ca4f26cf2ee55fc1ca49a9b9f8ff">SetCarbonInPool</a>((<span class="keywordtype">char</span>*)humName.c_str(),nom);
<a name="l01125"></a>01125             <a class="code" href="classcn_matter.html">cnMatter</a> after=<a class="code" href="classorganic_matter.html#ae19830c90a2f172ede6a81e778c98d32">GetTotalCarbon</a>();
<a name="l01126"></a>01126             <span class="keywordflow">if</span> (fabs(before.c_iso-after.c_iso)&gt;0.01)
<a name="l01127"></a>01127             {
<a name="l01128"></a>01128                cout &lt;&lt; <span class="stringliteral">&quot;Balancing error carbon isotope.&quot;</span> &lt;&lt; endl;
<a name="l01129"></a>01129                cout &lt;&lt; <span class="stringliteral">&quot;Before scaling: &quot;</span> &lt;&lt; before.c_iso
<a name="l01130"></a>01130                     &lt;&lt; <span class="stringliteral">&quot;  After scaling: &quot;</span> &lt;&lt; after.c_iso &lt;&lt; endl;
<a name="l01131"></a>01131             }
<a name="l01132"></a>01132             <span class="keywordflow">if</span> (fabs(before.c-after.c)&gt;0.01)
<a name="l01133"></a>01133             {
<a name="l01134"></a>01134                cout &lt;&lt; <span class="stringliteral">&quot;Balancing error C-12.&quot;</span> &lt;&lt; endl;
<a name="l01135"></a>01135                cout &lt;&lt; <span class="stringliteral">&quot;Before scaling: &quot;</span> &lt;&lt; before.c
<a name="l01136"></a>01136                     &lt;&lt; <span class="stringliteral">&quot;  After scaling: &quot;</span> &lt;&lt; after.c &lt;&lt; endl;
<a name="l01137"></a>01137                cout &lt;&lt; <span class="stringliteral">&quot;Press a key.&quot;</span> &lt;&lt; endl;
<a name="l01138"></a>01138 <span class="preprocessor">#ifndef __BCplusplus__</span>
<a name="l01139"></a>01139 <span class="preprocessor"></span>               <span class="keywordtype">char</span> dum;
<a name="l01140"></a>01140                cin &gt;&gt; dum;
<a name="l01141"></a>01141 <span class="preprocessor">#else</span>
<a name="l01142"></a>01142 <span class="preprocessor"></span>               getch();
<a name="l01143"></a>01143 <span class="preprocessor">#endif</span>
<a name="l01144"></a>01144 <span class="preprocessor"></span>            }
<a name="l01145"></a>01145          }
<a name="l01146"></a>01146       }
<a name="l01147"></a>01147       <span class="comment">// BALANCE C/N RATIO USING POOL WITH ZERO TURNOVER !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l01148"></a>01148       <span class="comment">// IF NO SUCH POOL, WRITE A WARNING</span>
<a name="l01149"></a>01149    }
<a name="l01150"></a>01150    <a class="code" href="classbase.html#a3af52ee9891719d09b8b19b42450b6f6">file</a>=NULL;
<a name="l01151"></a>01151 }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153 <span class="comment">/****************************************************************************\</span>
<a name="l01154"></a>01154 <span class="comment">Performs mineralisation of the organic matter pools in the soil layer.</span>
<a name="l01155"></a>01155 <span class="comment"> temp          - Soil temperature [C]</span>
<a name="l01156"></a>01156 <span class="comment"> pFValue       - Soil water status as a pF-value</span>
<a name="l01157"></a>01157 <span class="comment"> nitrate_mob   - Nitrate in the mobile water phase [g N/m/d]</span>
<a name="l01158"></a>01158 <span class="comment"> nitrate_imob  - Nitrate in the immobile water phase [g N/m/d]</span>
<a name="l01159"></a>01159 <span class="comment"> ammonium_mob  - Ammonium in the mobile water phase [g N/m/d]</span>
<a name="l01160"></a>01160 <span class="comment"> ammonium_imob - Ammonium in the immobile water phase [g N/m/d]</span>
<a name="l01161"></a>01161 <span class="comment"> Returns CO2 evolution</span>
<a name="l01162"></a>01162 <span class="comment">\****************************************************************************/</span>
<a name="l01163"></a><a class="code" href="classorganic_matter.html#afe20379314e0eb234bd6b6c8684c41d4">01163</a> <span class="keywordtype">double</span> <a class="code" href="classorganic_matter.html#afe20379314e0eb234bd6b6c8684c41d4">organicMatter::Update</a>(<span class="keywordtype">double</span> temp,
<a name="l01164"></a>01164                                                                           <span class="keywordtype">double</span> pFValue,
<a name="l01165"></a>01165                                                                           <a class="code" href="classnitrogen.html">nitrogen</a> * nitrate,
<a name="l01166"></a>01166                                                                           <a class="code" href="classnitrogen.html">nitrogen</a> * ammonium)
<a name="l01167"></a>01167 {
<a name="l01168"></a>01168 
<a name="l01169"></a>01169    <span class="keywordflow">if</span> (nitrate-&gt;<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-9)
<a name="l01170"></a>01170       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::Update - function called with nitrate below zero&quot;</span>);
<a name="l01171"></a>01171    <span class="keywordflow">if</span> (ammonium-&gt;<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-9)
<a name="l01172"></a>01172       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::Update - function called with anmmnium below zero&quot;</span>);
<a name="l01173"></a>01173    carbon_avalibility=0.0;
<a name="l01174"></a>01174 
<a name="l01175"></a>01175    <span class="comment">// Calculate frations of nitrate and ammonium in mobile water phases</span>
<a name="l01176"></a>01176    NO3 = *nitrate;
<a name="l01177"></a>01177    NH4 = *ammonium;
<a name="l01178"></a>01178    <a class="code" href="classcn_matter.html">cnMatter</a> tot=<a class="code" href="classorganic_matter.html#a0796a73dd50dd9cf1d97bf8a5de3d3a4">GetTotalSystem</a>();
<a name="l01179"></a>01179 
<a name="l01180"></a>01180 <span class="comment">// Decompose ----------------------------------------------------------------</span>
<a name="l01181"></a>01181    <a class="code" href="classcn_matter.html">cnMatter</a> c;
<a name="l01182"></a>01182 
<a name="l01183"></a>01183    <span class="comment">// 1. Update all pools, outflux that would cause immobilisation in</span>
<a name="l01184"></a>01184    <span class="comment">// a receiver pool is stored in a &quot;transit&quot; pool.</span>
<a name="l01185"></a>01185    <span class="keywordtype">double</span> fT=TemperatureEffect(temp,tResponseType);
<a name="l01186"></a>01186    <span class="keywordtype">double</span> environmentEffect=fT*SoilWaterEffect(pFValue,waterResponseType);
<a name="l01187"></a>01187 
<a name="l01188"></a>01188    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;numberOfPools;j++)
<a name="l01189"></a>01189    {
<a name="l01190"></a>01190       <span class="keywordflow">if</span> (!poolList[j]-&gt;IsBiomass())
<a name="l01191"></a>01191          carbon_avalibility+=poolList[j]-&gt;<a class="code" href="classmatter.html#ad8531740a6494ac68f0223cd49d272eb">PotentialCarbonTurnover</a>();
<a name="l01192"></a>01192       c=poolList[j]-&gt;<a class="code" href="classmatter.html#ae85f8f64ea546c5cbe056c641304b514">GetCarbon</a>();
<a name="l01193"></a>01193       poolList[j]-&gt;<a class="code" href="classmatter.html#a2b3dd492a18a139790bd227e2b4e0a70">Update</a>(environmentEffect,0);
<a name="l01194"></a>01194    }
<a name="l01195"></a>01195 
<a name="l01196"></a>01196    <span class="comment">// 2. Catch all influx, none off which would cause immobilisation</span>
<a name="l01197"></a>01197    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;numberOfPools;j++)
<a name="l01198"></a>01198       poolList[j]-&gt;CatchInflux(c,0);
<a name="l01199"></a>01199 
<a name="l01200"></a>01200    <span class="comment">// 3. Calculate the total potential immobilisation and the available N</span>
<a name="l01201"></a>01201    <span class="keywordtype">double</span> Nimob=0.0;
<a name="l01202"></a>01202    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;numberOfPools;j++)
<a name="l01203"></a>01203    {
<a name="l01204"></a>01204       <span class="keywordtype">double</span> Ni=poolList[j]-&gt;<a class="code" href="classmatter.html#a59fa9a6e0ff21bac9ab9fb5b4de9392f">PotentialNitrogenMineralisation</a>();
<a name="l01205"></a>01205       <span class="keywordflow">if</span> (Ni&lt;=1E-20)
<a name="l01206"></a>01206          Nimob+=Ni;
<a name="l01207"></a>01207       <span class="keywordflow">else</span>
<a name="l01208"></a>01208          <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::UpdatePools - programming inconsistency&quot;</span>);
<a name="l01209"></a>01209    }
<a name="l01210"></a>01210 
<a name="l01211"></a>01211    <span class="keywordtype">double</span> availN=max(0.0,NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+max(0.0,NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>-NH4allwaysLeft)); <span class="comment">// max takes care of minute rounding errors</span>
<a name="l01212"></a>01212                                                                <span class="comment">// All N considered avaliable !!!</span>
<a name="l01213"></a>01213 
<a name="l01214"></a>01214    <span class="comment">// 4. Calculate the remaining total C turnover</span>
<a name="l01215"></a>01215    <span class="keywordtype">double</span> Cpot=0.0;
<a name="l01216"></a>01216    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;numberOfPools;j++)
<a name="l01217"></a>01217       Cpot+=poolList[j]-&gt;ResidualCarbon();
<a name="l01218"></a>01218 
<a name="l01219"></a>01219    <span class="comment">// 5. For each pool determine the individual ratio, export this ratio</span>
<a name="l01220"></a>01220    <span class="comment">// and put the rest back</span>
<a name="l01221"></a>01221    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;numberOfPools;j++)
<a name="l01222"></a>01222    {
<a name="l01223"></a>01223       <span class="keywordtype">double</span> Nwanted=-poolList[j]-&gt;<a class="code" href="classmatter.html#a59fa9a6e0ff21bac9ab9fb5b4de9392f">PotentialNitrogenMineralisation</a>();
<a name="l01224"></a>01224       <span class="keywordflow">if</span> (Nwanted&gt;0.0)
<a name="l01225"></a>01225       {
<a name="l01226"></a>01226          <span class="keywordtype">double</span> Cf=poolList[j]-&gt;<a class="code" href="classmatter.html#abaf880e3b1efd04eae0db055caed9b12">ResidualCarbon</a>()/Cpot;
<a name="l01227"></a>01227          <span class="keywordtype">double</span> rt=min(1.0,availN*Cf/Nwanted);
<a name="l01228"></a>01228          poolList[j]-&gt;<a class="code" href="classmatter.html#a36bd225841eda2240009df17d239cfa1">FinalExport</a>(rt);
<a name="l01229"></a>01229       }
<a name="l01230"></a>01230       <span class="keywordflow">else</span>
<a name="l01231"></a>01231          poolList[j]-&gt;<a class="code" href="classmatter.html#a36bd225841eda2240009df17d239cfa1">FinalExport</a>(1.0); <span class="comment">// Probably unnescescary</span>
<a name="l01232"></a>01232    }
<a name="l01233"></a>01233    NH4near=NH4near*max(0.0,min(1.0,(1.0-exchangeRate)));
<a name="l01234"></a>01234 
<a name="l01235"></a>01235    <span class="comment">// 6. Transfer the last influxes to the pool. All theses influxes will</span>
<a name="l01236"></a>01236    <span class="comment">// cause immobilisation.</span>
<a name="l01237"></a>01237    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;numberOfPools;j++)
<a name="l01238"></a>01238       poolList[j]-&gt;CatchInflux(c,0);
<a name="l01239"></a>01239 
<a name="l01240"></a>01240    <span class="comment">// 7. Put possible N-surplus into biomatter pools - variant of &quot;luxury</span>
<a name="l01241"></a>01241    <span class="comment">//    uptake.</span>
<a name="l01242"></a>01242 
<a name="l01243"></a>01243    availN=max(0.0,NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+max(0.0,NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>-NH4allwaysLeft));
<a name="l01244"></a>01244    <span class="keywordtype">double</span> Ndesire=0.0;
<a name="l01245"></a>01245    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;numberOfPools;j++)
<a name="l01246"></a>01246       Ndesire+=poolList[j]-&gt;GetMicrobialPoolNdesire();
<a name="l01247"></a>01247 
<a name="l01248"></a>01248    <span class="keywordtype">double</span> ratio=0.0;
<a name="l01249"></a>01249    <span class="keywordflow">if</span> (Ndesire&gt;1E-12 &amp;&amp; availN&gt;1E-12)
<a name="l01250"></a>01250       ratio=min(1.0,availN/Ndesire);
<a name="l01251"></a>01251    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;numberOfPools;j++)
<a name="l01252"></a>01252       poolList[j]-&gt;GiveMicrobialPoolExtraN(ratio);
<a name="l01253"></a>01253 
<a name="l01254"></a>01254    <span class="comment">// 8. Optional &quot;cycling&quot; of biomass N</span>
<a name="l01255"></a>01255    <span class="keywordflow">if</span> (nCycling&gt;1E-10)
<a name="l01256"></a>01256    {
<a name="l01257"></a>01257       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;numberOfPools;j++)
<a name="l01258"></a>01258          poolList[j]-&gt;CycleNitrogen(nCycling,environmentEffect);
<a name="l01259"></a>01259    }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261 <span class="comment">// Decomposition finished-------------------------------------------------------</span>
<a name="l01262"></a>01262 
<a name="l01263"></a>01263   <span class="keywordflow">if</span> (NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;0.0)
<a name="l01264"></a>01264   {
<a name="l01265"></a>01265      <span class="keywordflow">if</span> (NO3.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;1E-15)
<a name="l01266"></a>01266         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#aacaa1466698a349689502491cf089f72">Warning</a>(<span class="stringliteral">&quot;organicMatter::Update - NO3 below zero&quot;</span>);
<a name="l01267"></a>01267      NO3.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l01268"></a>01268   }
<a name="l01269"></a>01269   <span class="keywordflow">if</span> (NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;0.0)
<a name="l01270"></a>01270   {
<a name="l01271"></a>01271      <span class="keywordflow">if</span> (NH4.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;1E-15)
<a name="l01272"></a>01272         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#aacaa1466698a349689502491cf089f72">Warning</a>(<span class="stringliteral">&quot;organicMatter::Update - NH4 below zero&quot;</span>);
<a name="l01273"></a>01273      NH4.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l01274"></a>01274   }
<a name="l01275"></a>01275 
<a name="l01276"></a>01276   *nitrate  = NO3;
<a name="l01277"></a>01277   *ammonium = NH4;
<a name="l01278"></a>01278 
<a name="l01279"></a>01279    <a class="code" href="classcn_matter.html">cnMatter</a> tot1=<a class="code" href="classorganic_matter.html#a0796a73dd50dd9cf1d97bf8a5de3d3a4">GetTotalSystem</a>();
<a name="l01280"></a>01280    <span class="keywordflow">if</span> (fabs(tot.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>-tot1.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>)&gt;1E-5)
<a name="l01281"></a>01281       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::Update - imbalance in N&quot;</span>);
<a name="l01282"></a>01282 
<a name="l01283"></a>01283    <a class="code" href="classcn_matter.html">cnMatter</a> RetVal=todayCO2;
<a name="l01284"></a>01284    todayCO2.<a class="code" href="classcn_matter.html#a45d9021d50f76e167388bf5de2e406ed">Clear</a>();
<a name="l01285"></a>01285    <span class="keywordflow">return</span> RetVal.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l01286"></a>01286 }
<a name="l01287"></a>01287 
<a name="l01288"></a>01288 <span class="comment">/****************************************************************************\</span>
<a name="l01289"></a>01289 <span class="comment">Return carbon in organic matter pools [g C/m]</span>
<a name="l01290"></a>01290 <span class="comment">\****************************************************************************/</span>
<a name="l01291"></a><a class="code" href="classorganic_matter.html#a5b3f9588dde6550e0311a13cf5fe50f5">01291</a> <span class="keywordtype">double</span> <a class="code" href="classorganic_matter.html#a5b3f9588dde6550e0311a13cf5fe50f5">organicMatter::GetCarbon</a>()
<a name="l01292"></a>01292 {
<a name="l01293"></a>01293    <a class="code" href="classcn_matter.html">cnMatter</a> cn=<a class="code" href="classorganic_matter.html#ae19830c90a2f172ede6a81e778c98d32">GetTotalCarbon</a>();
<a name="l01294"></a>01294    <span class="keywordflow">if</span> (cn.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>&lt;0.0)
<a name="l01295"></a>01295       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::GetCarbon - returns negative value&quot;</span>);
<a name="l01296"></a>01296    <span class="keywordflow">return</span> cn.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l01297"></a>01297 }
<a name="l01298"></a>01298 
<a name="l01299"></a>01299 <span class="comment">/****************************************************************************\</span>
<a name="l01300"></a>01300 <span class="comment">Return nitrogen in organic matter pools [g N/m]</span>
<a name="l01301"></a>01301 <span class="comment">\****************************************************************************/</span>
<a name="l01302"></a><a class="code" href="classorganic_matter.html#a719b504d46e267423e58c37d1c1bc058">01302</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classorganic_matter.html#a719b504d46e267423e58c37d1c1bc058">organicMatter::GetNitrogen</a>()
<a name="l01303"></a>01303 {
<a name="l01304"></a>01304    <a class="code" href="classcn_matter.html">cnMatter</a> cn=<a class="code" href="classorganic_matter.html#ae19830c90a2f172ede6a81e778c98d32">GetTotalCarbon</a>();
<a name="l01305"></a>01305    <a class="code" href="classnitrogen.html">nitrogen</a> TotalNitrogen;
<a name="l01306"></a>01306    TotalNitrogen.<a class="code" href="classnitrogen.html#a49bebcba4c40f3c0a6abb24f590b2c8c">SetBoth</a>(cn.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>,cn.<a class="code" href="classcn_matter.html#a80822025457f202cd4199fb4a1a61ded">n15</a>);
<a name="l01307"></a>01307 
<a name="l01308"></a>01308    <span class="keywordflow">if</span> (cn.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>&lt;0.0)
<a name="l01309"></a>01309       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::GetNitrogen - returns negative value&quot;</span>);
<a name="l01310"></a>01310    <span class="keywordflow">return</span> TotalNitrogen;
<a name="l01311"></a>01311 }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313 <span class="comment">/****************************************************************************\</span>
<a name="l01314"></a>01314 <span class="comment">Return carbon in organic matter pools with a specific name [g C/m]</span>
<a name="l01315"></a>01315 <span class="comment">   name - Pool name</span>
<a name="l01316"></a>01316 <span class="comment">\****************************************************************************/</span>
<a name="l01317"></a><a class="code" href="classorganic_matter.html#ae4953f5b42a97f95201b293633a89e17">01317</a> <span class="keywordtype">double</span> <a class="code" href="classorganic_matter.html#ae4953f5b42a97f95201b293633a89e17">organicMatter::GetPoolCarbon</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * name)
<a name="l01318"></a>01318 {
<a name="l01319"></a>01319    <a class="code" href="classcn_matter.html">cnMatter</a> cn=<a class="code" href="classorganic_matter.html#a88b256f650c79221267c4d688f41f948">GetCarbonInPool</a>((<span class="keywordtype">char</span>*)name);
<a name="l01320"></a>01320    <span class="keywordflow">return</span> cn.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l01321"></a>01321 }
<a name="l01322"></a>01322 
<a name="l01323"></a>01323 <span class="comment">/****************************************************************************\</span>
<a name="l01324"></a>01324 <span class="comment">Return nitrogen in organic matter pools with a specific name [g N/m]</span>
<a name="l01325"></a>01325 <span class="comment">   name - Pool name</span>
<a name="l01326"></a>01326 <span class="comment">\****************************************************************************/</span>
<a name="l01327"></a><a class="code" href="classorganic_matter.html#a57c64ddc2f0aacaa27b4e2fb7e6c1713">01327</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classorganic_matter.html#a57c64ddc2f0aacaa27b4e2fb7e6c1713">organicMatter::GetPoolNitrogen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * name)
<a name="l01328"></a>01328 {
<a name="l01329"></a>01329    <a class="code" href="classcn_matter.html">cnMatter</a> cn=<a class="code" href="classorganic_matter.html#a88b256f650c79221267c4d688f41f948">GetCarbonInPool</a>((<span class="keywordtype">char</span>*)name);
<a name="l01330"></a>01330    <a class="code" href="classnitrogen.html">nitrogen</a> PoolNitrogen;
<a name="l01331"></a>01331    PoolNitrogen.<a class="code" href="classnitrogen.html#a49bebcba4c40f3c0a6abb24f590b2c8c">SetBoth</a>(cn.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>,cn.<a class="code" href="classcn_matter.html#a80822025457f202cd4199fb4a1a61ded">n15</a>);
<a name="l01332"></a>01332    <span class="keywordflow">return</span> PoolNitrogen;
<a name="l01333"></a>01333 }
<a name="l01334"></a>01334 
<a name="l01335"></a>01335 <span class="comment">/****************************************************************************\</span>
<a name="l01336"></a>01336 <span class="comment">Add an organic product to the organic matter</span>
<a name="l01337"></a>01337 <span class="comment">   product - Organic product object</span>
<a name="l01338"></a>01338 <span class="comment">\****************************************************************************/</span>
<a name="l01339"></a>01339 
<a name="l01340"></a><a class="code" href="classorganic_matter.html#affa8ea4461d2badd187dc2fe9ef467d7">01340</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#affa8ea4461d2badd187dc2fe9ef467d7">organicMatter::AddProduct</a>(<a class="code" href="classorganic_product.html">organicProduct</a> * <a class="code" href="classproduct.html">product</a>)
<a name="l01341"></a>01341 {
<a name="l01342"></a>01342    <span class="comment">/*</span>
<a name="l01343"></a>01343 <span class="comment">   if (product-&gt;GetAmount().c&gt;0 &amp;&amp; product-&gt;GetAmount().n&lt;=0)</span>
<a name="l01344"></a>01344 <span class="comment">      Terminate(&quot;organicMatter::AddProduct - added matter contains C but no N&quot;);</span>
<a name="l01345"></a>01345 <span class="comment">   */</span>
<a name="l01346"></a>01346    <span class="keywordtype">double</span> tot=<a class="code" href="classorganic_matter.html#a0796a73dd50dd9cf1d97bf8a5de3d3a4">GetTotalSystem</a>().<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>+product-&gt;<a class="code" href="classorganic_product.html#aba7720784ab3cc2e672d2659085b3950">GetTotalNitrogen</a>().<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>;
<a name="l01347"></a>01347    <span class="keywordflow">if</span> (product-&gt;<a class="code" href="classorganic_product.html#a8e2346d9fb4a3309b32ae90548142246">GetOrganicNitrogen</a>().<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-36)
<a name="l01348"></a>01348       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::AddProduct - The added product has negative N content&quot;</span>);
<a name="l01349"></a>01349    <span class="keywordflow">if</span> (useNCfractionation)
<a name="l01350"></a>01350       SetFractionation(product);
<a name="l01351"></a>01351    <span class="keywordtype">double</span> f=product-&gt;<a class="code" href="classorganic_product.html#a9d4c5ab06266e32de73559d1b80a47ac">GetCarbonFraction</a>();
<a name="l01352"></a>01352 
<a name="l01353"></a>01353    <span class="keywordflow">if</span> ((product-&gt;<a class="code" href="classorganic_product.html#acf7568317f8ce00b6073eda432ba7483">GetAmount</a>()*product-&gt;<a class="code" href="classorganic_product.html#a9d4c5ab06266e32de73559d1b80a47ac">GetCarbonFraction</a>()).n&lt;0.0)
<a name="l01354"></a>01354       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::AddProduct - negative amount of N added&quot;</span>);
<a name="l01355"></a>01355    <span class="keywordflow">if</span> ((product-&gt;<a class="code" href="classorganic_product.html#acf7568317f8ce00b6073eda432ba7483">GetAmount</a>()*product-&gt;<a class="code" href="classorganic_product.html#a9d4c5ab06266e32de73559d1b80a47ac">GetCarbonFraction</a>()).c&lt;0.0)
<a name="l01356"></a>01356       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::AddProduct - negative amount of C added&quot;</span>);
<a name="l01357"></a>01357    <span class="keywordtype">double</span> check=0.0;
<a name="l01358"></a>01358    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;product-&gt;<a class="code" href="classorganic_product.html#a8901cf7bada2bbba03698a61ba213ea4">GetNumOfFractions</a>();i++)
<a name="l01359"></a>01359       <span class="keywordflow">if</span> (product-&gt;<a class="code" href="classorganic_product.html#a819eb78c2c6ed351bdfc27264ea74281">GetDestPool</a>(i)==<span class="stringliteral">&quot;CO2&quot;</span>)
<a name="l01360"></a>01360       {
<a name="l01361"></a>01361          <a class="code" href="classcn_matter.html">cnMatter</a> CO2directly=product-&gt;<a class="code" href="classorganic_product.html#acf7568317f8ce00b6073eda432ba7483">GetAmount</a>()
<a name="l01362"></a>01362                              *product-&gt;<a class="code" href="classorganic_product.html#a8017dbe0d08fdbc603c7e66c1aad6bb7">GetCFraction</a>(i)*f;
<a name="l01363"></a>01363          check+=CO2directly.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>;
<a name="l01364"></a>01364          <a class="code" href="classorganic_matter.html#af8da4028cf9d47ffff40198537947652">CO2emmision</a>(CO2directly); <span class="comment">// Direct release of CO2</span>
<a name="l01365"></a>01365       }
<a name="l01366"></a>01366 
<a name="l01367"></a>01367    <span class="comment">// Test if animal manure needs readjustment of C fractionation</span>
<a name="l01368"></a>01368    <span class="comment">// Coding specific for the CN-SIM model, january 2003</span>
<a name="l01369"></a>01369    <span class="keywordtype">double</span> f0=product-&gt;<a class="code" href="classorganic_product.html#a8017dbe0d08fdbc603c7e66c1aad6bb7">GetCFraction</a>(0);
<a name="l01370"></a>01370    <span class="keywordtype">double</span> f1=product-&gt;<a class="code" href="classorganic_product.html#a8017dbe0d08fdbc603c7e66c1aad6bb7">GetCFraction</a>(1);
<a name="l01371"></a>01371    <span class="keywordtype">double</span> f2=product-&gt;<a class="code" href="classorganic_product.html#a8017dbe0d08fdbc603c7e66c1aad6bb7">GetCFraction</a>(2);
<a name="l01372"></a>01372    <a class="code" href="classmatter.html">matter</a> * nom=(<a class="code" href="classmatter.html">matter</a>*)<a class="code" href="classorganic_matter.html#a3c6a07a913e1f837f235329615787c22">GetPoolPointer</a>(<span class="stringliteral">&quot;NOM&quot;</span>);
<a name="l01373"></a>01373    <span class="keywordflow">if</span> (nom==NULL)
<a name="l01374"></a>01374       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;The pool &#39;NOM&#39; was not found&quot;</span>);
<a name="l01375"></a>01375    <span class="keywordtype">double</span> maxCToNOM=0.0;
<a name="l01376"></a>01376    <span class="keywordflow">if</span> (product-&gt;<a class="code" href="classorganic_product.html#abec5af127d3ff1f687ddec55f0d7a827">GetCNratio</a>()&gt;0.0)
<a name="l01377"></a>01377       maxCToNOM = nom-&gt;<a class="code" href="classmatter.html#a1c97017b5f16dd256b99961f8b50a946">GetCNratio</a>()/product-&gt;<a class="code" href="classorganic_product.html#abec5af127d3ff1f687ddec55f0d7a827">GetCNratio</a>();
<a name="l01378"></a>01378    <span class="keywordflow">if</span> (maxCToNOM&lt;f2) <span class="comment">// Adjust to avoid program termination</span>
<a name="l01379"></a>01379    {
<a name="l01380"></a>01380       <span class="keywordtype">double</span> diff=f2-maxCToNOM;
<a name="l01381"></a>01381       <span class="keywordtype">double</span> factor=(diff+f0+f1)/(f0+f1);
<a name="l01382"></a>01382       product-&gt;<a class="code" href="classorganic_product.html#ae6f2c4cfc006067ed21baa50e8e3c4db">SetCFraction</a>(0,f0*factor);
<a name="l01383"></a>01383       product-&gt;<a class="code" href="classorganic_product.html#ae6f2c4cfc006067ed21baa50e8e3c4db">SetCFraction</a>(1,f1*factor);
<a name="l01384"></a>01384       product-&gt;<a class="code" href="classorganic_product.html#ae6f2c4cfc006067ed21baa50e8e3c4db">SetCFraction</a>(2,maxCToNOM);
<a name="l01385"></a>01385    }
<a name="l01386"></a>01386 
<a name="l01387"></a>01387    <span class="keywordtype">double</span> fsum=0.0;
<a name="l01388"></a>01388    <span class="keywordtype">double</span> used=0.0;
<a name="l01389"></a>01389    <span class="keywordtype">double</span> CN;
<a name="l01390"></a>01390    <span class="keywordtype">int</span> num;
<a name="l01391"></a>01391 
<a name="l01392"></a>01392    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++) <span class="comment">// For pools with fixed C/N ratio</span>
<a name="l01393"></a>01393    {
<a name="l01394"></a>01394       num=0;
<a name="l01395"></a>01395       poolList[i]-&gt;<a class="code" href="classmatter.html#ac17664d421545b45ef91061b17ae6c7b">TestAddProduct</a>(product,&amp;check,&amp;CN,&amp;num,<span class="keyword">false</span>);
<a name="l01396"></a>01396       <span class="keywordflow">if</span> (num&gt;0) <span class="comment">// Match found</span>
<a name="l01397"></a>01397       {
<a name="l01398"></a>01398          fsum+=product-&gt;<a class="code" href="classorganic_product.html#ab67cb65794b92f1f4181efdb988b0524">GetNFraction</a>(num);
<a name="l01399"></a>01399          used+=product-&gt;<a class="code" href="classorganic_product.html#a8017dbe0d08fdbc603c7e66c1aad6bb7">GetCFraction</a>(num)*product-&gt;<a class="code" href="classorganic_product.html#abec5af127d3ff1f687ddec55f0d7a827">GetCNratio</a>()/CN;
<a name="l01400"></a>01400       }
<a name="l01401"></a>01401    }
<a name="l01402"></a>01402    <span class="keywordflow">if</span>(<a class="code" href="compare_8cpp.html#a25f3a514ece50d360338a392f70f8609">doubleGreater</a>(used,1.0,0.0000001))
<a name="l01403"></a>01403    {
<a name="l01404"></a>01404       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::AddProduct - The added product did not contain enough N to match consistently with pools&quot;</span>);
<a name="l01405"></a>01405    }
<a name="l01406"></a>01406 
<a name="l01407"></a>01407    <span class="keywordtype">double</span> factor=(1.0-used)/(1.0-fsum);
<a name="l01408"></a>01408    <a class="code" href="classcn_matter.html">cnMatter</a> amount=product-&gt;<a class="code" href="classorganic_product.html#acf7568317f8ce00b6073eda432ba7483">GetAmount</a>();
<a name="l01409"></a>01409    amount.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>=amount.<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>*factor;
<a name="l01410"></a>01410    amount.<a class="code" href="classcn_matter.html#a80822025457f202cd4199fb4a1a61ded">n15</a>=amount.<a class="code" href="classcn_matter.html#a80822025457f202cd4199fb4a1a61ded">n15</a>*factor;
<a name="l01411"></a>01411    product-&gt;<a class="code" href="classorganic_product.html#a37de4c556fd969898cdf6af1375a7542">SetAmount</a>(amount);
<a name="l01412"></a>01412    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++) <span class="comment">// For pools without fixed C/N ratio</span>
<a name="l01413"></a>01413       poolList[i]-&gt;TestAddProduct(product,&amp;check,&amp;CN,&amp;num,<span class="keyword">true</span>);
<a name="l01414"></a>01414    <span class="keywordflow">if</span> (fabs(check-amount.<a class="code" href="classcn_matter.html#ad1d68c3a937d7111070aa0821c6c10f9">c</a>*f)&gt;1E-6)
<a name="l01415"></a>01415       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::AddProduct - The added product was not consistently matched with pools for C&quot;</span>);
<a name="l01416"></a>01416 
<a name="l01417"></a>01417    <span class="keywordtype">double</span> tot1=<a class="code" href="classorganic_matter.html#a0796a73dd50dd9cf1d97bf8a5de3d3a4">GetTotalSystem</a>().<a class="code" href="classcn_matter.html#aeae2078338cb768beda7ab04d69a1479">n</a>;
<a name="l01418"></a>01418    <span class="keywordflow">if</span> (fabs(tot-tot1)&gt;1E-5)
<a name="l01419"></a>01419       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::Update - imbalance in N&quot;</span>);
<a name="l01420"></a>01420 }
<a name="l01421"></a>01421 
<a name="l01422"></a>01422 
<a name="l01423"></a>01423 <span class="comment">/****************************************************************************\</span>
<a name="l01424"></a>01424 <span class="comment">Fraction (0-1) : fraction of SMB killed</span>
<a name="l01425"></a>01425 <span class="comment">\****************************************************************************/</span>
<a name="l01426"></a><a class="code" href="classorganic_matter.html#ae6148352b9c917d7c35e7452d4d62449">01426</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#ae6148352b9c917d7c35e7452d4d62449">organicMatter::KillSMB</a>(<span class="keywordtype">double</span> Fraction)
<a name="l01427"></a>01427 {
<a name="l01428"></a>01428    <span class="keywordtype">int</span> count=0;
<a name="l01429"></a>01429         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)
<a name="l01430"></a>01430       <span class="keywordflow">if</span> (strcmp(<span class="stringliteral">&quot;SMB1&quot;</span>,poolList[i]-&gt;GetPoolName())==0 || strcmp(<span class="stringliteral">&quot;SMB2&quot;</span>,poolList[i]-&gt;GetPoolName())==0)
<a name="l01431"></a>01431       {
<a name="l01432"></a>01432          count++;
<a name="l01433"></a>01433          <span class="keywordflow">if</span> (!poolList[i]-&gt;ExtraTurnover(Fraction))
<a name="l01434"></a>01434             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::KillSMB - illegal call for this type of pool&quot;</span>);
<a name="l01435"></a>01435       }
<a name="l01436"></a>01436    <span class="keywordflow">if</span> (count!=2)
<a name="l01437"></a>01437       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::KillSMB - SMB pool(s) not found&quot;</span>);
<a name="l01438"></a>01438 }
<a name="l01439"></a>01439 
<a name="l01440"></a>01440 <span class="comment">/****************************************************************************\</span>
<a name="l01441"></a>01441 <span class="comment">Fraction (0-1) : fraction of AOM transferred to pools with a modified</span>
<a name="l01442"></a>01442 <span class="comment">                 turnover rate</span>
<a name="l01443"></a>01443 <span class="comment">TurnoverFactor : Factor for modification of turnover rate</span>
<a name="l01444"></a>01444 <span class="comment">\****************************************************************************/</span>
<a name="l01445"></a><a class="code" href="classorganic_matter.html#a97b9ea17f175972db509425152e7f69a">01445</a> <span class="keywordtype">void</span> <a class="code" href="classorganic_matter.html#a97b9ea17f175972db509425152e7f69a">organicMatter::ModifyAOM</a>(<span class="keywordtype">double</span> Fraction,<span class="keywordtype">double</span> TurnoverFactor)
<a name="l01446"></a>01446 {
<a name="l01447"></a>01447    <span class="keywordtype">int</span> count=0;
<a name="l01448"></a>01448         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;numberOfPools;i++)
<a name="l01449"></a>01449       <span class="keywordflow">if</span> (strcmp(<span class="stringliteral">&quot;AOM1&quot;</span>,poolList[i]-&gt;GetPoolName())==0 || strcmp(<span class="stringliteral">&quot;AOM2&quot;</span>,poolList[i]-&gt;GetPoolName())==0)
<a name="l01450"></a>01450       {
<a name="l01451"></a>01451          count++;
<a name="l01452"></a>01452          <span class="keywordflow">if</span> (!poolList[i]-&gt;CloneAndModify(Fraction,TurnoverFactor))
<a name="l01453"></a>01453             <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::ModifyAOM - illegal call for this type of pool&quot;</span>);
<a name="l01454"></a>01454       }
<a name="l01455"></a>01455    <span class="keywordflow">if</span> (count!=2)
<a name="l01456"></a>01456       <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;organicMatter::ModifyAOM - AOM pool(s) not found&quot;</span>);
<a name="l01457"></a>01457 }
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Mon Aug 22 2011 10:29:05 for Fasset by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
