<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Fasset: C:/main/trunk/src/soil/soilLayer.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Fasset</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">C:/main/trunk/src/soil/soilLayer.cpp</div>  </div>
</div>
<div class="contents">
<a href="soil_layer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/****************************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"> $URL$</span>
<a name="l00003"></a>00003 <span class="comment"> $LastChangedDate$</span>
<a name="l00004"></a>00004 <span class="comment"> $LastChangedRevision$</span>
<a name="l00005"></a>00005 <span class="comment"> $LastChangedBy$</span>
<a name="l00006"></a>00006 <span class="comment">\****************************************************************************/</span>
<a name="l00007"></a>00007 <span class="comment">// ============================================================================</span>
<a name="l00008"></a>00008 <span class="comment">// Soil layer</span>
<a name="l00009"></a>00009 <span class="comment">// (c) J�rgen E. Olesen, Statens Planteavlsfors�g</span>
<a name="l00010"></a>00010 <span class="comment">// Changes:</span>
<a name="l00011"></a>00011 <span class="comment">// JEO 24-06-1997: Support for initialization of added organic carbon and nitrogen</span>
<a name="l00012"></a>00012 <span class="comment">// JEO 01-07-1997: Nutrient contents in AOM changed from percent to relative</span>
<a name="l00013"></a>00013 <span class="comment">// JEO 18-07-1997: Error in MaxNitrogenUptake corrected.</span>
<a name="l00014"></a>00014 <span class="comment">// JEO 27-10-1997: New soil evaporation formula</span>
<a name="l00015"></a>00015 <span class="comment">// CHD 12-06-2004: Added denitrification and N2O emission model</span>
<a name="l00016"></a>00016 <span class="comment">// =============================================================================</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;../base/common.h&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="soil_layer_8h.html">soilLayer.h</a>&quot;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;../base/bstime.h&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;../base/message.h&quot;</span>
<a name="l00023"></a><a class="code" href="soil_layer_8cpp.html#ae71449b1cc6e6250b91f539153a7a0d3">00023</a> <span class="preprocessor">#define M_PI       3.14159265358979323846</span>
<a name="l00024"></a><a class="code" href="soil_layer_8cpp.html#a919d29cf645fc11f88575071d141e2b2">00024</a> <span class="preprocessor"></span><span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_layer_8cpp.html#a919d29cf645fc11f88575071d141e2b2">HeatCapacityFreezingWater</a> = 334400.0;  <span class="comment">// J/kg</span>
<a name="l00025"></a><a class="code" href="soil_layer_8cpp.html#aa802d053b0e834f15ac8331c6c1d42b8">00025</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_layer_8cpp.html#aa802d053b0e834f15ac8331c6c1d42b8">HeatCapacityWater</a>         = 4192.0;    <span class="comment">// J/kgC</span>
<a name="l00026"></a><a class="code" href="soil_layer_8cpp.html#a60ac72fe64fb25fb3826fa9324a8ab6e">00026</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_layer_8cpp.html#a60ac72fe64fb25fb3826fa9324a8ab6e">HeatCapacityIce</a>           = 2000.0;    <span class="comment">// J/kgC</span>
<a name="l00027"></a><a class="code" href="soil_layer_8cpp.html#a3429b0569d7d39f18cbcb8bfba864023">00027</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_layer_8cpp.html#a3429b0569d7d39f18cbcb8bfba864023">HeatCapacitySolid</a>         = 750.0;     <span class="comment">// J/kgC</span>
<a name="l00028"></a><a class="code" href="soil_layer_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">00028</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="soil_layer_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">WaterDensity</a>              = 1000.0;    <span class="comment">// kg/m3</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="comment">/****************************************************************************\</span>
<a name="l00031"></a>00031 <span class="comment">\****************************************************************************/</span>
<a name="l00032"></a><a class="code" href="classsoil_layer.html#af5adc704be0dfcaca6210b6217242470">00032</a> soilLayer::soilLayer(<span class="keyword">const</span> <span class="keywordtype">char</span> * aName, <span class="keyword">const</span> <span class="keywordtype">int</span> aIndex, <span class="keyword">const</span> <a class="code" href="classbase.html">base</a> * aOwner)
<a name="l00033"></a>00033  : <a class="code" href="classbase.html">base</a>(aName,aIndex,aOwner)
<a name="l00034"></a>00034 {
<a name="l00035"></a>00035    <a class="code" href="classsoil_layer.html#af34f26ea69c673eaa8db70f6c0572373">next</a>                     = NULL;
<a name="l00036"></a>00036    <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>                       = NULL;
<a name="l00037"></a>00037    <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>            = <span class="keyword">new</span> <a class="code" href="classorganic_matter.html">organicMatter</a>(<span class="stringliteral">&quot;OrganicMatter&quot;</span>,0,<span class="keyword">this</span>);
<a name="l00038"></a>00038    <a class="code" href="classsoil_layer.html#a5dd2dd5bfbdfc6d2e79a50136185da04">ammoniumLeaching</a>.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00039"></a>00039    <a class="code" href="classsoil_layer.html#a4082fb4d9c9c2a1decbe1dc735a1c3f7">nitrateLeaching</a>.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00040"></a>00040    <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00041"></a>00041    <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00042"></a>00042    <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00043"></a>00043    <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00044"></a>00044    <a class="code" href="classsoil_layer.html#ac067c039016361465b827a712fc4ee46">N2OFromNitrification</a>.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00045"></a>00045    <a class="code" href="classsoil_layer.html#a4ba9ff292a84bae74b17671f46c2d32d">N2OFromDenitrification</a>.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00046"></a>00046    <a class="code" href="classsoil_layer.html#adad888a2d01d277a32514646edb71c9e">Denitrification</a>.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00047"></a>00047    <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>             = 0;
<a name="l00048"></a>00048    <a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>              = 8;
<a name="l00049"></a>00049    <a class="code" href="classsoil_layer.html#a7c798f757104d72b66f54e76e284097f">waterFlux</a>                = 0.0;                     <span class="comment">// mm</span>
<a name="l00050"></a>00050    <a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>               = 0.0;
<a name="l00051"></a>00051    <a class="code" href="classsoil_layer.html#a9d84413d44f869d41635363bf2de0e04">TillageEffectTemperature</a> = 0.0;
<a name="l00052"></a>00052    <a class="code" href="classsoil_layer.html#a5dcc4d96a38106a631098dd65f4a7e6d">equilibrated</a>             = <span class="keyword">false</span>;
<a name="l00053"></a>00053    <a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>              = 0;
<a name="l00054"></a>00054    <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>             = 0;
<a name="l00055"></a>00055    <a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>            = 0;
<a name="l00056"></a>00056    <a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>         = 0;
<a name="l00057"></a>00057    <a class="code" href="classsoil_layer.html#ae050c0e0b52e07baf301a5bbebc239db">holdbackConstant</a>         = 0;
<a name="l00058"></a>00058    <a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>           = 0;
<a name="l00059"></a>00059    <a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a>                 = 0;
<a name="l00060"></a>00060    <a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>            = 0;
<a name="l00061"></a>00061    <a class="code" href="classsoil_layer.html#acbee67e83ac96f6906c03498366616b6">startDepth</a>               = 0;
<a name="l00062"></a>00062    <a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>                = 0;
<a name="l00063"></a>00063    <a class="code" href="classsoil_layer.html#ae98e1db7a6e369ad8c15667150daaaf0">wiltCapacity</a>             = 0;
<a name="l00064"></a>00064    <a class="code" href="classsoil_layer.html#a50746e4427b349f891f3be4eb3bd6878">nitrificationRate</a>        = 0;
<a name="l00065"></a>00065    <a class="code" href="classsoil_layer.html#abe6002dd278efb361b9adc4cfb299d92">tortuosityLimit</a>          = 0;
<a name="l00066"></a>00066    <a class="code" href="classsoil_layer.html#aea0648625d45f262740d107bbdfa4d55">waterUptake</a>              = 0;
<a name="l00067"></a>00067    <a class="code" href="classsoil_layer.html#a99d47de1a6d78f922c9d988b691422fd">CO2Evolution</a>             = 0;
<a name="l00068"></a>00068    <a class="code" href="classsoil_layer.html#abc49478bbf466b7211f02fcd32a84e9f">mobility</a>                 = 0;
<a name="l00069"></a>00069    <a class="code" href="classsoil_layer.html#a529a180a696b6f94ae72126ae7ee42b8">mobility1</a>                = 0;
<a name="l00070"></a>00070    <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#ada0ca75f0dd9d8a6d0dfd5fcbd666653">SetNames</a>(<span class="stringliteral">&quot;soillayer&quot;</span>,<span class="stringliteral">&quot;N&quot;</span>);
<a name="l00071"></a>00071    <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#ada0ca75f0dd9d8a6d0dfd5fcbd666653">SetNames</a>(<span class="stringliteral">&quot;soillayer&quot;</span>,<span class="stringliteral">&quot;N15&quot;</span>);
<a name="l00072"></a>00072    <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>.<a class="code" href="classbudget.html#ada0ca75f0dd9d8a6d0dfd5fcbd666653">SetNames</a>(<span class="stringliteral">&quot;soillayer&quot;</span>,<span class="stringliteral">&quot;water&quot;</span>);
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="comment">/****************************************************************************\</span>
<a name="l00076"></a>00076 <span class="comment">\****************************************************************************/</span>
<a name="l00077"></a><a class="code" href="classsoil_layer.html#a948fc6fe95c6f89f80c4bc77ff401d7c">00077</a> soilLayer::soilLayer(<span class="keyword">const</span> <a class="code" href="classsoil_layer.html">soilLayer</a>&amp; Layer)
<a name="l00078"></a>00078 : <a class="code" href="classbase.html">base</a>(Layer)
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080  <a class="code" href="classsoil_layer.html#af34f26ea69c673eaa8db70f6c0572373">next</a> = NULL;
<a name="l00081"></a>00081  <span class="keywordflow">if</span> (&amp;Layer)
<a name="l00082"></a>00082  {
<a name="l00083"></a>00083   <a class="code" href="classsoil_layer.html#a9d84413d44f869d41635363bf2de0e04">TillageEffectTemperature</a> = Layer.<a class="code" href="classsoil_layer.html#a9d84413d44f869d41635363bf2de0e04">TillageEffectTemperature</a>;
<a name="l00084"></a>00084   <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>             = Layer.<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>;
<a name="l00085"></a>00085   <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>              = Layer.<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>;
<a name="l00086"></a>00086   <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>             = Layer.<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>;
<a name="l00087"></a>00087   <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>             = Layer.<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>;
<a name="l00088"></a>00088   <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>            = Layer.<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>;
<a name="l00089"></a>00089   <a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>              = Layer.<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>;
<a name="l00090"></a>00090   <a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>         = Layer.<a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>;
<a name="l00091"></a>00091   <a class="code" href="classsoil_layer.html#ae050c0e0b52e07baf301a5bbebc239db">holdbackConstant</a>         = Layer.<a class="code" href="classsoil_layer.html#ae050c0e0b52e07baf301a5bbebc239db">holdbackConstant</a>;
<a name="l00092"></a>00092   <a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>           = Layer.<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>;
<a name="l00093"></a>00093   <a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a>                 = Layer.<a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a>;
<a name="l00094"></a>00094   <a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>            = Layer.<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>;
<a name="l00095"></a>00095   <a class="code" href="classsoil_layer.html#acbee67e83ac96f6906c03498366616b6">startDepth</a>               = Layer.<a class="code" href="classsoil_layer.html#acbee67e83ac96f6906c03498366616b6">startDepth</a>;
<a name="l00096"></a>00096   <a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>                = Layer.<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;
<a name="l00097"></a>00097   <a class="code" href="classsoil_layer.html#ae98e1db7a6e369ad8c15667150daaaf0">wiltCapacity</a>             = Layer.<a class="code" href="classsoil_layer.html#ae98e1db7a6e369ad8c15667150daaaf0">wiltCapacity</a>;
<a name="l00098"></a>00098   <a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>              = Layer.<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>;
<a name="l00099"></a>00099   <a class="code" href="classsoil_layer.html#a50746e4427b349f891f3be4eb3bd6878">nitrificationRate</a>        = Layer.<a class="code" href="classsoil_layer.html#a50746e4427b349f891f3be4eb3bd6878">nitrificationRate</a>;
<a name="l00100"></a>00100   <a class="code" href="classsoil_layer.html#abe6002dd278efb361b9adc4cfb299d92">tortuosityLimit</a>          = Layer.<a class="code" href="classsoil_layer.html#abe6002dd278efb361b9adc4cfb299d92">tortuosityLimit</a>;
<a name="l00101"></a>00101   <a class="code" href="classsoil_layer.html#aea0648625d45f262740d107bbdfa4d55">waterUptake</a>              = Layer.<a class="code" href="classsoil_layer.html#aea0648625d45f262740d107bbdfa4d55">waterUptake</a>;
<a name="l00102"></a>00102   <a class="code" href="classsoil_layer.html#a7c798f757104d72b66f54e76e284097f">waterFlux</a>                = Layer.<a class="code" href="classsoil_layer.html#a7c798f757104d72b66f54e76e284097f">waterFlux</a>;
<a name="l00103"></a>00103   <a class="code" href="classsoil_layer.html#a99d47de1a6d78f922c9d988b691422fd">CO2Evolution</a>             = Layer.<a class="code" href="classsoil_layer.html#a99d47de1a6d78f922c9d988b691422fd">CO2Evolution</a>;
<a name="l00104"></a>00104   <a class="code" href="classsoil_layer.html#a5dd2dd5bfbdfc6d2e79a50136185da04">ammoniumLeaching</a>         = Layer.<a class="code" href="classsoil_layer.html#a5dd2dd5bfbdfc6d2e79a50136185da04">ammoniumLeaching</a>;
<a name="l00105"></a>00105   <a class="code" href="classsoil_layer.html#a4082fb4d9c9c2a1decbe1dc735a1c3f7">nitrateLeaching</a>          = Layer.<a class="code" href="classsoil_layer.html#a4082fb4d9c9c2a1decbe1dc735a1c3f7">nitrateLeaching</a>;
<a name="l00106"></a>00106   <a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>               = Layer.<a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>;
<a name="l00107"></a>00107   <a class="code" href="classsoil_layer.html#a5dcc4d96a38106a631098dd65f4a7e6d">equilibrated</a>             = Layer.<a class="code" href="classsoil_layer.html#a5dcc4d96a38106a631098dd65f4a7e6d">equilibrated</a>;
<a name="l00108"></a>00108   <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>             = Layer.<a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>;
<a name="l00109"></a>00109   <a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>            = Layer.<a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>;
<a name="l00110"></a>00110   <a class="code" href="classsoil_layer.html#abc49478bbf466b7211f02fcd32a84e9f">mobility</a>                 = Layer.<a class="code" href="classsoil_layer.html#abc49478bbf466b7211f02fcd32a84e9f">mobility</a>;
<a name="l00111"></a>00111   <a class="code" href="classsoil_layer.html#a529a180a696b6f94ae72126ae7ee42b8">mobility1</a>                = Layer.<a class="code" href="classsoil_layer.html#a529a180a696b6f94ae72126ae7ee42b8">mobility1</a>;
<a name="l00112"></a>00112   <a class="code" href="classsoil_layer.html#ac067c039016361465b827a712fc4ee46">N2OFromNitrification</a>     = Layer.<a class="code" href="classsoil_layer.html#ac067c039016361465b827a712fc4ee46">N2OFromNitrification</a>;
<a name="l00113"></a>00113   <a class="code" href="classsoil_layer.html#a4ba9ff292a84bae74b17671f46c2d32d">N2OFromDenitrification</a>   = Layer.<a class="code" href="classsoil_layer.html#a4ba9ff292a84bae74b17671f46c2d32d">N2OFromDenitrification</a>;
<a name="l00114"></a>00114   <a class="code" href="classsoil_layer.html#adad888a2d01d277a32514646edb71c9e">Denitrification</a>          = Layer.<a class="code" href="classsoil_layer.html#adad888a2d01d277a32514646edb71c9e">Denitrification</a>;
<a name="l00115"></a>00115   <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>            = <span class="keyword">new</span> <a class="code" href="classorganic_matter.html">organicMatter</a>(*Layer.<a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>);
<a name="l00116"></a>00116   <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classbase.html#a42c446f0adea294e97a2486946b7cbc4">SetOwner</a>(<span class="keyword">this</span>);
<a name="l00117"></a>00117   <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>                       = <span class="keyword">new</span> <a class="code" href="classp_f___curve.html">pF_Curve</a>(*Layer.<a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>);
<a name="l00118"></a>00118   <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>                                = <a class="code" href="classbudget.html">budget</a>(Layer.<a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>);
<a name="l00119"></a>00119   <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#a47533e4ef9b8907303904da10f934f74">Reset</a>();         <span class="comment">// History ignored!</span>
<a name="l00120"></a>00120   <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>                              = <a class="code" href="classbudget.html">budget</a>(Layer.<a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>);
<a name="l00121"></a>00121   <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#a47533e4ef9b8907303904da10f934f74">Reset</a>();       <span class="comment">// History ignored!</span>
<a name="l00122"></a>00122   <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>               = <a class="code" href="classbudget.html">budget</a>(Layer.<a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>);
<a name="l00123"></a>00123   <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>.<a class="code" href="classbudget.html#a47533e4ef9b8907303904da10f934f74">Reset</a>();     <span class="comment">// History ignored!</span>
<a name="l00124"></a>00124  }
<a name="l00125"></a>00125 }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="comment">/****************************************************************************\</span>
<a name="l00128"></a>00128 <span class="comment">pF curves are assumed to be equal. This assumption is not tested though.</span>
<a name="l00129"></a>00129 <span class="comment">\****************************************************************************/</span>
<a name="l00130"></a><a class="code" href="classsoil_layer.html#a6dcefc2b3278461493f73971d8885cb7">00130</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#a6dcefc2b3278461493f73971d8885cb7">soilLayer::Add</a>(<a class="code" href="classsoil_layer.html">soilLayer</a>* Layer, <span class="keywordtype">double</span> <a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132  <span class="keywordflow">if</span> (Layer)
<a name="l00133"></a>00133  {
<a name="l00134"></a>00134   <a class="code" href="classsoil_layer.html#a9d84413d44f869d41635363bf2de0e04">TillageEffectTemperature</a>= <a class="code" href="classsoil_layer.html#a9d84413d44f869d41635363bf2de0e04">TillageEffectTemperature</a>*(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)+Layer-&gt;<a class="code" href="classsoil_layer.html#a9d84413d44f869d41635363bf2de0e04">TillageEffectTemperature</a>*fraction;
<a name="l00135"></a>00135   <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>                           = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>*(1.0-fraction)+Layer-&gt;<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>*<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>;
<a name="l00136"></a>00136   <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>                  = <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>*(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)+Layer-&gt;<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>*fraction;
<a name="l00137"></a>00137   <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>                  = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>*(1.0-fraction)+Layer-&gt;<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>*<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>;
<a name="l00138"></a>00138   <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>                         = <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>*(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)+Layer-&gt;<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>*fraction;
<a name="l00139"></a>00139   <a class="code" href="classsoil_layer.html#a5dd2dd5bfbdfc6d2e79a50136185da04">ammoniumLeaching</a>              = <a class="code" href="classsoil_layer.html#a5dd2dd5bfbdfc6d2e79a50136185da04">ammoniumLeaching</a>*(1.0-fraction)+Layer-&gt;<a class="code" href="classsoil_layer.html#a5dd2dd5bfbdfc6d2e79a50136185da04">ammoniumLeaching</a>*<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>;
<a name="l00140"></a>00140   <a class="code" href="classsoil_layer.html#a4082fb4d9c9c2a1decbe1dc735a1c3f7">nitrateLeaching</a>               = <a class="code" href="classsoil_layer.html#a4082fb4d9c9c2a1decbe1dc735a1c3f7">nitrateLeaching</a>*(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)+Layer-&gt;<a class="code" href="classsoil_layer.html#a4082fb4d9c9c2a1decbe1dc735a1c3f7">nitrateLeaching</a>*fraction;
<a name="l00141"></a>00141   <a class="code" href="classsoil_layer.html#ac067c039016361465b827a712fc4ee46">N2OFromNitrification</a>  = <a class="code" href="classsoil_layer.html#ac067c039016361465b827a712fc4ee46">N2OFromNitrification</a>*(1.0-fraction)+Layer-&gt;<a class="code" href="classsoil_layer.html#ac067c039016361465b827a712fc4ee46">N2OFromNitrification</a>*<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>;
<a name="l00142"></a>00142   <a class="code" href="classsoil_layer.html#a4ba9ff292a84bae74b17671f46c2d32d">N2OFromDenitrification</a>= <a class="code" href="classsoil_layer.html#a4ba9ff292a84bae74b17671f46c2d32d">N2OFromDenitrification</a>*(1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)+Layer-&gt;<a class="code" href="classsoil_layer.html#a4ba9ff292a84bae74b17671f46c2d32d">N2OFromDenitrification</a>*fraction;
<a name="l00143"></a>00143   <a class="code" href="classsoil_layer.html#adad888a2d01d277a32514646edb71c9e">Denitrification</a>       = <a class="code" href="classsoil_layer.html#adad888a2d01d277a32514646edb71c9e">Denitrification</a>*(1.0-fraction)+Layer-&gt;<a class="code" href="classsoil_layer.html#adad888a2d01d277a32514646edb71c9e">Denitrification</a>*<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145   <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>                  = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>;
<a name="l00146"></a>00146   <a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>                           = (1.0-fraction)*<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>;
<a name="l00147"></a>00147   <a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>              = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*<a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>;
<a name="l00148"></a>00148   <a class="code" href="classsoil_layer.html#ae050c0e0b52e07baf301a5bbebc239db">holdbackConstant</a>              = (1.0-fraction)*<a class="code" href="classsoil_layer.html#ae050c0e0b52e07baf301a5bbebc239db">holdbackConstant</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#ae050c0e0b52e07baf301a5bbebc239db">holdbackConstant</a>;
<a name="l00149"></a>00149   <a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>                        = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>;
<a name="l00150"></a>00150   <a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a>                                      = (1.0-fraction)*<a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a>;
<a name="l00151"></a>00151   <a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>                         = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>;
<a name="l00152"></a>00152   <a class="code" href="classsoil_layer.html#acbee67e83ac96f6906c03498366616b6">startDepth</a>                            = (1.0-fraction)*<a class="code" href="classsoil_layer.html#acbee67e83ac96f6906c03498366616b6">startDepth</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#acbee67e83ac96f6906c03498366616b6">startDepth</a>;
<a name="l00153"></a>00153   <a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>                             = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;
<a name="l00154"></a>00154   <a class="code" href="classsoil_layer.html#ae98e1db7a6e369ad8c15667150daaaf0">wiltCapacity</a>          = (1.0-fraction)*<a class="code" href="classsoil_layer.html#ae98e1db7a6e369ad8c15667150daaaf0">wiltCapacity</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#ae98e1db7a6e369ad8c15667150daaaf0">wiltCapacity</a>;
<a name="l00155"></a>00155   <a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>           = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>;
<a name="l00156"></a>00156   <a class="code" href="classsoil_layer.html#a50746e4427b349f891f3be4eb3bd6878">nitrificationRate</a>     = (1.0-fraction)*<a class="code" href="classsoil_layer.html#a50746e4427b349f891f3be4eb3bd6878">nitrificationRate</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#a50746e4427b349f891f3be4eb3bd6878">nitrificationRate</a>;
<a name="l00157"></a>00157   <a class="code" href="classsoil_layer.html#abe6002dd278efb361b9adc4cfb299d92">tortuosityLimit</a>               = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*<a class="code" href="classsoil_layer.html#abe6002dd278efb361b9adc4cfb299d92">tortuosityLimit</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#abe6002dd278efb361b9adc4cfb299d92">tortuosityLimit</a>;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159   <a class="code" href="classsoil_layer.html#aea0648625d45f262740d107bbdfa4d55">waterUptake</a>                           = (1.0-fraction)*<a class="code" href="classsoil_layer.html#aea0648625d45f262740d107bbdfa4d55">waterUptake</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#aea0648625d45f262740d107bbdfa4d55">waterUptake</a>;
<a name="l00160"></a>00160   <a class="code" href="classsoil_layer.html#a7c798f757104d72b66f54e76e284097f">waterFlux</a>                             = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*<a class="code" href="classsoil_layer.html#a7c798f757104d72b66f54e76e284097f">waterFlux</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#a7c798f757104d72b66f54e76e284097f">waterFlux</a>;
<a name="l00161"></a>00161   <a class="code" href="classsoil_layer.html#a99d47de1a6d78f922c9d988b691422fd">CO2Evolution</a>                  = (1.0-fraction)*<a class="code" href="classsoil_layer.html#a99d47de1a6d78f922c9d988b691422fd">CO2Evolution</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#a99d47de1a6d78f922c9d988b691422fd">CO2Evolution</a>;
<a name="l00162"></a>00162   <a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>                            = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*<a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>;
<a name="l00163"></a>00163   <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>          = (1.0-fraction)*<a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>;
<a name="l00164"></a>00164   <a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>         = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*<a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>;
<a name="l00165"></a>00165   <a class="code" href="classsoil_layer.html#abc49478bbf466b7211f02fcd32a84e9f">mobility</a>              = (1.0-fraction)*<a class="code" href="classsoil_layer.html#abc49478bbf466b7211f02fcd32a84e9f">mobility</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#abc49478bbf466b7211f02fcd32a84e9f">mobility</a>;
<a name="l00166"></a>00166   <a class="code" href="classsoil_layer.html#a529a180a696b6f94ae72126ae7ee42b8">mobility1</a>             = (1.0-<a class="code" href="typer_8h.html#ae4c405e5c68c6ec2c44bb6d6adfc2f6cab10366ecc76133a0a4a4712a5ee26f65">fraction</a>)*<a class="code" href="classsoil_layer.html#a529a180a696b6f94ae72126ae7ee42b8">mobility1</a>+fraction*Layer-&gt;<a class="code" href="classsoil_layer.html#a529a180a696b6f94ae72126ae7ee42b8">mobility1</a>;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168   <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#a2f378ac0b5f670cc9ec42b4e9ceb3c51">Add</a>(Layer-&gt;<a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>,fraction);
<a name="l00169"></a>00169   <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#a2f378ac0b5f670cc9ec42b4e9ceb3c51">Add</a>(Layer-&gt;<a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>,fraction);
<a name="l00170"></a>00170   <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>.<a class="code" href="classbudget.html#a2f378ac0b5f670cc9ec42b4e9ceb3c51">Add</a>(Layer-&gt;<a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>,fraction);
<a name="l00171"></a>00171   <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#af8e7ce68e31c09319d0b33d7f20a5100">Add</a>(Layer-&gt;<a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>,fraction);
<a name="l00172"></a>00172  }
<a name="l00173"></a>00173 }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="comment">/****************************************************************************\</span>
<a name="l00176"></a>00176 <span class="comment">\****************************************************************************/</span>
<a name="l00177"></a><a class="code" href="classsoil_layer.html#a7b1d8051966f9fbd7452b1c7dfbdc663">00177</a> <a class="code" href="classsoil_layer.html#a7b1d8051966f9fbd7452b1c7dfbdc663">soilLayer::~soilLayer</a>()
<a name="l00178"></a>00178 {
<a name="l00179"></a>00179    <span class="keyword">delete</span> <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>;
<a name="l00180"></a>00180    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>)
<a name="l00181"></a>00181       <span class="keyword">delete</span> <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>;
<a name="l00182"></a>00182    <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a> = NULL;
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 <span class="comment">/****************************************************************************\</span>
<a name="l00186"></a>00186 <span class="comment">\****************************************************************************/</span>
<a name="l00187"></a><a class="code" href="classsoil_layer.html#a9408711ac2943d5aff72bf3fc0e9e7c7">00187</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#a9408711ac2943d5aff72bf3fc0e9e7c7">soilLayer::Initialize</a>(<span class="keywordtype">double</span> startDep,
<a name="l00188"></a>00188                                                                         <span class="keywordtype">double</span> thick,
<a name="l00189"></a>00189                                                                         fstream * f)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191    <a class="code" href="classbase.html#a3cb378050dc4ced8420f41dcd7292239">Setfile</a>(f);
<a name="l00192"></a>00192    <a class="code" href="classsoil_layer.html#acbee67e83ac96f6906c03498366616b6">startDepth</a>          = startDep;
<a name="l00193"></a>00193    <a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>           = thick;
<a name="l00194"></a>00194    <span class="keywordtype">double</span> center       = startDep+0.5*thick;
<a name="l00195"></a>00195    <span class="keywordtype">bool</span> foundLayer=<span class="keyword">false</span>;
<a name="l00196"></a>00196    <span class="keywordtype">int</span> n,<a class="code" href="typer_8h.html#a74e289adaa38a655bd68482967f86cfdaa4500e61db092c2e1719b5d68b047ec3">first</a>;
<a name="l00197"></a>00197    <a class="code" href="classbase.html#a80052a7eeb8bce90247aedd358cc1cf6">SetCritical</a>();
<a name="l00198"></a>00198    <a class="code" href="classbase.html#a4f63fec241f5857f3fe28b43f85d0fa5">GetSectionNumbers</a>(<span class="stringliteral">&quot;SoilLayer&quot;</span>,&amp;first,&amp;n);
<a name="l00199"></a>00199    <span class="keywordtype">int</span> i=<a class="code" href="typer_8h.html#a74e289adaa38a655bd68482967f86cfdaa4500e61db092c2e1719b5d68b047ec3">first</a>;
<a name="l00200"></a>00200    <span class="keywordtype">double</span> topOfLayer=0.0;
<a name="l00201"></a>00201    <span class="keywordflow">while</span> (!foundLayer &amp;&amp; (i&lt;(first+n)))
<a name="l00202"></a>00202    {
<a name="l00203"></a>00203       <a class="code" href="classbase.html#a88e41ff60ffb7e707312a09f20457e73">FindSection</a>(<span class="stringliteral">&quot;SoilLayer&quot;</span>,i);
<a name="l00204"></a>00204       <span class="keywordtype">double</span> totalThickness;
<a name="l00205"></a>00205       <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;Thickness&quot;</span>,&amp;totalThickness);
<a name="l00206"></a>00206       <span class="keywordflow">if</span> (totalThickness&lt;=0.0)
<a name="l00207"></a>00207         <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;soilLayer::Initialize - Thickness must be above zero&quot;</span>);
<a name="l00208"></a>00208       foundLayer=(center&gt;=topOfLayer) &amp;&amp; (center&lt;=(topOfLayer+totalThickness));
<a name="l00209"></a>00209       <span class="keywordflow">if</span> (foundLayer)
<a name="l00210"></a>00210       {
<a name="l00211"></a>00211          <a class="code" href="classbase.html#a5c9e361dfd9a7804a33b7baa8f5a4b1f">UnsetCritical</a>();
<a name="l00212"></a>00212          <span class="keywordtype">int</span> soilType=5;
<a name="l00213"></a>00213          <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;SoilType&quot;</span>,&amp;soilType);
<a name="l00214"></a>00214          <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;Ammonium&quot;</span>,&amp;<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l00215"></a>00215          <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>=<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>*<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>/totalThickness;
<a name="l00216"></a>00216          <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>        = 0.0;
<a name="l00217"></a>00217          <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;Nitrate&quot;</span>,&amp;<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l00218"></a>00218          <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>=<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>*<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>/totalThickness;
<a name="l00219"></a>00219          <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00220"></a>00220          <span class="keywordtype">double</span> siltContent;
<a name="l00221"></a>00221          <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;SiltContent&quot;</span>,&amp;siltContent);
<a name="l00222"></a>00222          <span class="keywordflow">if</span> (!<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;ClayContent&quot;</span>,&amp;<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>))
<a name="l00223"></a>00223          {
<a name="l00224"></a>00224             <span class="keywordtype">double</span> JBC[] = {0.025,0.025,0.075,0.075,0.125,0.125,0.20,0.35,0.50,0.10};
<a name="l00225"></a>00225             <span class="keywordtype">int</span> JB = 5;
<a name="l00226"></a>00226             <span class="keywordflow">if</span> (soilType&gt;=1 &amp;&amp; soilType&lt;=10)
<a name="l00227"></a>00227                 JB = soilType;
<a name="l00228"></a>00228             <a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>= JBC[JB-1];
<a name="l00229"></a>00229          }
<a name="l00230"></a>00230          <span class="keywordflow">if</span> (!<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;DrainageConstant&quot;</span>,&amp;<a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>))
<a name="l00231"></a>00231          {
<a name="l00232"></a>00232             <a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>=1.0271-3.02*<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>*<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>;   <span class="comment">// Function from Addiscot &amp; Whitmore 1991, Soil Use. Man., 94-102</span>
<a name="l00233"></a>00233             <a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>=min(1.0,max(0.1,<a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>));    <span class="comment">// Cut at [0.1;1.0]</span>
<a name="l00234"></a>00234             <a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>=min(1.0,<a class="code" href="classsoil_layer.html#a995f64ed0bb7052bee9be257daa0b346">drainageConstant</a>*15.462*pow(<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>,-0.7)); <span class="comment">// Fitted to Fig. 2c, Addiscot &amp; Whitmore 1991</span>
<a name="l00235"></a>00235          }
<a name="l00236"></a>00236          <span class="keywordflow">if</span> (!<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;HoldbackConstant&quot;</span>,&amp;<a class="code" href="classsoil_layer.html#ae050c0e0b52e07baf301a5bbebc239db">holdbackConstant</a>))
<a name="l00237"></a>00237          {
<a name="l00238"></a>00238             <a class="code" href="classsoil_layer.html#ae050c0e0b52e07baf301a5bbebc239db">holdbackConstant</a>=0.1;
<a name="l00239"></a>00239             <span class="keywordflow">if</span> (startDep&gt;199)
<a name="l00240"></a>00240                 <a class="code" href="classsoil_layer.html#ae050c0e0b52e07baf301a5bbebc239db">holdbackConstant</a>=0.3;
<a name="l00241"></a>00241          }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243          <span class="keywordflow">if</span> (!<a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;DryBulkDensity&quot;</span>,&amp;<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>))
<a name="l00244"></a>00244                 <a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>=1.5;
<a name="l00245"></a>00245          <a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a> = 1.0-<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>/2.65;
<a name="l00246"></a>00246          <a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>=<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>*1E6;
<a name="l00247"></a>00247          <span class="keywordtype">double</span> carbon=0.0;
<a name="l00248"></a>00248          <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;CarbonPct&quot;</span>,&amp;carbon);
<a name="l00249"></a>00249 
<a name="l00250"></a>00250                         <span class="keywordtype">bool</span> TopSoil = (startDep&lt;250);
<a name="l00251"></a>00251          <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a> = <span class="keyword">new</span> <a class="code" href="classp_f___curve.html">pF_Curve</a>(0); <span class="comment">// Interpolation method set to zero. Correct ????!!!!!!!!!!!!!!!</span>
<a name="l00252"></a>00252          <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a32cae6290138a8f729593ed623b03af5">ReadParameters</a>(f,i,<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>,<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>,siltContent,carbon,TopSoil);          <span class="comment">// Extra parameters added for support of Mualem van Genucten model</span>
<a name="l00253"></a>00253          <span class="keywordtype">double</span> pF_FC = 2.0;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255          <span class="keywordflow">if</span> (soilType==1)
<a name="l00256"></a>00256                 pF_FC = 1.8;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258          <a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a> = <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a662cff8287e3a413961df635acef65b7">GetRelativeWater</a>(pF_FC)*<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;
<a name="l00259"></a>00259          <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a> = <a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>;
<a name="l00260"></a>00260          <span class="keywordtype">double</span> MaxContent = <a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a>*<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;
<a name="l00261"></a>00261          <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>&gt;MaxContent)
<a name="l00262"></a>00262                 <a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a> = <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a662cff8287e3a413961df635acef65b7">GetRelativeWater</a>(0.0);        <span class="comment">// HACK !!!!!???</span>
<a name="l00263"></a>00263          <span class="keywordflow">if</span> (porosity&lt;=.9*pF-&gt;GetRelativeWater(0.0))
<a name="l00264"></a>00264                 <a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a> = <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a662cff8287e3a413961df635acef65b7">GetRelativeWater</a>(0.0);        <span class="comment">// HACK !!!!!???</span>
<a name="l00265"></a>00265 
<a name="l00266"></a>00266          <a class="code" href="classsoil_layer.html#ae98e1db7a6e369ad8c15667150daaaf0">wiltCapacity</a> = <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a662cff8287e3a413961df635acef65b7">GetRelativeWater</a>(4.2)*<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;
<a name="l00267"></a>00267          <a class="code" href="classsoil_layer.html#a50746e4427b349f891f3be4eb3bd6878">nitrificationRate</a>    = 0.1;
<a name="l00268"></a>00268          <a class="code" href="classsoil_layer.html#abe6002dd278efb361b9adc4cfb299d92">tortuosityLimit</a>      = 0.1;
<a name="l00269"></a>00269          carbon=carbon*<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>*thickness/10E4;
<a name="l00270"></a>00270          <span class="keywordtype">char</span> sfn[80]=<span class="stringliteral">&quot;cnmodel.dat&quot;</span>;
<a name="l00271"></a>00271          <a class="code" href="classbase.html#aff0b96b92d78c345fd60335cece99d08">GetParameter</a>(<span class="stringliteral">&quot;SomFileName&quot;</span>,sfn);
<a name="l00272"></a>00272          <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#af7bf4f5a06da9f6c4977c56d1bbb17ef">Initialize</a>(<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>,carbon,f,i,sfn);
<a name="l00273"></a>00273       }
<a name="l00274"></a>00274       topOfLayer+=totalThickness;
<a name="l00275"></a>00275       i++;
<a name="l00276"></a>00276    }
<a name="l00277"></a>00277    <span class="keywordflow">if</span> (!foundLayer)
<a name="l00278"></a>00278     <a class="code" href="classbase.html#a32986c47c1ff0d162befc4a3830734f2">Terminate</a>(<span class="stringliteral">&quot;soilLayer::Initialize - no appropriate layer found&quot;</span>);
<a name="l00279"></a>00279    <a class="code" href="classbase.html#a3cb378050dc4ced8420f41dcd7292239">Setfile</a>(NULL);
<a name="l00280"></a>00280    <a class="code" href="classbase.html#a7ca584f6b100bb78cbaec8cfaaf9a30c">DeleteInputFile</a>();
<a name="l00281"></a>00281 }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 <span class="comment">/****************************************************************************\</span>
<a name="l00285"></a>00285 <span class="comment">\****************************************************************************/</span>
<a name="l00286"></a><a class="code" href="classsoil_layer.html#a1f943c69c9e19526aa5e7e8ef11503fa">00286</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#a1f943c69c9e19526aa5e7e8ef11503fa">soilLayer::SetIceContent</a>(<span class="keywordtype">double</span> aIceContent)
<a name="l00287"></a>00287 {
<a name="l00288"></a>00288    <span class="keywordflow">if</span> (aIceContent&gt;<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>)
<a name="l00289"></a>00289       <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::SetIceContent - requsted ice content exceeds total amount of water&quot;</span>);
<a name="l00290"></a>00290 <span class="comment">/*   if (aIceContent&lt;0)</span>
<a name="l00291"></a>00291 <span class="comment">      theMessage-&gt;WarningWithDisplay(&quot;soilLayer::SetIceContent - requsted ice content is negative&quot;);</span>
<a name="l00292"></a>00292 <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!! PUT BACK !!!!!!!!!!!!!! */</span>
<a name="l00293"></a>00293    <a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a> = max(0.0,min(<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>,aIceContent));
<a name="l00294"></a>00294 }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296 <span class="comment">/****************************************************************************\</span>
<a name="l00297"></a>00297 <span class="comment">\****************************************************************************/</span>
<a name="l00298"></a><a class="code" href="classsoil_layer.html#a1789c88edae9f3ef01bc1b321bc71913">00298</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a1789c88edae9f3ef01bc1b321bc71913">soilLayer::GetCenterDepth</a>()
<a name="l00299"></a>00299 {
<a name="l00300"></a>00300    <span class="keywordtype">double</span> retVal=<a class="code" href="classsoil_layer.html#acbee67e83ac96f6906c03498366616b6">startDepth</a>+<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>/2.0;
<a name="l00301"></a>00301    <span class="keywordflow">if</span> (retVal&lt;0)
<a name="l00302"></a>00302       <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilLayer::GetCenterDepth() - center depth of a soil layer can not be negative&quot;</span>);
<a name="l00303"></a>00303    <span class="keywordflow">return</span> retVal;
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 <span class="comment">/****************************************************************************\</span>
<a name="l00308"></a>00308 <span class="comment">\****************************************************************************/</span>
<a name="l00309"></a><a class="code" href="classsoil_layer.html#aa3f614a875b5dbc8b8002f56595abb37">00309</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_layer.html#ae96a8b15fed4200fee1a8001599e3c8d">soilLayer::GetPoolNitrogen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * Name,<span class="keywordtype">double</span> startDepth,<span class="keywordtype">double</span> thickness)
<a name="l00310"></a>00310 {
<a name="l00311"></a>00311         <span class="keywordflow">return</span> <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#a57c64ddc2f0aacaa27b4e2fb7e6c1713">GetPoolNitrogen</a>(Name)*<a class="code" href="classsoil_layer.html#affa95354eeb271651824f92af6b24ca6">IntervalFraction</a>(startDepth,thickness);
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 <span class="comment">/****************************************************************************\</span>
<a name="l00315"></a>00315 <span class="comment">\****************************************************************************/</span>
<a name="l00316"></a><a class="code" href="classsoil_layer.html#a09f4c3dc099147645d71480166261191">00316</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#a09f4c3dc099147645d71480166261191">soilLayer::AddNext</a>(<a class="code" href="classsoil_layer.html">soilLayer</a> * layer)
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318  <a class="code" href="classsoil_layer.html#af34f26ea69c673eaa8db70f6c0572373">next</a> = layer;
<a name="l00319"></a>00319 }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321 <span class="comment">/****************************************************************************\</span>
<a name="l00322"></a>00322 <span class="comment">Adds nitrogen to layer</span>
<a name="l00323"></a>00323 <span class="comment">addNitrate    - Nitrate to be added [g N/m�]</span>
<a name="l00324"></a>00324 <span class="comment">addAmmonium   - Ammonium to be added [g N/m�]</span>
<a name="l00325"></a>00325 <span class="comment">\****************************************************************************/</span>
<a name="l00326"></a><a class="code" href="classsoil_layer.html#a1cdb99656097b11d7b7acb329dd6cd5e">00326</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#a1cdb99656097b11d7b7acb329dd6cd5e">soilLayer::AddNutrient</a>(<a class="code" href="classnitrogen.html">nitrogen</a> addNitrate, <a class="code" href="classnitrogen.html">nitrogen</a> addAmmonium)
<a name="l00327"></a>00327 {
<a name="l00328"></a>00328         <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a> &gt; <a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>)
<a name="l00329"></a>00329    {
<a name="l00330"></a>00330         <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a> = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a> + addNitrate;
<a name="l00331"></a>00331         <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a> = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a> + addAmmonium;
<a name="l00332"></a>00332    }
<a name="l00333"></a>00333    <span class="keywordflow">else</span>
<a name="l00334"></a>00334    {
<a name="l00335"></a>00335         <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a> = <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a> + addNitrate;
<a name="l00336"></a>00336       <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a> = <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a> + addAmmonium;
<a name="l00337"></a>00337    }
<a name="l00338"></a>00338    <span class="keywordflow">if</span>(<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6)
<a name="l00339"></a>00339         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::AddNutrient - negative n concentrations&quot;</span>);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341    <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#ad619d773e77931df0435e8c08314f68e">AddInput</a>(addNitrate.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+addAmmonium.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l00342"></a>00342    <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#ad619d773e77931df0435e8c08314f68e">AddInput</a>(addNitrate.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+addAmmonium.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>);
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 <span class="comment">/****************************************************************************\</span>
<a name="l00347"></a>00347 <span class="comment">Calculates the volumetric heatcapacity</span>
<a name="l00348"></a>00348 <span class="comment">\****************************************************************************/</span>
<a name="l00349"></a><a class="code" href="classsoil_layer.html#a0f90f88d0dfdd44b5075f2e20cec6f45">00349</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a0f90f88d0dfdd44b5075f2e20cec6f45">soilLayer::HeatCapacity</a>()    <span class="comment">//kg/m3/dgC</span>
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351         <span class="keywordflow">return</span> (<a class="code" href="soil_layer_8cpp.html#a3429b0569d7d39f18cbcb8bfba864023">HeatCapacitySolid</a>*<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>/1000
<a name="l00352"></a>00352                           +<a class="code" href="soil_layer_8cpp.html#aa802d053b0e834f15ac8331c6c1d42b8">HeatCapacityWater</a>*<a class="code" href="soil_layer_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">WaterDensity</a>*(<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>-<a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>)/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>
<a name="l00353"></a>00353                           +<a class="code" href="soil_layer_8cpp.html#a60ac72fe64fb25fb3826fa9324a8ab6e">HeatCapacityIce</a>*<a class="code" href="soil_layer_8cpp.html#a79ee1ed68b41e6515e17cc7529c31a8a">WaterDensity</a>*<a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>);
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="comment">/****************************************************************************\</span>
<a name="l00357"></a>00357 <span class="comment">\****************************************************************************/</span>
<a name="l00358"></a><a class="code" href="classsoil_layer.html#a670e17930818ea08c5ace53a25700f4a">00358</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a670e17930818ea08c5ace53a25700f4a">soilLayer::SpecWaterCapacity</a>()
<a name="l00359"></a>00359 {
<a name="l00360"></a>00360         <span class="keywordtype">double</span> relativeWater = <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;
<a name="l00361"></a>00361    <span class="keywordtype">double</span> specWater;
<a name="l00362"></a>00362    <span class="keywordtype">double</span> pF1;
<a name="l00363"></a>00363    pF1 = <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a816b70830f88edec58e42d94dee0b254">GetPressurePotential</a>(relativeWater);
<a name="l00364"></a>00364    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>&lt;<a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a>*<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>)
<a name="l00365"></a>00365       <span class="keywordflow">if</span> (pF1==<a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a816b70830f88edec58e42d94dee0b254">GetPressurePotential</a>(relativeWater-0.01))
<a name="l00366"></a>00366                 specWater = 1e10;
<a name="l00367"></a>00367       <span class="keywordflow">else</span>
<a name="l00368"></a>00368         specWater = 0.01/(pF1-<a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a816b70830f88edec58e42d94dee0b254">GetPressurePotential</a>(relativeWater-0.01));
<a name="l00369"></a>00369    <span class="keywordflow">else</span>
<a name="l00370"></a>00370         <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a816b70830f88edec58e42d94dee0b254">GetPressurePotential</a>(relativeWater+0.01)==pF1)
<a name="l00371"></a>00371          specWater = 1e10;                     <span class="comment">// er ss forkert</span>
<a name="l00372"></a>00372       <span class="keywordflow">else</span>
<a name="l00373"></a>00373         specWater = -0.01/(pF1-<a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a816b70830f88edec58e42d94dee0b254">GetPressurePotential</a>(relativeWater+0.01));
<a name="l00374"></a>00374    <span class="keywordflow">return</span> 1.1019e-5*specWater;                <span class="comment">// converts m to J m-3</span>
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 <span class="comment">/****************************************************************************\</span>
<a name="l00380"></a>00380 <span class="comment">\****************************************************************************/</span>
<a name="l00381"></a><a class="code" href="classsoil_layer.html#a6c55ade0e8450447467b46f13c169309">00381</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_layer.html#aa5fa8a32edd6f42e0cb5fac607a65b29">soilLayer::GetAmmonium</a>(<span class="keywordtype">double</span> startDepth,<span class="keywordtype">double</span> thickness)
<a name="l00382"></a>00382 {
<a name="l00383"></a>00383         <span class="keywordflow">return</span> (<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>+<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>)*<a class="code" href="classsoil_layer.html#affa95354eeb271651824f92af6b24ca6">IntervalFraction</a>(startDepth,thickness);
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 <span class="comment">/****************************************************************************\</span>
<a name="l00387"></a>00387 <span class="comment">\****************************************************************************/</span>
<a name="l00388"></a><a class="code" href="classsoil_layer.html#a35ebeffcc6514687cac1cb50dea2cad1">00388</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_layer.html#a79f32d89dd310312e5974d2959c0c8c3">soilLayer::GetNitrate</a>(<span class="keywordtype">double</span> startDepth,<span class="keywordtype">double</span> thickness)
<a name="l00389"></a>00389 {
<a name="l00390"></a>00390         <span class="keywordflow">return</span> (<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>+<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>)*<a class="code" href="classsoil_layer.html#affa95354eeb271651824f92af6b24ca6">IntervalFraction</a>(startDepth,thickness);
<a name="l00391"></a>00391 }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 <span class="comment">/****************************************************************************\</span>
<a name="l00394"></a>00394 <span class="comment">\****************************************************************************/</span>
<a name="l00395"></a><a class="code" href="classsoil_layer.html#ad3683d88ec613da7fd985169287c1553">00395</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#ad3683d88ec613da7fd985169287c1553">soilLayer::GetChloride</a>(<span class="keywordtype">double</span> startDepth,<span class="keywordtype">double</span> thickness)
<a name="l00396"></a>00396 {
<a name="l00397"></a>00397         <span class="keywordflow">return</span> (<a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>+<a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>)*<a class="code" href="classsoil_layer.html#affa95354eeb271651824f92af6b24ca6">IntervalFraction</a>(startDepth,thickness);
<a name="l00398"></a>00398 }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400 <span class="comment">/****************************************************************************\</span>
<a name="l00401"></a>00401 <span class="comment">\****************************************************************************/</span>
<a name="l00402"></a><a class="code" href="classsoil_layer.html#a0ced82f9d04aa117b289acd4daa61659">00402</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_layer.html#ab59162a095c3cc12c515b5e37f3b650a">soilLayer::GetOrganicNitrogen</a>(<span class="keywordtype">double</span> startDepth, <span class="keywordtype">double</span> thickness)
<a name="l00403"></a>00403 {
<a name="l00404"></a>00404         <span class="keywordflow">return</span> <a class="code" href="classsoil_layer.html#ab59162a095c3cc12c515b5e37f3b650a">GetOrganicNitrogen</a>()*<a class="code" href="classsoil_layer.html#affa95354eeb271651824f92af6b24ca6">IntervalFraction</a>(startDepth,thickness);
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 <span class="comment">/****************************************************************************\</span>
<a name="l00409"></a>00409 <span class="comment">\****************************************************************************/</span>
<a name="l00410"></a><a class="code" href="classsoil_layer.html#a68f3bd7b3e269ba3592e6fd5f04ba9e3">00410</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a68f3bd7b3e269ba3592e6fd5f04ba9e3">soilLayer::HeatConductivity</a>()
<a name="l00411"></a>00411 {
<a name="l00412"></a>00412    <span class="comment">// Taken from SOIL-N (1996 p18 &amp; p24)</span>
<a name="l00413"></a>00413 
<a name="l00414"></a>00414    <span class="keyword">const</span> <span class="keywordtype">double</span> a1=0.70000;
<a name="l00415"></a>00415    <span class="keyword">const</span> <span class="keywordtype">double</span> a2=0.40000;
<a name="l00416"></a>00416    <span class="keyword">const</span> <span class="keywordtype">double</span> a3=0.62450;
<a name="l00417"></a>00417         <span class="keywordtype">double</span> b1=0.00158;
<a name="l00418"></a>00418         <span class="keywordtype">double</span> b2=1.336;
<a name="l00419"></a>00419         <span class="keywordtype">double</span> b3=0.00375;
<a name="l00420"></a>00420         <span class="keywordtype">double</span> b4=0.9118;
<a name="l00421"></a>00421         <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>&gt;0.1)
<a name="l00422"></a>00422    {
<a name="l00423"></a>00423         b1=0.00144;
<a name="l00424"></a>00424                 b2=1.32;
<a name="l00425"></a>00425                 b3=0.0036;
<a name="l00426"></a>00426                 b4=0.8743;
<a name="l00427"></a>00427         }
<a name="l00428"></a>00428    <span class="keywordtype">double</span> frozenPart=<a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>/<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>;
<a name="l00429"></a>00429         <span class="keywordtype">double</span> waterConcentration = max(1.0,<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>)*100/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;   <span class="comment">// converted mm to vol %. Minimum of 1% according to COUP figure p 31</span>
<a name="l00430"></a>00430    <span class="keywordtype">double</span> BulkDensity = <a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>/1e6;
<a name="l00431"></a>00431    <span class="keywordflow">if</span> (waterConcentration&lt;=0)
<a name="l00432"></a>00432       <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilLayer::HeatConductivity - water content zero or below&quot;</span>);
<a name="l00433"></a>00433    <span class="keywordtype">double</span> k_hm = 0.1434*(a1*log10(waterConcentration/BulkDensity)+a2)*pow(10.0,a3*BulkDensity);
<a name="l00434"></a>00434    <span class="keywordtype">double</span> k_hmi = b1*pow(10.0,b2*BulkDensity)+b3*waterConcentration/BulkDensity*pow(10.0,b4*BulkDensity);
<a name="l00435"></a>00435    <span class="keywordtype">double</span> result = (1-frozenPart)*k_hm+frozenPart*k_hmi;
<a name="l00436"></a>00436    result=max(0.05,result);                                          <span class="comment">// According to COUP figure p 31</span>
<a name="l00437"></a>00437    <span class="keywordflow">if</span> (result&gt;10)
<a name="l00438"></a>00438         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::HeatConductivity - conductivity to high&quot;</span>);
<a name="l00439"></a>00439         <span class="keywordflow">return</span> result;
<a name="l00440"></a>00440 }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 <span class="comment">/****************************************************************************\</span>
<a name="l00444"></a>00444 <span class="comment">Calculates the maximum transpiration from the soil layer</span>
<a name="l00445"></a>00445 <span class="comment">returns       - Maximum transpiration [mm]</span>
<a name="l00446"></a>00446 <span class="comment">\****************************************************************************/</span>
<a name="l00447"></a><a class="code" href="classsoil_layer.html#aaa3df5650bfb89fe57e853d34680b887">00447</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#aaa3df5650bfb89fe57e853d34680b887">soilLayer::MaxTranspiration</a>(<a class="code" href="structroot_structure.html">rootStructure</a>* root)
<a name="l00448"></a>00448 {
<a name="l00449"></a>00449    <span class="keywordtype">double</span> radius = root-&gt;<a class="code" href="structroot_structure.html#ae822dd60a6dd1507a84c10ab228fe97e">rootRadius</a>;
<a name="l00450"></a>00450    <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>     = root-&gt;<a class="code" href="structroot_structure.html#aeb9a13ce72bd039bc6821e4264b2da64">rootpF</a>;
<a name="l00451"></a>00451    <span class="keywordtype">double</span> rootLength = root-&gt;<a class="code" href="structroot_structure.html#a20025f911a33441a80de37712a1a659c">rootLengthList</a>[<a class="code" href="classbase.html#afa59aaa1a0201700640234eb13a03aae">Index</a>];
<a name="l00452"></a>00452    <span class="keywordtype">double</span> maxTranspiration = <a class="code" href="classsoil_layer.html#aaa3df5650bfb89fe57e853d34680b887">MaxTranspiration</a>(radius,pF,rootLength);
<a name="l00453"></a>00453    <span class="keywordflow">return</span> maxTranspiration;
<a name="l00454"></a>00454 }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 <span class="comment">/****************************************************************************\</span>
<a name="l00457"></a>00457 <span class="comment">\****************************************************************************/</span>
<a name="l00458"></a><a class="code" href="classsoil_layer.html#acb4fdc1a1144da5577b222285bf4f161">00458</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#aaa3df5650bfb89fe57e853d34680b887">soilLayer::MaxTranspiration</a>(<span class="keywordtype">double</span> rootRadius,
<a name="l00459"></a>00459                                                                                           <span class="keywordtype">double</span> rootpF,
<a name="l00460"></a>00460                                                                                           <span class="keywordtype">double</span> rootLength)
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462         <span class="keywordflow">if</span> (rootLength &lt;= 0)
<a name="l00463"></a>00463                 <span class="keywordflow">return</span> 0.;
<a name="l00464"></a>00464         <span class="keywordflow">else</span>
<a name="l00465"></a>00465         {
<a name="l00466"></a>00466                 <span class="keywordtype">double</span> rootDens = rootLength/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;                            <span class="comment">//m m-1</span>
<a name="l00467"></a>00467                 <span class="keywordtype">double</span> relWater = <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;
<a name="l00468"></a>00468         <span class="keywordtype">double</span> UptakeRate = -4.0*<a class="code" href="soil_layer_8cpp.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*(<a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a8a960e306ab5f6285102c50e3de04b65">GetFluxPotential</a>(<a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a6989350998b7c15af4fd59055ee20676">GetpF</a>(relWater))-<a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a8a960e306ab5f6285102c50e3de04b65">GetFluxPotential</a>(rootpF))/
<a name="l00469"></a>00469                                                          (-log(rootRadius*rootRadius*<a class="code" href="soil_layer_8cpp.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*rootDens));
<a name="l00470"></a>00470                 <span class="keywordflow">if</span> (UptakeRate&lt;=0)
<a name="l00471"></a>00471                 <span class="keywordflow">return</span> 0.0;
<a name="l00472"></a>00472                 <span class="keywordtype">double</span> availableWater = <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>-<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>*<a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a662cff8287e3a413961df635acef65b7">GetRelativeWater</a>(rootpF);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474       <span class="keywordflow">return</span> min(max(0.0,availableWater),1000.*86400.*UptakeRate*rootLength*relWater/<a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a>);
<a name="l00475"></a>00475         }
<a name="l00476"></a>00476 }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478 <span class="comment">/****************************************************************************\</span>
<a name="l00479"></a>00479 <span class="comment">Subtracts estimated transpiration from the water in the layer.</span>
<a name="l00480"></a>00480 <span class="comment">aWaterUptake         - water uptake [mm]</span>
<a name="l00481"></a>00481 <span class="comment">\****************************************************************************/</span>
<a name="l00482"></a><a class="code" href="classsoil_layer.html#afed3ac753d46a4ed2ea2b1f3e160752b">00482</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#afed3ac753d46a4ed2ea2b1f3e160752b">soilLayer::SubtractTranspiration</a>(<span class="keywordtype">double</span> &amp;aWaterUptake)
<a name="l00483"></a>00483 {
<a name="l00484"></a>00484    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>&lt;aWaterUptake)
<a name="l00485"></a>00485         aWaterUptake=<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>;
<a name="l00486"></a>00486    <a class="code" href="classsoil_layer.html#aea0648625d45f262740d107bbdfa4d55">waterUptake</a> = aWaterUptake;
<a name="l00487"></a>00487         <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a> -= <a class="code" href="classsoil_layer.html#aea0648625d45f262740d107bbdfa4d55">waterUptake</a>;
<a name="l00488"></a>00488    <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(aWaterUptake);
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 <span class="comment">/****************************************************************************\</span>
<a name="l00492"></a>00492 <span class="comment">Estimate the fraction of mobile water (SLIM concept)</span>
<a name="l00493"></a>00493 <span class="comment">\****************************************************************************/</span>
<a name="l00494"></a><a class="code" href="classsoil_layer.html#a7e696db2177aef85f23ca3c21b076d93">00494</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a7e696db2177aef85f23ca3c21b076d93">soilLayer::FractionMobileWater</a>()
<a name="l00495"></a>00495 {
<a name="l00496"></a>00496         <span class="keywordflow">return</span> max(<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>-<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>,0.0)/<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>;
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499 
<a name="l00500"></a>00500 <span class="comment">/****************************************************************************\</span>
<a name="l00501"></a>00501 <span class="comment">Perform infiltration of water, nitrate and ammonium in layer.</span>
<a name="l00502"></a>00502 <span class="comment">surplus         - Water to be added to current (next) layer [mm]</span>
<a name="l00503"></a>00503 <span class="comment">nitrateLeached  - Nitrate to the added to current (next) layer [g N/m�]</span>
<a name="l00504"></a>00504 <span class="comment">ammoniumLeached - Ammonium to the added to current (next) layer [g N/m�]</span>
<a name="l00505"></a>00505 <span class="comment">\****************************************************************************/</span>
<a name="l00506"></a><a class="code" href="classsoil_layer.html#a491ca2b3b788a1c66221610124e19929">00506</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#a491ca2b3b788a1c66221610124e19929">soilLayer::AddWater</a>(<span class="keywordtype">double</span> surplus,
<a name="l00507"></a>00507                          <a class="code" href="classnitrogen.html">nitrogen</a> nitrateLeached,
<a name="l00508"></a>00508                                                                  <a class="code" href="classnitrogen.html">nitrogen</a> ammoniumLeached,
<a name="l00509"></a>00509                          <span class="keywordtype">double</span> ChlorideLeached)
<a name="l00510"></a>00510 {
<a name="l00511"></a>00511    <span class="keywordflow">if</span>(<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6)
<a name="l00512"></a>00512         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::AddWater - negative n concentrations&quot;</span>);
<a name="l00513"></a>00513         <span class="keywordflow">if</span> (surplus&lt;0)
<a name="l00514"></a>00514         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::AddWater - amount of water to add can not be negative&quot;</span>);
<a name="l00515"></a>00515 
<a name="l00516"></a>00516    <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>  += surplus;
<a name="l00517"></a>00517    <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>.<a class="code" href="classbudget.html#ad619d773e77931df0435e8c08314f68e">AddInput</a>(surplus);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519    <span class="keywordtype">double</span> fractionOfSolutesToMobile = 0.0;
<a name="l00520"></a>00520 
<a name="l00521"></a>00521    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>&lt;<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>)                                      <span class="comment">//all solutes go into imobile domain</span>
<a name="l00522"></a>00522         fractionOfSolutesToMobile = 0.0;
<a name="l00523"></a>00523    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>-surplus&lt;<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>)         <span class="comment">//parts go into mobile</span>
<a name="l00524"></a>00524         fractionOfSolutesToMobile = max(0.0,min(1.0,(<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>-<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>)/surplus));
<a name="l00525"></a>00525    <span class="keywordflow">else</span>                                                                                                                 <span class="comment">//all go into mobile</span>
<a name="l00526"></a>00526         fractionOfSolutesToMobile = 1.0;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 
<a name="l00529"></a>00529       <span class="comment">// Nitrate</span>
<a name="l00530"></a>00530       <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a> = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>+nitrateLeached*fractionOfSolutesToMobile;
<a name="l00531"></a>00531       <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a> = <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>+nitrateLeached*(1-fractionOfSolutesToMobile);
<a name="l00532"></a>00532 
<a name="l00533"></a>00533       <span class="comment">// Ammonium</span>
<a name="l00534"></a>00534       <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a> = ammonium_mob+ammoniumLeached*fractionOfSolutesToMobile;
<a name="l00535"></a>00535       <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a> = <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>+ammoniumLeached*(1-fractionOfSolutesToMobile);
<a name="l00536"></a>00536 
<a name="l00537"></a>00537       <span class="comment">// Chloride</span>
<a name="l00538"></a>00538       <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a> = Chloride_mob+ChlorideLeached*fractionOfSolutesToMobile;
<a name="l00539"></a>00539       <a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a> = <a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>+ChlorideLeached*(1-fractionOfSolutesToMobile);
<a name="l00540"></a>00540 
<a name="l00541"></a>00541    <span class="keywordflow">if</span>(ammonium_mob.n&lt;-1E-6 || <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6)
<a name="l00542"></a>00542         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::AddWater - negative n concentrations&quot;</span>);
<a name="l00543"></a>00543 
<a name="l00544"></a>00544    <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#ad619d773e77931df0435e8c08314f68e">AddInput</a>(nitrateLeached.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+ammoniumLeached.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l00545"></a>00545    <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#ad619d773e77931df0435e8c08314f68e">AddInput</a>(nitrateLeached.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+ammoniumLeached.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>);
<a name="l00546"></a>00546    <span class="keywordflow">if</span>((<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>+0.001)&lt;<a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>)
<a name="l00547"></a>00547         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::AddWater - ice exceeds total water at the end of the function&quot;</span>);
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 <span class="comment">/****************************************************************************\</span>
<a name="l00551"></a>00551 <span class="comment">Adds water, nitrate, ammonium and chloride to layer.</span>
<a name="l00552"></a>00552 <span class="comment">surplus         - Water to be added to current (next) layer [mm]</span>
<a name="l00553"></a>00553 <span class="comment">nitrateLeached  - Nitrate to the added to current (next) layer [g N/m�]</span>
<a name="l00554"></a>00554 <span class="comment">ammoniumLeached - Ammonium to the added to current (next) layer [g N/m�]</span>
<a name="l00555"></a>00555 <span class="comment">\****************************************************************************/</span>
<a name="l00556"></a><a class="code" href="classsoil_layer.html#af8268406c1828af1fdd3fe704d386f1e">00556</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#af8268406c1828af1fdd3fe704d386f1e">soilLayer::AddWaterAndSolutes</a>(<span class="keywordtype">double</span> waterInFlow,
<a name="l00557"></a>00557                          <a class="code" href="classnitrogen.html">nitrogen</a> nitrateAdd,
<a name="l00558"></a>00558                                                                  <a class="code" href="classnitrogen.html">nitrogen</a> ammoniumAdd,
<a name="l00559"></a>00559                          <span class="keywordtype">double</span> chlorideAdd)
<a name="l00560"></a>00560 {
<a name="l00561"></a>00561    <span class="keywordflow">if</span>(<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6)
<a name="l00562"></a>00562         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::AddWater - negative n concentrations&quot;</span>);
<a name="l00563"></a>00563         <span class="keywordflow">if</span> (waterInFlow&lt;0)
<a name="l00564"></a>00564         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::AddWater - amount of water to add can not be negative&quot;</span>);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566    <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>  += waterInFlow;
<a name="l00567"></a>00567    <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>.<a class="code" href="classbudget.html#ad619d773e77931df0435e8c08314f68e">AddInput</a>(waterInFlow);
<a name="l00568"></a>00568 
<a name="l00569"></a>00569    <span class="keywordtype">double</span> fractionOfSolutesToMobile = 0.0;
<a name="l00570"></a>00570 
<a name="l00571"></a>00571    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>&lt;<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>)                                      <span class="comment">//all solutes go into imobile domain</span>
<a name="l00572"></a>00572         fractionOfSolutesToMobile = 0.0;
<a name="l00573"></a>00573    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>-waterInFlow&lt;<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>)     <span class="comment">//parts go into mobile</span>
<a name="l00574"></a>00574         fractionOfSolutesToMobile = max(0.0,min(1.0,(<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>-<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>)/waterInFlow));
<a name="l00575"></a>00575    <span class="keywordflow">else</span>                                                                                                                 <span class="comment">//all go into mobile</span>
<a name="l00576"></a>00576         fractionOfSolutesToMobile = 1.0;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578       <span class="comment">// Nitrate</span>
<a name="l00579"></a>00579       <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a> = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>+nitrateAdd*fractionOfSolutesToMobile;
<a name="l00580"></a>00580       <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a> = <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>+nitrateAdd*(1-fractionOfSolutesToMobile);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582       <span class="comment">// Ammonium</span>
<a name="l00583"></a>00583       <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a> = ammonium_mob+ammoniumAdd*fractionOfSolutesToMobile;
<a name="l00584"></a>00584       <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a> = <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>+ammoniumAdd*(1-fractionOfSolutesToMobile);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586       <span class="comment">// Chloride</span>
<a name="l00587"></a>00587       <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a> = Chloride_mob+chlorideAdd*fractionOfSolutesToMobile;
<a name="l00588"></a>00588       <a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a> = <a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>+chlorideAdd*(1-fractionOfSolutesToMobile);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590    <span class="keywordflow">if</span>(ammonium_mob.n&lt;-1E-6 || <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6)
<a name="l00591"></a>00591         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::AddWater - negative n concentrations&quot;</span>);
<a name="l00592"></a>00592 
<a name="l00593"></a>00593    <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#ad619d773e77931df0435e8c08314f68e">AddInput</a>(nitrateAdd.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+ammoniumAdd.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l00594"></a>00594    <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#ad619d773e77931df0435e8c08314f68e">AddInput</a>(nitrateAdd.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+ammoniumAdd.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>);
<a name="l00595"></a>00595    <span class="keywordflow">if</span>((<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>+0.001)&lt;<a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>)
<a name="l00596"></a>00596         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::AddWater - ice exceeds total water at the end of the function&quot;</span>);
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 <span class="comment">/****************************************************************************\</span>
<a name="l00600"></a>00600 <span class="comment">Perform infiltration of water, nitrate and ammonium in layer.</span>
<a name="l00601"></a>00601 <span class="comment">Used with the convection dispersion equation.</span>
<a name="l00602"></a>00602 <span class="comment">The fluxes of nitrate ammonium and chloride can be negative.</span>
<a name="l00603"></a>00603 <span class="comment">waterOutFlow   - Water to be revoved from current layer [mm]</span>
<a name="l00604"></a>00604 <span class="comment">nitrateRemove  - Nitrate to be revomed from current layer [g N/m�]</span>
<a name="l00605"></a>00605 <span class="comment">ammoniumRemove - Ammonium to be revomed from current layer [g N/m�]</span>
<a name="l00606"></a>00606 <span class="comment">\****************************************************************************/</span>
<a name="l00607"></a><a class="code" href="classsoil_layer.html#aa3c2588bb518594ccb63a7004bc823d4">00607</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#aa3c2588bb518594ccb63a7004bc823d4">soilLayer::RemoveWaterAndSolutes</a>(<span class="keywordtype">double</span> waterOutflow,
<a name="l00608"></a>00608                                          <a class="code" href="classnitrogen.html">nitrogen</a> nitrateRemove,
<a name="l00609"></a>00609                                                                                  <a class="code" href="classnitrogen.html">nitrogen</a> ammoniumRemove,
<a name="l00610"></a>00610                                          <span class="keywordtype">double</span> ChlorideRemove)
<a name="l00611"></a>00611 {
<a name="l00612"></a>00612 
<a name="l00613"></a>00613    <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>-= waterOutflow;
<a name="l00614"></a>00614    <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(waterOutflow);
<a name="l00615"></a>00615 
<a name="l00616"></a>00616    <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a> = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>-nitrateRemove;
<a name="l00617"></a>00617    <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>  = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>-ammoniumRemove;
<a name="l00618"></a>00618    <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>  -= ChlorideRemove;
<a name="l00619"></a>00619 
<a name="l00620"></a>00620    <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(ammoniumRemove.n+nitrateRemove.n);
<a name="l00621"></a>00621    <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(ammoniumRemove.n15+nitrateRemove.n15);
<a name="l00622"></a>00622 
<a name="l00623"></a>00623    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>&lt;0)
<a name="l00624"></a>00624         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilLayer::RemoveWaterAndSolutes - water content below zero&quot;</span>);
<a name="l00625"></a>00625    <span class="keywordflow">if</span>((<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)&lt;-1E-6)
<a name="l00626"></a>00626         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilLayer::RemoveWaterAndSolutes - mineral nitrogen content below zero&quot;</span>);
<a name="l00627"></a>00627    <span class="keywordflow">if</span>((<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>+0.001)&lt;<a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>)
<a name="l00628"></a>00628         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::RemoveWaterAndSolutes - ice exceeds total water&quot;</span>);
<a name="l00629"></a>00629    <span class="keywordflow">if</span>(<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6)
<a name="l00630"></a>00630         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::RemoveWaterAndSolutes - negative n concentrations&quot;</span>);
<a name="l00631"></a>00631 }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 <span class="comment">/****************************************************************************\</span>
<a name="l00634"></a>00634 <span class="comment">Intra-layer movement of water and solute</span>
<a name="l00635"></a>00635 <span class="comment">\****************************************************************************/</span>
<a name="l00636"></a><a class="code" href="classsoil_layer.html#a0761c6670b5ffb8affd945117f84335b">00636</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#a0761c6670b5ffb8affd945117f84335b">soilLayer::EquilibrateNitrogen</a>(<span class="keywordtype">double</span> mobileWater)
<a name="l00637"></a>00637 {
<a name="l00638"></a>00638 
<a name="l00639"></a>00639 
<a name="l00640"></a>00640    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>&lt;0.0)
<a name="l00641"></a>00641         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilLayer::EquilibrateNitrogen - water content below zero&quot;</span>);
<a name="l00642"></a>00642 
<a name="l00643"></a>00643 
<a name="l00644"></a>00644    <span class="comment">// Nitrate</span>
<a name="l00645"></a>00645 
<a name="l00646"></a>00646         <span class="keywordtype">double</span> rateCoefficient=0.9;
<a name="l00647"></a>00647    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#acbee67e83ac96f6906c03498366616b6">startDepth</a>&gt;199)
<a name="l00648"></a>00648         rateCoefficient=0.7;       <span class="comment">//holdbackconstant =0.3</span>
<a name="l00649"></a>00649 
<a name="l00650"></a>00650    <span class="keywordflow">if</span> (mobileWater &gt; 0.0)
<a name="l00651"></a>00651    {
<a name="l00652"></a>00652        <span class="comment">// Chloride</span>
<a name="l00653"></a>00653         <span class="keywordtype">double</span> concDiffChloride  = <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>/mobileWater-(<a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>+<a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>)/<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>;
<a name="l00654"></a>00654       <span class="keywordtype">double</span> moveChlorideFromMobile=concDiffChloride*mobileWater*(rateCoefficient);
<a name="l00655"></a>00655       <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>   = Chloride_mob - moveChlorideFromMobile;
<a name="l00656"></a>00656       <a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>  = <a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a> + moveChlorideFromMobile;
<a name="l00657"></a>00657       <span class="comment">//Nitrate</span>
<a name="l00658"></a>00658       <a class="code" href="classnitrogen.html">nitrogen</a> concDiffNitrate  = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>/mobileWater-(<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>+<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>)/<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>;
<a name="l00659"></a>00659       <a class="code" href="classnitrogen.html">nitrogen</a> moveNitrateFromMobile=concDiffNitrate*mobileWater*(rateCoefficient);
<a name="l00660"></a>00660       <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>   = nitrate_mob - moveNitrateFromMobile;
<a name="l00661"></a>00661       <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>  = <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a> + moveNitrateFromMobile;
<a name="l00662"></a>00662       <span class="comment">//Ammonium</span>
<a name="l00663"></a>00663         <span class="keywordtype">double</span> fAm    = <a class="code" href="classsoil_layer.html#a45a1255f7f65f6f2ac3087b13061ee93">FracAmmoniumInWater</a>();
<a name="l00664"></a>00664       <a class="code" href="classnitrogen.html">nitrogen</a> concDiffAmmonium  = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>/mobileWater-(<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>)/<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>;
<a name="l00665"></a>00665       <a class="code" href="classnitrogen.html">nitrogen</a> moveAmmoniumFromMobile=concDiffAmmonium*mobileWater*(rateCoefficient);
<a name="l00666"></a>00666       <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>   = ammonium_mob - moveAmmoniumFromMobile*fAm;
<a name="l00667"></a>00667       <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>  = <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a> + moveAmmoniumFromMobile*fAm;
<a name="l00668"></a>00668    }
<a name="l00669"></a>00669    <span class="keywordflow">else</span>
<a name="l00670"></a>00670    {
<a name="l00671"></a>00671    <a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>=<a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>+<a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>;       <span class="comment">//if no mobile phase is present the mobile solutes are moved to the immobile phase</span>
<a name="l00672"></a>00672    <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>=0.0;
<a name="l00673"></a>00673    <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>=<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>+<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>;
<a name="l00674"></a>00674    <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>=0.0;
<a name="l00675"></a>00675    <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>=<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>+<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>;
<a name="l00676"></a>00676    <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>=0.0;
<a name="l00677"></a>00677    }
<a name="l00678"></a>00678 <span class="comment">/*   // Chloride</span>
<a name="l00679"></a>00679 <span class="comment">   double AddChloride  = (Chloride_mob+Chloride_imob)*(1.-holdbackConstant);       // Holdback constant burde afh�nge af antallet af lag!</span>
<a name="l00680"></a>00680 <span class="comment">   Chloride_mob   = Chloride_mob*holdbackConstant + AddChloride*f;</span>
<a name="l00681"></a>00681 <span class="comment">   Chloride_imob  = Chloride_imob*holdbackConstant + AddChloride*(1.-f);*/</span>
<a name="l00682"></a>00682 
<a name="l00683"></a>00683    <span class="keywordflow">if</span>(<a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a969901a8fb6ed843156e09d78655dbe4">Chloride_imob</a>&lt;-1E-6)
<a name="l00684"></a>00684         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::Equilibrate - negative cloride concentrations&quot;</span>);
<a name="l00685"></a>00685    <span class="keywordflow">if</span>(<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6)
<a name="l00686"></a>00686    {
<a name="l00687"></a>00687 
<a name="l00688"></a>00688         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::Equilibrate - negative n concentrations&quot;</span>);
<a name="l00689"></a>00689    }
<a name="l00690"></a>00690 
<a name="l00691"></a>00691    <a class="code" href="classsoil_layer.html#a5dcc4d96a38106a631098dd65f4a7e6d">equilibrated</a>  = <span class="keyword">true</span>;
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 <span class="comment">/****************************************************************************\</span>
<a name="l00695"></a>00695 <span class="comment">Perform infiltration of water, nitrate and ammonium in layer. Used for SWAT</span>
<a name="l00696"></a>00696 <span class="comment">water model with hourly timestep</span>
<a name="l00697"></a>00697 <span class="comment">surplus         - Water to be added to current (next) layer [mm]</span>
<a name="l00698"></a>00698 <span class="comment">nitrateLeached  - Nitrate to the added to current (next) layer [g N/m�]</span>
<a name="l00699"></a>00699 <span class="comment">ammoniumLeached - Ammonium to the added to current (next) layer [g N/m�]</span>
<a name="l00700"></a>00700 <span class="comment">\****************************************************************************/</span>
<a name="l00701"></a><a class="code" href="classsoil_layer.html#a88b4d99d40dcc208f9a4c3776e85d130">00701</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#a88b4d99d40dcc208f9a4c3776e85d130">soilLayer::RemoveWaterHourly</a>(<span class="keywordtype">double</span> moveWater,
<a name="l00702"></a>00702                                          <a class="code" href="classnitrogen.html">nitrogen</a> * nitrateLeached,
<a name="l00703"></a>00703                                                                                  <a class="code" href="classnitrogen.html">nitrogen</a> * ammoniumLeached,
<a name="l00704"></a>00704                                          <span class="keywordtype">double</span> * ChlorideLeached,
<a name="l00705"></a>00705                                          <span class="keywordtype">bool</span> downwardMovement)
<a name="l00706"></a>00706 {
<a name="l00707"></a>00707    <span class="keywordflow">if</span>(<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6)
<a name="l00708"></a>00708         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::RemoveWater - negative n concentrations&quot;</span>);
<a name="l00709"></a>00709    nitrateLeached-&gt;<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00710"></a>00710    ammoniumLeached-&gt;<a class="code" href="classnitrogen.html#a706b101d934ddb44c4bff07761c8dfef">Clear</a>();
<a name="l00711"></a>00711    <span class="keywordflow">if</span> (moveWater&gt;0)
<a name="l00712"></a>00712    {
<a name="l00713"></a>00713       <span class="keywordtype">double</span> FirstMoveFraction = 0.0;                        <span class="comment">// Default value 0.5. BMP and JBE changed this - very important difference!!!</span>
<a name="l00714"></a>00714       <span class="keywordtype">double</span> mobileWater = max(<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>-<a class="code" href="classsoil_layer.html#a611720c51fe1a74360b4afb29161617b">fieldCapacity</a>,0.0);
<a name="l00715"></a>00715       <span class="keywordtype">double</span> alpha = 0.0;
<a name="l00716"></a>00716       <span class="keywordflow">if</span> (mobileWater&gt;0)
<a name="l00717"></a>00717          alpha = min(1.0,moveWater/mobileWater);       <span class="comment">// As defined in original SLIM</span>
<a name="l00718"></a>00718 
<a name="l00719"></a>00719       <span class="comment">// Leach first proportion of the water using current mobile solute concentrations</span>
<a name="l00720"></a>00720       *nitrateLeached  = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>*alpha*FirstMoveFraction;
<a name="l00721"></a>00721       <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>      = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a> - *nitrateLeached;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723       *ammoniumLeached = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>*alpha*FirstMoveFraction;
<a name="l00724"></a>00724       <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>     = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a> - *ammoniumLeached;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726       *ChlorideLeached = <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>*alpha*FirstMoveFraction;
<a name="l00727"></a>00727       <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a> -= *ChlorideLeached;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729       <a class="code" href="classsoil_layer.html#a0761c6670b5ffb8affd945117f84335b">EquilibrateNitrogen</a>(mobileWater);
<a name="l00730"></a>00730       <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a> -= FirstMoveFraction*moveWater;
<a name="l00731"></a>00731       mobileWater  -= FirstMoveFraction*moveWater;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733       <span class="comment">// Leach second proportion of the water using new mobile solute concentrations</span>
<a name="l00734"></a>00734 
<a name="l00735"></a>00735       <a class="code" href="classnitrogen.html">nitrogen</a> N       = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>*alpha*(1.0-FirstMoveFraction);
<a name="l00736"></a>00736       *nitrateLeached  = *nitrateLeached + N;
<a name="l00737"></a>00737       <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>      = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a> - N;
<a name="l00738"></a>00738 
<a name="l00739"></a>00739       N                = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>*alpha*(1.0-FirstMoveFraction);
<a name="l00740"></a>00740       *ammoniumLeached = *ammoniumLeached + N;
<a name="l00741"></a>00741       <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>     = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a> - N;
<a name="l00742"></a>00742 
<a name="l00743"></a>00743       *ChlorideLeached += <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>*alpha*(1.0-FirstMoveFraction);
<a name="l00744"></a>00744       <a class="code" href="classsoil_layer.html#a9864a5b154fa8571ef715324b3c58722">Chloride_mob</a>     -= Chloride_mob*alpha*(1.0-FirstMoveFraction);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746 
<a name="l00747"></a>00747       <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a> -= (1.0-FirstMoveFraction)*moveWater;
<a name="l00748"></a>00748       <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(moveWater);
<a name="l00749"></a>00749    }
<a name="l00750"></a>00750    <span class="keywordflow">else</span>
<a name="l00751"></a>00751         <span class="keywordflow">if</span> (moveWater&lt;0)
<a name="l00752"></a>00752                 <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::RemoveWater - amount of water to remove can not be negative&quot;</span>);
<a name="l00753"></a>00753    <span class="keywordflow">if</span> (downwardMovement)
<a name="l00754"></a>00754    {
<a name="l00755"></a>00755       <a class="code" href="classsoil_layer.html#a5dd2dd5bfbdfc6d2e79a50136185da04">ammoniumLeaching</a> = <a class="code" href="classsoil_layer.html#a5dd2dd5bfbdfc6d2e79a50136185da04">ammoniumLeaching</a> + *ammoniumLeached;
<a name="l00756"></a>00756       <a class="code" href="classsoil_layer.html#a4082fb4d9c9c2a1decbe1dc735a1c3f7">nitrateLeaching</a>  = <a class="code" href="classsoil_layer.html#a4082fb4d9c9c2a1decbe1dc735a1c3f7">nitrateLeaching</a> + *nitrateLeached;
<a name="l00757"></a>00757    }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759    <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(ammoniumLeached-&gt;<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+nitrateLeached-&gt;<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l00760"></a>00760    <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(ammoniumLeached-&gt;<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+nitrateLeached-&gt;<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>);
<a name="l00761"></a>00761 
<a name="l00762"></a>00762    <span class="keywordflow">if</span>(<a class="code" href="classsoil_layer.html#a5dd2dd5bfbdfc6d2e79a50136185da04">ammoniumLeaching</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a4082fb4d9c9c2a1decbe1dc735a1c3f7">nitrateLeaching</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 )
<a name="l00763"></a>00763         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::RemoveWater - negative leaching&quot;</span>);
<a name="l00764"></a>00764    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>&lt;0)
<a name="l00765"></a>00765         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilLayer::RemoveWater - water content below zero&quot;</span>);
<a name="l00766"></a>00766    <span class="keywordflow">if</span>((<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)&lt;-1E-6)
<a name="l00767"></a>00767         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#af9891cb7111375e6a36363afffb09d63">FatalError</a>(<span class="stringliteral">&quot;soilLayer::RemoveWater - mineral nitrogen content below zero&quot;</span>);
<a name="l00768"></a>00768    <span class="keywordflow">if</span>((<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>+0.001)&lt;<a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>)
<a name="l00769"></a>00769         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::RemoveWater - ice exceeds total water&quot;</span>);
<a name="l00770"></a>00770 }
<a name="l00771"></a>00771 
<a name="l00772"></a>00772 
<a name="l00773"></a>00773 <span class="comment">/****************************************************************************\</span>
<a name="l00774"></a>00774 <span class="comment">Subtracts evaporation from layer</span>
<a name="l00775"></a>00775 <span class="comment">evaporation   - Evaporation to be subtracted [mm].</span>
<a name="l00776"></a>00776 <span class="comment">\****************************************************************************/</span>
<a name="l00777"></a><a class="code" href="classsoil_layer.html#a9a38de935d6d6abe383bfd2f886559f3">00777</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#a9a38de935d6d6abe383bfd2f886559f3">soilLayer::SubtractEvaporation</a>(<span class="keywordtype">double</span> evaporation)
<a name="l00778"></a>00778 {
<a name="l00779"></a>00779  <span class="keywordtype">double</span> draw = max(0.0,min(<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>-<a class="code" href="classsoil_layer.html#a57ae095602c7294364a449b2ee13ec1d">iceContent</a>-1E-10,evaporation));
<a name="l00780"></a>00780  <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a> -= draw;
<a name="l00781"></a>00781  <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(draw);
<a name="l00782"></a>00782 }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784 <span class="comment">/****************************************************************************\</span>
<a name="l00785"></a>00785 <span class="comment">Calculates the maximum flux of nitrate or ammonium into roots in the layer.</span>
<a name="l00786"></a>00786 <span class="comment">returns       - Maximum nitrogen uptake in layer [g N/m/d]</span>
<a name="l00787"></a>00787 <span class="comment">\****************************************************************************/</span>
<a name="l00788"></a><a class="code" href="classsoil_layer.html#a8d2a6031dcc56ae0c290a9503c192963">00788</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a5685f314f5fc88763799e71fd34b8c75">soilLayer::MaxNitrogenFlux</a>(<span class="keywordtype">bool</span> nitrate, <a class="code" href="structroot_structure.html">rootStructure</a>* root)
<a name="l00789"></a>00789 {
<a name="l00790"></a>00790         <span class="keywordtype">double</span> concentration, bufferingCoef, N_amount, uptake;
<a name="l00791"></a>00791    <span class="keywordtype">double</span> StdDiff = 0.0;
<a name="l00792"></a>00792    <span class="keywordflow">if</span> (nitrate)
<a name="l00793"></a>00793    {
<a name="l00794"></a>00794       StdDiff       = 3600 * 2.0e-5 * 24 * 1e-4;            <span class="comment">// convert to m2 d-1</span>
<a name="l00795"></a>00795       uptake        = root-&gt;<a class="code" href="structroot_structure.html#a6279d30c06e19a3e088f57fd6d793ed9">NitrateUptakeRate</a>;
<a name="l00796"></a>00796         N_amount      = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>;
<a name="l00797"></a>00797       concentration = 0;
<a name="l00798"></a>00798       <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>&gt;0)
<a name="l00799"></a>00799          concentration=max(0.0,1000.*N_amount/<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>-root-&gt;<a class="code" href="structroot_structure.html#a51bcb0f431a64a3b26d21a4e86a9d16e">MinimumSoilNitrate</a>);
<a name="l00800"></a>00800                 bufferingCoef = 1.0; <span class="comment">//waterContent/thickness;   NOT USED IN CURRENT DAISY CONCEPT ????????</span>
<a name="l00801"></a>00801    }
<a name="l00802"></a>00802    <span class="keywordflow">else</span>                               <span class="comment">// ammonium</span>
<a name="l00803"></a>00803    {
<a name="l00804"></a>00804       StdDiff       = 3600 * 1.8e-5 * 24 * 1e-4;            <span class="comment">// convert to m2 d-1</span>
<a name="l00805"></a>00805         uptake        = root-&gt;<a class="code" href="structroot_structure.html#a5a6c705454eeafeb83624a2351b53cf1">AmmoniumUptakeRate</a>;
<a name="l00806"></a>00806       N_amount      = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>;
<a name="l00807"></a>00807       concentration = 0;
<a name="l00808"></a>00808       <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>&gt;0)
<a name="l00809"></a>00809          concentration = max(0.0,1000.*N_amount/<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>*<a class="code" href="classsoil_layer.html#a45a1255f7f65f6f2ac3087b13061ee93">FracAmmoniumInWater</a>()-root-&gt;<a class="code" href="structroot_structure.html#a80208bc0dea6228779648359e9bd1c01">MinimumSoilAmmonium</a>);
<a name="l00810"></a>00810                 bufferingCoef = 1.0; <span class="comment">//AmmoniumBuffering();   NOT USED IN CURRENT DAISY CONCEPT ????????</span>
<a name="l00811"></a>00811    }
<a name="l00812"></a>00812    <span class="keywordtype">double</span> diffusionCoef = StdDiff*pow(1.03,<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>)*<a class="code" href="classsoil_layer.html#adc0d1556be252d13f6facc7634757254">Tortuosity</a>()*<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;   <span class="comment">// m2 day-1</span>
<a name="l00813"></a>00813    <span class="keywordtype">double</span> rootLength = root-&gt;<a class="code" href="structroot_structure.html#a20025f911a33441a80de37712a1a659c">rootLengthList</a>[<a class="code" href="classbase.html#afa59aaa1a0201700640234eb13a03aae">Index</a>];
<a name="l00814"></a>00814    <span class="keywordtype">double</span> maxFlux = <a class="code" href="classsoil_layer.html#a5685f314f5fc88763799e71fd34b8c75">MaxNitrogenFlux</a>(root-&gt;<a class="code" href="structroot_structure.html#ae822dd60a6dd1507a84c10ab228fe97e">rootRadius</a>,uptake,rootLength,concentration,diffusionCoef,bufferingCoef);
<a name="l00815"></a>00815    <span class="keywordtype">double</span> Nuptake = rootLength*maxFlux;
<a name="l00816"></a>00816    <span class="keywordflow">return</span> min(N_amount,Nuptake);
<a name="l00817"></a>00817 }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819 <span class="comment">/****************************************************************************\</span>
<a name="l00820"></a>00820 <span class="comment">\****************************************************************************/</span>
<a name="l00821"></a><a class="code" href="classsoil_layer.html#a5685f314f5fc88763799e71fd34b8c75">00821</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a5685f314f5fc88763799e71fd34b8c75">soilLayer::MaxNitrogenFlux</a>(<span class="keywordtype">double</span> rootRadius,
<a name="l00822"></a>00822                                                                                          <span class="keywordtype">double</span> uptakeRate,
<a name="l00823"></a>00823                                                                                          <span class="keywordtype">double</span> rootLength,
<a name="l00824"></a>00824                                                                                          <span class="keywordtype">double</span> conc,
<a name="l00825"></a>00825                                                                                          <span class="keywordtype">double</span> diffusionCoef,
<a name="l00826"></a>00826                                                                                          <span class="keywordtype">double</span> bufferingCoef)
<a name="l00827"></a>00827 {
<a name="l00828"></a>00828    <span class="keywordflow">if</span> (rootLength&lt;1e-15)
<a name="l00829"></a>00829         <span class="keywordflow">return</span> 0.0;
<a name="l00830"></a>00830    <span class="keywordtype">double</span> q = <a class="code" href="classsoil_layer.html#aea0648625d45f262740d107bbdfa4d55">waterUptake</a>/(1000.*rootLength);
<a name="l00831"></a>00831    <span class="keywordtype">double</span> rootDens = 1000.0*rootLength/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;
<a name="l00832"></a>00832    <span class="keywordtype">double</span> alpha = 0;
<a name="l00833"></a>00833    <span class="keywordflow">if</span> (q&gt;0 &amp;&amp; diffusionCoef&gt;0)
<a name="l00834"></a>00834         alpha = q/(2.*<a class="code" href="soil_layer_8cpp.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*diffusionCoef*bufferingCoef);
<a name="l00835"></a>00835    <span class="keywordtype">double</span> beta = 1./(rootRadius*sqrt(<a class="code" href="soil_layer_8cpp.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*rootDens));
<a name="l00836"></a>00836    <span class="keywordtype">double</span> beta_2 = beta*beta;
<a name="l00837"></a>00837    <span class="keywordtype">double</span> beta_1 = beta_2-1.;
<a name="l00838"></a>00838    <span class="keywordtype">double</span> beta_3 = beta_1*(1-0.5*alpha);
<a name="l00839"></a>00839    <span class="keywordtype">double</span> I = 0;
<a name="l00840"></a>00840    <span class="keywordflow">if</span> (alpha&gt;1E-13)
<a name="l00841"></a>00841    {
<a name="l00842"></a>00842       <span class="keywordflow">if</span> (alpha==2.)
<a name="l00843"></a>00843         I = q*beta_1*conc/(beta_1-log(beta_2));
<a name="l00844"></a>00844       <span class="keywordflow">else</span>
<a name="l00845"></a>00845         I = q*beta_3*conc/(beta_3-pow(beta,2.-alpha)+1.);
<a name="l00846"></a>00846    }
<a name="l00847"></a>00847    <span class="keywordflow">else</span>
<a name="l00848"></a>00848         I = 4.*<a class="code" href="soil_layer_8cpp.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*diffusionCoef*conc/(beta_2*log(beta_2)/beta_1-1.0);
<a name="l00849"></a>00849       <span class="comment">// old: 2.*M_PI*diffusionCoef*bufferingCoef*conc/(beta_2*log(beta)/beta_1-0.5);</span>
<a name="l00850"></a>00850 
<a name="l00851"></a>00851    <span class="keywordflow">return</span> min(I,uptakeRate);
<a name="l00852"></a>00852 }
<a name="l00853"></a>00853 
<a name="l00854"></a>00854 <span class="comment">/****************************************************************************\</span>
<a name="l00855"></a>00855 <span class="comment">\****************************************************************************/</span>
<a name="l00856"></a><a class="code" href="classsoil_layer.html#aa7189120b1afb35795a040acd399b179">00856</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_layer.html#aa7189120b1afb35795a040acd399b179">soilLayer::SubtractNitrateUptake</a>(<span class="keywordtype">double</span> &amp;nitrateUptake)
<a name="l00857"></a>00857 {
<a name="l00858"></a>00858         <a class="code" href="classnitrogen.html">nitrogen</a> nitrate = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>+<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>;
<a name="l00859"></a>00859    <span class="keywordtype">double</span> N15RatioNitrate = nitrate.<a class="code" href="classnitrogen.html#ac97f3ebad4801a13a7c444bab3b3a886">Get15NRatio</a>();
<a name="l00860"></a>00860 
<a name="l00861"></a>00861    <a class="code" href="classnitrogen.html">nitrogen</a> NO3_Uptake;
<a name="l00862"></a>00862    <span class="keywordflow">if</span> (nitrateUptake&gt;0 &amp;&amp; nitrate.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0)
<a name="l00863"></a>00863         {
<a name="l00864"></a>00864       NO3_Uptake.<a class="code" href="classnitrogen.html#a49bebcba4c40f3c0a6abb24f590b2c8c">SetBoth</a>(nitrateUptake,N15RatioNitrate*nitrateUptake);
<a name="l00865"></a>00865 
<a name="l00866"></a>00866                 <span class="comment">// N</span>
<a name="l00867"></a>00867                 <span class="keywordtype">double</span> frac = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>/nitrate.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>));
<a name="l00868"></a>00868                 <span class="keywordflow">if</span> (frac&lt;1e-10) frac = 0;
<a name="l00869"></a>00869                 <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a> -= nitrateUptake*frac;
<a name="l00870"></a>00870                 nitrate_imob.n -= nitrateUptake*(1.0-frac);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872       <span class="comment">// 15N</span>
<a name="l00873"></a>00873                 frac = 1.0;
<a name="l00874"></a>00874       <span class="keywordflow">if</span> (nitrate.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&gt;0)
<a name="l00875"></a>00875         frac = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>/nitrate.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>));
<a name="l00876"></a>00876       <span class="keywordflow">if</span> (frac&lt;1e-10) frac = 0;
<a name="l00877"></a>00877                 <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a> -= N15RatioNitrate*nitrateUptake*frac;
<a name="l00878"></a>00878                 nitrate_imob.n15 -= N15RatioNitrate*nitrateUptake*(1.0-frac);
<a name="l00879"></a>00879 
<a name="l00880"></a>00880       <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1e-6 || <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&lt;-1e-6 || nitrate_imob.n&lt;-1e-6 || nitrate_imob.n15&lt;-1e-6)
<a name="l00881"></a>00881         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;SoilLayer:: SubtractNitrate nitrate less than zero&quot;</span>);
<a name="l00882"></a>00882       <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(NO3_Uptake.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l00883"></a>00883                 <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(NO3_Uptake.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>);
<a name="l00884"></a>00884         }
<a name="l00885"></a>00885    <span class="keywordflow">return</span> NO3_Uptake;
<a name="l00886"></a>00886 }
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 <span class="comment">/****************************************************************************\</span>
<a name="l00889"></a>00889 <span class="comment">\****************************************************************************/</span>
<a name="l00890"></a><a class="code" href="classsoil_layer.html#a88b301de01a73797ff3c48b11d1eef58">00890</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_layer.html#a88b301de01a73797ff3c48b11d1eef58">soilLayer::SubtractAmmoniumUptake</a>(<span class="keywordtype">double</span> &amp;ammoniumUptake)
<a name="l00891"></a>00891 {
<a name="l00892"></a>00892         <a class="code" href="classnitrogen.html">nitrogen</a> ammonium = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>+<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>;
<a name="l00893"></a>00893    <span class="keywordtype">double</span> N15RatioAmmonium = ammonium.<a class="code" href="classnitrogen.html#ac97f3ebad4801a13a7c444bab3b3a886">Get15NRatio</a>();
<a name="l00894"></a>00894    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&lt;-1e-10 || ammonium_imob.n15&lt;-1e-10)
<a name="l00895"></a>00895         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;SoilLayer:: SubtractAmmonium ammonium-N15 less than zero&quot;</span>);
<a name="l00896"></a>00896 
<a name="l00897"></a>00897         <a class="code" href="classnitrogen.html">nitrogen</a> NH4_Uptake;
<a name="l00898"></a>00898    <span class="keywordflow">if</span> (ammoniumUptake&gt;0 &amp;&amp; ammonium.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0)
<a name="l00899"></a>00899         {
<a name="l00900"></a>00900                 NH4_Uptake.<a class="code" href="classnitrogen.html#a49bebcba4c40f3c0a6abb24f590b2c8c">SetBoth</a>(ammoniumUptake,N15RatioAmmonium*ammoniumUptake);
<a name="l00901"></a>00901 
<a name="l00902"></a>00902                 <span class="comment">// N</span>
<a name="l00903"></a>00903                 <span class="keywordtype">double</span> frac = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>/ammonium.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>));
<a name="l00904"></a>00904 
<a name="l00905"></a>00905                 <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>  -= ammoniumUptake*frac;
<a name="l00906"></a>00906                 ammonium_imob.n -= ammoniumUptake*(1-frac);
<a name="l00907"></a>00907       <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;0 ||  ammonium_imob.n&lt;0)
<a name="l00908"></a>00908         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;SoilLayer:: SubtractAmmonium ammonium less than zero&quot;</span>);
<a name="l00909"></a>00909 
<a name="l00910"></a>00910       <span class="comment">// 15N</span>
<a name="l00911"></a>00911       frac = 1.0;
<a name="l00912"></a>00912       <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&lt;-1e-10 || ammonium_imob.n15&lt;-1e-10)
<a name="l00913"></a>00913         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;SoilLayer:: SubtractAmmonium ammonium-N15 less than zero&quot;</span>);
<a name="l00914"></a>00914                 <span class="keywordflow">if</span> (ammonium.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&gt;0)
<a name="l00915"></a>00915                         frac = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>/ammonium.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>));
<a name="l00916"></a>00916                 <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a> -= N15RatioAmmonium*ammoniumUptake*frac;
<a name="l00917"></a>00917                 ammonium_imob.n15 -= N15RatioAmmonium*ammoniumUptake*(1-frac);
<a name="l00918"></a>00918       <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&lt;-1e-10 || ammonium_imob.n15&lt;-1e-10)
<a name="l00919"></a>00919         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;SoilLayer:: SubtractAmmonium ammonium-N15 less than zero&quot;</span>);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921       <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(NH4_Uptake.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l00922"></a>00922                 <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(NH4_Uptake.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>);
<a name="l00923"></a>00923 
<a name="l00924"></a>00924         }
<a name="l00925"></a>00925    <span class="keywordflow">return</span> NH4_Uptake;
<a name="l00926"></a>00926 }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 
<a name="l00930"></a>00930 <span class="comment">/****************************************************************************\</span>
<a name="l00931"></a>00931 <span class="comment">Update organic matter pools in layer.</span>
<a name="l00932"></a>00932 <span class="comment">\****************************************************************************/</span>
<a name="l00933"></a><a class="code" href="classsoil_layer.html#a3499e118eccf838b5d9c7784cfbecee8">00933</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a3499e118eccf838b5d9c7784cfbecee8">soilLayer::UpdateOrganicMatter</a>()
<a name="l00934"></a>00934 {
<a name="l00935"></a>00935    <span class="comment">// TEST !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="l00936"></a>00936    <a class="code" href="classsoil_layer.html#a9d84413d44f869d41635363bf2de0e04">TillageEffectTemperature</a> = max(0.0,<a class="code" href="classsoil_layer.html#a9d84413d44f869d41635363bf2de0e04">TillageEffectTemperature</a>-0.05);
<a name="l00937"></a>00937    <span class="keywordtype">double</span> NewTemperature = min(37.0,<a class="code" href="classsoil_layer.html#a9d84413d44f869d41635363bf2de0e04">TillageEffectTemperature</a>+<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>);
<a name="l00938"></a>00938 
<a name="l00939"></a>00939    <span class="keywordtype">double</span> pFValue = <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a6989350998b7c15af4fd59055ee20676">GetpF</a>(<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>);
<a name="l00940"></a>00940 
<a name="l00941"></a>00941    <a class="code" href="classnitrogen.html">nitrogen</a> nitrate  = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a> + <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>;
<a name="l00942"></a>00942    <a class="code" href="classnitrogen.html">nitrogen</a> ammonium = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a> + <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>;
<a name="l00943"></a>00943    <span class="keywordtype">double</span> nitfrac = 0.0;
<a name="l00944"></a>00944    <span class="keywordflow">if</span> (nitrate.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0.0)
<a name="l00945"></a>00945       nitfrac = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>/nitrate));
<a name="l00946"></a>00946 
<a name="l00947"></a>00947    <span class="keywordtype">double</span> ammfrac = 0.0;
<a name="l00948"></a>00948    <span class="keywordflow">if</span> ((<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0.0) &amp;&amp; (ammonium.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a> &gt;0.0))
<a name="l00949"></a>00949       ammfrac = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>/ammonium));
<a name="l00950"></a>00950 
<a name="l00951"></a>00951    <span class="comment">// Deals with protected NH4</span>
<a name="l00952"></a>00952    <span class="keywordtype">double</span> unprotecFrac = 0.0;
<a name="l00953"></a>00953    <span class="keywordflow">if</span> (ammonium.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0.0)
<a name="l00954"></a>00954         unprotecFrac = <a class="code" href="classsoil_layer.html#a879c1862803235bad6caa578cfb2989d">AccesibleAmmonium</a>()/ammonium.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>;
<a name="l00955"></a>00955    <a class="code" href="classnitrogen.html">nitrogen</a> ProtectedNH4_mob  = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>*(1.0-unprotecFrac);
<a name="l00956"></a>00956    <a class="code" href="classnitrogen.html">nitrogen</a> ProtectedNH4_imob = ammonium_imob*(1.0-unprotecFrac);
<a name="l00957"></a>00957    ammonium = ammonium*unprotecFrac;
<a name="l00958"></a>00958 
<a name="l00959"></a>00959    <a class="code" href="classsoil_layer.html#a99d47de1a6d78f922c9d988b691422fd">CO2Evolution</a> = <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#afe20379314e0eb234bd6b6c8684c41d4">Update</a>(NewTemperature,pFValue,&amp;nitrate,&amp;ammonium);
<a name="l00960"></a>00960         nitfrac = <a class="code" href="classsoil_layer.html#a7e696db2177aef85f23ca3c21b076d93">FractionMobileWater</a>();
<a name="l00961"></a>00961         ammfrac = nitfrac;
<a name="l00962"></a>00962         <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>  = nitrate*nitfrac;
<a name="l00963"></a>00963         nitrate_imob = nitrate*(1.0-nitfrac);
<a name="l00964"></a>00964         <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a> = ammonium*ammfrac+ProtectedNH4_mob;
<a name="l00965"></a>00965         ammonium_imob= ammonium*(1.0-ammfrac)+ProtectedNH4_imob;
<a name="l00966"></a>00966 
<a name="l00967"></a>00967    <span class="keywordflow">if</span>(ammonium_mob.n&lt;-1E-6 || ammonium_imob.n&lt;-1E-6 || <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || nitrate_imob.n&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#a719b504d46e267423e58c37d1c1bc058">GetNitrogen</a>().<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&lt;-1e-10)
<a name="l00968"></a>00968         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::UpdateOrganicMatter - negative n concentrations&quot;</span>);
<a name="l00969"></a>00969    <span class="keywordflow">return</span> <a class="code" href="classsoil_layer.html#a99d47de1a6d78f922c9d988b691422fd">CO2Evolution</a>;
<a name="l00970"></a>00970 }
<a name="l00971"></a>00971 
<a name="l00972"></a>00972 <span class="comment">/****************************************************************************\</span>
<a name="l00973"></a>00973 <span class="comment">Potential carbon turnover used in denitrification model</span>
<a name="l00974"></a>00974 <span class="comment">\****************************************************************************/</span>
<a name="l00975"></a><a class="code" href="classsoil_layer.html#ae664742ac96eb6f49caa66e8c4b8d708">00975</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#ae664742ac96eb6f49caa66e8c4b8d708">soilLayer::PotentialCarbonTurnover</a>()
<a name="l00976"></a>00976 {
<a name="l00977"></a>00977         <span class="keywordtype">double</span> PotTurnover = <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#a110fb0a083dc7ae8a1f955d699204bee">GetCarbonAvailability</a>();
<a name="l00978"></a>00978    <span class="keywordflow">return</span> PotTurnover;
<a name="l00979"></a>00979 }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981 <span class="comment">/****************************************************************************\</span>
<a name="l00982"></a>00982 <span class="comment">\****************************************************************************/</span>
<a name="l00983"></a><a class="code" href="classsoil_layer.html#ac492720707c5061523bb4996b522107f">00983</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#ac492720707c5061523bb4996b522107f">soilLayer::GetWaterFilledPorosity</a>()
<a name="l00984"></a>00984 {
<a name="l00985"></a>00985         <span class="keywordtype">double</span> PorosityFilled = <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>/(<a class="code" href="classsoil_layer.html#abc113be3a910c24109309495a62d35ee">porosity</a>*<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>);
<a name="l00986"></a>00986    <span class="keywordflow">return</span> min(1.0,max(0.0,PorosityFilled));
<a name="l00987"></a>00987 }
<a name="l00988"></a>00988 
<a name="l00989"></a>00989 <span class="comment">/****************************************************************************\</span>
<a name="l00990"></a>00990 <span class="comment">Calculates the ammonium (g/m2) which is accesible for nitrification and mineralisation</span>
<a name="l00991"></a>00991 <span class="comment">The rest is assumed to be physically-chemically protected from nitrifying</span>
<a name="l00992"></a>00992 <span class="comment">bacteria by clay minerals allthough it is still chemically exchangeable.</span>
<a name="l00993"></a>00993 <span class="comment">This protected part is only assumed to constitute part of the total</span>
<a name="l00994"></a>00994 <span class="comment">adsorbed but exchangeable ammonium.</span>
<a name="l00995"></a>00995 <span class="comment">\****************************************************************************/</span>
<a name="l00996"></a><a class="code" href="classsoil_layer.html#a879c1862803235bad6caa578cfb2989d">00996</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a879c1862803235bad6caa578cfb2989d">soilLayer::AccesibleAmmonium</a>()
<a name="l00997"></a>00997 {
<a name="l00998"></a>00998 
<a name="l00999"></a>00999         <span class="keywordtype">double</span> AmmoniumSum          = <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>;
<a name="l01000"></a>01000         <span class="keywordtype">double</span> adsorbedAmmonium     = AmmoniumSum*(1-<a class="code" href="classsoil_layer.html#a45a1255f7f65f6f2ac3087b13061ee93">FracAmmoniumInWater</a>());
<a name="l01001"></a>01001 
<a name="l01002"></a>01002         <span class="keyword">const</span> <span class="keywordtype">double</span> protectionCoeff = 1E-9;                     <span class="comment">// optimised on organic crop rotation experiment by JB (24_3_3)</span>
<a name="l01003"></a>01003         <span class="keywordtype">double</span> maxProtectedAmmonium = <a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>*<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>*<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>*protectionCoeff;
<a name="l01004"></a>01004         <span class="keywordtype">double</span> protectedAmmonium    = min(maxProtectedAmmonium,adsorbedAmmonium);
<a name="l01005"></a>01005         <span class="keywordflow">return</span> AmmoniumSum-protectedAmmonium;
<a name="l01006"></a>01006 
<a name="l01007"></a>01007 }
<a name="l01008"></a>01008 
<a name="l01009"></a>01009 <span class="comment">/****************************************************************************\</span>
<a name="l01010"></a>01010 <span class="comment">Perform nitrification and update contents of ammonia and nitrate.</span>
<a name="l01011"></a>01011 <span class="comment">returns       - Nitrification [g N/m�/d]</span>
<a name="l01012"></a>01012 <span class="comment">\****************************************************************************/</span>
<a name="l01013"></a><a class="code" href="classsoil_layer.html#a05e9eb7bc23f2ca60d2358eae2e3638c">01013</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_layer.html#a05e9eb7bc23f2ca60d2358eae2e3638c">soilLayer::UpdateNitrification</a>()
<a name="l01014"></a>01014 {
<a name="l01015"></a>01015    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1e-10 || <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1e-10 || <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&lt;-1e-10 || <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&lt;-1e-10)
<a name="l01016"></a>01016         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;SoilLayer::UpdateNitrification NH4 less than zero&quot;</span>);
<a name="l01017"></a>01017         <a class="code" href="classnitrogen.html">nitrogen</a> AddN;
<a name="l01018"></a>01018    <span class="keywordtype">double</span> ratio = 1.;
<a name="l01019"></a>01019    <span class="keywordflow">if</span> ((<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>+<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>).n&gt;0)
<a name="l01020"></a>01020         ratio = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>/(<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>+<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>);
<a name="l01021"></a>01021    <span class="keywordtype">double</span> N15RatioAmmonium = 1.0;
<a name="l01022"></a>01022    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0.0)
<a name="l01023"></a>01023         N15RatioAmmonium = max(0.0,min(1.0,(<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>)/(<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)));
<a name="l01024"></a>01024 
<a name="l01025"></a>01025    <span class="comment">//M-N kinetics DAISY parameters</span>
<a name="l01026"></a>01026    <span class="comment">/*double NH4Conc = (ammonium_imob+ammonium_mob).n/(thickness/10)/10000;            // unit g-N/cm-3</span>
<a name="l01027"></a>01027 <span class="comment">   double MNRate = 5e-5*NH4Conc/(NH4Conc+5e-5)*thickness/50*10000;</span>
<a name="l01028"></a>01028 <span class="comment">   double Add = MNRate*</span>
<a name="l01029"></a>01029 <span class="comment">                TemperatureNitrificationEffect()*</span>
<a name="l01030"></a>01030 <span class="comment">                WaterNitrificationEffect();*/</span>
<a name="l01031"></a>01031         <span class="comment">//Old DAISY nitrification model</span>
<a name="l01032"></a>01032         <span class="keywordtype">double</span> FirstOrderRate = <a class="code" href="classsoil_layer.html#a50746e4427b349f891f3be4eb3bd6878">nitrificationRate</a>*<a class="code" href="classsoil_layer.html#a879c1862803235bad6caa578cfb2989d">AccesibleAmmonium</a>();
<a name="l01033"></a>01033 
<a name="l01034"></a>01034    <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a6dcefc2b3278461493f73971d8885cb7">Add</a> = FirstOrderRate*
<a name="l01035"></a>01035                 <a class="code" href="classsoil_layer.html#a6a9f57294317984233f216b9ce747878">TemperatureNitrificationEffect</a>()*
<a name="l01036"></a>01036                 <a class="code" href="classsoil_layer.html#a68c0eb08bca115585e5abc4cee3c11b7">WaterNitrificationEffect</a>();
<a name="l01037"></a>01037 
<a name="l01038"></a>01038 
<a name="l01039"></a>01039    AddN.<a class="code" href="classnitrogen.html#a49bebcba4c40f3c0a6abb24f590b2c8c">SetBoth</a>(Add,Add*N15RatioAmmonium);
<a name="l01040"></a>01040 
<a name="l01041"></a>01041    <span class="keywordtype">double</span> N2Oratio = <a class="code" href="classsoil_layer.html#a00af828149bbb4f4f7e1544bf75a33e3">RatioN2OEmissionNitri</a>();
<a name="l01042"></a>01042         ratio = <a class="code" href="classsoil_layer.html#a7e696db2177aef85f23ca3c21b076d93">FractionMobileWater</a>();
<a name="l01043"></a>01043    <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>  = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a> + AddN*ratio*(1.0-N2Oratio);
<a name="l01044"></a>01044    <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a> = nitrate_imob + AddN*(1.0-ratio)*(1.0-N2Oratio);
<a name="l01045"></a>01045 
<a name="l01046"></a>01046    <a class="code" href="classsoil_layer.html#ac067c039016361465b827a712fc4ee46">N2OFromNitrification</a> = AddN*N2Oratio;
<a name="l01047"></a>01047 
<a name="l01048"></a>01048    <span class="comment">// Remove ammonium</span>
<a name="l01049"></a>01049    ratio = 1.;
<a name="l01050"></a>01050    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0)
<a name="l01051"></a>01051         ratio = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>/(<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)));
<a name="l01052"></a>01052 
<a name="l01053"></a>01053    <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>  = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a> - AddN.n*ratio;
<a name="l01054"></a>01054    <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a> = <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a> - AddN.n*(1-ratio);
<a name="l01055"></a>01055 
<a name="l01056"></a>01056    <span class="comment">// 15N</span>
<a name="l01057"></a>01057    ratio = 1.;
<a name="l01058"></a>01058    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&gt;0)
<a name="l01059"></a>01059         ratio = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>/(<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>)));
<a name="l01060"></a>01060 
<a name="l01061"></a>01061    <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>  = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a> - AddN.n15*ratio;
<a name="l01062"></a>01062    <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a> = <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a> - AddN.n15*(1-ratio);
<a name="l01063"></a>01063 
<a name="l01064"></a>01064    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1e-10 || <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1e-10 || <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&lt;-1e-10 || <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&lt;-1e-10)
<a name="l01065"></a>01065         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;SoilLayer::UpdateNitrification NH4 less than zero&quot;</span>);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067    <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(<a class="code" href="classsoil_layer.html#ac067c039016361465b827a712fc4ee46">N2OFromNitrification</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l01068"></a>01068    <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(<a class="code" href="classsoil_layer.html#ac067c039016361465b827a712fc4ee46">N2OFromNitrification</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>);
<a name="l01069"></a>01069 
<a name="l01070"></a>01070    <span class="keywordflow">return</span> AddN*(1.0-N2Oratio);
<a name="l01071"></a>01071 }
<a name="l01072"></a>01072 
<a name="l01073"></a>01073 <span class="comment">/****************************************************************************\</span>
<a name="l01074"></a>01074 <span class="comment">Perform denitrification and update contents of nitrate.</span>
<a name="l01075"></a>01075 <span class="comment">returns       - Denitrification [g N/m�/d]</span>
<a name="l01076"></a>01076 <span class="comment">\****************************************************************************/</span>
<a name="l01077"></a><a class="code" href="classsoil_layer.html#ae923fdabe8dc5e40195e3cf39b9ef569">01077</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#ae923fdabe8dc5e40195e3cf39b9ef569">soilLayer::UpdateN2OFromDenitrification</a>(<span class="keywordtype">double</span> TotalCO2Emission)
<a name="l01078"></a>01078 {
<a name="l01079"></a>01079    <a class="code" href="classnitrogen.html">nitrogen</a> NRemove;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081         <span class="comment">// Water effect on denitrificaiton, data presented in Parton et al. (2000)</span>
<a name="l01082"></a>01082    <span class="keywordtype">double</span> WaterEffect = max(0.0,min(1.0,0.0116+1.36/(1+exp(-(<a class="code" href="classsoil_layer.html#ac492720707c5061523bb4996b522107f">GetWaterFilledPorosity</a>()-0.815)/0.0896))));
<a name="l01083"></a>01083 
<a name="l01084"></a>01084    <span class="comment">// N effect on denitrificaiton, based on loam soil</span>
<a name="l01085"></a>01085    <span class="keywordtype">double</span> NitrateConc = (<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>*1000/<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>*1e6; <span class="comment">//unit mg kg-1</span>
<a name="l01086"></a>01086    <span class="keywordtype">double</span> NitrateEffect = max(0.0,min(1.0,1.17*NitrateConc/(32.7+NitrateConc)));
<a name="l01087"></a>01087 
<a name="l01088"></a>01088    <span class="comment">// Temperature effect on denitrificaiton</span>
<a name="l01089"></a>01089    <span class="keywordtype">double</span> tempAdjust = 1.0/exp(-3.432+0.168*10*(1.0-0.5*10/36.9));
<a name="l01090"></a>01090    <span class="keywordtype">double</span> TemperatureEffect = tempAdjust*exp(-3.432+0.168*<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>*(1.0-0.5*<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>/36.9));
<a name="l01091"></a>01091 
<a name="l01092"></a>01092    <span class="comment">// kd estimation</span>
<a name="l01093"></a>01093         <span class="keywordtype">double</span> DenPotClay = 0.286+0.0028*<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>*100; <span class="comment">// clay effect is based on Drury et al., 1991  (Based on linear regression of data - JBE)</span>
<a name="l01094"></a>01094 
<a name="l01095"></a>01095    <span class="comment">// Actual denitrification</span>
<a name="l01096"></a>01096         <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#adad888a2d01d277a32514646edb71c9e">Denitrification</a> = DenPotClay * <a class="code" href="classsoil_layer.html#ae664742ac96eb6f49caa66e8c4b8d708">PotentialCarbonTurnover</a>()*WaterEffect*NitrateEffect*TemperatureEffect;
<a name="l01097"></a>01097    Denitrification = min(Denitrification,0.9999*(<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>));
<a name="l01098"></a>01098 
<a name="l01099"></a>01099    <span class="keywordflow">if</span> (Denitrification&gt;0)
<a name="l01100"></a>01100    {
<a name="l01101"></a>01101       <span class="keywordtype">double</span> N15RatioNitrate= 1.0;
<a name="l01102"></a>01102         <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0.0)
<a name="l01103"></a>01103                 N15RatioNitrate = max(0.0,min(1.0,(<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>)/(<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)));
<a name="l01104"></a>01104 
<a name="l01105"></a>01105       NRemove.<a class="code" href="classnitrogen.html#a49bebcba4c40f3c0a6abb24f590b2c8c">SetBoth</a>(Denitrification,N15RatioNitrate*Denitrification);
<a name="l01106"></a>01106       <span class="comment">// N from nitrate pools</span>
<a name="l01107"></a>01107            <span class="keywordtype">double</span> ratio = 1.;
<a name="l01108"></a>01108         <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0)
<a name="l01109"></a>01109         ratio = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>/(<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>+<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>)));
<a name="l01110"></a>01110 
<a name="l01111"></a>01111         <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a> -= ratio*<a class="code" href="classsoil_layer.html#adad888a2d01d277a32514646edb71c9e">Denitrification</a>;
<a name="l01112"></a>01112         <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a> -= (1-ratio)*Denitrification;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114       <span class="comment">// 15N from nitrate pools</span>
<a name="l01115"></a>01115       ratio = 1.;
<a name="l01116"></a>01116         <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&gt;0)
<a name="l01117"></a>01117         ratio = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>/(<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>+<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>)));
<a name="l01118"></a>01118         <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a> -= N15RatioNitrate*ratio*<a class="code" href="classsoil_layer.html#adad888a2d01d277a32514646edb71c9e">Denitrification</a>;
<a name="l01119"></a>01119         <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a> -= N15RatioNitrate*(1-ratio)*Denitrification;
<a name="l01120"></a>01120       <span class="keywordflow">if</span>(<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-0.0 || <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-0.0)
<a name="l01121"></a>01121                 <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::Denitrification - negative nitrate concentrations&quot;</span>);
<a name="l01122"></a>01122 
<a name="l01123"></a>01123         }
<a name="l01124"></a>01124    <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(NRemove.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l01125"></a>01125    <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#a47bfa9740186f2be18a10dd3423a5eea">AddOutput</a>(NRemove.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127 
<a name="l01128"></a>01128    <a class="code" href="classsoil_layer.html#a4ba9ff292a84bae74b17671f46c2d32d">N2OFromDenitrification</a> = NRemove;
<a name="l01129"></a>01129 }
<a name="l01130"></a>01130 
<a name="l01131"></a>01131 <span class="comment">/****************************************************************************\</span>
<a name="l01132"></a>01132 <span class="comment">Perform estimation of N2 production from N2O pool</span>
<a name="l01133"></a>01133 <span class="comment">returns       - emission</span>
<a name="l01134"></a>01134 <span class="comment">\****************************************************************************/</span>
<a name="l01135"></a><a class="code" href="classsoil_layer.html#a994f47ea2ca0d8a0d98515bb83600cf2">01135</a> <a class="code" href="classnitrogen.html">nitrogen</a> <a class="code" href="classsoil_layer.html#a994f47ea2ca0d8a0d98515bb83600cf2">soilLayer::UpdateN2Production</a>()
<a name="l01136"></a>01136 {
<a name="l01137"></a>01137         <a class="code" href="classnitrogen.html">nitrogen</a> TotalN2OProduction = <a class="code" href="classsoil_layer.html#a4ba9ff292a84bae74b17671f46c2d32d">N2OFromDenitrification</a> + <a class="code" href="classsoil_layer.html#ac067c039016361465b827a712fc4ee46">N2OFromNitrification</a>;
<a name="l01138"></a>01138 
<a name="l01139"></a>01139    <span class="comment">// W-factor (deficit of oxygen), based on Nommik (1956) and Wijler &amp; Delwiche (1954)</span>
<a name="l01140"></a>01140    <span class="keywordtype">double</span> fWater = 1.0-(0.0116+1.36/(1.0+exp(-(<a class="code" href="classsoil_layer.html#ac492720707c5061523bb4996b522107f">GetWaterFilledPorosity</a>()-0.815)/0.0896))); <span class="comment">// inversed water factor</span>
<a name="l01141"></a>01141    fWater = max(0.0,min(1.0,fWater));
<a name="l01142"></a>01142 
<a name="l01143"></a>01143    <span class="comment">// Diffusion model substitution; the profile N2O also will be included!!!</span>
<a name="l01144"></a>01144    <span class="keywordtype">double</span> fTemperature = 1.0/(1+exp(-0.64+0.08*<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>)); <span class="comment">// Finn&#39;s temperature factor</span>
<a name="l01145"></a>01145 
<a name="l01146"></a>01146    <span class="comment">// Updated for loam soil to the clayContent range, corr. with data from Letey et al. (1980)</span>
<a name="l01147"></a>01147    <span class="keywordtype">double</span> fClay = 1.26*exp(-1.16*<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>)-0.249;
<a name="l01148"></a>01148    <span class="comment">// Soil N20 emission profile for loam soil, based on Yoh et al. (1999)</span>
<a name="l01149"></a>01149    <span class="keywordtype">double</span> depth = <a class="code" href="classsoil_layer.html#a1789c88edae9f3ef01bc1b321bc71913">GetCenterDepth</a>()/1000.0;
<a name="l01150"></a>01150    <span class="keywordtype">double</span> fProfile = max(0.0,min(1.0,1.0008-0.0343*depth-3.1816*depth*depth));
<a name="l01151"></a>01151 
<a name="l01152"></a>01152    <span class="comment">// N2 evolution and distribution of emitted N2O between the sources</span>
<a name="l01153"></a>01153    <span class="keywordtype">double</span> N2ORatio = fClay*fWater*fTemperature*fProfile; <span class="comment">// N2O reduction corrected!</span>
<a name="l01154"></a>01154 
<a name="l01155"></a>01155    <a class="code" href="classnitrogen.html">nitrogen</a> N2OEmission = TotalN2OProduction*N2ORatio;
<a name="l01156"></a>01156    <a class="code" href="classsoil_layer.html#a4ba9ff292a84bae74b17671f46c2d32d">N2OFromDenitrification</a> = <a class="code" href="classsoil_layer.html#a4ba9ff292a84bae74b17671f46c2d32d">N2OFromDenitrification</a>*N2ORatio;
<a name="l01157"></a>01157    N2OFromNitrification = N2OFromNitrification*N2ORatio;
<a name="l01158"></a>01158 
<a name="l01159"></a>01159    <a class="code" href="classsoil_layer.html#adad888a2d01d277a32514646edb71c9e">Denitrification</a> = TotalN2OProduction*(1-N2ORatio);
<a name="l01160"></a>01160 
<a name="l01161"></a>01161    <span class="keywordflow">return</span> TotalN2OProduction*(1-N2ORatio); <span class="comment">// notice this sum only includes N2 from denitrification</span>
<a name="l01162"></a>01162 }
<a name="l01163"></a>01163 <span class="comment">/****************************************************************************\</span>
<a name="l01164"></a>01164 <span class="comment">Perform N2O emission from nitrification</span>
<a name="l01165"></a>01165 <span class="comment">returns       - emission</span>
<a name="l01166"></a>01166 <span class="comment">\****************************************************************************/</span>
<a name="l01167"></a><a class="code" href="classsoil_layer.html#a00af828149bbb4f4f7e1544bf75a33e3">01167</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a00af828149bbb4f4f7e1544bf75a33e3">soilLayer::RatioN2OEmissionNitri</a>()
<a name="l01168"></a>01168 {
<a name="l01169"></a>01169         <span class="keywordtype">double</span> N2Oratio;
<a name="l01170"></a>01170 
<a name="l01171"></a>01171         <span class="comment">// Approach by Ingwersen et al, 1999</span>
<a name="l01172"></a>01172    <span class="keywordtype">double</span> tFactor = max(0.0,min(1.0,exp(-0.5*pow(<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>/(2*3.14*2.72)-2.0,2.0))));
<a name="l01173"></a>01173    <span class="keywordtype">double</span> WaterFactor = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#ac492720707c5061523bb4996b522107f">GetWaterFilledPorosity</a>()));
<a name="l01174"></a>01174 
<a name="l01175"></a>01175    <span class="comment">// Combined emission factor from er Ambus (2001), anual effect as from N2Oratio = 0.28-0.48% (Maag and Vinther, 1996)</span>
<a name="l01176"></a>01176    N2Oratio = 0.047*tFactor*WaterFactor; 
<a name="l01177"></a>01177    <span class="keywordflow">return</span> N2Oratio;
<a name="l01178"></a>01178 }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180 <span class="comment">/****************************************************************************\</span>
<a name="l01181"></a>01181 <span class="comment">Calculate the fraction of ammonium that is in the water phase.</span>
<a name="l01182"></a>01182 <span class="comment">returns       - Fraction of ammonium in soluble phase.</span>
<a name="l01183"></a>01183 <span class="comment">\****************************************************************************/</span>
<a name="l01184"></a><a class="code" href="classsoil_layer.html#a45a1255f7f65f6f2ac3087b13061ee93">01184</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a45a1255f7f65f6f2ac3087b13061ee93">soilLayer::FracAmmoniumInWater</a>()
<a name="l01185"></a>01185 {
<a name="l01186"></a>01186  <span class="keyword">const</span> <span class="keywordtype">double</span> Vp=5.96E-3;
<a name="l01187"></a>01187  <span class="keyword">const</span> <span class="keywordtype">double</span> Ve=0.308E-3;
<a name="l01188"></a>01188  <span class="keyword">const</span> <span class="keywordtype">double</span> Kp=630;
<a name="l01189"></a>01189  <span class="keyword">const</span> <span class="keywordtype">double</span> Ke=13.7;
<a name="l01190"></a>01190  <span class="keywordtype">double</span> f;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192  f = (<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>)/(<a class="code" href="classsoil_layer.html#aaf3922a3efbd185e030373650622b630">clayContent</a>*<a class="code" href="classsoil_layer.html#ad190ee5264df24788ae2854167ad92c1">dryBulkDensity</a>*(Vp/Kp+Ve/Ke)+(<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>));
<a name="l01193"></a>01193  <span class="keywordflow">return</span> min(1.,f);
<a name="l01194"></a>01194 }
<a name="l01195"></a>01195 
<a name="l01196"></a>01196 
<a name="l01197"></a>01197 
<a name="l01198"></a>01198 <span class="comment">/****************************************************************************\</span>
<a name="l01199"></a>01199 <span class="comment">Calculate the tortuosity factor</span>
<a name="l01200"></a>01200 <span class="comment">returns       - Tortuosity factor</span>
<a name="l01201"></a>01201 <span class="comment">\****************************************************************************/</span>
<a name="l01202"></a><a class="code" href="classsoil_layer.html#adc0d1556be252d13f6facc7634757254">01202</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#adc0d1556be252d13f6facc7634757254">soilLayer::Tortuosity</a>()
<a name="l01203"></a>01203 {
<a name="l01204"></a>01204    <span class="keywordtype">double</span> relWat = <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>;
<a name="l01205"></a>01205    <span class="keywordtype">double</span> val = pow(relWat,7.0/3.0)/pow(<a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a662cff8287e3a413961df635acef65b7">GetRelativeWater</a>(0.0),2.0);        <span class="comment">// Millington-Quirk</span>
<a name="l01206"></a>01206    <span class="keywordflow">return</span> val;
<a name="l01207"></a>01207    <span class="comment">//double f = 1.0E-6;</span>
<a name="l01208"></a>01208    <span class="comment">//if (relWat&gt;tortuosityLimit)</span>
<a name="l01209"></a>01209    <span class="comment">//f = 1.0E-6+tortuosityFactor*(relWat-tortuosityLimit);</span>
<a name="l01210"></a>01210 }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 <span class="comment">/****************************************************************************\</span>
<a name="l01213"></a>01213 <span class="comment">Calculates the effect of temperature on nitrification</span>
<a name="l01214"></a>01214 <span class="comment">returns       - Relative effect</span>
<a name="l01215"></a>01215 <span class="comment">\****************************************************************************/</span>
<a name="l01216"></a><a class="code" href="classsoil_layer.html#a6a9f57294317984233f216b9ce747878">01216</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a6a9f57294317984233f216b9ce747878">soilLayer::TemperatureNitrificationEffect</a>()
<a name="l01217"></a>01217 {
<a name="l01218"></a>01218    <span class="keywordtype">double</span> F = 0;
<a name="l01219"></a>01219    <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>&lt;=1.) F = 0.0;
<a name="l01220"></a>01220    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>&lt;=5) F = 0.125*(<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>-1.);
<a name="l01221"></a>01221    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>&lt;=20) F = 0.1*<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>;
<a name="l01222"></a>01222    <span class="keywordflow">else</span> F = exp(0.4657-0.027259*<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>+0.0019315*<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>*<a class="code" href="classsoil_layer.html#a8c100de8f42bdeee54f33f8df188ba6e">temperature</a>);
<a name="l01223"></a>01223    <span class="keywordflow">return</span> F;
<a name="l01224"></a>01224 }
<a name="l01225"></a>01225 
<a name="l01226"></a>01226 <span class="comment">/****************************************************************************\</span>
<a name="l01227"></a>01227 <span class="comment">Calculates the effect of soil water content on nitrification</span>
<a name="l01228"></a>01228 <span class="comment">returns       - Relative effect</span>
<a name="l01229"></a>01229 <span class="comment">\****************************************************************************/</span>
<a name="l01230"></a><a class="code" href="classsoil_layer.html#a68c0eb08bca115585e5abc4cee3c11b7">01230</a> <span class="keywordtype">double</span> <a class="code" href="classsoil_layer.html#a68c0eb08bca115585e5abc4cee3c11b7">soilLayer::WaterNitrificationEffect</a>()
<a name="l01231"></a>01231 {
<a name="l01232"></a>01232    <span class="keywordtype">double</span> F = 0.0;
<a name="l01233"></a>01233    <span class="keywordtype">double</span> pf = <a class="code" href="classsoil_layer.html#ac97a45048a4d857718e2ab7bbe581619">pF</a>-&gt;<a class="code" href="classp_f___curve.html#a6989350998b7c15af4fd59055ee20676">GetpF</a>(<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>/<a class="code" href="classsoil_layer.html#adaeedd67db3ed2312056db1469945ffa">thickness</a>);
<a name="l01234"></a>01234    <span class="keywordflow">if</span> (pf&lt;=0 || pf&gt;=5)
<a name="l01235"></a>01235       F = 0.0;
<a name="l01236"></a>01236    <span class="keywordflow">else</span>
<a name="l01237"></a>01237       <span class="keywordflow">if</span> (pf&lt;1.5)
<a name="l01238"></a>01238          F = pf/1.5;
<a name="l01239"></a>01239       <span class="keywordflow">else</span>
<a name="l01240"></a>01240          <span class="keywordflow">if</span> (pf&lt;2.5)
<a name="l01241"></a>01241             F = 1.0;
<a name="l01242"></a>01242          <span class="keywordflow">else</span>
<a name="l01243"></a>01243             F = (5.0-pf)/2.5;
<a name="l01244"></a>01244    <span class="keywordflow">return</span> F;
<a name="l01245"></a>01245 }
<a name="l01246"></a>01246 
<a name="l01247"></a>01247 
<a name="l01248"></a>01248 
<a name="l01249"></a>01249 
<a name="l01250"></a>01250 <span class="comment">/****************************************************************************\</span>
<a name="l01251"></a>01251 <span class="comment">\****************************************************************************/</span>
<a name="l01252"></a><a class="code" href="classsoil_layer.html#a02f3d74a63ae05911287bd29ce22427c">01252</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#a02f3d74a63ae05911287bd29ce22427c">soilLayer::AddProduct</a>(<a class="code" href="classorganic_product.html">organicProduct</a>&amp; <a class="code" href="classproduct.html">product</a>)
<a name="l01253"></a>01253 {
<a name="l01254"></a>01254    <a class="code" href="classorganic_product.html">organicProduct</a> * p = <span class="keyword">new</span> <a class="code" href="classorganic_product.html">organicProduct</a>(product);
<a name="l01255"></a>01255    <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>  = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>+p-&gt;<a class="code" href="classorganic_product.html#a0802b95a06c9487102b3f8c1852f683a">GetNitrate</a>();
<a name="l01256"></a>01256    <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a> = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>+p-&gt;<a class="code" href="classorganic_product.html#a40c6ff10538b07cc1dcd0a9d55bb2b6e">GetAmmonium</a>();
<a name="l01257"></a>01257 
<a name="l01258"></a>01258    p-&gt;<a class="code" href="classorganic_product.html#a6068cca47d8fb9b69fa3f5ebdc4de374">ClearNO3_content</a>();
<a name="l01259"></a>01259    p-&gt;<a class="code" href="classorganic_product.html#a8717b1f12853806f7e4290e6df1db63d">ClearNH4_content</a>();
<a name="l01260"></a>01260 
<a name="l01261"></a>01261    <a class="code" href="classnitrogen.html">nitrogen</a> nitrate  = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a> + <a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>;
<a name="l01262"></a>01262    <a class="code" href="classnitrogen.html">nitrogen</a> ammonium = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a> + <a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>;
<a name="l01263"></a>01263    <span class="keywordtype">double</span> nitfrac = 0.0;
<a name="l01264"></a>01264    <span class="keywordflow">if</span> (nitrate.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0.0)
<a name="l01265"></a>01265       nitfrac = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>/nitrate));
<a name="l01266"></a>01266 
<a name="l01267"></a>01267    <span class="keywordtype">double</span> ammfrac = 0.0;
<a name="l01268"></a>01268    <span class="keywordflow">if</span> ((<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0.0) &amp;&amp; (ammonium.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a> &gt;0.0))
<a name="l01269"></a>01269       ammfrac = max(0.0,min(1.0,<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>/ammonium));
<a name="l01270"></a>01270 
<a name="l01271"></a>01271    <span class="comment">// Deals with protected NH4</span>
<a name="l01272"></a>01272    <span class="keywordtype">double</span> unprotecFrac = 0.0;
<a name="l01273"></a>01273    <span class="keywordflow">if</span> (ammonium.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&gt;0.0)
<a name="l01274"></a>01274         unprotecFrac = <a class="code" href="classsoil_layer.html#a879c1862803235bad6caa578cfb2989d">AccesibleAmmonium</a>()/ammonium.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>;
<a name="l01275"></a>01275    <a class="code" href="classnitrogen.html">nitrogen</a> ProtectedNH4_mob  = <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>*(1.0-unprotecFrac);
<a name="l01276"></a>01276    <a class="code" href="classnitrogen.html">nitrogen</a> ProtectedNH4_imob = ammonium_imob*(1.0-unprotecFrac);
<a name="l01277"></a>01277    ammonium = ammonium*unprotecFrac;
<a name="l01278"></a>01278 
<a name="l01279"></a>01279    <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#ab31c08dc89717cfc1d1e212c4076ff3c">SetMineralNitrogen</a>(nitrate,ammonium);
<a name="l01280"></a>01280    <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#affa8ea4461d2badd187dc2fe9ef467d7">AddProduct</a>(p);
<a name="l01281"></a>01281    <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#a08fafc2497f2ef975d24ed944a7fe39d">GetMineralNitrogen</a>(nitrate,ammonium);
<a name="l01282"></a>01282 
<a name="l01283"></a>01283    nitfrac=<a class="code" href="classsoil_layer.html#a7e696db2177aef85f23ca3c21b076d93">FractionMobileWater</a>();
<a name="l01284"></a>01284    ammfrac = nitfrac;
<a name="l01285"></a>01285 
<a name="l01286"></a>01286         <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>  = nitrate*nitfrac;
<a name="l01287"></a>01287         nitrate_imob = nitrate*(1.0-nitfrac);
<a name="l01288"></a>01288         <a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a> = ammonium*ammfrac+ProtectedNH4_mob;
<a name="l01289"></a>01289         ammonium_imob= ammonium*(1.0-ammfrac)+ProtectedNH4_imob;
<a name="l01290"></a>01290 
<a name="l01291"></a>01291    <span class="keywordflow">if</span>(ammonium_mob.n&lt;-1E-6 || ammonium_imob.n&lt;-1E-6 || <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>&lt;-1E-6 || nitrate_imob.n&lt;-1E-6 || <a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#a719b504d46e267423e58c37d1c1bc058">GetNitrogen</a>().<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>&lt;-1e-10)
<a name="l01292"></a>01292         <a class="code" href="message_8h.html#a8ad29009121a629982c6ade0bd332470">theMessage</a>-&gt;<a class="code" href="classmessage.html#afed66d0552f90b4385c5169cf5929907">WarningWithDisplay</a>(<span class="stringliteral">&quot;soilLayer::UpdateOrganicMatter - negative n concentrations&quot;</span>);
<a name="l01293"></a>01293 
<a name="l01294"></a>01294    <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#ad619d773e77931df0435e8c08314f68e">AddInput</a>(product.<a class="code" href="classorganic_product.html#aba7720784ab3cc2e672d2659085b3950">GetTotalNitrogen</a>().<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l01295"></a>01295    <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#ad619d773e77931df0435e8c08314f68e">AddInput</a>(product.<a class="code" href="classorganic_product.html#aba7720784ab3cc2e672d2659085b3950">GetTotalNitrogen</a>().<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>);
<a name="l01296"></a>01296 
<a name="l01297"></a>01297    <span class="keyword">delete</span> p;
<a name="l01298"></a>01298 }
<a name="l01299"></a>01299 
<a name="l01300"></a>01300 <span class="comment">/****************************************************************************\</span>
<a name="l01301"></a>01301 <span class="comment">\****************************************************************************/</span>
<a name="l01302"></a><a class="code" href="classsoil_layer.html#a183d7d2254081522d73ac4abf588691d">01302</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#a183d7d2254081522d73ac4abf588691d">soilLayer::StartBudget</a>()
<a name="l01303"></a>01303 {
<a name="l01304"></a>01304    <a class="code" href="classnitrogen.html">nitrogen</a> NO=<a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#a719b504d46e267423e58c37d1c1bc058">GetNitrogen</a>();
<a name="l01305"></a>01305    <a class="code" href="classnitrogen.html">nitrogen</a> N = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>+<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>+<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>+NO;
<a name="l01306"></a>01306    <a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#a885260b83f245dee43a1e6ee70a4c68d">SetInput</a>(N.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>);
<a name="l01307"></a>01307    <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#a885260b83f245dee43a1e6ee70a4c68d">SetInput</a>(N.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>);
<a name="l01308"></a>01308    <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>.<a class="code" href="classbudget.html#a885260b83f245dee43a1e6ee70a4c68d">SetInput</a>(<a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>);
<a name="l01309"></a>01309 }
<a name="l01310"></a>01310 
<a name="l01311"></a>01311 <span class="comment">/****************************************************************************\</span>
<a name="l01312"></a>01312 <span class="comment">\****************************************************************************/</span>
<a name="l01313"></a><a class="code" href="classsoil_layer.html#ac1c46edeecd5a54044c434adf939301b">01313</a> <span class="keywordtype">void</span> <a class="code" href="classsoil_layer.html#ac1c46edeecd5a54044c434adf939301b">soilLayer::EndBudget</a>()
<a name="l01314"></a>01314 {
<a name="l01315"></a>01315    <a class="code" href="classnitrogen.html">nitrogen</a> NO=<a class="code" href="classsoil_layer.html#a2a435b2ee0bb8fc085bfd8e418339c9f">OrganicMatter</a>-&gt;<a class="code" href="classorganic_matter.html#a719b504d46e267423e58c37d1c1bc058">GetNitrogen</a>();
<a name="l01316"></a>01316    <a class="code" href="classnitrogen.html">nitrogen</a> NRemain = <a class="code" href="classsoil_layer.html#aa5d5dd2021604f5ce457550571689bb7">nitrate_mob</a>+<a class="code" href="classsoil_layer.html#a94f7dd776e541528ee10c8bba3810d8c">nitrate_imob</a>+<a class="code" href="classsoil_layer.html#a46a692f84c465b139ac6ba90f00929c8">ammonium_mob</a>+<a class="code" href="classsoil_layer.html#afcca8c6729c4acfef5af17e79f06640a">ammonium_imob</a>+NO;
<a name="l01317"></a>01317    <span class="keywordflow">if</span> (!<a class="code" href="classsoil_layer.html#a2fb9c4c31dd844007f1bf229e69fd1fa">Nbudget</a>.<a class="code" href="classbudget.html#a2814c71d2d504462defc2c85f2cd86b2">Balance</a>(NRemain.<a class="code" href="classnitrogen.html#aa708078375ba23f1dd31e08e28269dac">n</a>))
<a name="l01318"></a>01318       cout &lt;&lt; <span class="stringliteral">&quot;soilLayer::EndBudget() - Name path &quot;</span> &lt;&lt; <a class="code" href="classbase.html#aae39ec3da4311af6b93e424d29b2c66a">GetLongName</a>() &lt;&lt; endl; <span class="comment">// !!!</span>
<a name="l01319"></a>01319    <a class="code" href="classsoil_layer.html#a50898c77bd337a9cd05b278876634b84">N15budget</a>.<a class="code" href="classbudget.html#a2814c71d2d504462defc2c85f2cd86b2">Balance</a>(NRemain.<a class="code" href="classnitrogen.html#a2d537cc848da50f09b7580539f261dfc">n15</a>);
<a name="l01320"></a>01320    <span class="keywordtype">double</span> WaterRemain = <a class="code" href="classsoil_layer.html#aa9ba9dbe9052bd34f5db9a05f85eeada">waterContent</a>;
<a name="l01321"></a>01321    <a class="code" href="classsoil_layer.html#aa005dc5bb5f38857b311ba363a57de9f">WaterBudget</a>.<a class="code" href="classbudget.html#a2814c71d2d504462defc2c85f2cd86b2">Balance</a>(WaterRemain);
<a name="l01322"></a>01322 }
<a name="l01323"></a>01323 
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Mon Aug 22 2011 10:29:05 for Fasset by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
